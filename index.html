<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Tools Launcher</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<!-- Load Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<!-- Google Font (Inter) -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<style>
/* Custom configuration to ensure full height and Inter font */
body {
  font-family: 'Inter', sans-serif;
  height: 100vh;
  margin: 0;
  display: flex;
  flex-direction: column;
}

/* Sidebar Specific Styles */
.sidebar {
  width: 250px; 
}
.sidebar.collapsed {
  width: 60px;
}

/* Base link styling */
.nav-link {
  transition: all 0.2s ease;
  font-weight: 500;
  white-space: nowrap;
}

/* Define a custom shadow for the active border */
.active-shadow {
  box-shadow: inset 3px 0 0 #4f46e5; /* Indigo 600 for the active indicator line */
}

/* Ensure the collapsed sidebar only shows the icon */
.sidebar.collapsed .tool-label {
  display: none;
}
.sidebar.collapsed .favorite {
  display: none;
}

/* Mobile specific styling for the fixed sidebar */
@media (max-width: 767px) {
  .sidebar {
    transform: translateX(-100%);
    position: fixed;
    top: 0;
    bottom: 0;
    z-index: 50; 
    width: 80vw; 
    max-width: 300px;
    box-shadow: 4px 0 10px rgba(0,0,0,.3);
  }
  .sidebar.open {
    transform: translateX(0);
  }
  #mobileToggleBtn {
    display: flex;
  }
  #desktopToggleBtn {
    display: none;
  }
}

/* Hide mobile toggle on desktop */
@media (min-width: 768px) {
  #mobileToggleBtn {
    display: none !important;
  }
  #desktopToggleBtn {
    display: flex;
  }
}
</style>
</head>
<body class="bg-gray-100">

<!-- Header -->
<header class="bg-gradient-to-r from-indigo-600 to-purple-700 text-white p-4 shadow-xl flex justify-between items-center">
  <h3 class="text-xl font-bold">‚öôÔ∏è MultiTools V2 Launcher</h3>
  <!-- Mobile Toggle Button (Visible only on small screens) -->
  <button id="mobileToggleBtn" class="p-1 rounded-md text-white hover:bg-white hover:text-indigo-600 transition-colors duration-200">
    <i class="bi bi-list text-2xl"></i>
  </button>
</header>

<div class="flex-1 flex overflow-hidden">
  
  <!-- Sidebar -->
  <nav class="sidebar flex flex-col bg-white border-r border-gray-200 overflow-y-auto transition-transform duration-300" id="sidebar">
    
    <!-- Desktop Toggle Button (Visible only on desktop) -->
    <div class="hidden md:flex justify-end p-2 border-b border-gray-200 cursor-pointer sticky top-0 bg-white z-10" id="desktopToggleBtn">
      <i class="bi bi-chevron-left text-xl text-gray-600 hover:text-indigo-600 transition"></i>
    </div>

    <!-- Pinned Tabs -->
    <ul class="flex flex-col border-b border-gray-200" id="pinnedTabs"></ul>
    
    <!-- Separator -->
    <div class="h-2 bg-gray-50 border-y border-gray-200"></div>

    <!-- All Tools -->
    <ul class="flex flex-col flex-1" id="toolTabs"></ul>
    
  </nav>

  <!-- Content Area (Iframe) -->
  <div class="content flex-1 p-2 md:p-4 overflow-hidden" id="mainContent">
    <iframe id="toolFrame" src="about:blank" class="w-full h-full border-none rounded-xl shadow-2xl bg-white"></iframe>
    <footer class="text-right text-xs text-gray-500 mt-2 md:mt-4">
      <a target="_blank" href="https://www.google.com" class="text-gray-500 hover:text-indigo-600 transition-colors duration-200">üåê Sandbox Browser</a>
    </footer>
  </div>
</div>

<script>
let allEntries = [];
let pinnedFiles = JSON.parse(localStorage.getItem("pinnedTools") || "[]");
let isDesktopCollapsed = false;

// --- CSS Class Definitions ---
const UNPINNED_BASE = 'text-gray-700 hover:bg-gray-100';
const PINNED_BASE = 'bg-indigo-50 text-indigo-800 hover:bg-indigo-100';

const ACTIVE_UNPINNED = 'bg-gray-200 active-shadow';
const ACTIVE_PINNED = 'bg-indigo-100 active-shadow';

const STAR_ON = 'text-yellow-400 hover:text-yellow-500';
const STAR_OFF = 'text-gray-300 hover:text-yellow-400';

// The fallback content from the user's provided list
const mockIni = `
  Ping Tool v1,ping_tool.html,2
  net_details.html
  device_specs.html
  user_info.html
  sticky_notes.html
  keyboard_tester.html
  mic_tester.html
  text_to_speech.html
  text_to_image.html
  image_analyzer.html
  image_to_text.html
  website_security_checker.html
  csv_writer.html
  xml_editor.html
  text_analyzer.html
  color_picker.html
  image_coordinate_tracker.html
  time_tools.html
`;

// --- API Mock/Fetch ---

function loadPagesIni() {
  const deferred = $.Deferred();

  // 1. Attempt AJAX call to load the external pages.ini
  $.ajax({ 
    url: "pages.ini", 
    method: "GET", 
    dataType: "text" 
  })
  .done(function(data) {
    // 2. Success: Resolve with loaded data
    console.log("pages.ini loaded successfully from external file.");
    deferred.resolve(data);
  })
  .fail(function(jqXHR, textStatus, errorThrown) {
    // 3. Failure: Fallback to mock data (user's provided list)
    console.warn(`pages.ini failed to load (${textStatus}: ${errorThrown}). Falling back to mock data.`);
    deferred.resolve(mockIni);
  });

  return deferred.promise();
}

// --- Utility Functions ---

function prettifyTitle(str) {
  str = str.replace(/\.html$/i, "");
  str = str.replace(/[_\-]+/g, " ");
  str = str.replace(/\w\S*/g, w => w.charAt(0).toUpperCase() + w.substr(1).toLowerCase());
  return str;
}

function getToolIcon(file) {
  file = file.toLowerCase();
  if(file.includes("csv") || file.includes("writer")) return "bi-file-spreadsheet";
  if(file.includes("color")) return "bi-palette";
  if(file.includes("keyboard")) return "bi-keyboard";
  if(file.includes("tts") || file.includes("speech")) return "bi-volume-up";
  if(file.includes("net") || file.includes("device") || file.includes("ping")) return "bi-wifi";
  if(file.includes("image") || file.includes("convert") || file.includes("tracker")) return "bi-image";
  if(file.includes("xml") || file.includes("text") || file.includes("analyzer")) return "bi-file-text";
  if(file.includes("security")) return "bi-shield-lock";
  if(file.includes("notes") || file.includes("sticky")) return "bi-stickies";
  return "bi-app-indicator";
}

function savePinnedFiles(){ localStorage.setItem("pinnedTools", JSON.stringify(pinnedFiles)); }

// --- Main Logic ---

$(function(){
  const $sidebar = $("#sidebar");
  const $desktopToggleBtn = $("#desktopToggleBtn");
  const $mobileToggleBtn = $("#mobileToggleBtn");
  const $pinnedTabs = $("#pinnedTabs");
  const $tabs = $("#toolTabs");
  const $frame = $("#toolFrame");

  // --- Sidebar Toggle Handlers ---
  
  $desktopToggleBtn.on("click", function(){
    $sidebar.toggleClass("collapsed");
    isDesktopCollapsed = $sidebar.hasClass("collapsed");
    const icon = isDesktopCollapsed ? "bi-chevron-right" : "bi-chevron-left";
    $(this).find("i").attr("class", "bi " + icon);
  });
  
  $mobileToggleBtn.on("click", function(){
    $sidebar.toggleClass("open");
  });

  $(document).on("click", ".nav-link", function(){
    if (window.innerWidth < 768) {
        $sidebar.removeClass("open");
    }
  });

  // --- Initial Data Load ---
  
  loadPagesIni().done(function(data){
    let lines = data.split(/\r?\n/).map(l => l.trim()).filter(l => l && !l.startsWith(";") && !l.startsWith("["));
    let entries = lines.map(line => {
      let parts = line.split(",").map(s => s.trim()), file = "", title = "", index = 9999;
      if(parts.length===3){title=parts[0]||parts[1];file=parts[1];index=parseInt(parts[2],10)||9999;}
      else if(parts.length===2){if(isNaN(parts[1])){file=parts[0];title=file;index=parseInt(parts[1],10)||9999;}else{title=parts[0]||parts[1];file=parts[1];}}
      else if(parts.length===1){file=parts[0];title=file;}

      title = prettifyTitle(title);
      let fav = pinnedFiles.includes(file);
      return {title, file, index, favorite: fav, idSuffix: Math.random().toString(36).substr(2,5)};
    });

    entries.sort((a, b) => a.index - b.index);
    allEntries = entries;

    // Render Tab Function
    function createTab(entry, container){
      let id = "tab-" + entry.file.replace(/[^a-z0-9]/gi, "") + "-" + entry.idSuffix;
      let iconClass = getToolIcon(entry.file);
      
      let baseClasses = entry.favorite ? PINNED_BASE : UNPINNED_BASE;
      let starClasses = entry.favorite ? STAR_ON : STAR_OFF;

      let $tab = $(`
        <li class="nav-item">
          <a class="nav-link p-3 rounded-none flex items-center justify-between transition-colors duration-150 ${baseClasses}" id="${id}" href="#" title="${entry.title}">
            <span class="tool-left flex items-center gap-3 flex-1 overflow-hidden">
                <i class="bi ${iconClass} text-xl"></i>
                <span class="tool-label">${entry.title}</span>
            </span>
            <i class="bi bi-star-fill favorite text-xl cursor-pointer ${starClasses}"></i>
          </a>
        </li>
      `);
      container.append($tab);

      // Tab Click Handler
      $tab.find("a").on("click", function(e){
        e.preventDefault();
        
        // 1. Remove active state from ALL tabs
        $(".sidebar .nav-link").each(function() {
            const $link = $(this);
            $link.removeClass(ACTIVE_UNPINNED).removeClass(ACTIVE_PINNED).removeClass('active-shadow');
            
            // Re-apply correct base class if it was pinned/unpinned
            const currentEntry = allEntries.find(en => $link.attr('id').includes(en.idSuffix));
            if (currentEntry) {
                 const baseClass = currentEntry.favorite ? PINNED_BASE : UNPINNED_BASE;
                 $link.addClass(baseClass);
            }
        });
        
        // 2. Add active state to the clicked tab
        const activeClass = entry.favorite ? ACTIVE_PINNED : ACTIVE_UNPINNED;
        $(this).removeClass(UNPINNED_BASE).removeClass(PINNED_BASE).addClass(activeClass);
        
        // 3. Load iframe - FIXED: added 'tools/' prefix
        $frame.attr("src", 'tools/' + entry.file);
      });
    }

    // Sort and render tabs
    entries.forEach(e => e.favorite ? createTab(e, $pinnedTabs) : createTab(e, $tabs));

    // Load the first entry by default and mark it as active
    if (entries.length > 0) {
        $(`#tab-${entries[0].file.replace(/[^a-z0-9]/gi,"")}-${entries[0].idSuffix}`).trigger('click');
    }
  });

  // --- Favorite/Pin Click Handler ---
  
  $(document).on("click", ".favorite", function(e){
    e.stopPropagation();
    const $star = $(this);
    const $tab = $star.closest("li.nav-item");
    const $link = $star.closest("a");
    
    const idPart = $link.attr("id").split("tab-")[1];
    const entry = allEntries.find(en => en.file.replace(/[^a-z0-9]/gi,"") + "-" + en.idSuffix === idPart);
    if (!entry) return;

    entry.favorite = !entry.favorite;
    const isActive = $link.hasClass(ACTIVE_UNPINNED) || $link.hasClass(ACTIVE_PINNED);
    
    // 1. Toggle Star Color
    $star.removeClass(STAR_ON).removeClass(STAR_OFF).addClass(entry.favorite ? STAR_ON : STAR_OFF);

    // 2. Toggle Background/Text Classes and position
    $link.removeClass(UNPINNED_BASE).removeClass(PINNED_BASE).removeClass(ACTIVE_UNPINNED).removeClass(ACTIVE_PINNED);
    
    if (entry.favorite) {
      // Pin: Set Pinned Base, then detach/prepend
      $link.addClass(PINNED_BASE);
      $tab.detach().prependTo("#pinnedTabs");
      if(isActive) $link.removeClass(PINNED_BASE).addClass(ACTIVE_PINNED); // If active, re-apply active pinned class
      if(!pinnedFiles.includes(entry.file)) pinnedFiles.push(entry.file);
    } else {
      // Unpin: Set Unpinned Base, then detach/append
      $link.addClass(UNPINNED_BASE);
      $tab.detach().appendTo("#toolTabs");
      if(isActive) $link.removeClass(UNPINNED_BASE).addClass(ACTIVE_UNPINNED); // If active, re-apply active unpinned class
      pinnedFiles = pinnedFiles.filter(f => f !== entry.file);
    }
    
    savePinnedFiles();
  });
});
</script>

</body>
</html>
