<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>XML Editor Tree View</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    body { font-family: monospace; font-size: 14px; }
    #editorWrapper {
      display: flex;
      border: 1px solid #ccc;
      border-radius: 6px;
      overflow: hidden;
      height: 200px;
      font-family: monospace;
    }
    #lineNumbers {
      background: #f0f0f0;
      color: #666;
      padding: 4px 6px;
      text-align: right;
      user-select: none;
      overflow: hidden;
      border-right: 1px solid #ccc;
    }
    #xmlText {
      flex: 1;
      border: none;
      padding: 4px;
      outline: none;
      resize: none;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.4em;
    }
    #tree { background: #f8f9fa; border-radius: 6px; padding: 10px; font-family: monospace; margin-top: 10px; }

    /* Tree with vertical lines */
    .node { position: relative; margin-left: 20px; padding-left: 15px; border-left: 1px solid #ccc; }
    .node::before {
      content: "";
      position: absolute;
      top: 0;
      left: -1px;
      width: 1px;
      height: 100%;
      border-left: 1px solid #ccc;
    }
    .root-node { border-left: none; margin-left: 0; padding-left: 0; }

    /* Toggle button */
    .toggle { cursor: pointer; font-size: 12px; margin-right: 5px; color: #0d6efd; }
    .collapsed > .children { display: none; }
    .line-info { font-size: 0.7rem; color: #6c757d; margin-right: 6px; }
    .editable { display: inline-block; padding: 1px 3px; border-radius: 3px; cursor: text; }
    .editable:hover { background: #f0f0f0; }
    .tag { color: #0d6efd; }
    .attr-name { color: #198754; }
    .attr-value { color: #d63384; }
    .text-node { color: #212529; margin-left: 20px; }
  </style>
</head>
<body class="p-3">
  <h5>XML Editor</h5>

  <!-- Toolbar -->
  <div class="mb-2">
    <button id="btnNew" class="btn btn-sm btn-outline-dark">New XML</button>
    <button id="btnLoadFile" class="btn btn-sm btn-outline-primary">Load XML File</button>
    <input type="file" id="fileInput" accept=".xml" hidden>
    <button id="btnFromText" class="btn btn-sm btn-outline-secondary">Load from Textarea</button>
    <button id="btnBeautify" class="btn btn-sm btn-outline-info">Beautify XML</button>
    <button id="btnSave" class="btn btn-sm btn-success">Save XML</button>
  </div>

  <!-- Editor with line numbers -->
  <div id="editorWrapper" class="mb-2">
    <div id="lineNumbers">1</div>
    <textarea id="xmlText"></textarea>
  </div>
  <div id="errorBox" class="text-danger small"></div>

  <!-- Tree -->
  <div id="tree"></div>

  <script>
    let xmlDoc = null;
    let nodePositions = {};

    function updateLineNumbers() {
      const text = $("#xmlText").val();
      const lines = text.split(/\r?\n/).length;
      let lineHtml = "";
      for (let i = 1; i <= lines; i++) {
        lineHtml += i + "<br>";
      }
      $("#lineNumbers").html(lineHtml);
    }

    function syncScroll() {
      $("#lineNumbers").scrollTop($("#xmlText").scrollTop());
    }

    function formatXml(xml) {
      const PADDING = "  ";
      let reg = /(>)(<)(\/*)/g;
      xml = xml.replace(reg, '$1\r\n$2$3');
      let pad = 0;
      return xml.split('\r\n').map((node) => {
        let indent = '';
        if (node.match(/.+<\/\w[^>]*>$/)) {
          indent = PADDING.repeat(pad);
        } else if (node.match(/^<\/\w/)) {
          pad = Math.max(pad - 1, 0);
          indent = PADDING.repeat(pad);
        } else if (node.match(/^<\w([^>]*[^/])?>.*$/)) {
          indent = PADDING.repeat(pad);
          pad++;
        } else {
          indent = PADDING.repeat(pad);
        }
        return indent + node;
      }).join('\r\n');
    }

    function buildNodePositions(xmlStr) {
      let lines = xmlStr.split(/\r?\n/);
      let positions = {};
      let regex = /<([a-zA-Z0-9_\-:]+)([^>]*)>/g;
      lines.forEach((line, i) => {
        let match;
        while ((match = regex.exec(line)) !== null) {
          let name = match[1];
          if (!positions[name]) positions[name] = [];
          positions[name].push({ line: i+1, col: match.index+1 });
        }
      });
      return positions;
    }

    function renderTree() {
      $("#tree").empty();
      if (!xmlDoc) return;
      const root = xmlDoc.documentElement;
      const $rootDiv = $('<div class="node root-node"></div>');
      renderNode(root, $rootDiv);
      $("#tree").append($rootDiv);
    }

    function renderNode(node, $parent) {
      const $nodeDiv = $('<div class="node"></div>');
      const hasChildren = Array.from(node.childNodes).some(c => c.nodeType === 1);
      if (hasChildren) {
        const $toggle = $('<span class="toggle">[-]</span>');
        $toggle.on("click", function() {
          $nodeDiv.toggleClass("collapsed");
          $toggle.text($nodeDiv.hasClass("collapsed") ? "[+]" : "[-]");
        });
        $nodeDiv.append($toggle);
      }

      let pos = nodePositions[node.nodeName] && nodePositions[node.nodeName].shift();
      const $lineInfo = $('<span class="line-info"></span>');
      if (pos) $lineInfo.text(`[${pos.line}:${pos.col}]`);
      $nodeDiv.append($lineInfo);

      const $openTag = $('<span class="tag">&lt;</span>');
      const $name = $('<span contenteditable="true" class="editable tag"></span>').text(node.nodeName);
      $name.on("blur", function() {
        let newName = $(this).text().trim();
        if (newName && newName !== node.nodeName) {
          let newNode = xmlDoc.createElement(newName);
          while (node.attributes.length > 0) {
            newNode.setAttribute(node.attributes[0].name, node.attributes[0].value);
            node.removeAttribute(node.attributes[0].name);
          }
          while (node.firstChild) newNode.appendChild(node.firstChild);
          node.parentNode.replaceChild(newNode, node);
          node = newNode;
          updateTextarea();
          renderTree();
        }
      });
      $nodeDiv.append($openTag, $name);

      if (node.attributes) {
        for (let attr of node.attributes) {
          const $space = $("<span> </span>");
          const $attrName = $('<span contenteditable="true" class="editable attr-name"></span>').text(attr.name);
          const $eq = $("<span>=</span>");
          const $attrValue = $('<span contenteditable="true" class="editable attr-value"></span>').text(`"${attr.value}"`);
          $attrName.on("blur", function() {
            let newName = $(this).text().trim();
            if (newName && newName !== attr.name) {
              let value = attr.value;
              node.removeAttribute(attr.name);
              node.setAttribute(newName, value);
              updateTextarea();
              renderTree();
            }
          });
          $attrValue.on("blur", function() {
            attr.value = $(this).text().replace(/^"|"$/g, "");
            updateTextarea();
          });
          $nodeDiv.append($space, $attrName, $eq, $attrValue);
        }
      }

      $nodeDiv.append($('<span class="tag">&gt;</span>'));
      for (let child of node.childNodes) {
        if (child.nodeType === 3 && child.nodeValue.trim() !== "") {
          const $text = $('<div class="text-node" contenteditable="true"></div>').text(child.nodeValue.trim());
          $text.on("blur", function() {
            child.nodeValue = $(this).text();
            updateTextarea();
          });
          $nodeDiv.append($text);
        }
      }
      let $childrenContainer = $('<div class="children"></div>');
      for (let child of node.childNodes) {
        if (child.nodeType === 1) renderNode(child, $childrenContainer);
      }
      if ($childrenContainer.children().length > 0) $nodeDiv.append($childrenContainer);
      $nodeDiv.append($('<div><span class="tag">&lt;/</span><span class="tag">'+node.nodeName+'</span><span class="tag">&gt;</span></div>'));
      $parent.append($nodeDiv);
    }

    function updateTextarea() {
      let xmlStr = new XMLSerializer().serializeToString(xmlDoc);
      $("#xmlText").val(formatXml(xmlStr));
      updateLineNumbers();
    }

    function parseTextarea() {
      let text = $("#xmlText").val();
      try {
        let parser = new DOMParser();
        let doc = parser.parseFromString(text, "application/xml");
        if (doc.getElementsByTagName("parsererror").length > 0) {
          $("#errorBox").text("❌ XML Error: " + doc.getElementsByTagName("parsererror")[0].textContent.trim());
          return;
        }
        $("#errorBox").text("");
        nodePositions = buildNodePositions(text);
        xmlDoc = doc;
        renderTree();
        updateLineNumbers();
      } catch (e) {
        $("#errorBox").text("❌ Parsing failed: " + e.message);
      }
    }

    // Toolbar actions
    $("#btnFromText").on("click", parseTextarea);
    $("#btnBeautify").on("click", function() {
      let text = $("#xmlText").val();
      $("#xmlText").val(formatXml(text));
      parseTextarea();
    });
    $("#btnSave").on("click", function() {
      let text = $("#xmlText").val();
      let blob = new Blob([text], {type: "application/xml"});
      let a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "edited.xml";
      a.click();
    });
    $("#btnLoadFile").on("click", () => $("#fileInput").click());
    $("#fileInput").on("change", function(e) {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(evt) {
        $("#xmlText").val(formatXml(evt.target.result));
        parseTextarea();
      };
      reader.readAsText(file);
    });

    // New XML
    $("#btnNew").on("click", function() {
      let template = `<?xml version="1.0" encoding="UTF-8"?>
<root id="1" type="example">
  <item id="101" name="Sample Item">
    <child key="a1">Child Value A</child>
    <child key="a2">Child Value B</child>
  </item>
  <item id="102" name="Another Item">
    <child key="b1">Another Child</child>
  </item>
</root>`;
      $("#xmlText").val(formatXml(template));
      parseTextarea();
    });

    $("#xmlText").on("input", updateLineNumbers);
    $("#xmlText").on("scroll", syncScroll);

    // Load from files/data.xml or fallback
    $(document).ready(function () {
      fetch("files/data.xml")
        .then(resp => {
          if (!resp.ok) throw new Error("Failed to load files/data.xml");
          return resp.text();
        })
        .then(text => {
          $("#xmlText").val(formatXml(text));
          parseTextarea();
        })
        .catch(err => {
          let sample = `<book title="XML Guide" author="John">
  <chapter>
    <section>Intro</section>
    <section>Advanced</section>
  </chapter>
</book>`;
          $("#xmlText").val(formatXml(sample));
          parseTextarea();
          $("#errorBox").text("⚠️ Could not load data.xml, showing sample instead.");
        });
    });
  </script>
</body>
</html>

