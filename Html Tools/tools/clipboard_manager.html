<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Advanced Clipboard History Manager</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            min-height: 100vh;
        }
        .mono {
            font-family: 'JetBrains Mono', monospace;
        }
        #editor { 
            height: 400px; 
            display: flex; 
            border: 1px solid #1f2937;
        }
        #lineNumbers {
            width: 50px; 
            background: #e5e7eb; 
            padding: 0; 
            text-align: right; 
            user-select: none;
            flex-shrink: 0; /* Important: prevents shrinking */
            overflow: hidden; /* Hide potential vertical overflow */
        }
        .line-number {
            padding: 0.5rem 0.5rem;
            font-size: 0.75rem;
            color: #4b5563;
            line-height: 1.5; /* Ensure consistent line height */
        }
        #content {
            flex: 1; 
            padding: 0;
            overflow-y: auto; 
            word-break: break-word;
            background: #ffffff;
            color: #1f2937;
        }
        .entry-row {
            padding: 0.5rem;
            border-bottom: 1px dotted #e5e7eb;
            transition: background-color 0.15s;
            line-height: 1.5; /* Match line-number line height */
        }
        .entry-row:last-child {
            border-bottom: none;
        }
        .entry-row:hover {
            background: #f8f9fa;
        }
        .entry-text {
            cursor: pointer;
            flex-grow: 1;
        }
        .entry-controls {
            display: none;
        }
        .entry-row:hover .entry-controls {
            display: flex;
        }
        .timestamp {
            color: #9ca3af;
            font-weight: 600;
        }
        #confirmModal {
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-6 flex items-center">
        <span class="mr-3 text-indigo-600">ðŸ“‹</span> Clipboard Manager
    </h1>

    <!-- Input and Add Controls -->
    <div class="flex flex-col md:flex-row gap-3 mb-4">
        <input type="text" id="clipInput" placeholder="Type or paste text to manually add" class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm mono">
        <button id="addBtn" class="px-4 py-2 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700 transition duration-150 font-semibold">
            Add Entry
        </button>
        <button id="pasteBtn" class="px-4 py-2 text-white bg-green-600 rounded-lg hover:bg-green-700 transition duration-150 font-semibold">
            Paste Clipboard
        </button>
    </div>

    <!-- Filter and Clear Controls -->
    <div class="flex flex-col md:flex-row gap-3 mb-6 items-center">
        <input type="text" id="filterInput" placeholder="Search clipboard history..." class="flex-grow px-4 py-2 border border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 shadow-sm mono">
        <button id="clearBtn" class="w-full md:w-auto px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition duration-150 font-semibold">
            Clear History
        </button>
    </div>

    <!-- Editor/History Panel -->
    <div class="bg-white rounded-xl shadow-xl overflow-hidden">
        <div id="editor" class="mono rounded-xl">
            <div id="lineNumbers"></div>
            <div id="content">No clipboard history saved.</div>
        </div>
    </div>
</div>

<!-- Custom Confirmation Modal (Hidden by default) -->
<div id="confirmModal" class="fixed inset-0 hidden items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
        <h4 class="text-xl font-bold mb-4">Confirm Clear</h4>
        <p class="mb-6 text-gray-700">Are you sure you want to permanently delete ALL history entries?</p>
        <div class="flex justify-end space-x-3">
            <button id="cancelClearBtn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
            <button id="confirmClearBtn" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700">Delete All</button>
        </div>
    </div>
</div>

<script>
    // --- Global State ---
    let history = JSON.parse(localStorage.getItem("clipboardEditor") || "[]");

    // --- DOM Elements ---
    const clipInput = document.getElementById('clipInput');
    const addBtn = document.getElementById('addBtn');
    const pasteBtn = document.getElementById('pasteBtn');
    const clearBtn = document.getElementById('clearBtn');
    const filterInput = document.getElementById('filterInput');
    const lineNumbers = document.getElementById('lineNumbers');
    const content = document.getElementById('content');
    const editor = document.getElementById('editor');
    const confirmModal = document.getElementById('confirmModal');
    const cancelClearBtn = document.getElementById('cancelClearBtn');
    const confirmClearBtn = document.getElementById('confirmClearBtn');
    
    // --- Utility Functions ---

    function saveHistory() {
        localStorage.setItem("clipboardEditor", JSON.stringify(history));
    }

    function formatEntry(text) {
        const now = new Date();
        const time = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        return {
            timestamp: `[${time}]`,
            text: text,
            id: Date.now() + Math.random().toString(36).substring(2, 9)
        };
    }

    /** Copies text to the clipboard and shows a temporary message */
    function copyText(text, buttonElement) {
        try {
            // Use fallback for secure copy command in iframe environment
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            tempInput.select();
            document.execCommand('copy');
            document.body.removeChild(tempInput);

            // Give visual feedback
            const originalText = buttonElement.textContent;
            buttonElement.textContent = 'Copied!';
            buttonElement.classList.remove('bg-indigo-500');
            buttonElement.classList.add('bg-green-500');

            setTimeout(() => {
                buttonElement.textContent = originalText;
                buttonElement.classList.remove('bg-green-500');
                buttonElement.classList.add('bg-indigo-500');
            }, 1500);

        } catch (e) {
            console.error("Failed to copy text:", e);
        }
    }

    function showCustomMessage(message) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-2xl w-full max-w-xs mono">
                <h4 class="text-xl font-bold mb-4 text-red-600">Clipboard Error</h4>
                <p class="mb-6 text-gray-700 text-sm">${message}</p>
                <div class="flex justify-end">
                    <button class="px-4 py-2 text-white bg-indigo-600 rounded-lg hover:bg-indigo-700" onclick="document.body.removeChild(this.closest('.fixed'))">Close</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }
    
    // --- Core Logic ---

    function deleteEntry(id) {
        history = history.filter(item => item.id !== id);
        saveHistory();
        renderHistory();
    }

    function addEntry(text) {
        if (!text) return;
        const entry = formatEntry(text);
        history.push(entry);
        
        if (history.length > 100) {
            history.shift();
        }
        
        saveHistory();
        renderHistory();
    }

    // Synchronize content scroll with line number scroll
    content.addEventListener('scroll', () => {
        lineNumbers.scrollTop = content.scrollTop;
    });


    function renderHistory() {
        const filterText = filterInput.value.toLowerCase();
        
        const filteredHistory = history.filter(item => 
            item.text.toLowerCase().includes(filterText)
        );

        lineNumbers.innerHTML = '';
        content.innerHTML = '';

        if (filteredHistory.length === 0) {
            content.innerHTML = `<div class="p-3 text-center text-gray-500">${history.length > 0 ? 'No results found.' : 'No clipboard history saved.'}</div>`;
            return;
        }

        filteredHistory.forEach((item, idx) => {
            // 1. Line numbers (one div per line number for perfect alignment)
            const lineNumberDiv = document.createElement('div');
            lineNumberDiv.className = 'line-number';
            lineNumberDiv.textContent = idx + 1;
            lineNumbers.appendChild(lineNumberDiv);
            
            // 2. Content Row
            const entryRow = document.createElement('div');
            entryRow.className = 'entry-row flex items-start justify-between';

            const entryText = document.createElement('div');
            entryText.className = 'entry-text flex-grow pr-2';
            
            // Create and append the Timestamp Span
            const timestampSpan = document.createElement('span');
            timestampSpan.className = 'timestamp';
            timestampSpan.textContent = item.timestamp;
            entryText.appendChild(timestampSpan);
            
            // Create and append the Text Node (CRITICAL: prevents HTML rendering)
            // Add a space after the timestamp
            entryText.appendChild(document.createTextNode(` ${item.text}`)); 
            
            // Add click-to-copy functionality to the text area
            entryText.addEventListener('click', () => {
                copyText(item.text, entryRow.querySelector('.copy-btn'));
            });

            // Controls Container
            const controls = document.createElement('div');
            controls.className = 'entry-controls space-x-2 flex-shrink-0';
            
            // Copy Button
            const copyBtn = document.createElement('button');
            copyBtn.className = 'copy-btn p-1 text-xs bg-indigo-500 text-white rounded-md hover:bg-indigo-600 transition duration-150';
            copyBtn.textContent = 'Copy';
            copyBtn.addEventListener('click', () => copyText(item.text, copyBtn));

            // Delete Button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'p-1 text-xs bg-red-500 text-white rounded-md hover:bg-red-600 transition duration-150';
            deleteBtn.textContent = 'Delete';
            deleteBtn.addEventListener('click', () => deleteEntry(item.id));

            controls.appendChild(copyBtn);
            controls.appendChild(deleteBtn);
            
            entryRow.appendChild(entryText);
            entryRow.appendChild(controls);
            content.appendChild(entryRow);

            // Synchronize the heights of the line number div and the entry row
            // This is done to ensure multiline entries have correctly sized line number boxes
            lineNumberDiv.style.height = `${entryRow.offsetHeight}px`;
        });

        // Scroll to the bottom of the content area
        content.scrollTop = content.scrollHeight;
    }

    // --- Event Handlers ---

    // Manual Add
    addBtn.addEventListener('click', () => {
        addEntry(clipInput.value.trim());
        clipInput.value = "";
    });

    // Paste from System Clipboard
    pasteBtn.addEventListener('click', async () => {
        try {
            const text = await navigator.clipboard.readText();
            if (text.trim()) {
                addEntry(text.trim());
            }
        } catch (e) {
            showCustomMessage("Error reading clipboard. Browser security policy may be blocking access. Try manually pasting into the input field and using 'Add Entry'.");
        }
    });

    // Filter Input
    filterInput.addEventListener('input', renderHistory);

    // Clear History Button (Opens Custom Modal)
    clearBtn.addEventListener('click', () => {
        confirmModal.style.display = 'flex';
    });
    
    // Modal Cancel
    cancelClearBtn.addEventListener('click', () => {
        confirmModal.style.display = 'none';
    });

    // Modal Confirm Clear
    confirmClearBtn.addEventListener('click', () => {
        history = [];
        saveHistory();
        renderHistory();
        confirmModal.style.display = 'none';
    });

    // Initial render
    document.addEventListener('DOMContentLoaded', renderHistory);

</script>
</body>
</html>
