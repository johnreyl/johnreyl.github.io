<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Advanced Gemini TTS Player</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
<style>
    /* Inter Font is the default for Tailwind, ensuring consistency */
    body { 
        padding: 1rem; 
        min-height: 100vh; 
        background-color: #f1f5f9; /* slate-100 */
        font-family: 'Inter', sans-serif;
    }
    .container-custom {
        max-width: 600px;
        margin: 0 auto;
        padding: 1.5rem;
        background: white;
        border-radius: 0.75rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 4, 0, 0.05);
    }
    textarea { 
        resize: none; 
        min-height: 120px;
    }
    #audioCanvas { 
        width: 100%; 
        height: 100px; 
        background: #e2e8f0; /* slate-200 */
        border: 1px solid #94a3b8; /* slate-400 */
        margin-bottom: 1rem; 
        border-radius: 0.5rem;
    }
    /* Style range inputs */
    input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        background: #cbd5e1;
        border-radius: 4px;
        cursor: pointer;
    }
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #4f46e5;
        cursor: pointer;
        transition: background 0.15s ease-in-out;
    }

    /* Custom Switch Styling */
    .toggle-checkbox:checked + .toggle-label {
        background-color: #4f46e5;
    }
    .toggle-checkbox:checked + .toggle-label .toggle-circle {
        transform: translateX(1.5rem);
    }
    .toggle-label {
        position: relative;
    }
    .toggle-circle {
        position: absolute;
        top: 2px;
        left: 2px;
        width: 1.1rem;
        height: 1.1rem;
        background-color: white;
        border-radius: 9999px;
        transition: transform 0.2s ease-in-out;
    }
    /* Feedback Toast */
    #feedbackToast {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
    }
</style>
</head>
<body>
<div class="container-custom">
<h1 class="text-2xl font-bold text-indigo-700 mb-4">ðŸŽ¤ Advanced Gemini TTS Player</h1>
<p class="text-sm text-gray-600 mb-4">Enter text, select a voice, and adjust the tone/pace. **Use the language toggle for Tagalog support.**</p>

<!-- Control and Status Group -->
<div class="flex flex-col gap-3 mb-4 p-3 bg-indigo-50 rounded-lg border border-indigo-200">
    <!-- Row 1: Language & Status -->
    <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
        <!-- Language Toggle -->
        <div class="flex items-center">
            <label for="tagalogToggle" class="text-sm font-semibold text-gray-700 mr-4 whitespace-nowrap">Language: <span id="langDisplay" class="font-bold text-indigo-800">English (en-US)</span></label>
            <div class="relative inline-block w-10 h-6 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" name="tagalogToggle" id="tagalogToggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                <label for="tagalogToggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer transition duration-200 ease-in">
                    <span class="toggle-circle"></span>
                </label>
            </div>
        </div>
        
        <!-- API Status -->
        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-2 text-sm font-semibold">
            <span id="apiStatusDisplay" class="px-2 py-0.5 rounded-full text-xs font-bold whitespace-nowrap bg-green-200 text-green-800">API Status</span>
            <span class="text-gray-700 whitespace-nowrap">Attempts Left: <span id="attemptsDisplay" class="font-bold text-red-600">--</span></span>
        </div>
    </div>
    
    <!-- Row 2: Reset Date -->
    <div class="text-xs text-gray-600 border-t border-indigo-100 pt-2 mt-2">
        Simulated Credit Reset: <span id="resetDateDisplay" class="font-semibold text-gray-800"></span>
    </div>
</div>

<textarea id="ttsText" class="p-3 border border-gray-300 rounded-lg w-full focus:ring-indigo-500 focus:border-indigo-500 mb-3 transition duration-150" placeholder="Hello world! Type your text here.">This is a test sentence to check the voice and language settings.</textarea>

<div class="mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-1">Voice:</label>
  <select id="voiceSelect" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></select>
</div>

<!-- Pitch Slider (used as style instruction) -->
<div class="mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-1">Pitch: <span id="pitchVal" class="font-mono text-indigo-600">1.0</span> (Low, Normal, High)</label>
  <input type="range" id="pitch" min="0.5" max="1.5" step="0.5" value="1.0" class="form-range">
</div>

<!-- Speed Slider (used as style instruction) -->
<div class="mb-4">
  <label class="block text-sm font-medium text-gray-700 mb-1">Speed: <span id="speedVal" class="font-mono text-indigo-600">1.0</span> (Slow, Normal, Fast)</label>
  <input type="range" id="speed" min="0.5" max="1.5" step="0.5" value="1.0" class="form-range">
</div>

<div class="flex flex-wrap gap-3 items-center mb-4">
  <button id="playBtn" class="px-5 py-2 text-white bg-indigo-600 rounded-full hover:bg-indigo-700 transition shadow-lg disabled:opacity-50 font-semibold">Play</button>
  <button id="resetBtn" class="px-5 py-2 text-indigo-600 bg-yellow-100 rounded-full hover:bg-yellow-200 transition font-semibold">Reset</button>
  <button id="downloadBtn" class="px-5 py-2 text-gray-700 bg-gray-200 rounded-full hover:bg-gray-300 transition font-semibold" disabled>Download</button>
  <span id="loadingIcon" class="hidden animate-spin h-6 w-6 border-4 border-indigo-500 border-t-transparent rounded-full" role="status"></span>
  <a id="downloadLink" style="display:none;"></a>
</div>

<canvas id="audioCanvas"></canvas>
<input type="range" id="progress" value="0" min="0" max="100" class="w-full h-2 bg-gray-300 rounded-lg" disabled>

</div>

<!-- Feedback Toast Element -->
<div id="feedbackToast" class="fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-xl opacity-0 transform translate-y-4 pointer-events-none z-50">
    <span id="toastMessage"></span>
</div>

<script>
const MODEL_NAME = "gemini-2.5-flash-preview-tts";
const apiKey = "AIzaSyApYfgZJq42sS_h2BrwFhbGaBc2cOMJbgg"; 

// --- Simulated Credit System ---
const MAX_ATTEMPTS = 100; // Increased from 10 to 100
let attemptsLeft = MAX_ATTEMPTS;
let resetTimestamp = 0; // UNIX timestamp for when credits reset

// --- Element References ---
const canvas = document.getElementById('audioCanvas');
const ctx = canvas.getContext('2d');
const progress = document.getElementById('progress');
const loadingIcon = document.getElementById('loadingIcon');
const playBtn = document.getElementById('playBtn');
const downloadBtn = document.getElementById('downloadBtn');
const tagalogToggle = document.getElementById('tagalogToggle');
const langDisplay = document.getElementById('langDisplay');
const attemptsDisplay = document.getElementById('attemptsDisplay');
const apiStatusDisplay = document.getElementById('apiStatusDisplay');
const resetDateDisplay = document.getElementById('resetDateDisplay');


// --- Utility Functions for PCM Audio Handling ---

function base64ToArrayBuffer(base64) {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}

function pcmToWav(pcm16, sampleRate) {
    const numChannels = 1;
    const bitsPerSample = 16;
    const blockAlign = numChannels * (bitsPerSample / 8);
    const byteRate = sampleRate * blockAlign;
    const dataSize = pcm16.length * 2;
    const buffer = new ArrayBuffer(44 + dataSize);
    const view = new DataView(buffer);
    
    // RIFF header
    writeString(view, 0, 'RIFF');
    view.setUint32(4, 36 + dataSize, true); // file size - 8
    writeString(view, 8, 'WAVE');
    
    // FMT chunk
    writeString(view, 12, 'fmt ');
    view.setUint32(16, 16, true); // chunk size
    view.setUint16(20, 1, true); // linear PCM
    view.setUint16(22, numChannels, true);
    view.setUint32(24, sampleRate, true);
    view.setUint32(28, byteRate, true);
    view.setUint16(32, blockAlign, true);
    view.setUint16(34, bitsPerSample, true);
    
    // DATA chunk
    writeString(view, 36, 'data');
    view.setUint32(40, dataSize, true);
    
    // Write PCM data
    for (let i = 0; i < pcm16.length; i++) {
        view.setInt16(44 + i * 2, pcm16[i], true);
    }
    
    return new Blob([view], { type: 'audio/wav' });

    function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }
}


// --- Voice and UI Configuration ---

const VOICE_MAP = [
    { name: "Kore", description: "Kore (Firm, Clear, Default)" },
    { name: "Puck", description: "Puck (Upbeat, Enthusiastic)" },
    { name: "Zephyr", description: "Zephyr (Bright, Energetic)" },
    { name: "Aoede", description: "Aoede (Breezy, Light)" },
    // Tagalog specific labels
    { name: "Leda", description: "Leda (Filipina, Youthful)" }, 
    { name: "Charon", description: "Charon (Filipino, Deep)" },
];

let audioCtx = null;
let analyser, source, dataArray, bufferLength;
let currentAudio = null;

// --- Credit Management Functions ---

function saveCreditState() {
    localStorage.setItem('ttsAttemptsLeft', attemptsLeft);
    localStorage.setItem('ttsResetTimestamp', resetTimestamp);
}

function loadCreditState() {
    const savedAttempts = localStorage.getItem('ttsAttemptsLeft');
    const savedResetTimestamp = localStorage.getItem('ttsResetTimestamp');
    const now = Date.now();

    const ONE_DAY_MS = 24 * 60 * 60 * 1000;

    if (savedResetTimestamp && savedAttempts !== null) {
        const resetTime = parseInt(savedResetTimestamp, 10);
        
        if (now > resetTime) {
            // Reset time has passed: FULL RESET
            attemptsLeft = MAX_ATTEMPTS;
            resetTimestamp = now + ONE_DAY_MS; 
            showToast("Demo credits have been reset (24 hours elapsed).", false, 3000);
            saveCreditState();
        } else {
            // Load existing, non-expired state
            attemptsLeft = parseInt(savedAttempts, 10);
            // Ensure attempts are not initialized to 10 if MAX_ATTEMPTS changed
            if (attemptsLeft > MAX_ATTEMPTS) {
                attemptsLeft = MAX_ATTEMPTS;
            }
            resetTimestamp = resetTime;
        }
    } else {
        // First load or incomplete state: INITIALIZE
        attemptsLeft = MAX_ATTEMPTS;
        resetTimestamp = now + ONE_DAY_MS; // 24 hours from now
        saveCreditState();
    }
}

function updateApiStatusDisplay() {
    if (attemptsLeft > 0) {
        apiStatusDisplay.textContent = 'Free Trial (Demo)';
        apiStatusDisplay.className = 'px-2 py-0.5 rounded-full text-xs font-bold whitespace-nowrap bg-green-200 text-green-800';
    } else {
        apiStatusDisplay.textContent = 'Quota Limit Reached';
        apiStatusDisplay.className = 'px-2 py-0.5 rounded-full text-xs font-bold whitespace-nowrap bg-red-200 text-red-800';
    }
}

function updateAttemptsDisplay() {
    attemptsDisplay.textContent = attemptsLeft;
    updateApiStatusDisplay();
    
    // Ensure we have a valid timestamp before trying to format
    if (resetTimestamp > Date.now() || attemptsLeft === MAX_ATTEMPTS) {
        const date = new Date(resetTimestamp);
        // Format to a readable string: e.g., Oct 7, 2025 at 1:23 PM
        resetDateDisplay.textContent = date.toLocaleString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } else if (attemptsLeft === 0) {
        // Attempts are zero, but the reset time has not been calculated to the future yet (shouldn't happen with the fix)
        resetDateDisplay.textContent = 'Refresh to check if 24 hours have passed.';
    } else {
         // Fallback for an unknown state, prevents "Calculating..." from getting stuck
         resetDateDisplay.textContent = '24-hour reset active.';
    }
    // Re-evaluate button state after updating attempts display
    setUiState(false, false); 
}

function decrementCredit() {
    attemptsLeft--;
    saveCreditState();
    updateAttemptsDisplay();
}


// --- Helper Functions ---

function showToast(message, isError = false, duration = 4000) {
    const toast = document.getElementById('feedbackToast');
    const toastMessage = document.getElementById('toastMessage');
    
    // 1. Set message and style
    toastMessage.textContent = message;
    toast.className = `fixed bottom-4 right-4 px-4 py-2 rounded-lg shadow-xl opacity-0 transform translate-y-4 pointer-events-none z-50 transition duration-300 ${isError ? 'bg-red-600 text-white' : 'bg-gray-900 text-white'}`;
    
    // 2. Show toast
    requestAnimationFrame(() => {
        toast.classList.remove('opacity-0', 'translate-y-4');
        toast.classList.add('opacity-100', 'translate-y-0');
    });

    // 3. Hide toast after duration
    setTimeout(() => {
        toast.classList.remove('opacity-100', 'translate-y-0');
        toast.classList.add('opacity-0', 'translate-y-4');
    }, duration);
}

function setUiState(isLoading, isPlaying = false) {
    // This is the crucial line for enabling/disabling the button
    playBtn.disabled = isLoading || isPlaying || (attemptsLeft <= 0 && !isPlaying);
    downloadBtn.disabled = isLoading || !currentAudio;
    loadingIcon.style.display = isLoading ? 'inline-block' : 'none';
    
    if (isPlaying) {
        playBtn.textContent = 'Playing...';
    } else {
        playBtn.textContent = 'Play';
    }
}

function getStyleInstruction(pitch, speed) {
    const pitchMap = { 0.5: "low pitch", 1.0: "normal pitch", 1.5: "high pitch" };
    const speedMap = { 0.5: "slow pace", 1.0: "normal pace", 1.5: "fast pace" };
    
    const p = pitchMap[pitch] || 'normal pitch';
    const s = speedMap[speed] || 'normal pace';

    return `Say this in a ${s} and ${p}: `;
}

function loadVoices() {
    const select = document.getElementById('voiceSelect');
    VOICE_MAP.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.name;
        opt.textContent = v.description;
        select.appendChild(opt);
    });
}

// --- API Call and Audio Generation ---

async function generateSpeech() {
    // --- 1. Quota Check ---
    if (attemptsLeft <= 0) {
        showToast("Demo Quota Exceeded. Please refresh the page after the reset time to continue.", true, 5000);
        setUiState(false);
        return null;
    }

    const text = document.getElementById('ttsText').value.trim();
    const voiceName = document.getElementById('voiceSelect').value;
    const pitchVal = document.getElementById('pitch').value;
    const speedVal = document.getElementById('speed').value;
    
    const languageCode = tagalogToggle.checked ? 'tl-PH' : 'en-US';

    if (!text) {
        showToast("Please enter some text to synthesize.", true, 2000);
        return null;
    }

    const instruction = getStyleInstruction(parseFloat(pitchVal), parseFloat(speedVal));
    const styledText = instruction + text;

    const payload = {
        contents: [{
            parts: [{ text: styledText }]
        }],
        generationConfig: {
            responseModalities: ["AUDIO"],
            speechConfig: {
                languageCode: languageCode, 
                voiceConfig: {
                    prebuiltVoiceConfig: { voiceName: voiceName }
                }
            }
        }
    };

    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}`;
    let response;
    
    for (let attempt = 0; attempt < 3; attempt++) {
        try {
            response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorBody = await response.json();
                let errorMessage = `API failed with status ${response.status}.`;
                if (errorBody.error && errorBody.error.message) {
                    errorMessage += ` Details: ${errorBody.error.message}`;
                }
                throw new Error(errorMessage);
            }

            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                if (!sampleRateMatch) {
                    throw new Error("Could not detect sample rate from MIME type.");
                }
                const sampleRate = parseInt(sampleRateMatch[1], 10);
                
                // Success: Decrement counter and update UI
                decrementCredit();
                showToast("Audio successfully generated!");

                const pcmData = base64ToArrayBuffer(audioData);
                const pcm16 = new Int16Array(pcmData);
                const wavBlob = pcmToWav(pcm16, sampleRate);
                const audioUrl = URL.createObjectURL(wavBlob);
                
                const audio = new Audio(audioUrl);
                audio.addEventListener('ended', () => setUiState(false, false));
                return audio;

            } else {
                throw new Error("Invalid or missing audio data in API response.");
            }

        } catch (error) {
            if (attempt === 2) {
                console.error("API Call failed after multiple retries:", error);
                showToast(`Critical API Error: ${error.message}`, true, 6000);
                return null;
            }
            await new Promise(resolve => setTimeout(resolve, Math.pow(2, attempt) * 1000));
        }
    }
}


// --- Visualizer and UI Handlers ---

function setupVisualizer(audio) {
    if(audioCtx) audioCtx.close();
    canvas.width = canvas.offsetWidth;
    canvas.height = canvas.offsetHeight;
    
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    source = audioCtx.createMediaElementSource(audio);
    analyser = audioCtx.createAnalyser();
    
    source.connect(analyser);
    analyser.connect(audioCtx.destination);
    
    analyser.fftSize = 2048;
    bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);

    function draw() {
        if (!audioCtx) return; 
        requestAnimationFrame(draw);
        analyser.getByteTimeDomainData(dataArray);
        
        ctx.fillStyle = "#e2e8f0";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.lineWidth = 2;
        ctx.strokeStyle = "#4f46e5";
        ctx.beginPath();
        
        const sliceWidth = canvas.width / bufferLength;
        let x = 0;
        
        for(let i = 0; i < bufferLength; i++) {
            const v = dataArray[i] / 128.0;
            const y = v * canvas.height / 2;
            
            if(i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
            
            x += sliceWidth;
        }
        ctx.lineTo(canvas.width, canvas.height / 2);
        ctx.stroke();
    }
    draw();
}

function attachProgress(audio) {
    audio.addEventListener('timeupdate', ()=>{
        if(audio.duration) progress.value = (audio.currentTime/audio.duration)*100;
    });
    audio.addEventListener('playing', () => setUiState(false, true));
    audio.addEventListener('ended', () => setUiState(false, false));
    progress.disabled = false;
    
    progress.addEventListener('input', ()=>{
        if(audio.duration) audio.currentTime = (progress.value/100)*audio.duration;
    });
}

// Play button handler
playBtn.addEventListener('click', async ()=>{
    setUiState(true);
    
    if(currentAudio) {
        currentAudio.pause();
        currentAudio.src = "";
    }
    
    currentAudio = await generateSpeech();
    
    if (currentAudio) {
        setupVisualizer(currentAudio);
        attachProgress(currentAudio);
        await currentAudio.play();
    } else {
        setUiState(false);
    }
});

// Reset button handler
document.getElementById('resetBtn').addEventListener('click', ()=>{
    if(currentAudio) {
        currentAudio.pause();
        URL.revokeObjectURL(currentAudio.src); 
        currentAudio.src = "";
        currentAudio = null;
    }
    progress.value = 0;
    progress.disabled = true;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#e2e8f0";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    if(audioCtx) { audioCtx.close(); audioCtx = null; }
    setUiState(false);
});

// Download button handler
downloadBtn.addEventListener('click', async ()=>{
    if (!currentAudio || !currentAudio.src) {
        showToast("No audio generated yet.", false, 2000);
        return;
    }
    
    setUiState(true);
    try {
        const blob = await fetch(currentAudio.src).then(r => r.blob());
        const url = URL.createObjectURL(blob);
        const a = document.getElementById('downloadLink');
        a.href = url;
        a.download = 'tts_audio.wav';
        a.click();
        URL.revokeObjectURL(url);
        showToast("Audio downloaded as WAV.", false, 3000);
    } catch(e){ 
        console.error(e); 
        showToast("Error downloading audio.", true, 4000); 
    }
    setUiState(false);
});

// Pitch/speed display update
document.getElementById('pitch').addEventListener('input', ()=>{document.getElementById('pitchVal').textContent=parseFloat(document.getElementById('pitch').value).toFixed(1);});
document.getElementById('speed').addEventListener('input', ()=>{document.getElementById('speedVal').textContent=parseFloat(document.getElementById('speed').value).toFixed(1);});

// Tagalog Toggle Handler
tagalogToggle.addEventListener('change', (e) => {
    if (e.target.checked) {
        langDisplay.textContent = 'Tagalog (tl-PH)';
        document.getElementById('ttsText').value = "Kumusta? Ang panahon ay maganda ngayon. Magandang araw!";
    } else {
        langDisplay.textContent = 'English (en-US)';
        document.getElementById('ttsText').value = "This is a test sentence to check the voice and language settings.";
    }
    document.getElementById('resetBtn').click();
});


// --- Initialization ---

window.addEventListener('load', () => {
    loadVoices();
    loadCreditState(); // Load state before resetting UI
    document.getElementById('resetBtn').click(); 
    updateAttemptsDisplay(); // Show initial count and status
});
</script>
</body>
</html>
