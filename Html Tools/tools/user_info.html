<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Advanced Session and Network Reporter</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            color: #1f2937;
        }
        /* Ensures long strings in table cells wrap */
        td {
            word-break: break-word;
        }
        /* Style for the custom confirmation modal */
        #confirmModal {
            z-index: 1000;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
        }
    </style>
</head>
<body class="p-4 md:p-8">

<div class="max-w-4xl mx-auto">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-8 flex items-center">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-500 mr-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1v-3.25m-7.25 0h14.5M16 11H8m-5 0h2m14 0h2M7 4h10a3 3 0 013 3v2a3 3 0 01-3 3H7a3 3 0 01-3-3V7a3 3 0 013-3z" />
        </svg>
        Advanced Session & Network Reporter
    </h1>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
        <!-- Current Session Info Card -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <div class="flex items-center mb-4">
                <span class="text-xl font-bold text-indigo-600 mr-2">‚ÑπÔ∏è</span>
                <h2 class="text-xl font-semibold text-gray-800">Current Session Details</h2>
            </div>
            <!-- Table Container with Horizontal Overflow -->
            <div class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm">
                <table class="min-w-full divide-y divide-gray-200">
                    <tbody class="bg-white divide-y divide-gray-200" id="sessionInfo">
                        <!-- Table content will be injected here -->
                        <tr><td colspan="2" class="px-4 py-2 text-center text-sm text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Network and Battery Card -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
            <div class="flex items-center mb-4">
                <span class="text-xl font-bold text-indigo-600 mr-2">üì∂</span>
                <h2 class="text-xl font-semibold text-gray-800">Network & Power</h2>
            </div>
            <!-- Table Container with Horizontal Overflow -->
            <div class="overflow-x-auto border border-gray-200 rounded-lg shadow-sm">
                <table class="min-w-full divide-y divide-gray-200">
                    <tbody class="bg-white divide-y divide-gray-200" id="networkBatteryInfo">
                         <!-- Table content will be injected here -->
                         <tr><td colspan="2" class="px-4 py-2 text-center text-sm text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Login History -->
    <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center">
                <span class="text-xl font-bold text-indigo-600 mr-2">üï∞Ô∏è</span>
                <h2 class="text-xl font-semibold text-gray-800">Session History (Local)</h2>
            </div>
            <button id="clearHistoryBtn" class="px-3 py-1 text-sm text-white bg-red-500 rounded-lg hover:bg-red-600 transition duration-150 shadow-md">
                Clear History
            </button>
        </div>
        
        <ul id="historyList" class="divide-y divide-gray-200 border border-gray-300 rounded-lg overflow-hidden">
            <!-- History items will be injected here -->
        </ul>
        <div id="noHistory" class="p-4 text-center text-gray-500 hidden">No session history saved in this browser.</div>
    </div>

    <!-- Warning -->
    <div class="mt-8 p-4 bg-yellow-100 border border-yellow-300 text-yellow-800 rounded-lg shadow-md">
        ‚ö†Ô∏è **Data Scope Note:** This tool analyzes the **browser environment** only. Login history is stored in this browser using **localStorage**. Clearing your browser data will permanently reset this history.
    </div>
</div>

<!-- Custom Confirmation Modal (Hidden by default) -->
<div id="confirmModal" class="fixed inset-0 hidden items-center justify-center p-4" role="dialog" aria-modal="true">
    <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
        <h4 class="text-xl font-bold mb-4">Confirm Clear History</h4>
        <p class="mb-6 text-gray-700">Are you sure you want to permanently delete all session history from this browser?</p>
        <div class="flex justify-end space-x-3">
            <button id="cancelClearBtn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">Cancel</button>
            <button id="confirmClearBtn" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700">Delete All</button>
        </div>
    </div>
</div>

<script>
    // Constants
    const HISTORY_KEY = "advancedSessionHistory";

    // Utility Functions
    function formatBytes(bytes) {
        if (!bytes || bytes === 0) return "0 Bytes";
        const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(1024));
        return (bytes / Math.pow(1024, i)).toFixed(2) + ' ' + sizes[i];
    }

    function getBrowserIdentity() {
        const ua = navigator.userAgent;
        if (ua.includes("Chrome") && !ua.includes("Edg")) return "Chrome";
        if (ua.includes("Firefox")) return "Firefox";
        if (ua.includes("Safari") && !ua.includes("Chrome")) return "Safari";
        if (ua.includes("Edg")) return "Edge";
        return "Unknown/Other";
    }

    // --- Data Gathering Functions ---

    function getCurrentSessionInfo() {
        return {
            "User Agent": navigator.userAgent,
            "Browser/OS Platform": navigator.platform || "Unknown",
            "Language": navigator.language || "Unknown",
            "Timezone": Intl.DateTimeFormat().resolvedOptions().timeZone,
            "Screen Resolution": `${window.screen.width} x ${window.screen.height}`,
            "Viewport Size": `${window.innerWidth} x ${window.innerHeight}`,
            "Device Pixel Ratio": window.devicePixelRatio,
            "Cookies Enabled": navigator.cookieEnabled ? "Yes" : "No",
            "Online Status": navigator.onLine ? "Online" : "Offline",
            "CPU Cores": navigator.hardwareConcurrency || "Unknown",
            "Device Memory (GB)": navigator.deviceMemory ? navigator.deviceMemory + ' GB' : "Unknown",
        };
    }

    async function getNetworkAndBatteryInfo() {
        const info = {};
        
        // Network Info
        if (navigator.connection) {
            const conn = navigator.connection;
            info["Connection Type"] = conn.type || "Unknown";
            info["Effective Speed"] = conn.effectiveType ? `${conn.effectiveType.toUpperCase()} (${Math.round(conn.downlink)} Mbps)` : "Unknown";
            info["RTT (Latency)"] = conn.rtt ? `${conn.rtt} ms` : "Unknown";
            info["Data Saver"] = conn.saveData ? "Active" : "Inactive";
        } else {
            info["Network Info"] = "Not fully supported by browser.";
        }
        
        // Storage Info (Quota and Usage)
        if (navigator.storage && navigator.storage.estimate) {
            try {
                const est = await navigator.storage.estimate();
                info["Storage Used"] = formatBytes(est.usage);
                info["Storage Quota"] = formatBytes(est.quota);
            } catch (e) {
                info["Storage Estimate"] = "Permission denied or error.";
            }
        } else {
            info["Storage Estimate"] = "Not available.";
        }

        // Battery Status (Requires promise/async)
        if ('getBattery' in navigator) {
            try {
                const battery = await navigator.getBattery();
                info["Battery Level"] = `${Math.round(battery.level * 100)}%`;
                info["Charging Status"] = battery.charging ? "Charging" : "Discharging";
            } catch (e) {
                info["Battery Status"] = "Permission denied or error.";
            }
        } else {
            info["Battery Status"] = "Not supported by browser.";
        }

        return info;
    }

    // --- History Management ---

    function getHistory() {
        return JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
    }

    function saveHistory(history) {
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }

    function logVisit() {
        let history = getHistory();
        const now = new Date().toLocaleString();
        
        // Log key session details with the visit
        const newEntry = {
            timestamp: now,
            browser: getBrowserIdentity(),
            resolution: `${window.screen.width}x${window.screen.height}`,
            userAgentSnippet: navigator.userAgent.substring(0, 50) + '...'
        };

        history.unshift(newEntry); // Add latest at top
        
        // Keep history manageable (e.g., max 50 entries)
        if (history.length > 50) {
            history.pop();
        }
        
        saveHistory(history);
        return history;
    }

    function displayHistory(history) {
        const list = document.getElementById('historyList');
        const noHistory = document.getElementById('noHistory');
        list.innerHTML = '';
        
        if (history.length === 0) {
            noHistory.classList.remove('hidden');
            list.classList.add('hidden');
        } else {
            noHistory.classList.add('hidden');
            list.classList.remove('hidden');
            history.forEach(item => {
                const listItem = document.createElement('li');
                // Use flex-col for mobile, sm:flex-row for small/desktop
                listItem.className = 'history-entry p-4 flex flex-col sm:flex-row justify-between text-sm';
                listItem.innerHTML = `
                    <div class="font-semibold text-gray-800 flex-shrink-0 mb-2 sm:mb-0">
                        ${item.timestamp}
                    </div>
                    <!-- Added flex-wrap and gap-2 here to ensure tags wrap on mobile -->
                    <div class="flex flex-wrap gap-2 text-gray-600 mt-1 sm:mt-0">
                        <span class="inline-block bg-gray-100 px-2 py-0.5 rounded-full text-xs">${item.browser}</span>
                        <span class="inline-block bg-gray-100 px-2 py-0.5 rounded-full text-xs">${item.resolution}</span>
                    </div>
                `;
                list.appendChild(listItem);
            });
        }
    }

    // --- Display Utility (Updated to generate Table HTML) ---

    function objectToTableHTML(obj) {
        let html = '';
        let rowIndex = 0;
        for (const [key, value] of Object.entries(obj)) {
            // Apply striped background every other row for readability
            const rowClass = rowIndex % 2 === 0 ? 'bg-white' : 'bg-gray-50';
            html += `
                <tr class="${rowClass}">
                    <th class="px-4 py-2 text-left text-sm font-medium text-gray-500 w-1/3 whitespace-nowrap">${key}</th>
                    <td class="px-4 py-2 text-sm text-gray-900">${value}</td>
                </tr>
            `;
            rowIndex++;
        }
        return html;
    }

    // --- Initialization and Event Listeners ---

    async function initialize() {
        // Display Current Session Info
        document.getElementById('sessionInfo').innerHTML = objectToTableHTML(getCurrentSessionInfo());
        
        // Display Network & Battery Info
        const networkBatteryData = await getNetworkAndBatteryInfo();
        document.getElementById('networkBatteryInfo').innerHTML = objectToTableHTML(networkBatteryData);

        // Log new visit + display history
        const history = logVisit();
        displayHistory(history);
        
        // Set up Clear History Button Listener
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const confirmModal = document.getElementById('confirmModal');
        const cancelClearBtn = document.getElementById('cancelClearBtn');
        const confirmClearBtn = document.getElementById('confirmClearBtn');
        
        clearHistoryBtn.addEventListener('click', () => {
            confirmModal.style.display = 'flex';
        });

        cancelClearBtn.addEventListener('click', () => {
            confirmModal.style.display = 'none';
        });

        confirmClearBtn.addEventListener('click', () => {
            localStorage.removeItem(HISTORY_KEY);
            displayHistory([]);
            confirmModal.style.display = 'none';
        });
    }

    // Run initialization after DOM load
    document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>

