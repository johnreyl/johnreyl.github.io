<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel-Like CSV Editor</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Bootstrap Icons (Still needed for icons) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <!-- JQuery and PapaParse for CSV handling -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        /* Custom Styles for Excel-like appearance and behavior */
        body { 
            padding: 20px; 
            background: #f1f5f9; /* Slate 100 */
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        
        /* Table styles */
        #tableContainer {
            overflow: auto;
            max-height: calc(100vh - 180px); /* Leave space for header/toolbar */
            border-radius: 0.5rem;
            border: 1px solid #cbd5e1; /* Slate 300 */
            background-color: white;
        }

        table { 
            border-collapse: collapse; 
            table-layout: fixed; 
            min-width: 100%;
        }
        
        /* Cell and Header Styles */
        th, td {
            border: 1px solid #e2e8f0; /* Slate 200 */
            padding: 8px 12px;
            min-width: 100px;
            height: 38px;
            box-sizing: border-box;
        }
        
        /* Column Header */
        th {
            background: #e0f7fa; /* Cyan 50 */
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        /* Row Header (Index Column) */
        .row-index-th {
            position: sticky;
            left: 0;
            background: #f0f9ff; /* Sky 50 */
            z-index: 11; /* Over column headers */
            font-weight: 700;
            width: 50px !important;
            min-width: 50px !important;
            text-align: right !important;
            padding-right: 8px !important;
        }

        /* Content Editable Cell */
        td[contenteditable="true"] { 
            background: #fff; 
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Active Focus */
        td:focus { 
            outline: 2px solid #4f46e5; /* Indigo 600 */
            box-shadow: 0 0 0 1px #4f46e5;
            z-index: 5;
        }
        
        /* Resizer handle */
        th.resizable {
            position: relative;
        }
        th.resizable .resizer {
            position: absolute;
            top: 0; right: -2px; 
            width: 5px; height: 100%;
            cursor: col-resize;
            user-select: none;
            z-index: 12;
            background: rgba(0, 0, 0, 0); 
        }

        /* Feedback Toast */
        #feedbackToast {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="p-4 sm:p-6">

    <h4 class="text-2xl font-bold text-gray-800 mb-4">üóÇÔ∏è CSV Editor</h4>
    <p class="text-sm text-gray-600 mb-3">Edit data directly, load/save CSV files, and use arrow keys to navigate cells.</p>

    <!-- Toolbar - Now grouped by Row and Column controls with labels and singular colors -->
    <div id="toolbar" class="flex flex-wrap gap-4 items-center mb-6 p-3 bg-white rounded-lg shadow-md">
        <input type="file" id="fileInput" accept=".csv" class="w-full sm:w-auto p-2 border border-gray-300 rounded-md text-sm text-gray-700 max-w-xs">
        
        <!-- Row Control Group (Indigo) -->
        <div class="flex items-center gap-1">
            <span class="text-sm font-semibold text-gray-700">Rows:</span>
            <div class="flex">
                <!-- Add Row (+) - Indigo -->
                <button id="addRowBtn" class="w-9 h-9 flex items-center justify-center text-xl bg-indigo-600 text-white rounded-l-md hover:bg-indigo-700 transition" title="Add Row"><i class="bi bi-plus-square"></i></button>
                <!-- Delete Row (-) - Indigo -->
                <button id="delRowBtn" class="w-9 h-9 flex items-center justify-center text-xl bg-indigo-600 text-white rounded-r-md hover:bg-indigo-700 transition" title="Delete Last Row"><i class="bi bi-dash-square"></i></button>
            </div>
        </div>
        
        <!-- Column Control Group (Emerald) -->
        <div class="flex items-center gap-1">
            <span class="text-sm font-semibold text-gray-700">Cols:</span>
            <div class="flex">
                <!-- Add Column (+) - Emerald -->
                <button id="addColBtn" class="w-9 h-9 flex items-center justify-center text-xl bg-emerald-600 text-white rounded-l-md hover:bg-emerald-700 transition" title="Add Column"><i class="bi bi-plus-square-fill"></i></button>
                <!-- Delete Column (-) - Emerald -->
                <button id="delColBtn" class="w-9 h-9 flex items-center justify-center text-xl bg-emerald-600 text-white rounded-r-md hover:bg-emerald-700 transition" title="Delete Last Column"><i class="bi bi-dash-square-fill"></i></button>
            </div>
        </div>
        
        <!-- Save button (Standalone Green) -->
        <button id="saveBtn" class="w-9 h-9 flex items-center justify-center text-xl bg-green-500 text-white rounded-md hover:bg-green-600 transition ml-auto" title="Download CSV"><i class="bi bi-download"></i></button>
    </div>

    <!-- Table Container -->
    <div id="tableContainer"></div>

    <!-- Feedback Toast -->
    <div id="feedbackToast" class="fixed bottom-4 right-4 bg-gray-900 text-white px-4 py-2 rounded-lg shadow-xl opacity-0 transform translate-y-4 pointer-events-none z-50">
        <span id="toastMessage"></span>
    </div>

    <script>
        let currentData = [];
        let saveCounter = localStorage.getItem("csvSaveCounter") ? parseInt(localStorage.getItem("csvSaveCounter"), 10) : 0;
        const DEFAULT_COL_WIDTH = 120; // Default width in pixels

        // --- Core Functions ---

        function showToast(message, duration = 2000) {
            const toast = document.getElementById('feedbackToast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-4');
            toast.classList.add('opacity-100', 'translate-y-0');

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-4');
            }, duration);
        }

        // Initialize with default empty grid if no data is loaded
        function initializeData() {
            // Start with a minimal 3x4 grid for immediate use
            currentData = [
                ["Header 1", "Header 2", "Header 3", "Header 4"],
                ["", "", "", ""],
                ["", "", "", ""],
                ["", "", "", ""]
            ];
            renderTable();
            showToast("Initialized with default grid data.");
        }

        // Load CSV data from an input file
        function loadCSVFromFile(file) {
            Papa.parse(file, {
                skipEmptyLines: false,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        // Filter out trailing empty rows that PapaParse might include
                        let cleanData = results.data.filter(row => row.some(cell => cell && cell.trim() !== ''));
                        if (cleanData.length === 0) {
                            showToast("File loaded but contained no data.", 3000);
                            return;
                        }

                        currentData = cleanData;
                        renderTable();
                        showToast(`Successfully loaded ${currentData.length} rows.`, 3000);
                    } else {
                        showToast("Error parsing file or file is empty.", 3000);
                    }
                },
                error: function(err, file) {
                    showToast(`Parsing error: ${err.message}`, 4000);
                }
            });
        }

        // Render editable Excel-like table
        function renderTable() {
            const numCols = currentData.length > 0 ? currentData[0].length : 0;
            if (numCols === 0) {
                currentData = [[""]];
            }

            let html = '<table class="w-full"><thead><tr>';
            
            // Fixed cell for the corner
            html += '<th class="row-index-th bg-gray-200" style="width: 50px; min-width: 50px;">#</th>'; 
            
            // Column Headers
            currentData[0].forEach((_, j) => {
                const colKey = `colWidth_${j}`;
                const colWidth = localStorage.getItem(colKey) || DEFAULT_COL_WIDTH;
                html += `<th class="resizable" data-col="${j}" style="width:${colWidth}px;">Col ${j+1}<div class="resizer"></div></th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Data Rows
            currentData.forEach((row, i) => {
                html += "<tr>";
                // Row Index Cell
                html += `<th class="row-index-th">${i + 1}</th>`; 
                row.forEach((cell, j) => {
                    const safe = cell || "";
                    html += `<td contenteditable="true" title="${safe}" data-row="${i}" data-col="${j}">${safe}</td>`;
                });
                html += "</tr>";
            });
            html += "</tbody></table>";
            $("#tableContainer").html(html);
            makeResizable();
        }

        // --- Event Handlers ---

        // Track edits
        $(document).on("input", "td[contenteditable='true']", function() {
            const row = $(this).data("row");
            const col = $(this).data("col");
            // Important: Use .text() for contenteditable to avoid saving HTML
            currentData[row][col] = $(this).text(); 
            $(this).attr("title", $(this).text());
        });

        // Cell Navigation (Up, Down, Left, Right)
        $(document).on("keydown", "td[contenteditable='true']", function(e) {
            const $this = $(this);
            const row = $this.data("row");
            const col = $this.data("col");
            const numRows = currentData.length;
            const numCols = currentData[0].length;
            let $nextCell = null;

            if (e.key === "Enter" || e.key === "ArrowDown") {
                e.preventDefault();
                if (row + 1 < numRows) {
                    $nextCell = $(`td[data-row="${row + 1}"][data-col="${col}"]`);
                } else if (e.key === "Enter") {
                    // If Enter at the last row, add a new row
                    $("#addRowBtn").trigger('click'); 
                    setTimeout(() => {
                        $(`td[data-row="${row + 1}"][data-col="${col}"]`).focus();
                    }, 50); 
                    return;
                }
            } else if (e.key === "ArrowUp") {
                e.preventDefault();
                if (row - 1 >= 0) {
                    $nextCell = $(`td[data-row="${row - 1}"][data-col="${col}"]`);
                }
            } else if (e.key === "ArrowRight" || (e.key === "Tab" && !e.shiftKey)) {
                if (col + 1 < numCols) {
                    $nextCell = $(`td[data-row="${row}"][data-col="${col + 1}"]`);
                } else if (row + 1 < numRows) {
                    // Move to the next row, first column
                    $nextCell = $(`td[data-row="${row + 1}"][data-col="0"]`);
                    e.preventDefault(); // Stop default tab behavior if we handle it
                }
            } else if (e.key === "ArrowLeft" || (e.key === "Tab" && e.shiftKey)) {
                if (col - 1 >= 0) {
                    $nextCell = $(`td[data-row="${row}"][data-col="${col - 1}"]`);
                } else if (row - 1 >= 0) {
                     // Move to the previous row, last column
                    $nextCell = $(`td[data-row="${row - 1}"][data-col="${numCols - 1}"]`);
                    e.preventDefault();
                }
            }

            if ($nextCell && $nextCell.length) {
                $nextCell.focus();
                // Select all text in the cell for quick overwriting
                document.execCommand('selectAll', false, null);
            }
        });

        // File Input Handler
        $("#fileInput").on("change", function(e) {
            const file = e.target.files[0];
            if (file) {
                loadCSVFromFile(file);
            }
        });

        // Add Row
        $("#addRowBtn").on("click", function() {
            let numCols = currentData.length > 0 ? currentData[0].length : 1;
            let newRow = new Array(numCols).fill("");
            currentData.push(newRow);
            renderTable();
            showToast(`Added row ${currentData.length}.`);
        });

        // Delete Row
        $("#delRowBtn").on("click", function() {
            if (currentData.length > 1) {
                currentData.pop();
                renderTable();
                showToast("Deleted last row.");
            } else {
                showToast("Cannot delete the last row.", 2000);
            }
        });

        // Add Column
        $("#addColBtn").on("click", function() {
            currentData.forEach(row => row.push(""));
            renderTable();
            showToast(`Added column ${currentData[0].length}.`);
        });

        // Delete Column
        $("#delColBtn").on("click", function() {
            if (currentData[0].length > 1) {
                currentData.forEach(row => row.pop());
                // Remove stored width for the deleted column
                const deletedColIndex = currentData[0].length;
                localStorage.removeItem(`colWidth_${deletedColIndex}`);
                renderTable();
                showToast("Deleted last column.");
            } else {
                showToast("Cannot delete the last column.", 2000);
            }
        });

        // Save CSV
        $("#saveBtn").on("click", function() {
            const csv = Papa.unparse(currentData);
            saveCounter++;
            localStorage.setItem("csvSaveCounter", saveCounter);
            const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `data_edit_${saveCounter}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("CSV file saved successfully!", 3000);
        });

        // --- Column Resize Logic ---

        function makeResizable() {
            const ths = document.querySelectorAll("th.resizable");
            ths.forEach(th => {
                const resizer = th.querySelector(".resizer");
                if (!resizer) return;
                
                let startX, startWidth;
                const colIndex = th.dataset.col;

                const startResize = (e) => {
                    e.preventDefault();
                    startX = e.pageX;
                    startWidth = th.offsetWidth;
                    document.addEventListener("mousemove", resize);
                    document.addEventListener("mouseup", stopResize);
                    th.style.cursor = 'col-resize';
                };

                const resize = (e) => {
                    const newWidth = Math.max(startWidth + (e.pageX - startX), 50); // Minimum 50px width
                    th.style.width = newWidth + "px";
                    // Apply width to all corresponding cells in the column
                    document.querySelectorAll(`td[data-col="${colIndex}"]`).forEach(td => {
                        td.style.width = newWidth + "px";
                    });
                };

                const stopResize = () => {
                    document.removeEventListener("mousemove", resize);
                    document.removeEventListener("mouseup", stopResize);
                    th.style.cursor = '';

                    const finalWidth = th.offsetWidth;
                    localStorage.setItem(`colWidth_${colIndex}`, finalWidth);
                };

                resizer.addEventListener("mousedown", startResize);
                resizer.addEventListener("touchstart", (e) => {
                    e.preventDefault();
                    startResize(e.touches[0]);
                }, { passive: false });
            });
        }

        // --- Initialization ---

        $(document).ready(function() {
            initializeData();
        });
    </script>

</body>
</html>

