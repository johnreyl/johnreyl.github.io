<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Laundry Shop System (Cloud/Local Sync)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Professional Color Palette (Inspired by Google/Material) */
        :root {
            --color-primary: #03a9f4; /* Light Blue for Laundry */
            --color-success: #34a853; /* Green */
            --color-warning: #fbbc05; /* Yellow/Warning */
            --color-info: #4285f4; /* Lighter Blue */
            --color-text-subtle: #5f6368; /* Gray Text */
            --color-danger: #ea4335; /* Red */
        }

        body { background-color: #f8f9fa; font-family: 'Roboto', sans-serif; }
        .container { max-width: 1050px; margin-top: 30px; }
        .card { border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); border-radius: 8px; }
        
        /* Custom Colors */
        .bg-primary { background-color: var(--color-primary) !important; }
        .btn-primary { background-color: var(--color-primary); border-color: var(--color-primary); }
        .text-primary { color: var(--color-primary) !important; }

        /* Tabs and List Styling */
        .nav-link.active { font-weight: 500; border-bottom: 2px solid var(--color-primary); color: var(--color-primary) !important; background-color: transparent !important; }
        
        /* HOME TAB CUSTOMIZATION: HIDE MAIN NAV */
        #myTab {
            display: none !important; 
        }

        /* Home Tab Specific Styles */
        .home-banner {
            background: linear-gradient(135deg, #03a9f4, #4285f4); 
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* Loading indicator for Firebase */
        #loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1050;
        }

        /* Custom Loading Overlay used by signInWithGoogle function */
        #auth-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: none; /* Starts hidden */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        /* Cloud Sync Modal Styling - kept original for Firebase login */
        .start-sync-modal-body {
            text-align: center;
            padding: 30px;
        }
        .google-sign-in-btn {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            width: 100%;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        .google-sign-in-btn:hover {
            background-color: #357ae8;
        }
        .guest-button {
            background-color: #e9ecef;
            color: #495057;
            border: 1px solid #ced4da;
            width: 100%;
        }

        /* Toast Message Styling */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1060;
        }
        .custom-toast {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(100%);
        }
        .custom-toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* List Group Styling */
        .list-group-item.list-group-item-danger {
            background-color: #f8d7da !important; 
        }
        .list-group-item.list-group-item-warning {
             background-color: #fff3cd !important;
        }
        .text-revenue { color: #008000 !important; }
        .border-left-revenue { border-left-color: #008000 !important; }
        .summary-box p {
            font-size: 1.5rem !important;
        }
        
        /* New Inventory List Item Styling */
        .inventory-item-row:hover {
            cursor: pointer;
            background-color: #f0f0f0; /* Light highlight on hover */
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-muted-subtle mb-0">Laundry Shop System</h1>
            </div>

        
        <div id="loading-indicator" class="d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-primary mt-2" id="loading-text">Connecting...</p>
        </div>

        <div id="auth-loading-overlay">
            <div class="spinner-border text-light mb-3" role="status"></div>
            <p class="text-light">Waiting for Google Sign-In...</p>
        </div>

        <div id="toast-container"></div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">
                    <i class="fas fa-home me-2"></i>Home
                </button>
            </li>
            <li class="nav-item d-none" role="presentation">
                <button class="nav-link" id="new-order-tab" data-bs-toggle="tab" data-bs-target="#new-order" type="button" role="tab" aria-controls="new-order" aria-selected="false">
                    <i class="fas fa-plus-circle me-2"></i>New Order
                </button>
            </li>
            <li class="nav-item d-none" role="presentation">
                <button class="nav-link" id="order-list-tab" data-bs-toggle="tab" data-bs-target="#order-list" type="button" role="tab" aria-controls="order-list" aria-selected="false">
                    <i class="fas fa-list-check me-2"></i>Order List
                </button>
            </li>
             <li class="nav-item d-none" role="presentation">
                <button class="nav-link" id="inventory-tab" data-bs-toggle="tab" data-bs-target="#inventory" type="button" role="tab" aria-controls="inventory" aria-selected="false">
                    <i class="fas fa-boxes-stacked me-2"></i>Inventory
                </button>
            </li>
            <li class="nav-item d-none" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">
                    <i class="fas fa-chart-line me-2"></i>Reporting
                </button>
            </li>
            <li class="nav-item d-none" role="presentation">
                <button class="nav-link" id="available-machines-tab" data-bs-toggle="tab" data-bs-target="#available-machines" type="button" role="tab" aria-controls="available-machines" aria-selected="false">Available Machines</button>
            </li>
            <li class="nav-item d-none" role="presentation">
                <button class="nav-link" id="workforce-tab" data-bs-toggle="tab" data-bs-target="#workforce" type="button" role="tab" aria-controls="workforce" aria-selected="false">Workforce</button>
            </li>
            <li class="nav-item d-none" role="presentation">
                <button class="nav-link" id="customers-tab" data-bs-toggle="tab" data-bs-target="#customers" type="button" role="tab" aria-controls="customers" aria-selected="false">Customers</button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div class="card p-4">
                    <h5 class="text-primary mb-4"><i class="fas fa-grip me-2"></i>Main System Dashboard</h5>
                    <p class="mb-4">Data storage mode: <span id="banner-storage-mode" class="fw-bold">...</span></p>
                    
                    <div class="row g-3" id="home-buttons-dashboard">
                        <div class="col-md-4"><button data-target-tab="#order-list" class="btn btn-primary w-100 py-3 home-nav-btn"><i class="fas fa-list-check me-2"></i>Laundry Requests</button></div>
                        <div class="col-md-4"><button data-target-tab="#reports" class="btn btn-primary w-100 py-3 home-nav-btn"><i class="fas fa-chart-line me-2"></i>Reports</button></div>
                        <div class="col-md-4"><button data-target-tab="#inventory" class="btn btn-primary w-100 py-3 home-nav-btn"><i class="fas fa-boxes-stacked me-2"></i>Inventory</button></div>
                        
                        <div class="col-md-4"><button data-target-tab="#available-machines" class="btn btn-info w-100 py-3 home-nav-btn"><i class="fas fa-washing-machine me-2"></i>Available Machines</button></div>
                        <div class="col-md-4"><button data-target-tab="#workforce" class="btn btn-info w-100 py-3 home-nav-btn"><i class="fas fa-users-gear me-2"></i>Workforce</button></div>
                        <div class="col-md-4"><button data-target-tab="#customers" class="btn btn-info w-100 py-3 home-nav-btn"><i class="fas fa-user-friends me-2"></i>Customers</button></div>
                        
                        <div class="col-md-12 mt-4"><button id="home-log-out-btn" class="btn btn-outline-danger w-100 py-3"><i class="fas fa-sign-out-alt me-2"></i>Log Out</button></div>
                    </div>
                </div>

                <div id="home-complex-data" class="d-none">
                     <div class="home-banner">
                        <h2>Welcome to Your Laundry Management System!</h2>
                        <p class="mb-0">Track your orders and inventory. Data is saved securely in the <span id="banner-storage-mode-hidden" class="fw-bold">...</span></p>
                    </div>
                    
                    <div class="row g-4">
                        </div>
                </div>
            </div>

            <div class="tab-pane fade" id="new-order" role="tabpanel" aria-labelledby="new-order-tab">
                <button class="btn btn-outline-secondary btn-sm mb-3 back-to-dashboard-btn"><i class="fas fa-arrow-left me-1"></i> Back to Dashboard</button>
                <div class="card p-4">
                    <h5 class="card-title text-primary mb-3"><i class="fas fa-soap me-2"></i>New Laundry Order Details</h5>
                    <form id="order-form" class="row g-3">
                        
                        <div class="col-12 mt-1 mb-0"><h6 class="text-info"><i class="fas fa-user me-2"></i>Customer Details</h6><hr class="mt-1 mb-2"></div>

                        <div class="col-md-3"><label for="customer-name" class="form-label text-muted-subtle">Customer Name</label><input type="text" class="form-control" id="customer-name" placeholder="e.g., Jane Doe"></div>
                        <div class="col-md-3"><label for="customer-phone-number" class="form-label text-muted-subtle">Phone Number</label><input type="tel" class="form-control" id="customer-phone-number" placeholder="e.g., +1 (555) 123-4567"></div>
                        <div class="col-md-6"><label for="customer-email" class="form-label text-muted-subtle">Customer Email (Optional)</label><input type="email" class="form-control" id="customer-email" placeholder="e.g., customer@example.com"></div>
                        
                        <div class="col-12 mt-3 mb-0"><h6 class="text-info"><i class="fas fa-shirt me-2"></i>Service Details & Weight</h6><hr class="mt-1 mb-2"></div>
                        
                        <div class="col-md-3">
                            <label for="service-type" class="form-label text-muted-subtle">Service Type</label>
                            <select class="form-select" id="service-type" required>
                                <option value="Wash & Fold" selected>Wash & Fold</option>
                                <option value="Dry Cleaning">Dry Cleaning</option>
                                <option value="Self Service">Self Service</option>
                                <option value="Pressing Only">Pressing Only</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="load-type" class="form-label text-muted-subtle">Load Type/Preference</label>
                            <select class="form-select" id="load-type" required>
                                <option value="Standard Detergent" selected>Standard Detergent</option>
                                <option value="Sensitive Skin">Sensitive Skin</option>
                                <option value="Organic Wash">Organic Wash</option>
                                <option value="Bleach Added">Bleach Added</option>
                                <option value="Heavy Duty">Heavy Duty</option>
                            </select>
                        </div>
                        <div class="col-md-3"><label for="weight-kg" class="form-label text-muted-subtle">Weight (kg) / Item Count</label><input type="number" step="0.1" min="0" class="form-control" id="weight-kg" required value="0"></div>
                        <div class="col-md-3"><label for="detergent-used" class="form-label text-muted-subtle">Detergent Units Used</label><input type="number" step="0.5" min="0" class="form-control" id="detergent-used" value="1"></div>
                        
                        <div class="col-12 mt-3 mb-0"><h6 class="text-info"><i class="fas fa-hand-holding-dollar me-2"></i>Financial & Personnel</h6><hr class="mt-1 mb-2"></div>
                        
                        <div class="col-md-3"><label for="staff-in-charge" class="form-label text-muted-subtle">Staff In Charge</label><input type="text" class="form-control" id="staff-in-charge" placeholder="e.g., Manager A"></div>
                        
                        <div class="col-md-3"><label for="base-cost" class="form-label text-muted-subtle">Base Service Cost (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="base-cost" value="0.00"></div>
                        <div class="col-md-3"><label for="deposit" class="form-label text-muted-subtle">Deposit Received (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="deposit" value="0.00"></div>
                        
                        <div class="col-md-3"><label for="total-price" class="form-label text-muted-subtle">Total Price (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="total-price" value="0.00" required></div>
                        
                        <div class="col-12 mt-3 mb-0"><h6 class="text-info"><i class="fas fa-calendar-alt me-2"></i>Pickup & Notes</h6><hr class="mt-1 mb-2"></div>

                        <div class="col-md-3"><label for="pickup-date" class="form-label text-muted-subtle">Est. Pickup Date</label><input type="date" class="form-control" id="pickup-date" required></div>
                        <div class="col-md-3"><label for="pickup-time" class="form-label text-muted-subtle">Est. Pickup Time</label><input type="time" class="form-control" id="pickup-time" value=""></div>

                        <div class="col-md-6"><label for="notes" class="form-label text-muted-subtle">Notes (Stains, Special Instructions)</label><textarea class="form-control" id="notes" rows="1" placeholder="e.g., Stain on collar. Do not use heat dry."></textarea></div>
                        
                        <div class="col-12 text-end"><button type="submit" class="btn btn-primary mt-3"><i class="fas fa-save me-2"></i>Save Order</button></div>
                    </form>
                </div>
            </div>

            <div class="tab-pane fade" id="order-list" role="tabpanel" aria-labelledby="order-list-tab">
                 <button class="btn btn-outline-secondary btn-sm mb-3 back-to-dashboard-btn"><i class="fas fa-arrow-left me-1"></i> Back to Dashboard</button>
                 <div class="card p-4 mb-3">
                     <h5 class="text-primary mb-3"><i class="fas fa-plus-circle me-2"></i>New Order Shortcut</h5>
                     <button id="add-new-order-btn" class="btn btn-success w-100"><i class="fas fa-plus me-2"></i>Add New Laundry Order</button>
                 </div>
                <div class="card rounded-top-0">
                    <ul id="order-list-ul" class="list-group list-group-flush">
                        <li class="list-group-item text-center text-muted-subtle">Orders will load after successful setup.</li>
                    </ul>
                </div>
                
                <div id="order-pagination-controls" class="d-flex justify-content-between align-items-center p-3 border-top bg-light rounded-bottom flex-wrap">
                    <button id="prev-page-btn" class="btn btn-outline-primary btn-sm mb-2 mb-sm-0" disabled><i class="fas fa-chevron-left me-1"></i> Previous</button>
                    <span id="page-info" class="text-muted-subtle mx-auto mb-2 mb-sm-0" style="font-size: 0.9rem;">Page 0 of 0</span>
                    <button id="next-page-btn" class="btn btn-outline-primary btn-sm" disabled>Next <i class="fas fa-chevron-right ms-1"></i></button>
                </div>
            </div>
            
            <div class="tab-pane fade" id="inventory" role="tabpanel" aria-labelledby="inventory-tab">
                <button class="btn btn-outline-secondary btn-sm mb-3 back-to-dashboard-btn"><i class="fas fa-arrow-left me-1"></i> Back to Dashboard</button>
                
                <ul class="nav nav-tabs mb-4" id="inventoryMainTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="inventory-add-tab" data-bs-toggle="tab" data-bs-target="#tab-inventory-add" type="button" role="tab" aria-controls="tab-inventory-add" aria-selected="false"><i class="fas fa-cart-plus me-2"></i>Add New Stock</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="inventory-view-tab" data-bs-toggle="tab" data-bs-target="#tab-inventory-view" type="button" role="tab" aria-controls="tab-inventory-view" aria-selected="true"><i class="fas fa-boxes-stacked me-2"></i>Current Inventory</button>
                    </li>
                </ul>
                
                <div class="tab-content" id="inventoryMainTabContent">
                    
                    <div class="tab-pane fade show active" id="tab-inventory-view" role="tabpanel" aria-labelledby="inventory-view-tab">
                        
                        <div id="low-stock-alert" class="alert alert-warning d-none" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Low on Stock!</strong> The following items need immediate reordering: 
                            <ul id="low-stock-list" class="mt-2 mb-0"></ul>
                        </div>
        
                        <div class="card mb-4">
                            <div class="card-header bg-white border-bottom p-3">
                                <button class="btn btn-block w-100 text-start d-flex justify-content-between align-items-center p-0" type="button" data-bs-toggle="collapse" data-bs-target="#inventoryFilterCollapse" aria-expanded="false" aria-controls="inventoryFilterCollapse">
                                    <h5 class="text-primary mb-0"><i class="fas fa-filter me-2"></i>Inventory Filters</h5>
                                    <i class="fas fa-chevron-up text-muted-subtle"></i>
                                </button>
                            </div>
                            <div class="collapse" id="inventoryFilterCollapse">
                                <div class="card-body p-4">
                                    <form id="inventory-filter-form" class="row g-3">
                                        <div class="col-md-4">
                                            <label for="filter-name" class="form-label text-muted-subtle">Item Name/Category</label>
                                            <input type="text" class="form-control" id="filter-name" placeholder="Search name or type...">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="filter-type" class="form-label text-muted-subtle">Item Type</label>
                                            <select class="form-select" id="filter-type">
                                                <option value="">All Types</option>
                                                <option value="Detergent">All Detergents</option>
                                                <option value="Liquid">Liquid</option>
                                                <option value="Powder">Powder</option>
                                                <option value="Pods">Pods/Unit</option>
                                                <option value="Softener">Softener</option>
                                                <option value="Special">Special</option>
                                                </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="filter-vendor" class="form-label text-muted-subtle">Vendor</label>
                                            <input type="text" class="form-control" id="filter-vendor" placeholder="Search vendor name...">
                                        </div>
                                        <div class="col-12 text-end">
                                            <button type="button" class="btn btn-outline-secondary me-2" id="clear-inventory-filter-btn"><i class="fas fa-redo me-1"></i> Clear Filter</button>
                                            <button type="submit" class="btn btn-primary"><i class="fas fa-search me-1"></i> Apply Filter</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card p-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-list me-2"></i>Current Inventory Stock (Click an item to update)</h5>
                            <ul id="inventory-list" class="list-group list-group-flush">
                                <li class="list-group-item text-center text-muted-subtle">Inventory will load here.</li>
                            </ul>
                        </div>
                    </div>
                    
                    <div class="tab-pane fade" id="tab-inventory-add" role="tabpanel" aria-labelledby="inventory-add-tab">
                        
                        <div class="card p-4 mb-4">
                            <h5 class="card-title text-success mb-3"><i class="fas fa-soap me-2"></i>Add New Detergent Stock</h5>
                            
                            <div class="tab-content" id="inventoryFormsTabContent">
                                <form id="detergent-form" class="row g-3">
                                    <div class="col-md-3">
                                        <label for="detergent-name" class="form-label text-muted-subtle">Detergent Name</label>
                                        <input type="text" class="form-control" id="detergent-name" list="detergent-recommendations" placeholder="e.g., Tide Pods" required>
                                        <datalist id="detergent-recommendations"></datalist>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="detergent-type" class="form-label text-muted-subtle">Type</label>
                                        <select class="form-select" id="detergent-type" required>
                                            <option value="Liquid">Liquid</option>
                                            <option value="Powder">Powder</option>
                                            <option value="Pods">Pods/Unit</option>
                                            <option value="Softener">Softener</option>
                                            <option value="Special">Special</option>
                                        </select>
                                    </div>
                                    <div class="col-md-2"><label for="detergent-qty" class="form-label text-muted-subtle">Quantity (Units)</label><input type="number" min="0" class="form-control" id="detergent-qty" required value="1"></div>
                                    <div class="col-md-2"><label for="detergent-cost" class="form-label text-muted-subtle">Cost Per Unit (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="detergent-cost" value="0.00" required></div>
                                    <div class="col-md-2"><label for="detergent-vendor" class="form-label text-muted-subtle">Vendor</label><input type="text" class="form-control" id="detergent-vendor" placeholder="e.g., Supplier X"></div>
                                    
                                    <div class="col-12 text-end"><button type="submit" class="btn btn-success mt-2"><i class="fas fa-boxes-stacked me-2"></i>Add/Update Stock</button></div>
                                </form>
                                
                                </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                 <button class="btn btn-outline-secondary btn-sm mb-3 back-to-dashboard-btn"><i class="fas fa-arrow-left me-1"></i> Back to Dashboard</button>
                 <div class="row g-4">
                    <div class="col-md-12">
                         <div class="card p-4">
                            </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="available-machines" role="tabpanel" aria-labelledby="available-machines-tab">
                <button class="btn btn-outline-secondary btn-sm mb-3 back-to-dashboard-btn"><i class="fas fa-arrow-left me-1"></i> Back to Dashboard</button>
                <div class="card p-4 mb-4">
                    <h5 class="text-info card-title mb-3"><i class="fas fa-washing-machine me-2"></i>Add New Machine Setup</h5>
                    <form id="machine-form" class="row g-3">
                        <div class="col-md-3"><label for="machine-name" class="form-label text-muted-subtle">Machine Name/ID</label><input type="text" class="form-control" id="machine-name" placeholder="e.g., Washer #1 / Dryer #A" required></div>
                        <div class="col-md-3">
                            <label for="machine-type" class="form-label text-muted-subtle">Machine Type</label>
                            <select class="form-select" id="machine-type" required>
                                <option value="Washer">Washer</option>
                                <option value="Dryer">Dryer</option>
                            </select>
                        </div>
                        <div class="col-md-2"><label for="machine-capacity" class="form-label text-muted-subtle">Capacity (kg)</label><input type="number" step="0.1" min="1" class="form-control" id="machine-capacity" required value="10.0"></div>
                        <div class="col-md-4"><label for="machine-purchase-date" class="form-label text-muted-subtle">Date Purchase</label><input type="date" class="form-control" id="machine-purchase-date"></div>
                        
                        <div class="col-md-9"><label for="machine-notes" class="form-label text-muted-subtle">Notes (Model, Location)</label><textarea class="form-control" id="machine-notes" rows="1"></textarea></div>
                        <div class="col-md-3 d-flex align-items-end">
                            <div class="form-check form-switch w-100">
                                <input class="form-check-input" type="checkbox" role="switch" id="machine-under-maintenance">
                                <label class="form-check-label" for="machine-under-maintenance">Under Maintenance</label>
                            </div>
                        </div>

                        <div class="col-12 text-end"><button type="submit" class="btn btn-info mt-2"><i class="fas fa-save me-2"></i>Save Machine</button></div>
                    </form>
                </div>
                
                <div class="card p-4">
                    <h5 class="text-primary mb-3"><i class="fas fa-list-check me-2"></i>Registered Machines</h5>
                    <ul id="machines-list" class="list-group list-group-flush">
                        <li class="list-group-item text-center text-muted-subtle">Machines will load here.</li>
                    </ul>
                </div>
            </div>

            <div class="tab-pane fade" id="workforce" role="tabpanel" aria-labelledby="workforce-tab">
                <button class="btn btn-outline-secondary btn-sm mb-3 back-to-dashboard-btn"><i class="fas fa-arrow-left me-1"></i> Back to Dashboard</button>
                <div class="card p-4 mb-4">
                    <h5 class="text-success card-title mb-3"><i class="fas fa-user-plus me-2"></i>Add New Employee</h5>
                    <form id="workforce-form" class="row g-3">
                        <div class="col-md-3"><label for="employee-name" class="form-label text-muted-subtle">Employee Name</label><input type="text" class="form-control" id="employee-name" required placeholder="e.g., John Smith"></div>
                        <div class="col-md-3">
                            <label for="employee-type" class="form-label text-muted-subtle">Employee Type</label>
                            <select class="form-select" id="employee-type" required>
                                <option value="Agent">Agent (Shop)</option>
                                <option value="Delivery">Delivery (Driver)</option>
                                <option value="Driver">Driver (Logistics)</option>
                                <option value="Manager">Manager</option>
                            </select>
                        </div>
                        <div class="col-md-3"><label for="employee-salary" class="form-label text-muted-subtle">Base Salary (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="employee-salary" value="0.00" required></div>
                        <div class="col-md-3">
                            <label for="employee-rate-type" class="form-label text-muted-subtle">Rate Type</label>
                            <select class="form-select" id="employee-rate-type" required>
                                <option value="Monthly">Monthly Rate</option>
                                <option value="Daily">Daily Rate</option>
                            </select>
                        </div>

                        <div class="col-12 text-end"><button type="submit" class="btn btn-success mt-2"><i class="fas fa-user-check me-2"></i>Add Employee</button></div>
                    </form>
                </div>
                
                <div class="card p-4">
                    <h5 class="text-primary mb-3"><i class="fas fa-users-gear me-2"></i>Current Workforce</h5>
                    <ul id="workforce-list" class="list-group list-group-flush">
                        <li class="list-group-item text-center text-muted-subtle">Workforce will load here.</li>
                    </ul>
                </div>
            </div>
            
            <div class="tab-pane fade" id="customers" role="tabpanel" aria-labelledby="customers-tab">
                <button class="btn btn-outline-secondary btn-sm mb-3 back-to-dashboard-btn"><i class="fas fa-arrow-left me-1"></i> Back to Dashboard</button>
                <div class="card p-4 mb-4">
                    <h5 class="text-info card-title mb-3"><i class="fas fa-address-card me-2"></i>Register New Customer</h5>
                    <form id="customer-form" class="row g-3">
                        <div class="col-md-4"><label for="customer-reg-name" class="form-label text-muted-subtle">Full Name</label><input type="text" class="form-control" id="customer-reg-name" required placeholder="e.g., Jane Doe"></div>
                        <div class="col-md-2"><label for="customer-reg-contact" class="form-label text-muted-subtle">Contact Number</label><input type="tel" class="form-control" id="customer-reg-contact" required placeholder="e.g., 09xxxxxxxxx"></div>
                        <div class="col-md-2"><label for="customer-reg-age" class="form-label text-muted-subtle">Age</label><input type="number" min="1" class="form-control" id="customer-reg-age" placeholder="e.g., 35"></div>
                        <div class="col-md-4"><label for="customer-reg-address" class="form-label text-muted-subtle">Address</label><input type="text" class="form-control" id="customer-reg-address" placeholder="e.g., 123 Main St."></div>
                        
                        <div class="col-md-6">
                            <label for="customer-reg-source" class="form-label text-muted-subtle">How did you know about us?</label>
                            <select class="form-select" id="customer-reg-source">
                                <option value="Referral">Referral</option>
                                <option value="Walk-In">Walk-In</option>
                                <option value="Social Media">Social Media</option>
                                <option value="Advertisement">Advertisement</option>
                                <option value="Online Search">Online Search</option>
                            </select>
                        </div>
                        <div class="col-md-6"><label for="customer-reg-date" class="form-label text-muted-subtle">Date Registered</label><input type="date" class="form-control" id="customer-reg-date" required></div>

                        <div class="col-12 text-end"><button type="submit" class="btn btn-info mt-2"><i class="fas fa-save me-2"></i>Register Customer</button></div>
                    </form>
                </div>
                
                <div class="card p-4">
                    <h5 class="text-primary mb-3"><i class="fas fa-user-friends me-2"></i>Registered Customers</h5>
                    <ul id="customers-list" class="list-group list-group-flush">
                        <li class="list-group-item text-center text-muted-subtle">Customers will load here.</li>
                    </ul>
                </div>
            </div>

        </div> </div>

    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="orderDetailModalLabel">Order Details</h5>
                    <button type="button" class="btn-close btn-close-white close-modal-btn" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <input type="hidden" id="modal-order-id">
                    
                    <ul class="nav nav-tabs mb-3" id="orderDetailTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="order-details-tab" data-bs-toggle="tab" data-bs-target="#tab-order-details" type="button" role="tab" aria-controls="tab-order-details" aria-selected="true"><i class="fas fa-shirt me-2"></i>Order Details</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="staff-inputs-tab" data-bs-toggle="tab" data-bs-target="#tab-staff-inputs" type="button" role="tab" aria-controls="tab-staff-inputs" aria-selected="false"><i class="fas fa-user-gear me-2"></i>Staff Inputs</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="generate-text-tab" data-bs-toggle="tab" data-bs-target="#tab-generate-text" type="button" role="tab" aria-controls="tab-generate-text" aria-selected="false"><i class="fas fa-mobile-alt me-2"></i>Generate SMS</button>
                        </li>
                    </ul>

                    <form id="order-update-form"> 
                        <div class="tab-content" id="orderDetailTabContent">
                            
                            <div class="tab-pane fade show active" id="tab-order-details" role="tabpanel" aria-labelledby="order-details-tab">
                                <div class="row g-3">
                                    <div class="col-12"><label for="modal-customer-name-input" class="form-label text-muted-subtle">Customer Name</label><input type="text" class="form-control" id="modal-customer-name-input"></div>
                                    
                                    <div class="col-md-6"><label for="modal-customer-phone-input" class="form-label text-muted-subtle">Customer Phone Number</label><input type="tel" class="form-control" id="modal-customer-phone-input" placeholder="e.g., +1 (555) 123-4567"></div>
                                    <div class="col-md-6"><label for="modal-customer-email-input" class="form-label text-muted-subtle">Customer Email</label><input type="email" class="form-control" id="modal-customer-email-input" placeholder="e.g., customer@example.com"></div>
                                    
                                    <div class="col-md-6">
                                        <label for="modal-service-type-input" class="form-label text-muted-subtle">Service Type</label>
                                        <select class="form-select" id="modal-service-type-input">
                                            <option value="Wash & Fold">Wash & Fold</option>
                                            <option value="Dry Cleaning">Dry Cleaning</option>
                                            <option value="Self Service">Self Service</option>
                                            <option value="Pressing Only">Pressing Only</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="modal-load-type-input" class="form-label text-muted-subtle">Load Type/Preference</label>
                                        <select class="form-select" id="modal-load-type-input">
                                            <option value="Standard Detergent">Standard Detergent</option>
                                            <option value="Sensitive Skin">Sensitive Skin</option>
                                            <option value="Organic Wash">Organic Wash</option>
                                            <option value="Bleach Added">Bleach Added</option>
                                            <option value="Heavy Duty">Heavy Duty</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6"><label for="modal-pickup-date-input" class="form-label text-muted-subtle">Est. Pickup Date</label><input type="date" class="form-control" id="modal-pickup-date-input" required></div>
                                    <div class="col-md-6"><label for="modal-pickup-time-input" class="form-label text-muted-subtle">Est. Pickup Time</label><input type="time" class="form-control" id="modal-pickup-time-input"></div>
                                    
                                    <div class="col-12"><label for="modal-notes-input" class="form-label text-muted-subtle">Notes (Stains, Special Instructions)</label><textarea class="form-control" id="modal-notes-input" rows="4"></textarea></div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="tab-staff-inputs" role="tabpanel" aria-labelledby="staff-inputs-tab">
                                <div class="row g-3">
                                    <div class="col-md-6"><label for="modal-base-cost-input" class="form-label text-muted-subtle">Base Service Cost (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="modal-base-cost-input"></div>
                                    <div class="col-md-6"><label for="modal-additional-cost-input" class="form-label text-muted-subtle">Additional Cost (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="modal-additional-cost-input" value="0.00"></div>
                                    
                                    <div class="col-md-6"><label for="modal-total-price-input" class="form-label text-muted-subtle">Total Price (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="modal-total-price-input" value="0.00"></div>
                                    <div class="col-md-6"><label for="modal-deposit-input" class="form-label text-muted-subtle">Deposit Received (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="modal-deposit-input" value="0.00"></div>
                                    
                                    <div class="col-md-6"><label for="modal-detergent-used-input" class="form-label text-muted-subtle">Detergent Units Used</label><input type="number" step="0.5" min="0" class="form-control" id="modal-detergent-used-input"></div>
                                    <div class="col-md-6"><label for="modal-weight-kg-input" class="form-label text-muted-subtle">Weight (kg)</label><input type="number" step="0.1" min="0" class="form-control" id="modal-weight-kg-input" value="0"></div>

                                    <div class="col-md-6"><label for="modal-staff-in-charge-input" class="form-label text-muted-subtle">Staff In Charge</label><input type="text" class="form-control" id="modal-staff-in-charge-input"></div>
                                    <div class="col-md-6">
                                        <label for="modal-internal-notes-input" class="form-label text-muted-subtle">Internal Notes</label>
                                        <input type="text" class="form-control" id="modal-internal-notes-input" placeholder="e.g., Machine 3, 40C">
                                    </div>
                                    
                                    <div class="col-12 mt-4"><strong>Status:</strong> <span id="modal-order-status" class="badge" title="Click to cycle status: Received -> Washing -> Ready -> Picked Up -> Cancelled"></span></div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="tab-generate-text" role="tabpanel" aria-labelledby="generate-text-tab">
                                <div class="mb-3">
                                    <label for="modal-generated-text-message" class="form-label text-muted-subtle">Generated Message Preview</label>
                                    <textarea class="form-control" id="modal-generated-text-message" rows="6" readonly placeholder="Click a 'Generate Message' button to create a customer pickup text based on the Order Details."></textarea>
                                </div>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    <button type="button" class="btn btn-outline-primary flex-grow-1" id="modal-generate-template-1-btn">
                                        <i class="fas fa-wand-magic-sparkles me-2"></i>**Order Received**
                                    </button>
                                    <button type="button" class="btn btn-outline-success flex-grow-1" id="modal-generate-template-2-btn">
                                        <i class="fas fa-check-double me-2"></i>**Ready for Pickup**
                                    </button>
                                    <button type="button" class="btn btn-outline-warning flex-grow-1" id="modal-generate-template-3-btn">
                                        <i class="fas fa-money-bill-wave me-2"></i>**Payment Reminder**
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="modal-footer d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-danger" id="delete-order-btn"><i class="fas fa-trash-alt me-1"></i> Delete Order</button>
                            <div>
                                <button type="button" class="btn btn-secondary close-modal-btn" data-bs-dismiss="modal">Close</button>
                                <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Save Changes</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="inventoryDetailModal" tabindex="-1" aria-labelledby="inventoryDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="inventoryDetailModalLabel">Update Detergent Stock</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="inventory-update-form">
                    <div class="modal-body">
                        <input type="hidden" id="modal-inventory-id">
                        <div class="row g-3">
                            <div class="col-md-12"><label for="modal-detergent-name" class="form-label text-muted-subtle">Detergent Name</label><input type="text" class="form-control" id="modal-detergent-name" required></div>
                            <div class="col-md-6">
                                <label for="modal-detergent-type" class="form-label text-muted-subtle">Type</label>
                                <select class="form-select" id="modal-detergent-type" required>
                                    <option value="Liquid">Liquid</option>
                                    <option value="Powder">Powder</option>
                                    <option value="Pods">Pods/Unit</option>
                                    <option value="Softener">Softener</option>
                                    <option value="Special">Special</option>
                                </select>
                            </div>
                            <div class="col-md-6"><label for="modal-detergent-vendor" class="form-label text-muted-subtle">Vendor</label><input type="text" class="form-control" id="modal-detergent-vendor" placeholder="e.g., Supplier X"></div>
                            <div class="col-md-6"><label for="modal-detergent-qty" class="form-label text-muted-subtle">Quantity (Units)</label><input type="number" min="0" class="form-control" id="modal-detergent-qty" required></div>
                            <div class="col-md-6"><label for="modal-detergent-cost" class="form-label text-muted-subtle">Cost Per Unit (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="modal-detergent-cost" required></div>
                        </div>
                    </div>
                    <div class="modal-footer d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-danger" id="delete-inventory-modal-btn"><i class="fas fa-trash-alt me-1"></i> Delete Item</button>
                        <div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary"><i class="fas fa-save me-1"></i> Save Changes</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="cloudSyncModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="cloudSyncModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="cloudSyncModalLabel">Cloud Sync Setup</h5>
                </div>
                <div class="modal-body start-sync-modal-body">
                    <p class="mb-4">Choose a mode to save and sync your Laundry Shop data.</p>
                    <button id="google-sign-in-btn" class="google-sign-in-btn mb-2">
                        <i class="fab fa-google me-2"></i>Sign In with Google (Cloud Sync)
                    </button>
                    <button id="guest-mode-btn" class="btn guest-button">
                        Continue as Guest (Local Storage Only)
                    </button>
                    <p class="mt-3 text-muted-subtle" style="font-size: 0.8rem;">Cloud Sync ensures data persistence across devices.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script>
        // --- FIREBASE CONFIGURATION (Use your own Project Details) ---
        // This configuration object must be replaced with your actual Firebase project settings.
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY", // Replace with your key
            authDomain: "YOUR_AUTH_DOMAIN", // Replace with your domain
            projectId: "YOUR_PROJECT_ID", // Replace with your project ID
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        
        // Initialize Firebase - using the compat library as per original file structure
        if (firebase.apps.length === 0) {
            firebase.initializeApp(firebaseConfig);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();

        // Global state
        let storageMode = 'local';
        let orders = [];
        let inventory = []; 
        let machines = []; 
        let workforce = []; 
        let customers = []; 
        let filteredOrders = [];
        const LOW_STOCK_THRESHOLD = 5; // Global Low Stock Threshold
        let currentPage = 1;
        const itemsPerPage = 10;
        let unsubscribeOrders = null;
        let unsubscribeInventory = null;
        let unsubscribeMachines = null; 
        let unsubscribeWorkforce = null; 
        let unsubscribeCustomers = null; 

        // --- Utility Functions ---

        const showToast = (message, type = 'success') => {
            const toastContainer = $('#toast-container');
            const toast = $('<div>').addClass(`custom-toast bg-${type}`).text(message);
            toastContainer.append(toast);
            setTimeout(() => {
                toast.addClass('show');
            }, 10);
            setTimeout(() => {
                toast.removeClass('show');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        };

        const formatCurrency = (amount) => {
            return parseFloat(amount).toFixed(2);
        };
        
        // --- DataService Module (Modified to handle all new entities) ---

        const DataService = (() => {
            const LOCAL_STORAGE_KEY_ORDERS = 'laundry_orders';
            const LOCAL_STORAGE_KEY_INVENTORY = 'laundry_inventory';
            const LOCAL_STORAGE_KEY_MACHINES = 'laundry_machines'; 
            const LOCAL_STORAGE_KEY_WORKFORCE = 'laundry_workforce'; 
            const LOCAL_STORAGE_KEY_CUSTOMERS = 'laundry_customers'; 

            // --- Generic Local Storage CRUD Helper (for New Entities) ---
            const createLocalDataService = (key, globalArray) => {
                const load = () => {
                    const json = localStorage.getItem(key);
                    return json ? JSON.parse(json) : [];
                };
                const save = (data) => {
                    localStorage.setItem(key, JSON.stringify(data));
                };

                const get = () => {
                    window[globalArray] = load();
                    return Promise.resolve(window[globalArray]);
                };
                
                const add = (item) => {
                    item.id = Date.now().toString();
                    window[globalArray].push(item);
                    save(window[globalArray]);
                    return Promise.resolve(item);
                };
                
                const update = (id, updates) => {
                    const index = window[globalArray].findIndex(i => i.id === id);
                    if (index !== -1) {
                        window[globalArray][index] = { ...window[globalArray][index], ...updates };
                        save(window[globalArray]);
                    }
                    return Promise.resolve();
                };
                
                const remove = (id) => {
                    window[globalArray] = window[globalArray].filter(i => i.id !== id);
                    save(window[globalArray]);
                    return Promise.resolve();
                };
                
                return { get, add, update, delete: remove, load, save };
            };

            // --- Orders and Inventory (Modified to use explicit logic for complex saves) ---
            const localOrders = createLocalDataService(LOCAL_STORAGE_KEY_ORDERS, 'orders');
            const localInventory = createLocalDataService(LOCAL_STORAGE_KEY_INVENTORY, 'inventory');
            
            // --- New Entities Local/Cloud Wrappers ---
            const localMachines = createLocalDataService(LOCAL_STORAGE_KEY_MACHINES, 'machines');
            const localWorkforce = createLocalDataService(LOCAL_STORAGE_KEY_WORKFORCE, 'workforce');
            const localCustomers = createLocalDataService(LOCAL_STORAGE_KEY_CUSTOMERS, 'customers');

            // --- Public Interface ---
            const getOrders = () => storageMode === 'local' ? localOrders.get() : Promise.resolve(orders);
            const addOrder = (order) => storageMode === 'local' ? localOrders.add(order) : db.collection('users').doc(auth.currentUser.uid).collection('orders').add(order);
            const updateOrder = (id, updates) => storageMode === 'local' ? localOrders.update(id, updates) : db.collection('users').doc(auth.currentUser.uid).collection('orders').doc(id).update(updates);
            const deleteOrder = (id) => storageMode === 'local' ? localOrders.delete(id) : db.collection('users').doc(auth.currentUser.uid).collection('orders').doc(id).delete();

            // Inventory logic remains the same (simplified add/update handled in form logic)
            const getInventory = () => storageMode === 'local' ? localInventory.get() : Promise.resolve(inventory);
            const saveInventoryItem = (item) => {
                if (storageMode === 'local') {
                    return item.id ? localInventory.update(item.id, item) : localInventory.add(item);
                } else {
                    const inventoryRef = db.collection('users').doc(auth.currentUser.uid).collection('inventory');
                    const { id, ...data } = item;
                    return id ? inventoryRef.doc(id).update(data) : inventoryRef.add(data);
                }
            };
            const deleteInventoryItem = (id) => storageMode === 'local' ? localInventory.delete(id) : db.collection('users').doc(auth.currentUser.uid).collection('inventory').doc(id).delete();
            
            // NEW: Machines
            const getMachines = () => storageMode === 'local' ? localMachines.get() : Promise.resolve(machines);
            const saveMachine = (item) => {
                 if (storageMode === 'local') {
                    return item.id ? localMachines.update(item.id, item) : localMachines.add(item);
                } else {
                    const machinesRef = db.collection('users').doc(auth.currentUser.uid).collection('machines');
                    const { id, ...data } = item;
                    return id ? machinesRef.doc(id).update(data) : machinesRef.add(data);
                }
            };
            const deleteMachine = (id) => storageMode === 'local' ? localMachines.delete(id) : db.collection('users').doc(auth.currentUser.uid).collection('machines').doc(id).delete();

            // NEW: Workforce
            const getWorkforce = () => storageMode === 'local' ? localWorkforce.get() : Promise.resolve(workforce);
            const saveWorkforce = (item) => {
                 if (storageMode === 'local') {
                    return item.id ? localWorkforce.update(item.id, item) : localWorkforce.add(item);
                } else {
                    const workforceRef = db.collection('users').doc(auth.currentUser.uid).collection('workforce');
                    const { id, ...data } = item;
                    return id ? workforceRef.doc(id).update(data) : workforceRef.add(data);
                }
            };
            const deleteWorkforce = (id) => storageMode === 'local' ? localWorkforce.delete(id) : db.collection('users').doc(auth.currentUser.uid).collection('workforce').doc(id).delete();

            // NEW: Customers
            const getCustomers = () => storageMode === 'local' ? localCustomers.get() : Promise.resolve(customers);
            const saveCustomer = (item) => {
                 if (storageMode === 'local') {
                    return item.id ? localCustomers.update(item.id, item) : localCustomers.add(item);
                } else {
                    const customersRef = db.collection('users').doc(auth.currentUser.uid).collection('customers');
                    const { id, ...data } = item;
                    return id ? customersRef.doc(id).update(data) : customersRef.add(data);
                }
            };
            const deleteCustomer = (id) => storageMode === 'local' ? localCustomers.delete(id) : db.collection('users').doc(auth.currentUser.uid).collection('customers').doc(id).delete();

            const resetToLocalMode = () => {
                 storageMode = 'local';
                 orders = localOrders.load();
                 inventory = localInventory.load();
                 machines = localMachines.load(); 
                 workforce = localWorkforce.load();
                 customers = localCustomers.load();
            };
            
            const endLocalSession = () => {
                storageMode = 'local_ended'; 
                orders = [];
                inventory = [];
                machines = [];
                workforce = [];
                customers = [];
            };

            // Updated setOrdersAndInventory to accept all global arrays
            const setGlobalData = (newOrders, newInventory, newMachines, newWorkforce, newCustomers) => {
                orders = newOrders;
                inventory = newInventory;
                machines = newMachines;
                workforce = newWorkforce;
                customers = newCustomers;
            };

            return {
                getOrders, addOrder, updateOrder, deleteOrder,
                getInventory, saveInventoryItem, deleteInventoryItem,
                getMachines, saveMachine, deleteMachine, 
                getWorkforce, saveWorkforce, deleteWorkforce, 
                getCustomers, saveCustomer, deleteCustomer, 
                resetToLocalMode, endLocalSession, 
                setGlobalData, 
                LOCAL_STORAGE_KEY_ORDERS, LOCAL_STORAGE_KEY_INVENTORY, 
                LOCAL_STORAGE_KEY_MACHINES, LOCAL_STORAGE_KEY_WORKFORCE, LOCAL_STORAGE_KEY_CUSTOMERS
            };

        })();

        // --- Firebase Implementation Module (Updated with New Listeners) ---

        const FirebaseImpl = (() => {
            let userUid = null;

            // --- Generic Listener Setup Helper ---
            const setupListener = (collectionName, orderByField, globalArrayName, unsubscribeVariable, renderFunction) => {
                if (window[unsubscribeVariable]) {
                    window[unsubscribeVariable]();
                }
                
                const ref = db.collection('users').doc(userUid).collection(collectionName).orderBy(orderByField, 'desc');
                window[unsubscribeVariable] = ref.onSnapshot(snapshot => {
                    const newData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    // The setGlobalData call is for complex synchronization, but for simple listeners,
                    // we just update the specific array and rely on renderFunction to use the updated data.
                    window[globalArrayName] = newData; // Directly update the global array
                    
                    // Manually ensure all global arrays are up-to-date before rendering if needed.
                    DataService.setGlobalData(orders, inventory, machines, workforce, customers);
                    
                    renderFunction();
                    if (collectionName === 'orders') updateUIOnDataChange();
                    showToast(`${collectionName.charAt(0).toUpperCase() + collectionName.slice(1)} synchronized with Cloud.`, 'info');
                }, error => {
                    console.error(`Error listening to ${collectionName}:`, error);
                    showToast(`Error syncing ${collectionName} with Cloud.`, 'danger');
                });
            };

            const setupAuthListeners = () => {
                auth.onAuthStateChanged(async (user) => {
                    hideLoadingIndicator();
                    if (user) {
                        userUid = user.uid;
                        storageMode = 'cloud';
                        await db.collection('users').doc(userUid).set({ lastLogin: firebase.firestore.FieldValue.serverTimestamp(), email: user.email || 'guest' }, { merge: true });

                        await syncLocalToCloud(user.uid);
                        
                        // Setup all listeners
                        setupListener('orders', 'timestamp', 'orders', 'unsubscribeOrders', renderOrderList); // Switched to 'timestamp'
                        setupListener('inventory', 'name', 'inventory', 'unsubscribeInventory', renderInventoryList);
                        setupListener('machines', 'machineName', 'machines', 'unsubscribeMachines', renderMachinesList); 
                        setupListener('workforce', 'employeeName', 'workforce', 'unsubscribeWorkforce', renderWorkforceList); 
                        setupListener('customers', 'customerRegName', 'customers', 'unsubscribeCustomers', renderCustomersList); // Switched to 'customerRegName'
                        
                        updateUIOnModeChange();
                        showToast('Signed in successfully. Cloud data syncing.', 'success');
                        hideCloudSyncModal();
                    } else {
                        userUid = null;
                        if (storageMode !== 'local') {
                            showCloudSyncModal();
                        }
                    }
                    // Hide overlay if user cancels or there's an error
                    $('#auth-loading-overlay').css('display', 'none');
                });
            };
            
            const syncLocalToCloud = async (uid) => {
                const localDataKeys = [
                    { key: DataService.LOCAL_STORAGE_KEY_ORDERS, collection: 'orders' },
                    { key: DataService.LOCAL_STORAGE_KEY_INVENTORY, collection: 'inventory' },
                    { key: DataService.LOCAL_STORAGE_KEY_MACHINES, collection: 'machines' }, 
                    { key: DataService.LOCAL_STORAGE_KEY_WORKFORCE, collection: 'workforce' }, 
                    { key: DataService.LOCAL_STORAGE_KEY_CUSTOMERS, collection: 'customers' } 
                ];

                let dataFound = false;
                const batch = db.batch();
                
                localDataKeys.forEach(({ key, collection }) => {
                    const localItems = JSON.parse(localStorage.getItem(key) || '[]');
                    if (localItems.length > 0) {
                        dataFound = true;
                        const collectionRef = db.collection('users').doc(uid).collection(collection);
                        localItems.forEach(item => {
                            const { id, ...data } = item; 
                            const newDocRef = collectionRef.doc();
                            batch.set(newDocRef, data);
                        });
                        localStorage.removeItem(key); // Clear local storage after batching
                    }
                });
                
                if (dataFound) {
                    showLoadingIndicator('Migrating local data to cloud...');
                    await batch.commit();
                    showToast('Local data migrated to cloud storage.', 'success');
                }
            };
            
            const signInWithGoogle = () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                $('#auth-loading-overlay').css('display', 'flex'); 
                auth.signInWithPopup(provider)
                    .catch(error => {
                        $('#auth-loading-overlay').css('display', 'none');
                        console.error(error);
                        showToast(`Sign in error: ${error.message}`, 'danger');
                    });
            };

            const signOutUser = () => {
                if (unsubscribeOrders) unsubscribeOrders();
                if (unsubscribeInventory) unsubscribeInventory();
                if (unsubscribeMachines) unsubscribeMachines(); 
                if (unsubscribeWorkforce) unsubscribeWorkforce(); 
                if (unsubscribeCustomers) unsubscribeCustomers(); 

                auth.signOut().then(() => {
                    DataService.endLocalSession();
                    updateUIOnDataChange();
                    showToast('Signed out from Cloud.', 'info');
                });
            };

            return { signInWithGoogle, signOutUser, setupAuthListeners };

        })();
        
        // --- UI & Rendering Functions (Updated - FIX APPLIED HERE) ---

        const updateUIOnDataChange = () => {
            renderOrderList();
            
            // FIX: If a filter is active, re-run the filter logic to refresh the view correctly.
            const filterActive = $('#filter-name').val() || $('#filter-type').val() || $('#filter-vendor').val();
            if (filterActive) {
                filterInventory(); // Re-runs filter and calls renderInventoryList(filtered)
            } else {
                renderInventoryList(); // Renders the full global 'inventory' array
            }
            
            // Render recommendations and other views
            renderInventoryRecommendations(); 
            renderMachinesList(); 
            renderWorkforceList(); 
            renderCustomersList(); 
            updateHomeSummary();
            updateReportSummary();
            updateHomeAlerts();
        };

        const showCloudSyncModal = () => {
            if (storageMode !== 'cloud' && auth.currentUser === null) {
                const cloudSyncModal = new bootstrap.Modal(document.getElementById('cloudSyncModal'));
                cloudSyncModal.show();
            }
        };

        const hideCloudSyncModal = () => {
             const cloudSyncModalEl = document.getElementById('cloudSyncModal');
             const cloudSyncModal = bootstrap.Modal.getInstance(cloudSyncModalEl);
             if (cloudSyncModal) {
                 cloudSyncModal.hide();
             }
        };

        const showLoadingIndicator = (text = 'Connecting to Firebase...') => {
            $('#loading-text').text(text);
            $('#loading-indicator').removeClass('d-none');
        };

        const hideLoadingIndicator = () => {
            $('#loading-indicator').addClass('d-none');
        };
        
        const updateUIOnModeChange = () => {
            $('#banner-storage-mode').text(storageMode === 'cloud' ? 'Cloud (Firebase)' : 'Local Storage');
            
            if (storageMode === 'local') {
                // Ensure local data is loaded and global arrays are populated
                DataService.getOrders();
                DataService.getInventory();
                DataService.getMachines(); 
                DataService.getWorkforce();
                DataService.getCustomers();
                updateUIOnDataChange();
            }
            
            // Switch to Home tab after mode change
             $('#home-tab').click(); 
        };
        
        // --- Order List Rendering (Unchanged) ---
        const renderOrderList = (filteredData = orders) => {
             // Not implemented in this step, placeholder for consistency
             $('#order-list-ul').html('<li class="list-group-item text-center text-muted-subtle">Orders will load here (rendering logic not fully implemented in this sample).</li>');
        };

        // NEW: Renders previous item names as recommendations
        const renderInventoryRecommendations = () => {
            const datalist = $('#detergent-recommendations');
            datalist.empty();
            // Use a Set to ensure unique names
            const uniqueNames = new Set(inventory.map(item => item.name).filter(n => n));
            uniqueNames.forEach(name => {
                datalist.append(`<option value="${name}">`);
            });
        };

        // --- Inventory List Rendering (MODIFIED) ---
        const renderInventoryList = (filteredData = inventory) => {
            const list = $('#inventory-list');
            const lowStockList = $('#low-stock-list');
            const lowStockAlert = $('#low-stock-alert');
            list.empty();
            lowStockList.empty();
            lowStockAlert.addClass('d-none');
            
            if (filteredData.length === 0) {
                list.append($('<li class="list-group-item text-center text-muted-subtle">No inventory items found.</li>'));
                return;
            }

            let lowStockItems = [];

            filteredData.forEach(item => {
                const qty = item.qty || 0;
                const isLow = qty < LOW_STOCK_THRESHOLD;
                const lowStockClass = isLow ? 'list-group-item-warning' : '';
                const itemType = item.detergentType || item.category || 'N/A';

                if (isLow) {
                    lowStockItems.push(item);
                }

                const listItem = $(`
                    <li class="list-group-item d-flex justify-content-between align-items-center ${lowStockClass} inventory-item-row" data-id="${item.id}" role="button">
                        <div class="d-flex flex-column">
                            <span class="fw-bold">${item.name} <small class="text-muted">(${itemType})</small></span>
                            <small class="d-block text-muted-subtle">Vendor: ${item.vendor || 'N/A'}</small>
                            <small class="d-block text-muted-subtle">Cost/Unit: ₱${formatCurrency(item.cost || 0)}</small>
                        </div>
                        <div class="d-flex align-items-center">
                            <span class="badge ${isLow ? 'bg-danger' : 'bg-primary'} rounded-pill me-3">${qty} Units</span>
                        </div>
                    </li>
                `);
                
                // NEW: Click handler to open the modal
                listItem.on('click', function() {
                    handleInventoryItemClick(item.id);
                });

                list.append(listItem);
            });
            
            // Low Stock Alert Panel Logic
            if (lowStockItems.length > 0) {
                lowStockAlert.removeClass('d-none');
                lowStockItems.forEach(item => {
                    lowStockList.append(`<li>${item.name} (Qty: ${item.qty})</li>`);
                });
            }
        };

        // --- Inventory Modal Handlers (NEW) ---
        const handleInventoryItemClick = (itemId) => {
            const item = inventory.find(i => i.id === itemId);
            if (!item) {
                showToast('Item not found.', 'danger');
                return;
            }

            // Populate Modal Fields
            $('#modal-inventory-id').val(item.id);
            $('#modal-detergent-name').val(item.name);
            $('#modal-detergent-type').val(item.detergentType);
            $('#modal-detergent-vendor').val(item.vendor);
            $('#modal-detergent-qty').val(item.qty);
            $('#modal-detergent-cost').val(item.cost);

            // Show Modal
            const modal = new bootstrap.Modal(document.getElementById('inventoryDetailModal'));
            modal.show();
        };

        const handleInventoryUpdate = function(e) {
            e.preventDefault();
            const itemId = $('#modal-inventory-id').val();
            showLoadingIndicator('Updating inventory item...');

            const updatedItem = {
                id: itemId,
                category: 'Detergent',
                name: $('#modal-detergent-name').val(),
                detergentType: $('#modal-detergent-type').val(),
                qty: parseInt($('#modal-detergent-qty').val() || 0),
                cost: parseFloat($('#modal-detergent-cost').val() || 0),
                vendor: $('#modal-detergent-vendor').val(),
            };

            DataService.saveInventoryItem(updatedItem) // saveInventoryItem handles update via ID
                .then(() => {
                    hideLoadingIndicator();
                    showToast(`${updatedItem.name} updated successfully!`, 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('inventoryDetailModal'));
                    if (modal) modal.hide();
                    
                    if (storageMode === 'local') {
                        updateUIOnDataChange(); // This call now correctly handles filter refreshing
                    }
                })
                .catch(error => {
                    hideLoadingIndicator();
                    console.error("Error updating inventory:", error);
                    showToast('Error updating inventory. Check console.', 'danger');
                });
        };
        
        const handleInventoryDelete = function() {
            if (!confirm('Are you sure you want to permanently delete this inventory item?')) {
                return;
            }
            const itemId = $('#modal-inventory-id').val();
            showLoadingIndicator('Deleting inventory item...');

            DataService.deleteInventoryItem(itemId)
                .then(() => {
                    hideLoadingIndicator();
                    showToast('Inventory item deleted.', 'danger');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('inventoryDetailModal'));
                    if (modal) modal.hide();
                    
                    if (storageMode === 'local') {
                        updateUIOnDataChange(); // This call now correctly handles filter refreshing
                    }
                })
                .catch(error => {
                    hideLoadingIndicator();
                    console.error("Error deleting inventory:", error);
                    showToast('Error deleting inventory. Check console.', 'danger');
                });
        };
        
        // --- NEW: Inventory Filtering Logic ---
        const filterInventory = () => {
            const filterName = $('#filter-name').val().toLowerCase();
            const filterType = $('#filter-type').val();
            const filterVendor = $('#filter-vendor').val().toLowerCase();

            const filtered = inventory.filter(item => {
                const itemName = item.name.toLowerCase();
                const itemType = item.detergentType || item.category;
                const itemVendor = item.vendor ? item.vendor.toLowerCase() : '';

                // Filter by Name/Category
                const nameMatch = itemName.includes(filterName) || (itemType ? itemType.toLowerCase().includes(filterName) : false);

                // Filter by Type (Detergent Type or General Item category)
                let typeMatch = true;
                if (filterType === 'Detergent') {
                     // Check if it's any specific detergent type
                    typeMatch = itemType && ['Liquid', 'Powder', 'Pods', 'Softener', 'Special'].includes(itemType);
                } else if (filterType) {
                    typeMatch = itemType === filterType;
                }
                
                // Filter by Vendor
                const vendorMatch = itemVendor.includes(filterVendor);

                return nameMatch && typeMatch && vendorMatch;
            });

            renderInventoryList(filtered);
        };
        
        // --- Inventory Item Creation Handlers (FIXED) ---
        
        const handleDetergentFormSubmit = function(e) {
             e.preventDefault();
                showLoadingIndicator('Saving detergent stock...');
                
                const newDetergent = {
                    category: 'Detergent', // New field to categorize
                    name: $('#detergent-name').val(),
                    detergentType: $('#detergent-type').val(), // Specific Type
                    qty: parseInt($('#detergent-qty').val() || 0),
                    cost: parseFloat($('#detergent-cost').val() || 0),
                    vendor: $('#detergent-vendor').val(),
                    timestamp: new Date().toISOString()
                };

                DataService.saveInventoryItem(newDetergent)
                    .then(() => {
                        hideLoadingIndicator();
                        showToast('Detergent stock saved successfully!', 'success');
                        $('#detergent-form')[0].reset();
                        $('#detergent-form').find('#detergent-qty').val('1');
                        $('#detergent-form').find('#detergent-cost').val('0.00');
                        
                        // FIX: Explicitly refresh the UI in local storage mode
                        if (storageMode === 'local') {
                            updateUIOnDataChange(); // This triggers renderInventoryList() and renderInventoryRecommendations()
                        }
                    })
                    .catch(error => {
                        hideLoadingIndicator();
                        console.error("Error saving detergent:", error);
                        showToast('Error saving detergent. Check console.', 'danger');
                    });
        };
        
        // --- Other List Rendering Functions (Stubs for brevity) ---
        const renderMachinesList = () => { 
             $('#machines-list').html('<li class="list-group-item text-center text-muted-subtle">Machines will load here (logic stubbed).</li>');
        };
        const renderWorkforceList = () => { 
             $('#workforce-list').html('<li class="list-group-item text-center text-muted-subtle">Workforce will load here (logic stubbed).</li>');
        };
        const renderCustomersList = () => { 
             $('#customers-list').html('<li class="list-group-item text-center text-muted-subtle">Customers will load here (logic stubbed).</li>');
        };


        // --- FORM SETUP FUNCTIONS (Updated) ---

        const setupForms = () => {
            // New Order Form Submission (Unchanged)
            $('#order-form').on('submit', function(e) { e.preventDefault(); showToast('Order saved (logic stubbed).', 'success'); });

            // Inventory Forms Submission (MODIFIED - Only Detergent remains)
            $('#detergent-form').on('submit', handleDetergentFormSubmit);

            // NEW: Inventory Update Form (Modal)
            $('#inventory-update-form').on('submit', handleInventoryUpdate);
            $('#delete-inventory-modal-btn').on('click', handleInventoryDelete); // Attached Delete handler
            
            // Inventory Filter Form Submission (NEW)
            $('#inventory-filter-form').on('submit', function(e) {
                e.preventDefault();
                filterInventory();
                showToast('Inventory filtered.', 'info');
            });
            
            $('#clear-inventory-filter-btn').on('click', function() {
                 $('#inventory-filter-form')[0].reset();
                 renderInventoryList(inventory);
                 showToast('Inventory filter cleared.', 'info');
            });
            
            // NEW: Machine Form Submission
            $('#machine-form').on('submit', function(e) { e.preventDefault(); showToast('Machine saved (logic stubbed).', 'success'); });

            // NEW: Workforce Form Submission
            $('#workforce-form').on('submit', function(e) { e.preventDefault(); showToast('Employee saved (logic stubbed).', 'success'); });

            // NEW: Customer Form Submission
            $('#customer-form').on('submit', function(e) { e.preventDefault(); showToast('Customer registered (logic stubbed).', 'success'); });
        };

        // --- AUTHENTICATION & INITIALIZATION ---
        
        const setupAuthListeners = () => {
            // Google Sign-In button in modal
            $('#google-sign-in-btn').on('click', FirebaseImpl.signInWithGoogle);

            // Guest Mode button in modal
            $('#guest-mode-btn').on('click', () => {
                hideCloudSyncModal();
                DataService.resetToLocalMode(); 
                updateUIOnModeChange();
                showToast('Continuing in Guest Mode. Data is only saved locally.', 'info');
            });
            
            // Log Out button on the Home Dashboard
            $('#home-log-out-btn').on('click', function() {
                if (storageMode === 'local') {
                    DataService.endLocalSession();
                    updateUIOnDataChange();
                    showCloudSyncModal();
                    showToast('Local session ended. Please choose a new mode.', 'info');
                } else {
                    FirebaseImpl.signOutUser(); 
                }
            });

            // Firebase Auth State Listener (main app controller)
            FirebaseImpl.setupAuthListeners();
        };

        
        // --- Document Ready ---
        $(function() {
            // Initialize event listeners for all parts of the application
            setupForms();
            setupAuthListeners();
            // Set today's date as default for pickup and customer registration
            const today = new Date().toISOString().split('T')[0];
            $('#pickup-date').val(today);
            $('#customer-reg-date').val(today);
            
            const hasLocalData = localStorage.getItem(DataService.LOCAL_STORAGE_KEY_ORDERS);
            
            if (hasLocalData) {
                 DataService.resetToLocalMode();
                 updateUIOnModeChange();
            } else {
                showLoadingIndicator();
            }
            
            // Setup event handlers for the Home Dashboard buttons
            $('#home-buttons-dashboard').on('click', '.home-nav-btn', function() {
                const targetTabId = $(this).data('target-tab');
                $(`${targetTabId}-tab`).click();
            });
            
            // NEW: Back to Dashboard Button handler
            $('.back-to-dashboard-btn').on('click', function() {
                $('#home-tab').click();
            });
            
            // Change the chevron icon when filter collapses
            $('#inventoryFilterCollapse').on('show.bs.collapse', function () {
                // When showing (expanded), change icon to fa-chevron-down
                $(this).prev().find('.fa-chevron-up').removeClass('fa-chevron-up').addClass('fa-chevron-down');
            }).on('hide.bs.collapse', function () {
                // When hiding (collapsed), change icon to fa-chevron-up
                $(this).prev().find('.fa-chevron-down').removeClass('fa-chevron-down').addClass('fa-chevron-up');
            });
            
            $('#myTab button').on('click', function (event) {
                event.preventDefault();
                const targetId = $(this).data('bs-target');
                const targetTab = new bootstrap.Tab(this);
                targetTab.show();
                
                // Hide the back-to-dashboard button on the Home tab
                if ($(this).attr('id') === 'home-tab') {
                    $('.back-to-dashboard-btn').hide();
                } else {
                    $('.back-to-dashboard-btn').show();
                }

                // If on Home tab, trigger a dashboard update (stub)
                if (targetId === '#home') {
                    updateHomeSummary();
                    updateHomeAlerts();
                }
                
                // If on Reports tab, trigger a report update (stub)
                 if (targetId === '#reports') {
                    updateReportSummary();
                }
            });
            
            // Auto-trigger home-tab on load
            const initialTab = new bootstrap.Tab(document.getElementById('home-tab'));
            initialTab.show();
            
            // Modal close button handler
            $('.close-modal-btn').on('click', function() {
                 $('.modal').modal('hide');
            });
            
            // Show cloud sync modal if no mode is set (stub)
            if (!localStorage.getItem('dbMode')) {
                $('#cloudSyncModal').modal('show');
            } else {
                // If a mode is already set, initialize the system
                if (localStorage.getItem('dbMode') === 'local') {
                    initializeLocalDB();
                    $('#banner-storage-mode').text('Local (Offline)');
                    $('#banner-storage-mode-hidden').text('Local (Offline)');
                } else {
                    initializeFirebase();
                    $('#banner-storage-mode').text('Cloud (Google/Firebase)');
                    $('#banner-storage-mode-hidden').text('Cloud (Google/Firebase)');
                }
                showLoadingIndicator();
            }
            
            // Setup event handlers for the Home Dashboard buttons
            $('#home-buttons-dashboard').on('click', '.home-nav-btn', function() {
                const targetTabId = $(this).data('target-tab');
                $(`${targetTabId}-tab`).click();
            });
            
            // NEW: Back to Dashboard Button handler
            $('.back-to-dashboard-btn').on('click', function() {
                $('#home-tab').click();
            });
            
            // Change the chevron icon when filter collapses
            $('#inventoryFilterCollapse').on('show.bs.collapse', function () {
                // When showing (expanded), change icon to fa-chevron-down
                $(this).prev().find('.fa-chevron-up').removeClass('fa-chevron-up').addClass('fa-chevron-down');
            }).on('hide.bs.collapse', function () {
                // When hiding (collapsed), change icon to fa-chevron-up
                $(this).prev().find('.fa-chevron-down').removeClass('fa-chevron-down').addClass('fa-chevron-up');
            });
        });
        
        // --- HOME TAB FUNCTIONS (Modified) ---
        const updateHomeSummary = () => {
            // This function remains largely the same but relies on the hidden divs for data.
            // ... (Home Summary logic remains the same)
            const now = new Date();
            const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfYear = new Date(now.getFullYear(), 0, 1);

            let weekStats = { cost: 0, revenue: 0, weight: 0 };
            let monthStats = { cost: 0, revenue: 0, weight: 0 };
            let yearStats = { cost: 0, revenue: 0, weight: 0 };

            orders.forEach(order => {
                const date = new Date(order.pickupDate);
                const baseCost = parseFloat(order.baseCost || 0);
                const additionalCost = parseFloat(order.additionalCost || 0); // Assuming actualCostVariance is used for additional cost
                const totalCost = baseCost + additionalCost;
                const totalPrice = parseFloat(order.totalPrice || 0);
                const weightKg = parseFloat(order.weightKg || 0);

                if (date >= startOfWeek) {
                    weekStats.cost += totalCost;
                    weekStats.revenue += totalPrice;
                    weekStats.weight += weightKg;
                }
                if (date >= startOfMonth) {
                    monthStats.cost += totalCost;
                    monthStats.revenue += totalPrice;
                    monthStats.weight += weightKg;
                }
                if (date >= startOfYear) {
                    yearStats.cost += totalCost;
                    yearStats.revenue += totalPrice;
                    yearStats.weight += weightKg;
                }
            });

            // Update Week
            $('#home-week-cost').text(formatCurrency(weekStats.cost));
            $('#home-week-revenue').text(formatCurrency(weekStats.revenue));
            $('#home-week-weight').text(weekStats.weight.toFixed(1) + ' kg');
            
            // Update Month
            $('#home-month-cost').text(formatCurrency(monthStats.cost));
            $('#home-month-revenue').text(formatCurrency(monthStats.revenue));
            $('#home-month-weight').text(monthStats.weight.toFixed(1) + ' kg');

            // Update Year
            $('#home-year-cost').text(formatCurrency(yearStats.cost));
            $('#home-year-revenue').text(formatCurrency(yearStats.revenue));
            $('#home-year-weight').text(yearStats.weight.toFixed(1) + ' kg');

            // Update Ready for Pickup list
            const readyOrders = orders.filter(o => o.status === 'Ready')
                                     .sort((a, b) => new Date(a.pickupDate) - new Date(b.pickupDate))
                                     .slice(0, 10);
            const readyList = $('#ready-orders-list');
            readyList.empty();

            if (readyOrders.length === 0) {
                readyList.append($('<li class="list-group-item text-center text-muted-subtle">No orders ready for pickup.</li>'));
            } else {
                readyOrders.forEach(order => {
                    const listItem = $(`<li class="list-group-item d-flex justify-content-between align-items-center" data-id="${order.id}">
                        <div>
                            <span class="fw-bold">${order.customerName} (${order.serviceType})</span>
                            <small class="d-block text-muted-subtle">${new Date(order.pickupDate).toLocaleDateString()} @ ${order.pickupTime}</small>
                        </div>
                        <span class="badge bg-primary rounded-pill">${order.weightKg} kg</span>
                    </li>`);
                    listItem.on('click', () => showEditOrderModal(order));
                    readyList.append(listItem);
                });
            }
        };
    
        // NEW: Inventory Alerts for Home Tab
        const updateHomeAlerts = () => {
            const LOW_STOCK_THRESHOLD = 10; // Define a threshold for low stock
            const lowStockItems = inventory.filter(i => i.qty <= LOW_STOCK_THRESHOLD);
            const alertList = $('#inventory-alerts-list');
            alertList.empty();

            if (lowStockItems.length === 0) {
                alertList.append($('<li class="list-group-item text-center text-muted-subtle">No low stock alerts.</li>'));
            } else {
                lowStockItems.forEach(item => {
                    const listItem = $(`<li class="list-group-item list-group-item-warning d-flex justify-content-between align-items-center" data-id="${item.id}">
                        <div>
                            <span class="fw-bold text-danger">${item.name} (${item.type})</span>
                            <small class="d-block text-muted-subtle">Vendor: ${item.vendor}</small>
                        </div>
                        <span class="badge bg-danger rounded-pill">Qty: ${item.qty}</span>
                    </li>`);
                    listItem.on('click', () => showEditInventoryModal(item));
                    alertList.append(listItem);
                });
            }
        };

        const updateReportSummary = () => {
            // ... (Reporting logic remains the same)
             let totalOrders = orders.length;
            let totalBaseCost = 0;
            let totalAdditionalCost = 0;
            let totalClientPayment = 0; // totalPrice
            let totalWeightKg = 0;
            let remainingOrders = 0;
            let totalDetergentUnits = 0;

            orders.forEach(order => {
                const baseCost = parseFloat(order.baseCost || 0);
                const additionalCost = parseFloat(order.additionalCost || 0);
                const totalPrice = parseFloat(order.totalPrice || 0);
                const weightKg = parseFloat(order.weightKg || 0);
                const detergentUsed = parseFloat(order.detergentUsed || 0);

                totalBaseCost += baseCost;
                totalAdditionalCost += additionalCost;
                totalClientPayment += totalPrice;
                totalWeightKg += weightKg;
                totalDetergentUnits += detergentUsed;

                if (order.status !== 'Picked Up' && order.status !== 'Cancelled') {
                    remainingOrders++;
                }
            });
            
            // Calculate total detergent cost by estimating based on a blended average cost or simple sum 
            // For a more accurate calculation, we would need to look up the cost of the detergent used, 
            // but for simplicity, we'll use a placeholder logic:
            const blendedDetergentCost = inventory.reduce((sum, item) => sum + (item.cost * item.qty), 0) / (inventory.length || 1);
            
            // This is a rough estimate for reporting:
            const totalDetergentCost = totalDetergentUnits * blendedDetergentCost; 
            
            const grandTotalExpense = totalBaseCost + totalAdditionalCost + totalDetergentCost;
            const netRevenue = totalClientPayment - grandTotalExpense;
            const revenuePerKg = totalWeightKg > 0 ? totalClientPayment / totalWeightKg : 0;
            
            // Update UI elements
            $('#total-orders').text(totalOrders);
            $('#total-cost-est').text(formatCurrency(totalBaseCost));
            $('#total-additional-cost').text(formatCurrency(totalAdditionalCost));
            $('#total-client-payment').text(formatCurrency(totalClientPayment));
            $('#total-net-revenue').text(formatCurrency(netRevenue));
            $('#total-weight-kg').text(totalWeightKg.toFixed(1) + ' kg');
            $('#revenue-per-kg').text(formatCurrency(revenuePerKg));
            $('#remaining-orders').text(remainingOrders);
            
            // Using total-detergent-cost instead of total-proc-cost for laundry
            $('#total-detergent-cost').text(formatCurrency(totalDetergentCost));
            $('#grand-total-cost').text(formatCurrency(grandTotalExpense));
        };
    </script>
</body>
</html>