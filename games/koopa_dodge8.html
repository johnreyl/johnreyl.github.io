<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koopa Fireball Dodge (MP3 Fallback & Flip & Quad Controls)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <style>
        /* 1. Global & Font Setup (Full Viewport Size) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden; 
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #2d3748; 
            display: flex; 
            flex-direction: column;
        }

        /* 2. Responsive Font Adjustments & Scoreboard Styling */
        #scoreboard {
            width: 100%;
            height: 40px; 
            margin: 0;
            display: flex;
            justify-content: space-between;
            align-items: center; 
            background-color: #2d3748; 
            color: white;
            padding: 0 12px;
            border-radius: 0; 
            font-weight: bold;
            flex-shrink: 0;
            font-size: 1rem;
        }
        @media (max-width: 640px) {
            #scoreboard {
                font-size: 0.875rem; 
            }
            #game-over-message {
                font-size: 2rem !important;
            }
        }
        #current-score { color: #f9d71c; margin: 0 10px; }
        #top-score { color: #ed8936; }
        #triple-jump-cooldown { 
            font-size: 0.9rem;
            min-width: 110px;
            text-align: right;
            padding-right: 5px;
        }

        /* Heart SVG Styling */
        #lives-display { display: flex; align-items: center; gap: 2px; }
        .heart-icon { width: 16px; height: 16px; fill: #E53E3E; stroke: #A03232; }
        .empty-heart { fill: none; stroke: #A03232; }

        /* Fullscreen Button Styling */
        #fullscreen-btn {
            cursor: pointer;
            margin-left: 10px;
            opacity: 0.8;
            transition: opacity 0.1s;
        }
        #fullscreen-btn:hover { opacity: 1; }

        /* 3. Game Container Styling */
        #game-container {
            width: 100%; 
            height: calc(100vh - 40px); 
            max-width: none;
            position: relative;
            overflow: hidden;
            margin: 0;
            background-color: #79a1d1; 
            border: none; 
            border-radius: 0;
            box-shadow: none; 
            cursor: pointer; 
            transition: transform 0.5s ease; 
            flex-grow: 1;
        }

        /* Wiggle Animation for Game Over AND Speed Reset */
        @keyframes wiggle {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            25% { transform: translateX(-4px) rotate(-0.5deg); }
            75% { transform: translateX(4px) rotate(0.5deg); }
        }
        .wiggle { animation: wiggle 0.1s ease-in-out 5; }
        .wiggle-short { animation: wiggle 0.3s ease-in-out 1; }
        
        /* Ground with Parallax Adjustment */
        #game-ground {
            position: absolute;
            bottom: 0;
            left: 0; 
            height: 35px;
            background-color: #38703a; 
            z-index: 5;
            transition: left 0.1s linear; 
            background-image: repeating-linear-gradient(
                45deg,
                #38703a,
                #38703a 10px,
                #346836 10px,
                #346836 20px
            );
        }

        /* Platform Base Styling (JS will create and position) */
        .game-platform {
            position: absolute;
            background-color: #f6ad55; 
            z-index: 9; 
            border-radius: 2px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }


        /* Character Base Styling (Koopa) */
        .character {
            position: absolute;
            bottom: 35px;
            z-index: 10;
            width: 55px;
            height: 55px;
            /* Added transition for smooth movement and flip */
            transition: transform 0.2s ease-out, left 0.1s linear; 
        }

        /* Koopa Flip State */
        .koopa-flip {
            transform: scaleX(-1);
        }

        #koopa {
            transition: left 0.1s linear; 
        }

        /* Visual cue for invincibility (after being hit) */
        .koopa-invincible {
            opacity: 0.6;
            animation: blink-koopa 0.1s infinite alternate;
        }
        @keyframes blink-koopa {
            0% { opacity: 1; }
            100% { opacity: 0.3; }
        }

        /* Fireball Rotation Animation */
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Fireball Styling */
        .fireball {
            position: absolute;
            z-index: 8;
            transition: opacity 0.2s;
        }
        
        .fireball svg {
            width: 100%;
            height: 100%;
            animation: rotate 1s linear infinite; 
        }
        /* Overlay and Button styles */
        #game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 20;
            color: white; text-align: center;
        }
        #play-button {
            background-color: #ed8936; padding: 12px 24px; border-radius: 8px;
            font-weight: bold; font-size: 1.25rem; cursor: pointer;
            box-shadow: 0 4px 0 #c06c1c; transition: all 0.1s ease-in-out;
        }
        #play-button:hover { background-color: #f6ad55; }
        #play-button:active { box-shadow: 0 1px 0 #c06c1c; transform: translateY(3px); }
        #game-over-message { font-size: 2.5rem; font-weight: 900; color: #ff0000; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); margin-bottom: 20px; }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-charcoal': '#2d3748',
                        'brand-orange': '#ed8936',
                        'text-gray': '#4a5568',
                    }
                }
            }
        }

        // =======================================================================
        // TONE.JS SOUND CONFIGURATION (Synth Fallback) 
        // =======================================================================
        const SOUND_CONFIG = {
            // Koopa: Lose life (high-pitch, descending)
            koopaDamage: { type: 'synth', notes: ['C5', 'G4'], duration: 0.15 }, 
            
            // Fireball: Normal ground bounce
            fireballBounceGround: { type: 'membrane', notes: ['A2'], duration: 0.05, velocity: 0.6 },
            
            // Fireball: Boost reset (stronger, low pitch, indicates speed loss)
            fireballBoostReset: { type: 'membrane', notes: ['D1', 'C1'], duration: 0.2, velocity: 0.9 }, 
            
            // Fireball: Platform collision (high-pitch, metallic for speed gain)
            fireballPlatformBounce: { type: 'synth', notes: ['E6', 'G6'], duration: 0.08, wave: 'square' }, 
            
            // UI: Click (simple blip)
            uiClick: { type: 'synth', notes: ['C6'], duration: 0.05 },
            
            // Game Over: Dramatic low tone
            gameOver: { type: 'synth', notes: ['A1', 'F#1'], duration: 1.0 }, 
            
            // Max Score: Ascending victory chime
            maxScore: { type: 'synth', notes: ['C6', 'E6', 'G6', 'C7'], duration: 0.5 },
            
            // Background Music (C major arpeggio loop)
            backgroundMusic: { notes: ['C4', 'E4', 'G4', 'C5'], tempo: '4n' }
        };
        // =======================================================================
        
        // =======================================================================
        // LOCAL MP3 SOUND CONFIGURATION (Priority Over Tone.js)
        // IMPORTANT: These files must exist in your 'audio/' directory!
        // =======================================================================
        const LOCAL_SOUND_CONFIG = {
            koopaDamage: 'audio/koopa_damage.mp3',
            fireballBounceGround: 'audio/fireball_bounce.mp3',
            fireballBoostReset: 'audio/boost_reset.mp3',
            fireballPlatformBounce: 'audio/platform_bounce.mp3',
            uiClick: 'audio/koopa_damage.mp3',
            gameOver: 'audio/game_over.mp3',
            maxScore: 'audio/koopa_damage.mp3',
            backgroundMusic: 'audio/background_music.mp3' 
        };
        // =======================================================================
        

        $(document).ready(function() {
            // --- Tone.js Setup Variables ---
            let audioContextInitialized = false;
            let mainSynth = null;
            let membraneSynth = null;
            let backgroundLoop = null; // Tone.Loop for synth fallback
            let backgroundPlayer = null; // Tone.Player for MP3 music
            
            // New variables for MP3 fallback
            let soundPlayers = {}; 
            let mp3LoadingFailed = {}; // Tracks which MP3s failed to load

            // --- Elements ---
            const $gameContainer = $('#game-container');
            const $koopa = $('#koopa');
            const $gameGround = $('#game-ground');
            const $overlay = $('#game-overlay');
            const $playButton = $('#play-button');
            const $fireballSelect = $('#fireball-select'); 
            const $difficultySelect = $('#difficulty-select'); 
            const $gameOverMessage = $('#game-over-message');
            const $currentScoreDisplay = $('#current-score');
            const $topScoreDisplay = $('#top-score');
            const $fireballTemplate = $('#fireball-template');
            const $fullscreenBtn = $('#fullscreen-btn');
            const $tripleJumpDisplay = $('#triple-jump-cooldown'); 
            const $platformWarning = $('#platform-warning'); 

            // --- Constants ---
            const GROUND_HEIGHT = 35;
            const PLAYER_WIDTH = 55;
            const PLAYER_HEIGHT = 55;
            const FIREBALL_SIZE = 15;
            const JUMP_BASE_HEIGHT = 70; 
            const JUMP_DURATION_UP = 200; 
            const JUMP_DURATION_DOWN = 600; 
            const MOVE_STEP = 20;
            const PARALLAX_STEP = 5; 
            const GROUND_EXTRA_WIDTH = 100; 
            const FIREBALL_BASE_SPEED = 5;
            const SPEED_INCREASE_FACTOR = 0.5;
            const COLLISION_BUFFER = 5; 
            const MIN_START_DISTANCE = 100;
            const STORAGE_KEY = 'koopaDodgeTopScore';
            const MAX_JUMPS = 3; 
            const TRIPLE_JUMP_COOLDOWN_MS = 40000; 
            const MAX_JUMP_RATIO = 0.75; 

            // Platform Constants
            const PLATFORM_WIDTH = 200; 
            const PLATFORM_HEIGHT = 5;
            const PLATFORM_SPEED = 3; 
            const PLATFORM_SPEED_MULTIPLIER = 3; 
            const PLATFORM_TOP_MARGIN = 50; 
            const PLATFORM_VERTICAL_SPACING = 50; 
            const WIGGLE_DURATION_MS = 300; 

            // Life System Constants
            const MAX_LIVES = 5;
            const INITIAL_LIVES = 3;
            const HEAL_INTERVAL_MS = 60000; 
            const DAMAGE_COOLDOWN_MS = 1000; 
            
            // Timers
            const INITIAL_FIREBALL_DELAY = 3000; 
            const SPEED_INTERVAL_MS = 60000; 
            const DUPLICATION_INTERVAL_MS = 20000; 
            const DUPLICATION_DELAY_MS = 2000; 
            let tjCooldownTimer = null; 

            // Fireball Configuration Constants
            const MIN_FIREBALLS = 1;
            const MAX_FIREBALLS = 25;


            // --- State Management ---
            let isPlaying = false;
            let jumpsCompleted = 0; 
            let lastTripleJumpTime = 0; 
            let lastDamageTime = 0;
            let gameLoopInterval = null;
            let scoreInterval = null;
            let speedUpInterval = null;
            let duplicationInterval = null;
            let healInterval = null;
            let currentScore = 0;
            let currentSpeed = FIREBALL_BASE_SPEED; 
            let koopaLives = INITIAL_LIVES;
            let currentDifficulty = 'medium'; 
            let topScoreAchievedDuringGame = false; // Flag to play sound only once

            // Position tracking
            let koopaX = 0; 
            let groundOffsetX = 0; 
            let currentFlipState = 0; // 0 = facing right (default), 1 = facing left (flipped) 

            // Platform state (Array of platform objects)
            let platforms = []; 

            // Dimension tracking
            let gameContainerWidth = 0;
            let gameContainerHeight = 0;
            let groundMaxMovement = 0; 

            // Fireball state
            let fireballs = []; 

            // --- Tone.js Audio Functions ---
            
            // Fallback: Plays the Tone.js sound from SOUND_CONFIG
            function playToneSound(soundName) {
                if (!audioContextInitialized || !SOUND_CONFIG[soundName]) return;
                
                const config = SOUND_CONFIG[soundName];
                const now = Tone.now();
                
                const notes = Array.isArray(config.notes) ? config.notes : [config.notes];

                if (config.type === 'synth' && mainSynth) {
                    mainSynth.triggerAttackRelease(notes, config.duration || '8n', now, config.velocity || 0.5);
                } else if (config.type === 'membrane' && membraneSynth) {
                    notes.forEach((note, index) => {
                        membraneSynth.triggerAttackRelease(note, config.duration || '8n', now + (index * 0.01), config.velocity || 0.8);
                    });
                }
            }

            // Priority Play: Tries MP3 first, falls back to Tone.js
            function playSound(soundName) {
                if (!audioContextInitialized) return;

                // Check if MP3 failed loading previously
                if (mp3LoadingFailed[soundName]) {
                    playToneSound(soundName);
                    return;
                }

                const player = soundPlayers[soundName];
                
                if (player && player.loaded) {
                    // MP3 is loaded, play it
                    player.start();
                } else {
                    // MP3 not loaded or not in config, use Tone.js fallback
                    playToneSound(soundName);
                }
            }

            // Must be called on the first user interaction
            function initializeAudioContext() {
                if (audioContextInitialized) return;
                
                // Initialize Tone.js context and synths
                Tone.start().then(() => {
                    mainSynth = new Tone.PolySynth(Tone.Synth, {
                        oscillator: { type: "triangle" },
                        envelope: { attack: 0.005, decay: 0.1, sustain: 0.05, release: 0.1 }
                    }).toDestination();
                    
                    membraneSynth = new Tone.MembraneSynth({
                        pitchDecay: 0.02,
                        octaves: 2,
                        envelope: { attack: 0.001, decay: 0.4, sustain: 0.01, release: 0.1, attackCurve: "exponential" }
                    }).toDestination();

                    Tone.Transport.bpm.value = 120; // Set base tempo
                    
                    // 1. Setup Tone.js Background Music Loop (Fallback)
                    const musicConfig = SOUND_CONFIG.backgroundMusic;
                    let noteIndex = 0;
                    backgroundLoop = new Tone.Loop(time => {
                        const note = musicConfig.notes[noteIndex % musicConfig.notes.length];
                        mainSynth.triggerAttackRelease(note, "8n", time, 0.5);
                        noteIndex++;
                    }, musicConfig.tempo); // Do NOT start loop here

                    // 2. Setup Tone.js Players for One-Shot MP3s (and handle errors)
                    for (const soundName in LOCAL_SOUND_CONFIG) {
                        const filePath = LOCAL_SOUND_CONFIG[soundName];
                        if (soundName !== 'backgroundMusic') {
                            // Create a player for each sound
                            const player = new Tone.Player(filePath, () => {
                                // On load success
                                player.toDestination();
                            });
                            
                            // Set up error handling to track failed loads
                            player.onerror = () => {
                                console.warn(`Failed to load MP3 for ${soundName}: ${filePath}. Falling back to Tone.js.`);
                                mp3LoadingFailed[soundName] = true;
                            };
                            soundPlayers[soundName] = player.toDestination(); // Route player to output
                        }
                    }
                    
                    // 3. Setup Tone.js Player for Background Music MP3 (Looping)
                    const musicPath = LOCAL_SOUND_CONFIG.backgroundMusic;
                    if (musicPath) {
                        backgroundPlayer = new Tone.Player({
                            url: musicPath,
                            loop: true,
                            volume: -6 // Lower volume for background music
                        }, () => {
                            // On load success
                        }).toDestination();

                        // Set up error handling for music track
                        backgroundPlayer.onerror = () => {
                            console.warn(`Failed to load MP3 for backgroundMusic: ${musicPath}. Falling back to Tone.js loop.`);
                            mp3LoadingFailed.backgroundMusic = true;
                        };
                    }

                    audioContextInitialized = true;
                });
            }
            
            function startBackgroundMusic() {
                if (!audioContextInitialized) return;
            
                Tone.Transport.start();

                // Check if MP3 exists and loaded, and hasn't failed
                if (backgroundPlayer && backgroundPlayer.loaded && !mp3LoadingFailed.backgroundMusic) {
                    backgroundPlayer.start();
                } else if (backgroundLoop) {
                    backgroundLoop.start(0);
                }
            }

            function stopBackgroundMusic() {
                if (backgroundPlayer) {
                    backgroundPlayer.stop();
                }
                if (backgroundLoop) {
                    backgroundLoop.stop();
                }
                Tone.Transport.stop();
            }

            // --- Fireball Class (To manage multiple instances) ---
            class Fireball {
                constructor(x, y, vx, vy, startTime) {
                    this.x = x;
                    this.y = y;
                    this.vx = vx;
                    this.vy = vy;
                    this.startTime = startTime;
                    this.element = this.createElement();
                    this.isMoving = false;
                    this.isBoosted = false;
                    this.baseSpeed = Math.sqrt(vx * vx + vy * vy); 
                }

                createElement() {
                    const $el = $fireballTemplate.clone().removeAttr('id').removeClass('hidden').addClass('fireball');
                    $el.find('svg').css({ width: FIREBALL_SIZE + 'px', height: FIREBALL_SIZE + 'px' });
                    $el.appendTo($gameContainer);
                    return $el;
                }

                updateDOM() {
                    const now = Date.now();
                    if (now >= this.startTime) {
                        this.isMoving = true;
                        this.element.css({ opacity: 1 });
                    } else {
                        this.element.css({ opacity: 0.3 }); 
                    }

                    this.element.css({
                        left: this.x + 'px',
                        bottom: this.y + 'px',
                        width: FIREBALL_SIZE + 'px',
                        height: FIREBALL_SIZE + 'px',
                    });
                }

                destroy() {
                    this.element.remove();
                }

                updateVelocityMagnitude(newSpeed) {
                    const currentMagnitude = Math.sqrt(this.vx * this.vx + this.vy * this.vy);
                    if (currentMagnitude > 0) {
                        const ratio = newSpeed / currentMagnitude;
                        this.vx *= ratio;
                        this.vy *= ratio;
                    } else {
                        this.vx = newSpeed * (Math.random() < 0.5 ? 1 : -1);
                        this.vy = newSpeed * (Math.random() < 0.5 ? 1 : -1);
                    }
                }
            }
            
            // --- Utilities & Display ---

            function loadTopScore() {
                const storedScore = localStorage.getItem(STORAGE_KEY);
                return storedScore ? parseFloat(storedScore) : 0.00;
            }

            function updateTopScore(newScore) {
                const currentTopScore = loadTopScore();
                
                // Check if a new top score is achieved
                if (newScore > currentTopScore) {
                    localStorage.setItem(STORAGE_KEY, newScore.toFixed(2));
                    $topScoreDisplay.text('Top: ' + newScore.toFixed(2) + 's');
                    
                    // Play max score sound if this is the first time we've surpassed the old high score this round
                    if (!topScoreAchievedDuringGame) {
                        playSound('maxScore');
                        topScoreAchievedDuringGame = true;
                    }
                }
            }

            function updateTripleJumpDisplay() {
                const now = Date.now();
                const elapsed = now - lastTripleJumpTime;
                const remainingTime = Math.max(0, TRIPLE_JUMP_COOLDOWN_MS - elapsed);
                
                if (remainingTime > 0) {
                    const seconds = (remainingTime / 1000).toFixed(1);
                    $tripleJumpDisplay.text(`TJ Cooldown: ${seconds}s`).removeClass('text-yellow-400').addClass('text-red-400');
                    if (!tjCooldownTimer) {
                        tjCooldownTimer = setInterval(updateTripleJumpDisplay, 100);
                    }
                } else {
                    $tripleJumpDisplay.text(`TJ Ready!`).removeClass('text-red-400').addClass('text-yellow-400');
                    if (tjCooldownTimer) {
                        clearInterval(tjCooldownTimer);
                        tjCooldownTimer = null;
                    }
                }
            }
            
            function populateFireballDropdown() {
                let optionsHtml = '';
                for (let i = MIN_FIREBALLS; i <= MAX_FIREBALLS; i++) {
                    optionsHtml += `<option value="${i}">${i}</option>`;
                }
                $fireballSelect.html(optionsHtml);
                
                // Set a sensible default (e.g., 5)
                $fireballSelect.val(5); 
            }

            function updatePlatformWarning(difficulty) { 
                let message = '';
                let className = '';
                if (difficulty === 'easy') {
                    message = 'EASY: No platforms.';
                    className = 'text-green-300';
                } else if (difficulty === 'medium') {
                    message = 'MEDIUM: 1 moving platform near the top (50px margin).';
                    className = 'text-yellow-300';
                } else if (difficulty === 'hard') {
                    message = 'HARD: 3 randomly moving platforms stacked from the top!';
                    className = 'text-red-300';
                }
                $platformWarning.text(message).removeClass().addClass('mt-2 text-sm font-semibold ' + className);
            }


            // --- Score Logic ---
            function startScoring() {
                if (scoreInterval) clearInterval(scoreInterval);
                currentScore = 0;
                topScoreAchievedDuringGame = false; // Reset flag
                scoreInterval = setInterval(() => {
                    currentScore += 0.01; 
                    $currentScoreDisplay.text('Time: ' + currentScore.toFixed(2) + 's');
                    updateTopScore(currentScore);
                }, 10); 
            }

            function stopScoring() {
                if (scoreInterval) {
                    clearInterval(scoreInterval);
                    scoreInterval = null;
                }
            }
            // --- End Score Logic ---

            function updateHeartDisplay() {
                let html = '';
                const fullHeartSvg = `<svg class="heart-icon" viewBox="0 0 24 24" fill="#E53E3E" stroke="#A03232" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`;
                const emptyHeartSvg = `<svg class="heart-icon empty-heart" viewBox="0 0 24 24" fill="none" stroke="#A03232" xmlns="http://www.w3.org/2000/svg"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>`;

                for (let i = 0; i < MAX_LIVES; i++) {
                    html += i < koopaLives ? fullHeartSvg : emptyHeartSvg;
                }
                
                $('#lives-display').html(html);
            }

            // --- Ground Parallax ---
            function updateGroundPosition(direction) {
                const PARALLAX_LIMIT = groundMaxMovement; 
                
                if (direction === 1) { 
                    groundOffsetX = Math.max(groundOffsetX - PARALLAX_STEP, -PARALLAX_LIMIT);
                } else if (direction === -1) { 
                    groundOffsetX = Math.min(groundOffsetX + PARALLAX_STEP, 0); 
                }

                $gameGround.css('left', groundOffsetX + 'px');
            }

            // --- Fullscreen Toggle ---
            function toggleFullscreen() {
                const element = document.documentElement; 
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else if (element.requestFullscreen) {
                    element.requestFullscreen().catch(err => {
                        console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                    });
                }
            }

            // --- Game Flow ---
            
            function startHealing() {
                stopHealing(); 
                healInterval = setInterval(() => {
                    if (koopaLives < MAX_LIVES) {
                        koopaLives++;
                        updateHeartDisplay();
                    }
                }, HEAL_INTERVAL_MS);
            }

            function stopHealing() {
                if (healInterval) {
                    clearInterval(healInterval);
                    healInterval = null;
                }
            }

            function startTimers() {
                speedUpInterval = setInterval(speedUpFireballs, SPEED_INTERVAL_MS);
                duplicationInterval = setInterval(duplicateFireball, DUPLICATION_INTERVAL_MS);
                startHealing(); 
            }

            function stopTimers() {
                if (speedUpInterval) clearInterval(speedUpInterval);
                if (duplicationInterval) clearInterval(duplicationInterval);
                stopHealing();
                speedUpInterval = null;
                duplicationInterval = null;
            }
            
            // Recalculates all dependent dimensions
            function updateDimensions() {
                gameContainerWidth = $gameContainer.width();
                gameContainerHeight = $gameContainer.height();

                const newGroundWidth = gameContainerWidth + GROUND_EXTRA_WIDTH;
                groundMaxMovement = GROUND_EXTRA_WIDTH; 

                $gameGround.css('width', newGroundWidth + 'px');
                
                resetKoopaPosition();
                populateFireballDropdown();
            }

            function resetKoopaPosition() {
                gameContainerWidth = $gameContainer.width(); 

                koopaX = (gameContainerWidth / 2) - (PLAYER_WIDTH / 2);
                groundOffsetX = 0; 
                jumpsCompleted = 0; 
                currentFlipState = 0; // Reset state variable
                
                updateTripleJumpDisplay();

                $koopa.css({
                    left: koopaX + 'px',
                    bottom: GROUND_HEIGHT + 'px',
                    opacity: 1
                }).removeClass('koopa-invincible koopa-flip'); // Remove koopa-flip on reset

                $gameGround.css('left', '0px');
            }
            
            // --- Fireball & Speed Logic ---

            function createFireball(delay = 0) {
                gameContainerWidth = $gameContainer.width();
                gameContainerHeight = $gameContainer.height();
                
                const koopaCenterX = koopaX + PLAYER_WIDTH / 2;
                const koopaCurrentY = parseFloat($koopa.css('bottom')) || GROUND_HEIGHT;
                const koopaCenterY = koopaCurrentY + PLAYER_HEIGHT / 2; 

                const minFireballY = GROUND_HEIGHT;
                const maxFireballY = gameContainerHeight - FIREBALL_SIZE;
                const maxFireballX = gameContainerWidth - FIREBALL_SIZE;
                
                let fx, fy, distance;

                let attempts = 0;
                do {
                    fx = Math.random() * maxFireballX;
                    fy = Math.random() * (maxFireballY - minFireballY) + minFireballY;

                    const fireballCenterX = fx + FIREBALL_SIZE / 2;
                    const fireballCenterY = fy + FIREBALL_SIZE / 2;

                    distance = Math.sqrt(
                        Math.pow(fireballCenterX - koopaCenterX, 2) + 
                        Math.pow(fireballCenterY - koopaCenterY, 2)
                    );
                    attempts++;
                    if (attempts > 50) break; 
                } while (distance < MIN_START_DISTANCE);

                let vx = currentSpeed * (Math.random() < 0.5 ? 1 : -1);
                let vy = currentSpeed * (Math.random() < 0.5 ? 1 : -1);

                const startTime = Date.now() + delay;

                const newFireball = new Fireball(fx, fy, vx, vy, startTime);
                fireballs.push(newFireball);
            }

            function duplicateFireball() {
                createFireball(DUPLICATION_DELAY_MS);
            }

            function speedUpFireballs() {
                currentSpeed += SPEED_INCREASE_FACTOR; 

                fireballs.forEach(fb => {
                    fb.baseSpeed += SPEED_INCREASE_FACTOR; 
                    
                    if (fb.isMoving) {
                        const magnitude = fb.isBoosted ? 
                                          fb.baseSpeed * PLATFORM_SPEED_MULTIPLIER : 
                                          fb.baseSpeed;
                        fb.updateVelocityMagnitude(magnitude);
                    }
                });
            }
            
            // --- Damage & Collision Logic ---

            function takeDamage() {
                const now = Date.now();
                if (now - lastDamageTime < DAMAGE_COOLDOWN_MS) {
                    return false;
                }
                
                koopaLives--;
                updateHeartDisplay();
                lastDamageTime = now;
                
                playSound('koopaDamage'); // Play Koopa damage sound
                
                $koopa.addClass('koopa-invincible');
                setTimeout(() => {
                    $koopa.removeClass('koopa-invincible');
                }, DAMAGE_COOLDOWN_MS);

                if (koopaLives <= 0) {
                    gameOver();
                }
                return true;
            }
            
            function checkCollision(fireball) {
                const koopaCurrentY = parseFloat($koopa.css('bottom')) || GROUND_HEIGHT; 

                const kLeft = koopaX + COLLISION_BUFFER;
                const kRight = koopaX + PLAYER_WIDTH - COLLISION_BUFFER;
                const kBottom = koopaCurrentY + COLLISION_BUFFER; 
                const kTop = koopaCurrentY + PLAYER_HEIGHT - COLLISION_BUFFER; 

                const fLeft = fireball.x;
                const fRight = fireball.x + FIREBALL_SIZE;
                const fBottom = fireball.y;
                const fTop = fireball.y + FIREBALL_SIZE;

                const overlapX = kLeft < fRight && kRight > fLeft;
                const overlapY = kBottom < fTop && kTop > fBottom;

                return overlapX && overlapY;
            }

            function startWiggle() { 
                $gameContainer.addClass('wiggle-short');
                setTimeout(() => {
                    $gameContainer.removeClass('wiggle-short');
                }, WIGGLE_DURATION_MS); 
            }
            
            // Function to create and position a platform element
            function createPlatformElement(width, height, x, yFromBottom) {
                const $el = $('<div class="game-platform"></div>');
                $el.css({
                    left: x + 'px',
                    bottom: yFromBottom + 'px', 
                    width: width + 'px',
                    height: height + 'px',
                }).appendTo($gameContainer);
                return $el;
            }

            // --- Game Loop ---
            function gameLoop() {
                if (!isPlaying) {
                    if (gameLoopInterval) clearInterval(gameLoopInterval);
                    return;
                }
                
                gameContainerWidth = $gameContainer.width();
                gameContainerHeight = $gameContainer.height();

                const maxFireballX = gameContainerWidth - FIREBALL_SIZE;
                const maxFireballY = gameContainerHeight - FIREBALL_SIZE;
                const minFireballY = GROUND_HEIGHT;
                
                let collisionDetected = false;
                let fireballsToKeep = []; 

                // Reset jumps only if koopa has fully landed
                const koopaCurrentY = parseFloat($koopa.css('bottom')) || GROUND_HEIGHT;
                if (Math.abs(koopaCurrentY - GROUND_HEIGHT) < 5) {
                    jumpsCompleted = 0;
                }

                
                // --- 0. Platform Movement ---
                platforms.forEach(p => {
                    p.x += p.vx;
                    const platformMaxX = gameContainerWidth - p.width;
                    
                    if (p.x <= 0) {
                        p.vx = Math.abs(p.vx);
                        p.x = 0;
                    } else if (p.x >= platformMaxX) {
                        p.vx = -Math.abs(p.vx);
                        p.x = platformMaxX;
                    }
                    p.element.css('left', p.x + 'px');
                });


                fireballs.forEach(fb => {
                    fb.updateDOM(); 
                    
                    if (!fb.isMoving) {
                        fireballsToKeep.push(fb);
                        return; 
                    }

                    const prevY = fb.y; 
                    const prevTop = prevY + FIREBALL_SIZE; 
                    
                    let hitPlatform = false; 
                    let hitGround = false;
                    let resetBoost = false;

                    // 1. Fireball Movement 
                    fb.x += fb.vx;
                    fb.y += fb.vy;

                    // 2. Fireball Wall Bounce Logic
                    if (fb.x <= 0) { fb.vx = Math.abs(fb.vx); fb.x = 0; } 
                    else if (fb.x >= maxFireballX) { fb.vx = -Math.abs(fb.vx); fb.x = maxFireballX; }

                    // Ground/Ceiling Bounce/Speed Reset Logic
                    if (fb.y <= minFireballY) { 
                        // ** SPEED RESET LOGIC **
                        if (fb.isBoosted) {
                            // Reset velocity magnitude back to the current base speed (undo 3x boost)
                            fb.updateVelocityMagnitude(fb.baseSpeed);
                            fb.isBoosted = false;
                            startWiggle(); 
                            resetBoost = true; // Flag for special sound
                        }
                        fb.vy = Math.abs(fb.vy); // Bounce UP
                        fb.y = minFireballY; 
                        hitGround = true; // Flag for normal bounce sound
                    } 
                    else if (fb.y >= maxFireballY) { fb.vy = -Math.abs(fb.vy); fb.y = maxFireballY; }


                    // 3. Platform Collision Check (Iterates over all active platforms)
                    platforms.forEach(p => {
                        
                        // Platform coordinates relative to the BOTTOM of the screen
                        const pBottom = p.y;
                        const pTop = p.y + p.height; 

                        // Fireball coordinates (from current frame, already moved)
                        const fLeft = fb.x;
                        const fRight = fb.x + FIREBALL_SIZE;
                        const fBottom = fb.y;
                        const fTop = fb.y + FIREBALL_SIZE;

                        // Check if the fireball is horizontally overlapping the platform
                        const platformOverlapX = fRight > p.x && fLeft < p.x + p.width;
                        
                        // Check if the fireball is vertically overlapping the platform
                        const platformOverlapY = fTop > pBottom && fBottom < pTop;

                        if (platformOverlapX && platformOverlapY) {
                            
                            // Only set hitPlatform flag if we apply the boost/bounce logic
                            hitPlatform = true; 

                            // --- 1. Speed Boost Logic ---
                            if (!fb.isBoosted) {
                                // Apply 3x multiplier to the current base speed
                                const newSpeed = fb.baseSpeed * PLATFORM_SPEED_MULTIPLIER;
                                fb.updateVelocityMagnitude(newSpeed);
                                fb.isBoosted = true;
                            }
                            
                            // --- 2. Bounce Logic (Vertical Prioritized) ---

                            // Hit TOP Surface: Moving DOWN (fb.vy < 0) AND was previously above the platform (prevY >= pTop)
                            if (fb.vy < 0 && prevY >= pTop) {
                                fb.vy = Math.abs(fb.vy); // Bounce UP
                                fb.y = pTop; // Correct position to be exactly at the top edge
                            } 
                            // Hit BOTTOM Surface: Moving UP (fb.vy > 0) AND was previously below the platform (prevTop <= pBottom)
                            else if (fb.vy > 0 && prevTop <= pBottom) {
                                fb.vy = -Math.abs(fb.vy); // Bounce DOWN
                                fb.y = pBottom - FIREBALL_SIZE; // Correct position to be exactly at the bottom edge
                            } 
                            // Side Collision (Fallback)
                            else {
                                fb.vx *= -1; // Reverse horizontal direction
                            }
                        }
                    });

                    // Play appropriate bounce sound
                    if (resetBoost) {
                        playSound('fireballBoostReset');
                    } else if (hitGround) {
                        playSound('fireballBounceGround');
                    } else if (hitPlatform) {
                        playSound('fireballPlatformBounce');
                    }


                    // 4. Koopa Collision Check
                    if (checkCollision(fb)) {
                        collisionDetected = true;
                        fb.destroy(); 
                    } else {
                        fireballsToKeep.push(fb); 
                    }
                });
                
                fireballs = fireballsToKeep; 
                
                if (collisionDetected) {
                    takeDamage(); 
                }
                
                if (lastTripleJumpTime > 0) {
                    updateTripleJumpDisplay();
                }
            }

            function wiggleMap() { // Wiggle for Game Over (longer duration)
                $gameContainer.addClass('wiggle');
                setTimeout(() => {
                    $gameContainer.removeClass('wiggle');
                }, 500);
            }

            function setupGame() {
                updateDimensions();

                isPlaying = false;
                currentDifficulty = $difficultySelect.val();
                updatePlatformWarning(currentDifficulty);

                $gameOverMessage.text('Koopa Fireball Dodge');
                $overlay.show();
                $playButton.text('START');
                stopScoring();
                stopBackgroundMusic(); // Ensure music is stopped on setup
                
                koopaLives = INITIAL_LIVES; 
                updateHeartDisplay(); 
                
                if (tjCooldownTimer) {
                    clearInterval(tjCooldownTimer);
                    tjCooldownTimer = null;
                }
                lastTripleJumpTime = 0; 
                updateTripleJumpDisplay(); 
                
                populateFireballDropdown();
                
                resetKoopaPosition();
                $topScoreDisplay.text('Top: ' + loadTopScore().toFixed(2) + 's');
            }

            function initializePlatforms(difficulty) { 
                // Clean up old platforms
                $('.game-platform').remove(); 
                platforms = []; 

                let numPlatforms = 0;
                if (difficulty === 'easy') numPlatforms = 0; // Ensures 'easy' is truly platform-free
                if (difficulty === 'medium') numPlatforms = 1;
                if (difficulty === 'hard') numPlatforms = 3;

                for (let i = 0; i < numPlatforms; i++) {
                    let pX, pY, pVx;
                    
                    // X position is always random across the width
                    pX = Math.random() * (gameContainerWidth - PLATFORM_WIDTH);

                    if (difficulty === 'medium') {
                        // Single platform: 50px from top, moving randomly
                        pY = gameContainerHeight - PLATFORM_TOP_MARGIN - PLATFORM_HEIGHT;
                        pVx = Math.random() < 0.5 ? PLATFORM_SPEED : -PLATFORM_SPEED;
                    } else {
                        // Three platforms: 50px spacing from top border for each one
                        
                        // Vertical offset: 50px (i=0), 100px (i=1), 150px (i=2)
                        const verticalOffset = PLATFORM_TOP_MARGIN + (i * PLATFORM_VERTICAL_SPACING);
                        pY = gameContainerHeight - verticalOffset - PLATFORM_HEIGHT; 
                        
                        // Ensure movement is set for hard mode
                        pVx = Math.random() < 0.5 ? PLATFORM_SPEED : -PLATFORM_SPEED;
                    }

                    const $el = createPlatformElement(PLATFORM_WIDTH, PLATFORM_HEIGHT, pX, pY);

                    platforms.push({
                        id: i,
                        x: pX,
                        y: pY, 
                        vx: pVx,
                        width: PLATFORM_WIDTH,
                        height: PLATFORM_HEIGHT,
                        element: $el
                    });
                }
            }


            function startGame() {
                // Initialize audio context on first click if not done already
                initializeAudioContext();
                playSound('uiClick');

                if (isPlaying) return;

                isPlaying = true;
                $overlay.hide();
                currentSpeed = FIREBALL_BASE_SPEED; 
                currentDifficulty = $difficultySelect.val();
                
                const initialFireballCount = parseInt($fireballSelect.val(), 10) || 1; 

                koopaLives = INITIAL_LIVES;
                updateHeartDisplay();
                
                lastTripleJumpTime = 0; 
                jumpsCompleted = 0; 
                updateTripleJumpDisplay();
                resetKoopaPosition();

                // Initialize platforms based on difficulty
                initializePlatforms(currentDifficulty); 

                fireballs.forEach(fb => fb.destroy());
                fireballs = [];
                
                for (let i = 0; i < initialFireballCount; i++) {
                    createFireball(INITIAL_FIREBALL_DELAY); 
                }

                startScoring();
                startTimers(); 
                startBackgroundMusic(); // Start background music

                gameLoopInterval = setInterval(gameLoop, 1000 / 60);
            }

            function gameOver() {
                isPlaying = false;
                if (gameLoopInterval) clearInterval(gameLoopInterval);
                stopScoring();
                stopTimers();
                stopBackgroundMusic(); // Stop background music
                playSound('gameOver'); // Play game over sound
                
                if (tjCooldownTimer) clearInterval(tjCooldownTimer);
                tjCooldownTimer = null;

                wiggleMap();

                $koopa.css('opacity', 0.5).removeClass('koopa-invincible'); 
                fireballs.forEach(fb => fb.element.css('opacity', 0.5));

                $gameOverMessage.text('GAME OVER');
                $overlay.show();
                $playButton.text('PLAY AGAIN');
                
                // Ensure platform info is visible again after game over
                updatePlatformWarning($difficultySelect.val()); 
            }

            // --- Koopa Movement and Jump Logic ---

            function moveKoopa(direction) {
                if (!isPlaying) return;

                let nextX = koopaX + (direction * MOVE_STEP);
                const maxKoopaX = gameContainerWidth - PLAYER_WIDTH;
                let oldKoopaX = koopaX;

                koopaX = Math.max(0, Math.min(nextX, maxKoopaX));
                
                // --- Flip Logic ---
                if (direction === -1) {
                    currentFlipState = 1;
                    $koopa.addClass('koopa-flip');
                } else if (direction === 1) {
                    currentFlipState = 0;
                    $koopa.removeClass('koopa-flip');
                }
                // --- End Flip Logic ---
                
                if (koopaX !== oldKoopaX) {
                    $koopa.css('left', koopaX + 'px');
                    
                    const nearLeftEdge = koopaX < 10 && direction === -1 && groundOffsetX === 0;
                    const nearRightEdge = koopaX > (maxKoopaX - 10) && direction === 1 && groundOffsetX === -groundMaxMovement;

                    if (!nearLeftEdge && !nearRightEdge) {
                        updateGroundPosition(direction);
                    }
                }
            }

            function handleJump() {
                if (!isPlaying || jumpsCompleted >= MAX_JUMPS) return;
                
                const now = Date.now();
                const isTripleJumpAttempt = (jumpsCompleted === MAX_JUMPS - 1); 

                if (isTripleJumpAttempt && (now - lastTripleJumpTime < TRIPLE_JUMP_COOLDOWN_MS)) {
                    console.warn("Triple Jump on cooldown!");
                    return; 
                }

                if (isTripleJumpAttempt) {
                    lastTripleJumpTime = now; 
                    updateTripleJumpDisplay();
                }

                jumpsCompleted++; 
                playSound('uiClick'); // Play click sound on jump

                $koopa.stop(true, false); 

                let currentBottom = parseFloat($koopa.css('bottom')) || GROUND_HEIGHT;
                
                let jumpMultiplier = 1.0;
                if (jumpsCompleted === 2) jumpMultiplier = 1.2;
                if (jumpsCompleted === 3) jumpMultiplier = 1.5; 

                const jumpHeight = JUMP_BASE_HEIGHT * jumpMultiplier;
                
                let newBottom = currentBottom + jumpHeight;

                const maxPossibleBottom = (gameContainerHeight - PLAYER_HEIGHT) * MAX_JUMP_RATIO;
                newBottom = Math.min(newBottom, maxPossibleBottom);
                
                $koopa.animate({ 
                    bottom: newBottom + 'px' 
                }, JUMP_DURATION_UP, 'easeOutQuad', function() {
                    $koopa.animate({ 
                        bottom: GROUND_HEIGHT + 'px' 
                    }, JUMP_DURATION_DOWN, 'easeInQuad', function() {
                        jumpsCompleted = 0; 
                    });
                });
            }


            // --- Event Handlers (Keyboard and Touch) ---

            function handleKeyDown(e) {
                const key = e.key.toLowerCase();
                
                if (!isPlaying) {
                    if (key === ' ') {
                        e.preventDefault();
                        if (!$overlay.is(':hidden')) startGame();
                    }
                    return;
                }

                switch (key) {
                    case 'arrowleft':
                    case 'a': 
                        e.preventDefault();
                        moveKoopa(-1);
                        break;
                    case 'arrowright':
                    case 'd': 
                        e.preventDefault();
                        moveKoopa(1);
                        break;
                    case ' ': 
                    case 'w':
                        e.preventDefault();
                        handleJump();
                        break;
                }
            }

            // MODIFIED: This function now implements the quadrant-based controls.
            function handleTouchOrClick(e) {
                // Ignore clicks on controls/overlay
                if (!isPlaying || $(e.target).closest('#play-button, #fireball-select, #difficulty-select, #game-overlay, #fullscreen-btn').length) return;
                
                // Prevent default behavior to stop accidental scrolling/zooming on mobile
                e.preventDefault();

                let clientX = e.clientX || (e.touches && e.touches[0] ? e.touches[0].clientX : null);
                let clientY = e.clientY || (e.touches && e.touches[0] ? e.touches[0].clientY : null);
                if (clientX === null || clientY === null) return;

                const containerOffset = $gameContainer.offset();
                const containerHeight = $gameContainer.height();
                const containerWidth = $gameContainer.width();
                
                // Calculate coordinates relative to the game container
                const clickX = clientX - containerOffset.left;
                const clickY = clientY - containerOffset.top; // Y is measured from top

                const halfHeight = containerHeight / 2;
                const halfWidth = containerWidth / 2;

                // ** Vertical Split (Top Half for Jump, Bottom Half for Move) **
                if (clickY < halfHeight) {
                    // Top Half: Jump control
                    handleJump();
                } else {
                    // Bottom Half: Movement control (Left/Right Split)
                    if (clickX < halfWidth) {
                        // Bottom Left: Move Left
                        moveKoopa(-1);
                    } else {
                        // Bottom Right: Move Right
                        moveKoopa(1);
                    }
                }
            }
            
            // --- Initialization ---

            function initEvents() {
                $(document).on('keydown', handleKeyDown);
                
                // UI Sound Effects
                $difficultySelect.on('change', function() {
                    initializeAudioContext();
                    playSound('uiClick');
                    updatePlatformWarning($(this).val());
                });
                
                $fireballSelect.on('change', function() {
                    initializeAudioContext();
                    playSound('uiClick');
                });

                $playButton.on('click', startGame);
                $fullscreenBtn.on('click', toggleFullscreen);

                // MODIFIED: Attach the single quadrant handler to mousedown/touchstart/click
                // Use touchstart and click to cover mobile and desktop, respectively.
                $gameContainer.on('mousedown touchstart', function(e) {
                    // Use setTimeout to ensure the click event doesn't also fire on the same tap/touch
                    if (e.type === 'touchstart' || e.type === 'mousedown') {
                        // Only run the handler on first touch/press
                        if (e.type === 'touchstart' && e.originalEvent.touches.length > 1) return;
                        
                        // Check if the target is part of the UI that should not trigger movement
                        if (!e.target.closest('#koopa') && !e.target.closest('.game-platform') && !e.target.closest('#play-button')) {
                            handleTouchOrClick(e);
                        }
                    }
                });
                
                // We keep the double click only on Koopa as a secondary, specific jump control
                $koopa.on('dblclick', handleJump); 
                
                // Also initialize audio on any click in the container, just in case
                $gameContainer.one('click', initializeAudioContext);

                $(window).on('resize', function() {
                    updateDimensions();
                    if (!isPlaying) {
                        resetKoopaPosition();
                    }
                }).trigger('resize');
            }

            $.easing.easeOutQuad = function (x, t, b, c, d) { return -c * (t /= d) * (t - 2) + b; };
            $.easing.easeInQuad = function (x, t, b, c, d) { return c * (t /= d) * t + b; };

            // Initial setup
            setupGame();
            initEvents();

        });
    </script>
</head>
<body>
    
    <div id="scoreboard">
        <div class="flex items-center gap-2">
            <div id="lives-display" class="flex items-center gap-1">
                </div>
        </div>
        
        <span id="current-score">Time: 0.00s</span>

        <div class="flex items-center">
            <span id="top-score">Top: 0.00s</span>
            <span id="triple-jump-cooldown" class="ml-4 text-red-400 font-normal">TJ Ready!</span>
            <button id="fullscreen-btn" aria-label="Toggle Fullscreen" class="p-1">
                 <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3v3a2 2 0 0 1-2 2H3m3 8H3m3-8V3m0 0l-3 3m3 0H3m18 0V3m-3 3h3m0 0l-3-3m3 3V3"/></svg>
            </button>
        </div>
    </div>

    <div id="game-container">

        <div id="game-overlay">
             <h1 id="game-over-message" class="text-3xl font-bold">Koopa Fireball Dodge</h1>
             
             <div class="flex flex-col items-center justify-center gap-4 mt-4 md:flex-row">
                 
                 <div class="flex items-center gap-2">
                     <label for="difficulty-select" class="text-white font-medium">Difficulty:</label>
                     <select id="difficulty-select" class="p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-brand-orange">
                         <option value="easy">Easy</option>
                         <option value="medium" selected>Medium</option>
                         <option value="hard">Hard</option>
                     </select>
                 </div>

                 <div class="flex items-center gap-2">
                     <label for="fireball-select" class="text-white font-medium">Starting Fireballs:</label>
                     <select id="fireball-select" class="p-2 rounded-lg bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-2 focus:ring-brand-orange">
                         </select>
                 </div>
             </div>
             
             <p id="platform-warning" class="mt-2 text-sm font-semibold text-yellow-300">MEDIUM: 1 moving platform near the top (50px margin).</p>

             <button id="play-button" class="mt-6">START</button>

             <p class="mt-8 text-sm font-medium">Controls: **Keyboard WASD/Arrows**. On Mobile/Touchscreen: **Bottom Half** of screen for **Left/Right Movement**, **Top Half** for **Jump**.</p>
             <div class="mt-4 text-sm font-semibold">
                <p class="text-yellow-300">Fireballs now destroy themselves on collision, speed up every 60s, and **WIGGLE** the screen when their boost resets!</p>
                <p class="text-red-300 font-bold">Triple Jump (3rd jump) has a **40-second cooldown**!</p>
                <p class="text-blue-300 font-bold">Platforms **triple the speed (3x multiplier)** of any fireball they hit until that fireball hits the ground!</p>
            </div>
        </div>

        <div id="game-ground"></div>
        
        <div id="koopa" class="character">
            <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="10" y="26" width="44" height="24" fill="#3CB371"/>
                <rect x="12" y="28" width="40" height="20" fill="#3CB371"/>
                <rect x="18" y="30" width="28" height="16" fill="#3CB371"/>
                <rect x="18" y="32" width="6" height="4" fill="#000000"/>
                <rect x="40" y="32" width="6" height="4" fill="#000000"/>
                <rect x="24" y="40" width="6" height="4" fill="#000000"/>
                <rect x="34" y="40" width="6" height="4" fill="#000000"/>

                <rect x="22" y="8" width="20" height="18" fill="#FFD700"/>

                <rect x="24" y="14" width="4" height="4" fill="#FFFFFF"/>
                <rect x="36" y="14" width="4" height="4" fill="#FFFFFF"/>
                <rect x="26" y="16" width="2" height="2" fill="#000000"/>
                <rect x="38" y="16" width="2" height="2" fill="#000000"/>

                <rect x="26" y="24" width="12" height="2" fill="#8B4513"/>

                <rect x="44" y="34" width="8" height="10" fill="#FFD700"/>
                <rect x="12" y="34" width="8" height="10" fill="#FFD700"/>

                <rect x="22" y="50" width="8" height ="6" fill="#8B4513"/>

                <rect x="34" y="50" width="8" height="6" fill="#8B4513"/>

                <rect x="22" y="6" width="20" height="2" fill="#8B4513"/>
            </svg>
        </div>

        <div id="fireball-template" class="fireball hidden" style="width: 15px; height: 15px;">
            <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="45" fill="#FF4500"/>
                <circle cx="55" cy="45" r="20" fill="#FFD700"/>
                <circle cx="40" cy="60" r="10" fill="#FFFFFF" opacity="0.8"/>
            </svg>
        </div>
    </div>

</body>
</html>