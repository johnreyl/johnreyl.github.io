<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koopa's Physics Sandbox v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        /* 1. Global & Fullscreen Setup */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* 2. Scoreboard Styling - Fixed at Top */
        #scoreboard {
            flex-shrink: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #2d3748;
            color: white;
            padding: 10px 20px;
            font-weight: bold;
            font-size: 1.1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.4);
            z-index: 20;
        }

        /* Styling for the hearts */
        #koopa-lives {
            font-size: 1.25rem;
            line-height: 1;
            margin-left: 10px;
        }

        .heart-icon {
            display: inline-block;
            margin: 0 1px;
        }

        /* 3. Game Container - Takes remaining height */
        #mario-world-container {
            flex-grow: 1;
            width: 100%;
            position: relative;
            overflow: hidden;
            background-color: #79a1d1;
            border-bottom: 15px solid #2d3748;
            box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.5);
            /* Ensure smooth animation properties */
            will-change: transform;
        }

        /* 4. Map Wiggle Animation (New) */
        @keyframes shake {
            0%, 100% {
                transform: translate(0, 0);
            }

            10% {
                transform: translate(-2px, -2px);
            }

            20% {
                transform: translate(3px, 3px);
            }

            30% {
                transform: translate(-4px, -1px);
            }

            40% {
                transform: translate(1px, 4px);
            }

            50% {
                transform: translate(-3px, 2px);
            }

            60% {
                transform: translate(2px, -3px);
            }

            70% {
                transform: translate(-1px, 4px);
            }

            80% {
                transform: translate(3px, -2px);
            }

            90% {
                transform: translate(-4px, 1px);
            }
        }

        /* Intense Wiggle (for 8 seconds) */
        @keyframes intense-wiggle-animation {
            0%, 100% {
                transform: translate(0, 0) rotate(0);
            }

            10% {
                transform: translate(-8px, -8px) rotate(-2deg);
            }

            20% {
                transform: translate(8px, 8px) rotate(2deg);
            }

            30% {
                transform: translate(-10px, -10px) rotate(-3deg);
            }

            40% {
                transform: translate(10px, 10px) rotate(3deg);
            }

            50% {
                transform: translate(-8px, -8px) rotate(-2deg);
            }

            60% {
                transform: translate(8px, 8px) rotate(2deg);
            }

            70% {
                transform: translate(-10px, -10px) rotate(-3deg);
            }

            80% {
                transform: translate(10px, 10px) rotate(3deg);
            }

            90% {
                transform: translate(-5px, -5px) rotate(-1deg);
            }
        }

        .is-intense-wiggling {
            /* Extremely fast cycle for maximum shaking intensity */
            animation: intense-wiggle-animation 30ms infinite;
        }

        /* Medium Wiggle (for 5 seconds) */
        @keyframes medium-wiggle-animation {
            0%, 100% {
                transform: translate(0, 0) rotate(0);
            }

            25% {
                transform: translate(-3px, -3px) rotate(-0.5deg);
            }

            50% {
                transform: translate(3px, 3px) rotate(0.5deg);
            }

            75% {
                transform: translate(-3px, -3px) rotate(-0.5deg);
            }
        }

        .is-medium-wiggling {
            /* Medium fast cycle */
            animation: medium-wiggle-animation 50ms infinite;
        }

        .map-wiggle {
            /* Base class to apply the animation */
            animation-name: shake;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        .wiggle-long {
            animation-duration: 1.3s;
        }

        .wiggle-short {
            animation-duration: 0.5s;
        }


        /* CSS for the Animated Mario World Ground */
        #mario-world-ground {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 300%;
            height: 25px;
            /* Green grass and brown dirt pattern */
            background: repeating-linear-gradient(90deg, #5aa85d, #5aa85d 20px, #61b365 20px, #61b365 40px), repeating-linear-gradient(90deg, #965a3c, #965a3c 20px, #a06341 20px, #a06341 40px);
            background-size: 100% 5px, 100% 20px;
            background-position: 0 0, 0 5px;
            background-repeat: repeat-x;
            animation-name: scroll-ground;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
            animation-duration: 1.5s;
            animation-play-state: paused;
        }

        @keyframes scroll-ground {
            from {
                background-position: 0 0, 0 5px;
            }

            to {
                background-position: -40px 0, -40px 5px;
            }
        }

        /* Wide Panel Styling */
        .wide-panel {
            position: absolute;
            width: 150px;
            height: 8px;
            background-color: #965a3c;
            border-top: 3px solid #b37e58;
            border-radius: 2px;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            z-index: 9;
            will-change: transform, left, bottom;
        }

        /* NEW: Fireball Styling (Modified) */
        .fireball {
            position: absolute;
            /* width and height are now set by JS on creation */
            background: radial-gradient(circle at 70% 30%, #ffd700, #ff4500, #8b0000);
            border-radius: 50%;
            box-shadow: 0 0 10px #ff4500, 0 0 20px #ff0000;
            z-index: 15;
            will-change: transform, left, bottom;
            animation: spin 0.5s linear infinite;
        }

        /* Custom styles for medium fireball (8x) */
        .fireball-medium {
            box-shadow: 0 0 25px #ff8c00, 0 0 50px #ff4500;
            border: 2px solid #ffaa00;
        }

        /* Custom styles for super fireball (16x) */
        .fireball-super {
            background: radial-gradient(circle at 70% 30%, #fffacd, #ff6347, #ff0000);
            box-shadow: 0 0 30px #ff0000, 0 0 60px #8b0000;
            border: 5px solid #ff0000;
        }


        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        /* Character Base Styling */
        .character {
            position: absolute;
            z-index: 10;
            width: 55px;
            height: 55px;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.4));
            will-change: transform, left, bottom;
            transition: transform 0.1s;
        }

        /* Temporary Invulnerability Flash */
        .invulnerable {
            opacity: 0.5;
            animation: flicker 0.2s infinite alternate;
        }

        @keyframes flicker {
            from {
                opacity: 1;
            }

            to {
                opacity: 0.2;
            }
        }

        /* Koopa Character */
        #koopa {
            left: 50px;
            animation: run-bob 0.4s infinite alternate;
        }

        @keyframes run-bob {
            from {
                transform: translateY(0px);
            }

            to {
                transform: translateY(2px);
            }
        }

        /* Class to flip Koopa horizontally when moving left */
        .flipped {
            transform: scaleX(-1);
        }

        /* Styling for the Character Selection Buttons (New Card Structure) */
        .char-card {
            /* Outer container for margin/padding on the grid */
            @apply p-1;
        }

        .char-btn {
            /* Inner container for border and selection style */
            @apply p-2 rounded-xl border-4 transition-all duration-200 cursor-pointer w-24 h-28 flex flex-col items-center justify-center;
        }

        .char-btn-selected {
            @apply border-yellow-400 bg-gray-800/50 scale-105;
        }

        .char-btn-unselected {
            @apply border-gray-600 bg-gray-700/50 hover:border-white/50 hover:bg-gray-600/50;
        }

        .char-btn svg {
            /* MODIFIED: Set fixed width and height to 50px */
            width: 50px;
            height: 50px;
            @apply mb-1;
        }

        /* Game Over Modal Styling */
        #game-over-modal {
            background-color: rgba(0, 0, 0, 0.9);
            z-index: 100;
        }

        #game-over-content {
            background-color: #8b0000; /* Dark Red */
            border: 8px solid #ff4500; /* Orange Red */
        }

        /* === POWER-UP AND INVINCIBILITY STYLES (NEW) === */
        @keyframes powerup-blink {
            0%, 100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        @keyframes powerup-rotate {
            0% {
                transform: translateY(0px) rotateY(0deg);
            }

            50% {
                transform: translateY(-5px) rotateY(180deg);
            }

            100% {
                transform: translateY(0px) rotateY(360deg);
            }
        }

        .power-up {
            position: absolute;
            width: 20px;
            height: 20px;
            z-index: 10;
            cursor: pointer;
            /* Slow blinking/rotating effect */
            animation: powerup-rotate 1.5s linear infinite, powerup-blink 1s step-end infinite;
        }

        @keyframes koopa-blink-red {
            0%, 100% {
                filter: brightness(1) drop-shadow(0 0 2px rgba(255, 255, 255, 0)); /* Default filter state */
            }

            25% {
                filter: brightness(2) drop-shadow(0 0 10px #ff0000); /* Red Flash */
            }

            50% {
                filter: brightness(1) drop-shadow(0 0 5px #ffd700); /* Gold Flash */
            }

            75% {
                filter: brightness(2) drop-shadow(0 0 10px #ff0000); /* Red Flash */
            }
        }

        .koopa-invincible {
            animation: koopa-blink-red 0.1s linear infinite; 
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-charcoal': '#2d3748',
                        'brand-orange': '#ed8936',
                    }
                }
            }
        }

        const KOOPA_SVG = `<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="10" y="26" width="44" height="24" fill="#3CB371"/>
                                <rect x="12" y="28" width="40" height="20" fill="#3CB371"/>
                                <rect x="18" y="30" width="28" height="16" fill="#3CB371"/>
                                <rect x="18" y="32" width="6" height="4" fill="#000000"/>
                                <rect x="40" y="32" width="6" height="4" fill="#000000"/>
                                <rect x="24" y="40" width="6" height="4" fill="#000000"/>
                                <rect x="34" y="40" width="6" height="4" fill="#000000"/>
                                <rect x="22" y="8" width="20" height="18" fill="#FFD700"/>
                                <rect x="24" y="14" width="4" height="4" fill="#FFFFFF"/>
                                <rect x="36" y="14" width="4" height="4" fill="#FFFFFF"/>
                                <rect x="26" y="16" width="2" height="2" fill="#000000"/>
                                <rect x="38" y="16" width="2" height="2" fill="#000000"/>
                                <rect x="26" y="24" width="12" height="2" fill="#8B4513"/>
                                <rect x="44" y="34" width="8" height="10" fill="#FFD700"/>
                                <rect x="12" y="34" width="8" height="10" fill="#FFD700"/>
                                <rect x="22" y="50" width="8" height ="6" fill="#8B4513"/>
                                <rect x="34" y="50" width="8" height="6" fill="#8B4513"/>
                                <rect x="22" y="6" width="20" height="2" fill="#8B4513"/>
                            </svg>`;

        // NEW: Character Data Structure
        const CHARACTER_DATA = {
            koopa: {
                name: "Koopa",
                svg: KOOPA_SVG,
            },
            goomba: {
                name: "Goomba",
                svg: `<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <rect x="15" y="15" width="34" height="40" rx="17" fill="#8B4513"/>
                                            <rect x="25" y="55" width="14" height="6" fill="#654321"/>
                                            <circle cx="25" cy="30" r="5" fill="white"/>
                                            <circle cx="39" cy="30" r="5" fill="white"/>
                                            <circle cx="25" cy="30" r="2" fill="black"/>
                                            <circle cx="39" cy="30" r="2" fill="black"/>
                                            <path d="M22 45 C25 48, 39 48, 42 45" stroke="#333333" stroke-width="2" stroke-linecap="round" fill="none"/>
                                        </svg>`,
            },
            lakitu: {
                name: "Lakitu",
                svg: `<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <rect x="10" y="42" width="44" height="15" rx="7" fill="#87CEEB"/>
                                            <path d="M10 50 C15 45, 49 45, 54 50" stroke="#87CEEB" stroke-width="5" stroke-linecap="round" fill="none"/>
                                            <circle cx="32" cy="20" r="18" fill="#FFD700"/>
                                            <circle cx="32" cy="20" r="15" fill="#FFFFFF"/>
                                            <rect x="18" y="32" width="28" height="10" rx="5" fill="#FFD700"/>
                                            <rect x="24" y="36" width="16" height="4" fill="#696969"/>
                                            <circle cx="25" cy="18" r="3" fill="#000000"/>
                                            <circle cx="39" cy="18" r="3" fill="#000000"/>
                                        </svg>`,
            },
            ghost: {
                name: "Ghost",
                svg: `<svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M32 5 C50 5, 50 40, 50 40 L50 40 L32 55 L14 40 L14 40 C14 40, 14 5, 32 5 Z" fill="white" stroke="#333333" stroke-width="2"/>
                                            <path d="M28 40 L30 45 L34 45 L36 40" fill="#000000"/>
                                            <circle cx="25" cy="25" r="4" fill="#000000"/>
                                            <circle cx="39" cy="25" r="4" fill="#000000"/>
                                        </svg>`,
            }
        };

        $(document).ready(function () {
            // --- DOM References ---
            const $koopa = $('#koopa');
            const $currentScoreDisplay = $('#current-score');
            const $topScoreDisplay = $('#top-score');
            const $livesDisplay = $('#koopa-lives');
            const $ground = $('#mario-world-ground');
            const $gameContainer = $('#mario-world-container');
            const $gameOverModal = $('#game-over-modal');

            // UI Elements
            const $fullscreenBtn = $('#fullscreen-btn');
            const $fullscreenIconPath = $('#fullscreen-path');
            const $pauseBtn = $('#pause-btn');
            const $menuModal = $('#game-menu-modal');
            const $mainMenuPanel = $('#main-menu-panel');
            const $pauseMenuPanel = $('#pause-menu-panel');
            const $settingsMenuPanel = $('#settings-menu-panel');
            const $charSelectPanel = $('#character-select-panel');
            const $difficultyButtons = $('.difficulty-btn');
            // NEW: Fireball Count Buttons
            const $fireballCountButtons = $('.fireball-count-btn');
            const $characterList = $('#character-list');

            // Current Selection Card DOM elements
            const $selectedCharDisplay = $('#selected-char-display');
            const $selectedCharName = $('#selected-char-name');

            // --- Sound Elements (Mocked) ---
            const tapSound = { play: () => { }, currentTime: 0, volume: 0.3 };
            const chaseMusic = { play: () => { }, pause: () => { }, currentTime: 0, volume: 0.5 };

            // --- Game Constants ---
            const groundHeight = 25;
            const KOOPA_HEIGHT = 55;
            const KOOPA_WIDTH = 55; // Used for collision
            const originalLeft = 50;
            const STORAGE_KEY = 'koopaTopScore';
            const PHYSICS_TICK_RATE = 1000 / 60;
            // Life Constants
            const INITIAL_LIVES = 5;
            const MAX_LIVES = 7;
            const FULL_HEART = '❤️';
            const EMPTY_HEART = '🤍';

            // --- NEW POWER-UP VARIABLES ---
            let isInvincible = false;
            let invincibilityTimer = 0;
            const powerUpLocations = { left: false, right: false }; // Tracks if a power-up exists on each side
            let powerUpCreationInterval;
            const POWERUP_CHECK_INTERVAL_MS = 30000; // Create a new power-up every ___ seconds
            const INVINCIBILITY_DURATION = 8000; // Invincibility duration in ms
            const GROUND_OFFSET = 30; // Power-up float height above ground

            // Panel Constants
            const PANEL_WIDTH = 150;
            const PANEL_HEIGHT = 8;
            const PANEL_SPACING_Y = 50;
            const PANEL_START_Y = groundHeight + KOOPA_HEIGHT + PANEL_SPACING_Y;
            const PANEL_SPEED = 2;

            // UPDATED: Fireball Constants
            const FIREBALL_NORMAL_SIZE = 23; // Base size
            const FIREBALL_MEDIUM_SIZE = FIREBALL_NORMAL_SIZE * 8; // 8x normal
            const FIREBALL_SUPER_SIZE = FIREBALL_NORMAL_SIZE * 16; // 16x normal
            const FIREBALL_BASE_SPEED = 5; // Vertical speed
            const FIREBALL_ANGULAR_VELOCITY_MAX = 2; // Max horizontal speed (scattering)
            const INVULNERABILITY_DURATION = 1500; // 1.5 seconds of invulnerability
            // Fireball Count Options
            const FIREBALL_COUNT_OPTIONS = [0, 5, 10]; // Available initial drop counts

            // --- Physics & Movement Constants ---
            const GRAVITY = 0.8;
            const JUMP_VELOCITY = Math.sqrt(2 * GRAVITY * (KOOPA_HEIGHT * 1.8));
            const KOOPA_SPEED = 6;
            const KOOPA_FRICTION = 0.9;
            const MIN_VEL_THRESHOLD = 0.5;
            const COLLISION_TOLERANCE_Y = 5;

            // --- SVG Icon Paths ---
            const ENTER_FS_PATH = 'M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z';
            const EXIT_FS_PATH = 'M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm8 11h2v-3h3v-2h-5v5zM17 5h-2v5h5V8h-3V5z';

            // --- State Variables (Global) ---
            let scoreInterval = null;
            let physicsUpdateInterval = null;
            let currentScore = 0;
            let startTime = 0;
            let isPaused = true;
            let koopaLives = INITIAL_LIVES;
            let gameDifficulty = 'easy';
            // NEW: State for initial fireball count
            let initialFireballCount = FIREBALL_COUNT_OPTIONS[0]; // Default to 0
            let selectedCharacterId = 'koopa';

            // Fireball State
            // Stores { $el, posX, posY, velY, velX, width, height, type }
            let fireballData = [];
            let fireballSpeedMultiplier = 1;
            let fireballTimeoutId = null; // Used to hold the ID of the recursive timeout

            // Panel State
            let panelData = []; // Stores { $el, posX, posY, velX }

            // Koopa State
            let koopaPosX = originalLeft;
            let koopaPosY = groundHeight;
            let koopaVelY = 0;
            let koopaVelX = 0;
            let isJumping = false;
            let jumpCount = 0;
            let isMovingLeft = false;
            let isMovingRight = false;
            let isJumpKeyPressed = false;
            let currentPlatform = null;
            let isInvulnerable = false;
            let invulnerableTimeout = null;

            // NEW: Ground Obstacle State
            let groundObstacleSetting = 'default'; // 'default' or 'enable'

            // NEW: Wiggle State
            let wiggleTimeoutId = null;


            // --- Map Wiggle Functions (NEW) ---
            function applyIntenseWiggle() {
                const target = document.getElementById('mario-world-container');
                const duration = 8000; // 8 seconds

                // Ensure no other wiggle is running
                target.classList.remove('is-medium-wiggling');

                // Apply the intense wiggle class
                target.classList.add('is-intense-wiggling');
                console.log(`Intense wiggle started for ${duration / 1000} seconds.`);

                // Remove the class after the duration
                setTimeout(() => {
                    target.classList.remove('is-intense-wiggling');
                    console.log('Intense wiggle ended.');
                }, duration);
            }

            /**
             * Applies a medium screen shake to the game container for 5 seconds.
             */
            function applyMediumWiggle() {
                const target = document.getElementById('mario-world-container');
                const duration = 5000; // 5 seconds

                // Ensure no other wiggle is running
                target.classList.remove('is-intense-wiggling');

                // Apply the medium wiggle class
                target.classList.add('is-medium-wiggling');
                console.log(`Medium wiggle started for ${duration / 1000} seconds.`);

                // Remove the class after the duration
                setTimeout(() => {
                    target.classList.remove('is-medium-wiggling');
                    console.log('Medium wiggle ended.');
                }, duration);
            }

            function longMapWiggle() {
                $gameContainer.addClass('map-wiggle wiggle-long');
                setTimeout(() => {
                    $gameContainer.removeClass('map-wiggle wiggle-long');
                }, 1300); // 1.3 seconds
            }

            function shortMapWiggle() {
                $gameContainer.addClass('map-wiggle wiggle-short');
                setTimeout(() => {
                    $gameContainer.removeClass('map-wiggle wiggle-short');
                }, 500); // 0.5 seconds
            }

            // Recursive Wiggle Timer
            function startWiggleTimer() {
                // Stop if paused or setting is disabled
                if (isPaused || groundObstacleSetting !== 'enable') {
                    clearTimeout(wiggleTimeoutId);
                    wiggleTimeoutId = null;
                    return;
                }

                // Random delay between 8000ms (8s) and 20000ms (20s)
                const minDelay = 8000;
                const maxDelay = 20000;
                const delay = Math.random() * (maxDelay - minDelay) + minDelay;

                // Schedule the next wiggle
                wiggleTimeoutId = setTimeout(() => {
                    // Choose between long (30% chance) and short (70% chance)
                    if (Math.random() < 0.3) {
                        applyIntenseWiggle()//longMapWiggle();
                    } else {
                        applyMediumWiggle()//shortMapWiggle();
                    }
                    // Immediately schedule the next call to maintain the random loop
                    startWiggleTimer();
                }, delay);
            }


            // --- Fireball Management Functions (UPDATED FOR CONTINUOUS RAPID GENERATION) ---

            /**
             * Creates a new fireball with a random type (Normal, Medium, or Super).
             */
            function createFireball() {
                const containerWidth = $gameContainer.width();
                const containerHeight = $gameContainer.height();

                let size = FIREBALL_NORMAL_SIZE;
                let type = 'normal';
                const chance = Math.random();

                // 3% chance for Super Fireball (0.00 to 0.03)
                if (chance < 0.03) {
                    size = FIREBALL_SUPER_SIZE;
                    type = 'super';
                }
                // 15% chance for Medium Fireball (0.03 to 0.18)
                else if (chance < 0.18) {
                    size = FIREBALL_MEDIUM_SIZE;
                    type = 'medium';
                }
                // Else, Normal Fireball
                // size = FIREBALL_NORMAL_SIZE;
                // type = 'normal';


                // Random X position across the entire width, ensuring it fits
                const initialX = Math.random() * (containerWidth - size);
                // Start position Y is just off the top of the screen
                const initialY = containerHeight + size;

                // Dynamically set CSS class based on size for visual distinction
                const fireballClass = `fireball fireball-${type}`;

                // Inject dynamic size and initial position
                const $fireball = $(`<div class="${fireballClass}" style="bottom: ${initialY}px; left: ${initialX}px; width: ${size}px; height: ${size}px;"></div>`);
                $gameContainer.append($fireball);

                // Random horizontal direction and speed, ensuring it's never perfectly horizontal (velX=0)
                let velX = (Math.random() * (FIREBALL_ANGULAR_VELOCITY_MAX * 2) - FIREBALL_ANGULAR_VELOCITY_MAX);
                if (Math.abs(velX) < 0.5) {
                    velX = velX > 0 ? 0.5 : -0.5; // Ensure a minimum horizontal movement
                }

                const fireball = {
                    $el: $fireball,
                    posX: initialX,
                    posY: initialY,
                    // Velocity is negative because it's moving downwards
                    velY: -FIREBALL_BASE_SPEED * fireballSpeedMultiplier,
                    velX: velX,
                    width: size, // NEW: Store width/height for collision
                    height: size, // NEW: Store width/height for collision
                    type: type // NEW: Store type for ground impact logic
                };

                fireballData.push(fireball);
                return fireball;
            }

            // Function to recursively generate fireballs with a random delay
            function startFireballMicroLoop() {
                // If paused, clear any pending timeout and check again later
                if (isPaused) {
                    // Check again in 0.5s if still paused
                    fireballTimeoutId = setTimeout(startFireballMicroLoop, 500);
                    return;
                }

                // Generate the fireball
                createFireball();

                let delay = Math.random() * (500 - 100) + 100;

                if (gameDifficulty === 'medium') {
                    delay = 100;
                } else if (gameDifficulty === 'hard') {
                    delay = 100;
                }

                // Schedule the next fireball attempt
                fireballTimeoutId = setTimeout(startFireballMicroLoop, delay);
            }


            function clearFireballs() {
                $('.fireball').remove();
                fireballData = [];
                // Stop the recursive generation loop
                if (fireballTimeoutId) {
                    clearTimeout(fireballTimeoutId);
                    fireballTimeoutId = null;
                }
            }

            // Setup now only sets speed and immediately starts the continuous loop
            function setupFireballGeneration() {
                clearFireballs(); // Clears all fireballs and stops the current generation loop

                fireballSpeedMultiplier = 1;

                if (gameDifficulty === 'easy') {
                    fireballSpeedMultiplier = 1.0;
                } else if (gameDifficulty === 'medium') {
                    fireballSpeedMultiplier = 2.3;
                } else if (gameDifficulty === 'hard') {
                    fireballSpeedMultiplier = 5.0;
                }

                // Start the continuous, random-delay generation loop
                startFireballMicroLoop();
            }

            function updateFireballs() {
                const containerWidth = $gameContainer.width();
                // Collision point is when the fireball's bottom (posY) is exactly on the groundHeight
                const groundY = groundHeight;
                const fireballsToRemove = [];

                fireballData.forEach((fireball, index) => {
                    // Update position
                    fireball.posX += fireball.velX;
                    fireball.posY += fireball.velY; // velY is negative, so posY decreases

                    // Check for ground collision (disappear) - Fireball's bottom position (posY) vs. ground top position (groundY)
                    if (fireball.posY <= groundY) {
                        fireballsToRemove.push(index);

                        // NEW: Trigger map wiggle based on fireball type
                        if (fireball.type === 'super') {
                            longMapWiggle(); // Call longMapWiggle() for superFireball
                        } else if (fireball.type === 'medium') {
                            shortMapWiggle(); // Call shortMapWiggle() for mediumFireball
                        }

                        // Optional: snap to ground for one frame before removing
                        fireball.posY = groundY;
                    }

                    // Check for horizontal bounds (bounce off side walls)
                    if (fireball.posX <= 0 || fireball.posX + fireball.width >= containerWidth) { // Use fireball.width
                        fireball.velX *= -1; // Reverse horizontal direction
                        fireball.posX = Math.max(0, Math.min(fireball.posX, containerWidth - fireball.width)); // Use fireball.width
                    }

                    // Apply visual update
                    fireball.$el.css({
                        left: fireball.posX + 'px',
                        bottom: fireball.posY + 'px'
                    });
                });

                // Remove fireballs that hit the ground
                fireballsToRemove.sort((a, b) => b - a).forEach(index => {
                    fireballData[index].$el.remove();
                    fireballData.splice(index, 1);
                });
            }


            // --- Panel Management Functions ---

            function createPanel(initialY, initialX, initialVelX) {
                const $panel = $(`<div class="wide-panel" style="bottom: ${initialY}px; left: ${initialX}px;"></div>`);
                $gameContainer.append($panel);

                const panel = {
                    $el: $panel,
                    posX: initialX,
                    posY: initialY,
                    velX: initialVelX,
                    width: PANEL_WIDTH,
                    height: PANEL_HEIGHT
                };

                panelData.push(panel);
            }

            function clearPanels() {
                $('.wide-panel').remove();
                panelData = [];
            }

            function initializePanels() {
                clearPanels();

                const containerWidth = $gameContainer.width();
                let numPanels = 0;
                let initialPanelSpeed = PANEL_SPEED;

                if (gameDifficulty === 'medium') {
                    numPanels = 1;
                } else if (gameDifficulty === 'hard') {
                    numPanels = 3;
                    initialPanelSpeed = PANEL_SPEED * 1.5; // Harder panels move faster
                }

                if (numPanels > 0) {
                    for (let i = 0; i < numPanels; i++) {
                        // Calculate initial Y position, increasing by spacing for each new panel
                        const panelY = PANEL_START_Y + (i * PANEL_SPACING_Y);
                        // Random X position within bounds
                        const panelX = Math.random() * (containerWidth - PANEL_WIDTH);
                        // Alternate initial direction
                        const panelVelX = i % 2 === 0 ? initialPanelSpeed : -initialPanelSpeed;

                        createPanel(panelY, panelX, panelVelX);
                    }
                }
            }

            function updatePanelPositions() {
                const containerWidth = $gameContainer.width();

                panelData.forEach(panel => {
                    // Update position
                    panel.posX += panel.velX;

                    // Boundary check and bounce
                    if (panel.posX <= 0) {
                        panel.posX = 0;
                        panel.velX = Math.abs(panel.velX); // Reverse direction
                    } else if (panel.posX + panel.width >= containerWidth) {
                        panel.posX = containerWidth - panel.width;
                        panel.velX = -Math.abs(panel.velX); // Reverse direction
                    }

                    // Apply visual update
                    panel.$el.css('left', panel.posX + 'px');
                });
            }

            // --- Score & Life Functions ---
            function loadTopScore() {
                const storedScore = localStorage.getItem(STORAGE_KEY);
                return storedScore ? parseInt(storedScore) : 0;
            }

            function updateTopScore(newScore) {
                const currentTopScore = loadTopScore();
                if (newScore > currentTopScore) {
                    localStorage.setItem(STORAGE_KEY, newScore);
                    $topScoreDisplay.text('Top Time: ' + (newScore / 1000).toFixed(2) + ' s');
                }
            }

            function startScoring() {
                currentScore = 0;
                $currentScoreDisplay.text('Time: 0.00 s');
                if (scoreInterval) return;
                startTime = Date.now();
                scoreInterval = setInterval(() => {
                    if (!isPaused) {
                        currentScore = Date.now() - startTime;
                        $currentScoreDisplay.text('Time: ' + (currentScore / 1000).toFixed(2) + ' s');
                    }
                }, 100);
            }

            function stopScoring() {
                if (scoreInterval) {
                    clearInterval(scoreInterval);
                    scoreInterval = null;
                    updateTopScore(currentScore);
                }
            }

            function updateLivesDisplay() {
                let heartIcons = '';
                for (let i = 0; i < koopaLives; i++) {
                    heartIcons += `<span class="heart-icon">${FULL_HEART}</span>`;
                }
                for (let i = 0; i < (MAX_LIVES - koopaLives); i++) {
                    heartIcons += `<span class="heart-icon">${EMPTY_HEART}</span>`;
                }
                $livesDisplay.html(heartIcons);
            }

            function changeLives(amount) {
                if (isInvulnerable && amount < 0) return; // Ignore damage if invulnerable

                koopaLives += amount;
                if (koopaLives < 0) koopaLives = 0;
                if (koopaLives > MAX_LIVES) koopaLives = MAX_LIVES;
                updateLivesDisplay();

                if (amount < 0 && koopaLives > 0) {
                    // Start invulnerability if damaged but still alive
                    $koopa.addClass('invulnerable');
                    isInvulnerable = true;

                    clearTimeout(invulnerableTimeout);
                    invulnerableTimeout = setTimeout(() => {
                        $koopa.removeClass('invulnerable');
                        isInvulnerable = false;
                    }, INVULNERABILITY_DURATION);
                }

                if (koopaLives === 0) {
                    gameOver();
                }
            }

            function gameOver() {
                isPaused = true;
                stopScoring();
                disableInteraction();
                $ground.css('animation-play-state', 'paused');
                chaseMusic.pause();
                clearFireballs(); // This now stops the continuous generation loop
                clearTimeout(wiggleTimeoutId); // NEW: Stop the wiggle timer
                $koopa.css('animation', 'none'); // Stop running bob
                $gameOverModal.removeClass('hidden');

                // Update final score display on Game Over modal
                $('#final-score-display').text((currentScore / 1000).toFixed(2) + ' seconds');
            }

            // --- Menu Management Functions ---

            function showPanel(panelElement) {
                $mainMenuPanel.addClass('hidden');
                $pauseMenuPanel.addClass('hidden');
                $settingsMenuPanel.addClass('hidden');
                $charSelectPanel.addClass('hidden');

                $(panelElement).removeClass('hidden');
            }

            function updateDifficultyDisplay() {
                $difficultyButtons.each(function () {
                    const difficulty = $(this).data('difficulty');
                    $(this).removeClass('bg-green-600 bg-gray-500 hover:bg-green-700 hover:bg-gray-600 ring-2 ring-green-400 font-extrabold font-bold');

                    if (difficulty === gameDifficulty) {
                        $(this).addClass('bg-green-600 ring-2 ring-green-400 font-extrabold');
                    } else {
                        $(this).addClass('bg-gray-500 hover:bg-gray-600 font-bold');
                    }
                });
            }

            // NEW: Update function for initial fireball count buttons
            function updateFireballCountDisplay() {
                $fireballCountButtons.each(function () {
                    const count = parseInt($(this).data('count'));
                    $(this).removeClass('bg-green-600 bg-gray-500 hover:bg-green-700 hover:bg-gray-600 ring-2 ring-green-400 font-extrabold font-bold');

                    if (count === initialFireballCount) {
                        $(this).addClass('bg-green-600 ring-2 ring-green-400 font-extrabold');
                    } else {
                        $(this).addClass('bg-gray-500 hover:bg-gray-600 font-bold');
                    }
                });
            }

            // NEW: Update function for Ground Obstacle buttons
            function updateGroundObstacleDisplay() {
                const $groundObstacleButtons = $('.ground-obstacle-btn');
                $groundObstacleButtons.each(function () {
                    const state = $(this).data('state');
                    $(this).removeClass('bg-green-600 bg-gray-500 hover:bg-green-700 hover:bg-gray-600 ring-2 ring-green-400 font-extrabold font-bold');

                    if (state === groundObstacleSetting) {
                        $(this).addClass('bg-green-600 ring-2 ring-green-400 font-extrabold');
                    } else {
                        $(this).addClass('bg-gray-500 hover:bg-gray-600 font-bold');
                    }
                });
            }


            // Character Visual Update Logic
            function updateKoopaVisual(charId) {
                const charData = CHARACTER_DATA[charId];
                if (charData) {
                    $koopa.html(charData.svg);
                    selectedCharacterId = charId;

                    // Update the current selection card display
                    $selectedCharDisplay.html(charData.svg);
                    $selectedCharName.text(charData.name);

                    // Update selection style in the menu if it's visible
                    $('.char-btn').each(function () {
                        const id = $(this).data('char-id');
                        $(this).removeClass('char-btn-selected char-btn-unselected');
                        if (id === charId) {
                            $(this).addClass('char-btn-selected');
                        } else {
                            $(this).addClass('char-btn-unselected');
                        }
                    });
                }
            }

            // Renders the character selection buttons within the new card panel
            function renderCharacterSelection() {
                $characterList.empty();

                Object.keys(CHARACTER_DATA).forEach(charId => {
                    const charData = CHARACTER_DATA[charId];
                    const isSelected = charId === selectedCharacterId;

                    const $button = $(`<div class="char-btn text-white text-sm" data-char-id="${charId}">
                                            ${charData.svg}
                                            <span>${charData.name}</span>
                                        </div>`);

                    const $cardPanel = $(`<div class="char-card"></div>`);
                    $cardPanel.append($button);

                    $button.addClass(isSelected ? 'char-btn-selected' : 'char-btn-unselected');

                    $button.on('click', function () {
                        updateKoopaVisual(charId);
                    });

                    $characterList.append($cardPanel);
                });
            }

            // --- Utility: Check for Bounding Box Collision ---
            function checkCollision(obj1, obj2) {
                return obj1.posX < obj2.posX + obj2.width &&
                    obj1.posX + obj1.width > obj2.posX &&
                    obj1.posY < obj2.posY + obj2.height &&
                    obj1.posY + obj1.height > obj2.posY;
            }

            // --- Physics Loop ---
            function updatePhysics() {
                if (isPaused) return;

                // 1. Panel Movement
                updatePanelPositions();

                // 2. Fireball Movement & Generation
                updateFireballs();

                // 3. Koopa Horizontal Movement & Friction
                let platformVelX = 0;
                if (currentPlatform) {
                    platformVelX = currentPlatform.velX;
                }

                if (isMovingLeft) {
                    koopaVelX = -KOOPA_SPEED;
                } else if (isMovingRight) {
                    koopaVelX = KOOPA_SPEED;
                } else if (koopaPosY <= groundHeight || currentPlatform) {
                    // Apply friction only when grounded or on a platform
                    koopaVelX *= KOOPA_FRICTION;
                    if (Math.abs(koopaVelX) < MIN_VEL_THRESHOLD) koopaVelX = 0;
                }

                // Apply platform's horizontal velocity to Koopa
                koopaPosX += platformVelX;


                // 4. Vertical Movement & Gravity
                let newPlatform = null;
                let onPanelSurface = false;
                const containerWidth = $gameContainer.width();
                const koopaWidth = KOOPA_WIDTH;

                // Platform Collision Detection (Landing Logic)
                if (koopaVelY <= 0) { // Only check for landing when falling or stationary
                    panelData.forEach(panel => {
                        const overlapX = koopaPosX + koopaWidth > panel.posX && koopaPosX < panel.posX + panel.width;
                        const abovePanel = koopaPosY + koopaVelY <= panel.posY + panel.height && koopaPosY >= panel.posY + panel.height - COLLISION_TOLERANCE_Y;

                        if (overlapX && abovePanel) {
                            newPlatform = panel;
                            onPanelSurface = true;
                        }
                    });
                }

                // Ground landing check
                const onGround = koopaPosY + koopaVelY <= groundHeight;

                if (onPanelSurface) {
                    koopaPosY = newPlatform.posY + newPlatform.height; // Snap to the top of the panel
                    koopaVelY = 0;
                    isJumping = false;
                    jumpCount = 0;
                    currentPlatform = newPlatform;
                } else if (onGround) {
                    koopaPosY = groundHeight; // Snap to the ground
                    koopaVelY = 0;
                    isJumping = false;
                    jumpCount = 0;
                    currentPlatform = null;
                } else {
                    // Apply gravity if not grounded/on a platform
                    koopaVelY -= GRAVITY;
                    isJumping = true;
                    currentPlatform = null;
                }

                // 5. Fireball Collision Check
                if (!isInvulnerable) {
                    const koopaBounds = {
                        posX: koopaPosX,
                        posY: koopaPosY,
                        width: KOOPA_WIDTH,
                        height: KOOPA_HEIGHT
                    };

                    const fireballsHit = [];

                    fireballData.forEach((fireball, index) => {
                        const fireballBounds = {
                            posX: fireball.posX,
                            posY: fireball.posY,// - fireball.height, // Fireball position is bottom, need top for collision. Use fireball.height
                            width: fireball.width, // Use fireball.width
                            height: fireball.height // Use fireball.height
                        };
                        if (checkCollision(koopaBounds, fireballBounds)) {
                            fireballsHit.push(index);
                        }
                    });

                    if (fireballsHit.length > 0) {
                        changeLives(-1); // Reduce life

                        if (isPaused) {
                            return; // Exit physics loop immediately if game is over
                        }
                        // Remove the fireballs that hit Koopa
                        fireballsHit.sort((a, b) => b - a).forEach(index => {
                            fireballData[index].$el.remove();
                            fireballData.splice(index, 1);
                        });
                    }
                }


                // 6. Update Positions
                koopaPosX += koopaVelX;
                koopaPosY += koopaVelY;

                // 7. World Boundaries Check (for Koopa)
                if (koopaPosX < 0) {
                    koopaPosX = 0;
                    koopaVelX = 0;
                } else if (koopaPosX > (containerWidth - koopaWidth)) {
                    koopaPosX = (containerWidth - koopaWidth);
                    koopaVelX = 0;
                }

                // 8. Apply Visual Updates (for Koopa)
                $koopa.css({
                    bottom: koopaPosY + 'px',
                    left: koopaPosX + 'px'
                });

                // Set flip class based on direction
                if (koopaVelX + platformVelX < -MIN_VEL_THRESHOLD) {
                    $koopa.addClass('flipped');
                    restoreKoopaAnimation();
                } else if (koopaVelX + platformVelX > MIN_VEL_THRESHOLD) {
                    $koopa.removeClass('flipped');
                    restoreKoopaAnimation();
                } else {
                    if (!isJumping && !currentPlatform) $koopa.css('animation', 'none');
                }

                // --- Power-up Checks (NEW) ---
                checkPowerUpCollisions();
                //handleInvincibility();
            }

            // --- Core Game State Functions ---
            function enableInteraction() {
                $(document).on('keydown', handleKeydown);
                $(document).on('keyup', handleKeyup);
                $gameContainer.on('mousedown touchstart', handleTouchOrClick);
                $gameContainer.on('mouseup touchend', handleTouchEnd);
                $pauseBtn.show();
            }

            function disableInteraction() {
                $(document).off('keydown', handleKeydown);
                $(document).off('keyup', handleKeyup);
                $gameContainer.off('mousedown touchstart', handleTouchOrClick);
                $gameContainer.off('mouseup touchend', handleTouchEnd);
            }

            function restoreKoopaAnimation() {
                $koopa.css('animation', 'run-bob 0.4s infinite alternate');
            }

            function initializeGame() {
                // Stop all loops and sounds
                if (physicsUpdateInterval) { clearInterval(physicsUpdateInterval); physicsUpdateInterval = null; }
                stopScoring();
                disableInteraction();
                chaseMusic.pause();
                clearTimeout(invulnerableTimeout);
                clearTimeout(wiggleTimeoutId); // NEW: Clear the wiggle timer on init

                // Reset states
                koopaLives = INITIAL_LIVES;
                koopaPosX = originalLeft;
                koopaPosY = groundHeight;
                $koopa.css({ left: koopaPosX + 'px', bottom: koopaPosY + 'px' });
                $koopa.removeClass('invulnerable');
                $gameContainer.removeClass('map-wiggle wiggle-long wiggle-short'); // NEW: Remove wiggle class
                $ground.css('animation-play-state', 'paused');
                koopaVelY = 0;
                koopaVelX = 0;
                isJumping = false;
                jumpCount = 0;
                isMovingLeft = false;
                isMovingRight = false;
                isPaused = true;
                isJumpKeyPressed = false;
                currentPlatform = null;
                isInvulnerable = false;
                clearPanels();
                clearFireballs(); // Clear fireballs and stop the generation loop

                // UI Setup: Show Main Menu
                $gameOverModal.addClass('hidden');
                $pauseBtn.hide();
                $menuModal.removeClass('hidden');
                showPanel('#main-menu-panel');

                $topScoreDisplay.text('Top Time: ' + (loadTopScore() / 1000).toFixed(2) + ' s');
                $currentScoreDisplay.text('Time: 0.00 s');
                updateLivesDisplay();
                updateDifficultyDisplay();
                // NEW: Update fireball count display
                updateFireballCountDisplay();
                updateGroundObstacleDisplay(); // Initialize ground obstacle display
                updateKoopaVisual(selectedCharacterId);

                // Start physics loop if not running
                if (!physicsUpdateInterval) {
                    physicsUpdateInterval = setInterval(updatePhysics, PHYSICS_TICK_RATE);
                }
            }

            // --- NEW FUNCTION: createPowerup ---
            function createPowerup() {
                const availableSides = [];
                if (!powerUpLocations.left) {
                    availableSides.push('left');
                }
                if (!powerUpLocations.right) {
                    availableSides.push('right');
                }

                // Stop if both sides have powerups
                if (availableSides.length === 0) {
                    return;
                }

                // Determine location
                let locationToUse = availableSides[Math.floor(Math.random() * availableSides.length)];

                // Randomly select power-up type
                const type = Math.random() < 0.5 ? 'heart' : 'star';
                const symbol = type === 'heart' ? '❤️' : '⭐';
                const className = type === 'heart' ? 'text-red-500' : 'text-yellow-300 drop-shadow-lg';

                // Create the element
                const POWERUP_SIZE = 20;
                const $powerUp = $(`<div class="power-up ${className} text-xl" data-type="${type}" data-location="${locationToUse}" style="width:${POWERUP_SIZE}px; height:${POWERUP_SIZE}px; line-height:${POWERUP_SIZE}px; text-align:center;position:absolute;">${symbol}</div>`);

                const worldWidth = $gameContainer.width();

                // Calculate position: lower left or lower right (GROUND_OFFSET px above ground)
                let leftPosition;
                const PADDING_PERCENT = 0.05;

                if (locationToUse === 'left') {
                    // Lower left: 5% from left
                    leftPosition = worldWidth * PADDING_PERCENT;
                    powerUpLocations.left = true;
                } else {
                    // Lower right: 5% from right, accounting for powerup width
                    leftPosition = worldWidth - (worldWidth * PADDING_PERCENT) - POWERUP_SIZE;
                    powerUpLocations.right = true;
                }

                $powerUp.css({
                    left: `${leftPosition}px`,
                    bottom: `${GROUND_OFFSET}px`, // 5px above ground
                });

                $gameContainer.append($powerUp);
            }

            function pickupPowerUp($powerUp, type) {
                $powerUp.remove();

                // 1. Update powerUpLocations state
                const location = $powerUp.data('location');
                if (location === 'left') {
                    powerUpLocations.left = false;
                } else if (location === 'right') {
                    powerUpLocations.right = false;
                }

                // 2. Apply effect
                if (type === 'heart') {
                    koopaLives ++;
                    updateLivesDisplay();
                } else if (type === 'star') {
                    // Make Koopa blink red and invincible for 10 seconds
                    if (!isInvincible) {
                        isInvincible = true;

                        $koopa.addClass('koopa-invincible');

                        isInvulnerable = true;
                        $koopa.addClass('invulnerable');

                        setInterval(removeInvulnerableState, INVINCIBILITY_DURATION)
                    } else {

                    }
                }
            }

            function checkPowerUpCollisions() {
                if (!$koopa || $koopa.length === 0) return;

                const koopaRect = {
                    left: koopaPosX,
                    right: koopaPosX + $koopa.width(),
                    top: $gameContainer.height() - (koopaPosY + $koopa.height()), // Convert bottom Y to top Y
                    bottom: $gameContainer.height() - koopaPosY
                };

                $('.power-up').each(function () {
                    const $powerUp = $(this);
                    const powerUpSize = $powerUp.width();
                    const powerUpLeft = parseFloat($powerUp.css('left'));
                    const powerUpBottom = parseFloat($powerUp.css('bottom'));

                    const powerUpRect = {
                        left: powerUpLeft,
                        right: powerUpLeft + powerUpSize,
                        top: $gameContainer.height() - (powerUpBottom + powerUpSize),
                        bottom: $gameContainer.height() - powerUpBottom
                    };

                    // AABB collision check
                    if (koopaRect.left < powerUpRect.right &&
                        koopaRect.right > powerUpRect.left &&
                        koopaRect.top < powerUpRect.bottom &&
                        koopaRect.bottom > powerUpRect.top) {

                        // Collision detected!
                        const type = $powerUp.data('type');
                        pickupPowerUp($powerUp, type);
                        // Stop checking after one pickup per frame
                        return false;
                    }
                });
            }

            function removeInvulnerableState() {
                isInvincible = false;
                $koopa.removeClass('koopa-invincible');

                isInvulnerable = false;
                $koopa.removeClass('invulnerable');
            }

            function startGame() {
                koopaLives = INITIAL_LIVES;
                updateLivesDisplay();
                initializePanels(); // Initialize panels based on selected difficulty
                setupFireballGeneration(); // Setup and start continuous fireball generation
                $menuModal.addClass('hidden');
                $gameOverModal.addClass('hidden');
                isPaused = false;
                enableInteraction();
                $ground.css('animation-play-state', 'running');
                chaseMusic.play();
                startScoring();
                restoreKoopaAnimation();

                // NEW: Start map wiggle timer if setting is enabled
                if (groundObstacleSetting === 'enable') {
                    startWiggleTimer();
                }

                powerUpCreationInterval = setInterval(createPowerup, POWERUP_CHECK_INTERVAL_MS);
            }

            function togglePause() {
                if ($mainMenuPanel.is(':visible') || $settingsMenuPanel.is(':visible') || $charSelectPanel.is(':visible') || !$gameOverModal.hasClass('hidden')) return;

                isPaused = !isPaused;
                if (isPaused) {
                    $ground.css('animation-play-state', 'paused');
                    chaseMusic.pause();
                    $menuModal.removeClass('hidden');
                    showPanel('#pause-menu-panel');
                    clearTimeout(wiggleTimeoutId); // NEW: Pause the wiggle timer
                } else {
                    $ground.css('animation-play-state', 'running');
                    chaseMusic.play();
                    $menuModal.addClass('hidden');
                    // If resuming, restart the micro-loop which handles the 'isPaused' check
                    startFireballMicroLoop();
                    // NEW: Resume the wiggle timer
                    if (groundObstacleSetting === 'enable') {
                        startWiggleTimer();
                    }
                }
            }

            function jumpAction() {
                if (isPaused) return;
                // Double jump limit
                if (jumpCount >= 2) return;

                // Reset platform state when jumping
                currentPlatform = null;

                tapSound.play();
                $koopa.css('animation', 'none');
                koopaVelY = JUMP_VELOCITY;
                koopaPosY += koopaVelY;
                jumpCount++;
            }

            function toggleFullscreen() {
                const doc = document.documentElement;
                if (!document.fullscreenElement) {
                    doc.requestFullscreen ? doc.requestFullscreen() : doc.webkitRequestFullscreen ? doc.webkitRequestFullscreen() : doc.msRequestFullscreen ? doc.msRequestFullscreen() : null;
                } else {
                    document.exitFullscreen ? document.exitFullscreen() : document.webkitExitFullscreen ? document.webkitExitFullscreen() : document.msExitFullscreen ? document.msExitFullscreen() : null;
                }
            }

            function handleFullscreenChange() {
                $fullscreenIconPath.attr('d', document.fullscreenElement ? EXIT_FS_PATH : ENTER_FS_PATH);
            }


            // --- INPUT HANDLERS ---
            function handleKeydown(e) {
                if (isPaused) return;
                const key = e.key.toLowerCase();
                if (key === 'a' || key === 'arrowleft') {
                    isMovingLeft = true;
                    isMovingRight = false;
                } else if (key === 'd' || key === 'arrowright') {
                    isMovingRight = true;
                    isMovingLeft = false;
                } else if (key === ' ' || key === 'w' || key === 'arrowup') {
                    e.preventDefault();
                    if (!isJumpKeyPressed) {
                        jumpAction();
                        isJumpKeyPressed = true;
                    }
                }
            }

            function handleKeyup(e) {
                if (isPaused) return;
                const key = e.key.toLowerCase();
                if (key === 'a' || key === 'arrowleft') {
                    isMovingLeft = false;
                } else if (key === 'd' || key === 'arrowright') {
                    isMovingRight = false;
                } else if (key === ' ' || key === 'w' || key === 'arrowup') {
                    isJumpKeyPressed = false;
                }
            }

            function handleTouchOrClick(e) {
                if (isPaused) return;
                e.preventDefault();
                const rect = $gameContainer[0].getBoundingClientRect();
                const clientX = e.originalEvent.touches ? e.originalEvent.touches[0].clientX : e.clientX;
                const clientY = e.originalEvent.touches ? e.originalEvent.touches[0].clientY : e.clientY;
                const relX = clientX - rect.left;
                const relY = clientY - rect.top;
                const containerWidth = rect.width;
                const containerHeight = rect.height;

                // 1. Jump (Upper 50% of screen)
                if (relY < containerHeight / 2) {
                    jumpAction();
                }
                // 2. Movement (Lower 50% of screen)
                else {
                    if (relX < containerWidth / 2) {
                        isMovingLeft = true;
                        isMovingRight = false;
                    } else {
                        isMovingRight = true;
                        isMovingLeft = false;
                    }
                }
            }

            function handleTouchEnd(e) {
                if (isPaused) return;
                isMovingLeft = false;
                isMovingRight = false;
            }

            // --- Event Listeners ---

            // Menu Navigation
            $('#start-game-button').on('click', startGame);
            $('#resume-game-button').on('click', togglePause);

            // Shared Back to Menu Logic
            const goToMainMenu = () => { initializeGame(); showPanel('#main-menu-panel'); };
            $('.back-to-menu-button').on('click', goToMainMenu);
            $('#back-from-settings-button').on('click', goToMainMenu);
            $('#back-from-char-select-button').on('click', goToMainMenu);
            $('#restart-game-button').on('click', startGame); // Game Over restart

            // Settings Buttons
            $('#more-settings-button').on('click', () => {
                updateGroundObstacleDisplay(); // Call new display update when opening settings
                showPanel('#settings-menu-panel');
            });

            // Character Selection Buttons
            $('#character-select-button').on('click', () => {
                renderCharacterSelection();
                showPanel('#character-select-panel');
            });

            // Difficulty Button Handlers
            $difficultyButtons.on('click', function () {
                gameDifficulty = $(this).data('difficulty');
                updateDifficultyDisplay();
            });

            // NEW: Initial Fireball Count Button Handlers
            $fireballCountButtons.on('click', function () {
                initialFireballCount = parseInt($(this).data('count'));
                updateFireballCountDisplay();
            });

            // NEW: Ground Obstacle Button Handlers
            $('.ground-obstacle-btn').on('click', function () {
                groundObstacleSetting = $(this).data('state');
                updateGroundObstacleDisplay();
                // When toggling, ensure the timer is cleared if setting is disabled
                if (groundObstacleSetting === 'default') {
                    clearTimeout(wiggleTimeoutId);
                    $gameContainer.removeClass('map-wiggle wiggle-long wiggle-short');
                } else if (!isPaused) {
                    startWiggleTimer(); // If enabling during gameplay, start immediately
                }
            });


            // General UI
            $fullscreenBtn.on('click', toggleFullscreen);
            $pauseBtn.on('click', togglePause);
            document.addEventListener('fullscreenchange', handleFullscreenChange);
            document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
            document.addEventListener('msfullscreenchange', handleFullscreenChange);

            // Initial setup
            initializeGame();
        });
    </script>
</head>
<body>
    <div id="game-menu-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm hidden">
        <div class="bg-brand-charcoal p-10 rounded-xl shadow-2xl max-w-lg w-full text-center border-4 border-brand-orange/50">
            <h1 class="text-4xl font-extrabold text-white mb-4 uppercase tracking-widest">Koopa's Sandbox</h1>

            <p class="text-white/80 mb-6">
                Practice Koopa's moves! Master the new controls in this physics environment.
            </p>
            <div id="main-menu-panel" class="flex flex-col md:flex-row gap-6">
                <div class="md:w-1/2 text-left">
                    <div class="text-left text-sm bg-gray-700 p-3 rounded-md mb-6 text-yellow-300">
                        <p class="font-bold mb-1">Controls:</p>
                        <ul class="list-disc list-inside ml-4 space-y-1">
                            <li>**Jump (Max 2):** W, Up Arrow, or tap top half of the screen.</li>
                            <li>**Move Left:** A, Left Arrow, or tap lower-left quadrant.</li>
                            <li>**Move Right:** D, Right Arrow, or tap lower-right quadrant.</li>
                        </ul>
                    </div>
                </div>

                <div class="md:w-1/2 flex flex-col space-y-3">
                    <button id="start-game-button" class="w-full px-8 py-3 bg-red-600 text-white text-xl font-black uppercase tracking-wider rounded-lg shadow-xl hover:bg-red-700 transition duration-200 ring-4 ring-red-400 focus:outline-none">
                        Start World
                    </button>
                    <button id="character-select-button" class="w-full px-8 py-2 bg-indigo-600 text-white text-base font-black uppercase tracking-wider rounded-lg shadow-xl hover:bg-indigo-700 transition duration-200 focus:outline-none">
                        Character
                    </button>
                    <button id="more-settings-button" class="w-full px-8 py-2 bg-gray-600 text-white text-base font-black uppercase tracking-wider rounded-lg shadow-xl hover:bg-gray-700 transition duration-200 focus:outline-none">
                        Settings
                    </button>
                </div>
            </div>

            <div id="pause-menu-panel" class="hidden">
                <h2 class="text-3xl font-extrabold text-white mb-6">Game Paused</h2>
                <div class="space-y-4">
                    <button id="resume-game-button" class="w-full px-8 py-3 bg-green-600 text-white text-xl font-black uppercase tracking-wider rounded-lg shadow-xl hover:bg-green-700 transition duration-200 focus:outline-none">
                        Resume
                    </button>
                    <button class="back-to-menu-button w-full px-8 py-3 bg-blue-600 text-white text-xl font-black uppercase tracking-wider rounded-lg shadow-xl hover:bg-blue-700 transition duration-200 focus:outline-none">
                        Main Menu
                    </button>
                </div>
            </div>

            <div id="settings-menu-panel" class="hidden">
                <h2 class="text-3xl font-extrabold text-white mb-6">Difficulty & Obstacles</h2>
                <div class="space-y-4 w-64 mx-auto">
                    <h3 class="text-white/90 text-xl font-bold">Difficulty</h3>
                    <p class="text-sm text-gray-400">Controls fireball speed and platform/fireball generation.</p>
                    <div class="flex justify-between space-x-2">
                        <button id="difficulty-easy" data-difficulty="easy" class="difficulty-btn px-4 py-2 text-white rounded-lg transition duration-150">Easy</button>
                        <button id="difficulty-medium" data-difficulty="medium" class="difficulty-btn px-4 py-2 text-white rounded-lg transition duration-150">Medium</button>
                        <button id="difficulty-hard" data-difficulty="hard" class="difficulty-btn px-4 py-2 text-white rounded-lg transition duration-150">Hard</button>
                    </div>

                    <h3 class="text-white/90 text-xl font-bold pt-4">Ground Obstacles</h3>
                    <p class="text-sm text-gray-400">Enables random map wiggles to throw off your control.</p>
                    <div class="flex justify-between space-x-2" id="ground-obstacle-settings">
                        <button id="ground-obstacle-default" data-state="default" class="ground-obstacle-btn px-4 py-2 text-white rounded-lg transition duration-150 w-full bg-green-600 ring-2 ring-green-400 font-extrabold">Default</button>
                        <button id="ground-obstacle-enable" data-state="enable" class="ground-obstacle-btn px-4 py-2 text-white rounded-lg transition duration-150 w-full bg-gray-500 hover:bg-gray-600 font-bold">Enable</button>
                    </div>
                    <div class="text-xs text-left text-gray-500 pt-2">
                        <p>**Easy:** Slow fireballs, few platforms.</p>
                        <p>**Medium:** 2.3x speed, 1 platform, rapid fireballs.</p>
                        <p>**Hard:** 5x speed, 3 platforms, intense fireball rain.</p>
                    </div>
                </div>
                <button id="back-from-settings-button" class="w-full mt-6 px-8 py-3 bg-blue-600 text-white text-xl font-black uppercase tracking-wider rounded-lg shadow-xl hover:bg-blue-700 transition duration-200 focus:outline-none">
                    Back to Menu
                </button>
            </div>

            <div id="character-select-panel" class="hidden max-w-lg w-full">
                <h2 class="text-3xl font-extrabold text-white mb-6">Select Character</h2>

                <div id="current-selection-card" class="bg-gray-800 p-4 rounded-xl mb-6 flex items-center justify-center space-x-4 border-2 border-yellow-400 shadow-lg">
                    <h3 class="text-xl font-bold text-white tracking-wider">Selected:</h3>
                    <div id="selected-char-display" class="w-12 h-12 text-white">
                    </div>
                    <span id="selected-char-name" class="text-2xl font-black text-yellow-300">Koopa</span>
                </div>
                <div id="character-list" class="flex flex-wrap justify-center gap-4 p-4 bg-gray-900 rounded-xl max-h-80 overflow-y-auto border-4 border-gray-700">
                </div>

                <button id="back-from-char-select-button" class="w-full mt-6 px-8 py-3 bg-blue-600 text-white text-xl font-black uppercase tracking-wider rounded-lg shadow-xl hover:bg-blue-700 transition duration-200 focus:outline-none">
                    Done
                </button>
            </div>

        </div>
    </div>

    <div id="game-over-modal" class="fixed inset-0 flex items-center justify-center p-4 hidden">
        <div id="game-over-content" class="p-10 rounded-xl shadow-2xl max-w-md w-full text-center">
            <h2 class="text-6xl font-black text-yellow-300 uppercase mb-4 animate-pulse">Game Over</h2>
            <p class="text-white text-xl mb-6">Koopa ran out of lives!</p>
            <p class="text-white text-lg font-semibold mb-8">Time Survived: <span id="final-score-display" class="text-red-300 font-extrabold">0.00 seconds</span></p>
            <div class="space-y-4">
                <button id="restart-game-button" class="w-full px-8 py-3 bg-green-600 text-white text-xl font-black uppercase tracking-wider rounded-lg shadow-xl hover:bg-green-700 transition duration-200 focus:outline-none">
                    Restart
                </button>
                <button class="w-full px-8 py-3 bg-blue-600 text-white text-xl font-black uppercase tracking-wider rounded-lg shadow-xl hover:bg-blue-700 transition duration-200 focus:outline-none back-to-menu-button">
                    Main Menu
                </button>
            </div>
        </div>
    </div>


    <div id="scoreboard" class="select-none">
        <div id="score-group" class="flex gap-4 items-center">
            <div id="koopa-lives" class="text-brand-orange"></div>
            <span id="current-score">Score: 0.00 s</span>
        </div>

        <div class="flex items-center space-x-4">
            <span id="top-score" class="text-gray-300">Top Time: 0.00 s</span>
            <button id="fullscreen-btn" class="text-white p-1 rounded-full bg-black/30 hover:bg-black/50 transition duration-150" title="Toggle Full Screen">
                <svg id="fullscreen-icon" class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path id="fullscreen-path" d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z" />
                </svg>
            </button>
        </div>
    </div>

    <div id="mario-world-container" class="relative">
        <button id="pause-btn" class="absolute top-4 right-4 text-white p-2 rounded-full bg-black/30 hover:bg-black/50 transition duration-150 shadow-lg z-30 hidden" title="Pause Game">
            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
            </svg>
        </button>

        <div id="mario-world-ground"></div>

        <div id="koopa" class="character">
        </div>
    </div>
</body>
</html>