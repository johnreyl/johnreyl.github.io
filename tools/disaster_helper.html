<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Disaster Helper - Survival & First Aid Guide</title>
    <link href="src\disaster_helper.tailwind.css" rel="stylesheet">
    <script src="src\jquery-3.6.0.min.js"></script>
    <style>
        /* Custom Tailwind Configuration (Safety Orange Theme) */
        :root {
            --accent-color: #f97316; /* Orange-500 for safety */
        }

        /* Custom scrollbar to match the dark theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1f2937; /* Gray-800 */
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-color);
            border-radius: 4px;
        }

            ::-webkit-scrollbar-thumb:hover {
                background: #ea580c; /* Orange-600 */
            }

        /* Specific style for active/selected nav item */
        .nav-item.active {
            color: var(--accent-color);
            border-bottom: 2px solid var(--accent-color);
        }

        /* FIX: Minimum height and aspect ratio for topic images */
        .topic-item img {
            min-height: 150px; /* Ensures the item block has height */
            aspect-ratio: 4 / 3; /* Wider aspect ratio for cover images */
            object-fit: cover;
        }
        /* Style for selected archive letter */
        .archive-letter.active {
            background-color: var(--accent-color);
            color: #1f2937;
        }

        /* Custom list style for step-by-step instructions */
        .instruction-step {
            display: flex;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #374151; /* Gray-700 */
        }

        .instruction-step-number {
            flex-shrink: 0;
            width: 2rem;
            height: 2rem;
            background-color: var(--accent-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 0.75rem;
        }

        /* Utility for limiting lines of text */
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Custom style for Dos/Don'ts list */
        .dos-list {
            list-style-type: '‚úÖ ';
            margin-left: 1.5rem;
        }

        .donts-list {
            list-style-type: '‚ùå ';
            margin-left: 1.5rem;
        }

        .nav-item.active {
            color: var(--accent-color); /* Makes the icon orange */
            /* This border will still work for desktop/text links */
            border-bottom: 2px solid var(--accent-color);
        }

        /* NEW: Add specific mobile styling for active link on smaller screens */
        @media (max-width: 767px) { /* Tailwinds 'md' breakpoint is 768px */
            .nav-item.active {
                background-color: #374151; /* Gray-700 background for selected icon */
                border-radius: 0.5rem; /* Soft round corners */
                border-bottom: none; /* Remove border-bottom on mobile */
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <header class="bg-gray-800 shadow-lg sticky top-0 z-10">
        <div class="container mx-auto px-4 py-3 flex flex-wrap md:flex-nowrap justify-between items-center">

            <a href="#" class="text-3xl font-bold text-orange-500 mr-8 flex-shrink-0" onclick="showPage('page-home'); return false;">Disaster<span class="text-white">Helper</span></a>

            <div class="order-2 md:order-3 flex-shrink-0">
                <button id="fullscreen-toggle" class="p-2 rounded-full bg-gray-700 text-orange-500 hover:bg-orange-600 hover:text-white transition" onclick="toggleFullScreen()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4M4 20l5-5m11 5l-5-5m5 5v-4m0 4h-4"></path></svg>
                </button>
            </div>

            <nav class="order-3 md:order-2 w-full mt-3 md:w-auto md:flex-grow md:mt-0 flex justify-between text-sm font-semibold md:border-t-0 md:border-b-0">
                <a href="#home" class="nav-item active flex-1 flex flex-col items-center px-2 py-2 hover:text-orange-500 transition md:w-1/5" data-page="home" title="Home">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11v10a1 1 0 001 1h3m-7 0h-2"></path></svg>
                    <span class="hidden md:inline-block text-xs mt-1">HOME</span>
                </a>

                <a href="#popular" class="nav-item flex-1 flex flex-col items-center px-2 py-2 hover:text-orange-500 transition md:w-1/5" data-page="popular" title="Popular Guides">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.152A1.665 1.665 0 0113 2.152L15.349 7.02l5.064.736a1.665 1.665 0 01.924 2.842l-3.666 3.578 0.865 5.048a1.665 1.665 0 01-2.417 1.75l-4.526-2.388-4.526 2.388a1.665 1.665 0 01-2.417-1.75l.865-5.048-3.666-3.578a1.665 1.665 0 01.924-2.842l5.064-.736L11.049 2.152z"></path></svg>
                    <span class="hidden md:inline-block text-xs mt-1">POPULAR</span>
                </a>

                <a href="#archive" class="nav-item flex-1 flex flex-col items-center px-2 py-2 hover:text-orange-500 transition md:w-1/5" data-page="archive" title="A-Z Index">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13h7.42M12 6.253H4.58M4.58 6.253l4.58 13M19.42 6.253l-4.58 13"></path></svg>
                    <span class="hidden md:inline-block text-xs mt-1">A-Z</span>
                </a>

                <a href="#search" class="nav-item flex-1 flex flex-col items-center px-2 py-2 hover:text-orange-500 transition md:w-1/5" data-page="filter" title="Search / Filter">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <span class="hidden md:inline-block text-xs mt-1">SEARCH</span>
                </a>

                <a href="#history" class="nav-item flex-1 flex flex-col items-center px-2 py-2 hover:text-orange-500 transition md:w-1/5" data-page="history" title="Recently Viewed">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <span class="hidden md:inline-block text-xs mt-1">HISTORY</span>
                </a>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8">

        <div id="page-content">

            <div id="page-home" class="page">

                <div class="bg-gray-800 p-4 rounded-lg shadow-xl mb-8">
                    <h2 class="text-xl font-bold border-b-2 border-orange-500 pb-2 mb-4 text-white">üî• FEATURED TOPIC</h2>

                    <div id="featured-tutorial-container" class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                        <div class="lg:col-span-2 order-2 lg:order-1">
                            <h3 id="featured-title" class="text-2xl font-bold text-orange-500 mb-2">Topic Title</h3>
                            <div id="featured-categories" class="flex flex-wrap gap-2 mb-3"></div>

                            <h4 class="text-lg font-bold border-b border-gray-700 pb-1 mb-2 text-white">Key Explanation</h4>
                            <p id="featured-explanation" class="text-sm text-gray-300 mb-4 line-clamp-3">A brief overview of the disaster topic and its importance...</p>

                            <h4 class="text-lg font-bold border-b border-gray-700 pb-1 mb-2 text-white">Quick Steps (How-To Snippet)</h4>
                            <div id="featured-steps-snippet" class="space-y-2 text-sm text-gray-300 mb-4">
                            </div>

                            <button id="show-details-modal" class="bg-orange-600 text-white p-3 rounded-lg font-bold hover:bg-orange-500 transition">
                                View Full Guide, Details & Examples
                            </button>
                        </div>

                        <div class="lg:col-span-1 order-1 lg:order-2">
                            <img id="featured-image" src="#" class="w-full rounded-lg object-cover max-h-72" alt="Featured Topic Image">
                            <div class="flex justify-between items-center mt-4">
                                <button id="prev-featured" class="bg-gray-700 text-white p-2 rounded hover:bg-orange-600 transition disabled:opacity-50" disabled>‚Üê Previous</button>

                                <div id="featured-page-details" class="text-sm text-gray-400 font-medium">
                                    Page Details
                                </div>
                                <button id="next-featured" class="bg-gray-700 text-white p-2 rounded hover:bg-orange-600 transition disabled:opacity-50">Next ‚Üí</button>
                            </div>
                        </div>

                    </div>
                </div>
                <div id="anime-detail-panel" class="bg-gray-800 p-4 rounded-lg shadow-xl mb-8 hidden">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div class="md:col-span-3">

                        <div class="bg-gray-800 p-4 rounded-lg shadow-xl mb-8">
                            <h2 class="text-xl font-bold border-b-2 border-orange-500 pb-2 mb-4 text-white">üè∑Ô∏è TOPIC CATEGORIES</h2>
                            <div id="all-categories-badges" class="flex flex-wrap gap-2">
                            </div>
                        </div>

                        <div class="bg-gray-800 p-4 rounded-lg shadow-xl">
                            <h2 class="text-xl font-bold border-b-2 border-orange-500 pb-2 mb-4 text-white flex justify-between items-center">
                                <span>üö® LATEST GUIDES & ALERTS</span>
                                <span id="latest-count" class="text-sm bg-orange-500 text-white px-2 py-1 rounded-full">
                                    0
                                </span>
                            </h2>
                            <div id="latest-episodes-container" class="w-full">
                                <div id="latest-episodes" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
                                </div>
                                <p id="latest-empty-message" class="text-gray-400 hidden">No new guides or alerts found at this time.</p>
                            </div>
                            <div class="mt-4 flex justify-between items-center">
                                <button id="see-more-latest" class="bg-gray-700 text-orange-500 p-2 rounded hover:bg-orange-600 hover:text-white transition" onclick="showPage('page-filter'); filterLatest()">
                                    See More...
                                </button>
                            </div>
                        </div>
                    </div>

                    <aside class="md:col-span-1">
                        <div class="bg-gray-800 p-4 rounded-lg shadow-xl">
                            <h3 class="text-lg font-bold border-b-2 border-orange-500 pb-2 mb-4 text-white">üó∫Ô∏è EMERGENCY HOTLINES</h3>

                            <div class="mb-3">
                                <label for="country-select" class="text-sm font-semibold text-gray-300 block mb-1">Select Country:</label>
                                <select id="country-select" class="w-full p-2 rounded bg-gray-700 border border-gray-600 text-sm" onchange="renderHotlines($('#country-select').val())">
                                </select>
                            </div>

                            <ul id="hotlines-list" class="space-y-3 text-sm">
                            </ul>

                            <button id="show-survival-rules" class="mt-4 w-full bg-orange-600 text-white p-3 rounded-lg font-bold hover:bg-orange-500 transition" onclick="renderSurvivalRules(); showPage('page-search-results'); return false;">
                                üìú General Survival Rules
                            </button>
                        </div>
                    </aside>
                </div>
            </div>

            <div id="page-popular" class="page hidden">
                <div class="bg-gray-800 p-4 rounded-lg shadow-xl">

                    <h2 class="text-xl font-bold border-b-2 border-orange-500 pb-2 mb-4 text-white flex justify-between items-center">
                        <span>‚≠ê HIGH-PRIORITY TOPICS</span>
                        <span id="popular-count" class="text-sm bg-orange-500 text-white px-2 py-1 rounded-full">
                            0
                        </span>
                    </h2>
                    <div id="popular-series" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
                    </div>
                </div>
            </div>

            <div id="page-archive" class="page hidden">
                <div class="bg-gray-800 p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-bold border-b-2 border-orange-500 pb-2 mb-4 text-white">üìö GUIDE INDEX (A-Z)</h2>
                    <div id="anime-archive-links" class="space-y-3 mb-6">
                    </div>

                    <h3 class="text-lg font-bold border-b-2 border-gray-700 pb-2 mb-4 text-white flex justify-between items-center">
                        <span id="archive-title">All Topics</span>
                        <span id="archive-result-count" class="text-sm bg-gray-700 text-orange-500 px-2 py-1 rounded">
                            0 results
                        </span>
                    </h3>

                    <div class="flex flex-wrap items-center gap-4 p-4 bg-gray-700 rounded-lg mb-6">
                        <label class="text-sm font-semibold">Sort By:</label>
                        <select id="archive-sort-by" class="p-2 rounded bg-gray-900 border border-gray-600 text-sm">
                            <option value="title">Title</option>
                            <option value="type">Topic Type</option>
                            <option value="date">Date Added</option>
                        </select>

                        <label class="text-sm font-semibold">Order:</label>
                        <select id="archive-sort-order" class="p-2 rounded bg-gray-900 border border-gray-600 text-sm">
                            <option value="asc">Ascending</option>
                            <option value="desc">Descending</option>
                        </select>

                        <button id="apply-archive-sort" class="bg-orange-600 text-white p-2 rounded hover:bg-orange-500 transition">Apply Sort</button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-700">
                            <thead class="bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/2">
                                        Topic / Type
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/6">
                                        Priority
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/6">
                                        Category
                                    </th>
                                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider w-1/6">
                                        Last Updated
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="anime-archive-table" class="bg-gray-800 divide-y divide-gray-700">
                                <tr><td colspan="4" class="px-6 py-4 text-center text-gray-500" id="archive-empty-message">Select a letter to filter the guides.</td></tr>
                            </tbody>
                        </table>
                    </div>

                </div>
            </div>

            <div id="page-filter" class="page hidden">
                <div class="bg-gray-800 p-4 rounded-lg shadow-xl mb-8">
                    <h2 class="text-xl font-bold border-b-2 border-orange-500 pb-2 mb-4 text-white">üîç ADVANCED SEARCH & FILTER</h2>

                    <div class="mb-6 flex">
                        <input id="filter-search-input" type="text" placeholder="Search by topic title..." class="p-3 w-full rounded-l bg-gray-700 text-gray-200 border border-gray-600 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 transition text-lg">
                        <button id="search-apply-button" class="text-white bg-orange-600 p-3 rounded-r hover:bg-orange-500 transition font-bold" onclick="applyFilter()">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </button>
                    </div>

                    <div class="flex flex-wrap items-center gap-4 p-4 bg-gray-700 rounded-lg mb-6">
                        <label class="text-sm font-semibold">Date Filter:</label>
                        <select id="filter-day" class="p-2 rounded bg-gray-900 border border-gray-600 text-sm">
                            <option value="">Day</option>
                        </select>
                        <select id="filter-month" class="p-2 rounded bg-gray-900 border border-gray-600 text-sm">
                            <option value="">Month</option>
                        </select>
                        <select id="filter-year" class="p-2 rounded bg-gray-900 border border-gray-600 text-sm">
                            <option value="">Year</option>
                        </select>

                        <label class="text-sm font-semibold ml-4">Category:</label>
                        <select id="filter-category" class="p-2 rounded bg-gray-900 border border-gray-600 text-sm">
                            <option value="">All Categories</option>
                        </select>

                        <button id="apply-filter" class="bg-orange-600 text-white p-2 rounded hover:bg-orange-500 transition">Apply Filters</button>
                        <button id="reset-filter" class="bg-gray-600 text-white p-2 rounded hover:bg-gray-500 transition">Reset</button>
                    </div>

                    <h3 class="text-lg font-bold border-b-2 border-gray-700 pb-2 mb-4 text-white flex justify-between items-center">
                        <span>SEARCH RESULTS</span>
                        <span id="search-result-count" class="text-sm bg-gray-700 text-orange-500 px-2 py-1 rounded">
                            0 results
                        </span>
                    </h3>
                    <div id="filtered-results-list" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
                        <p class="text-gray-400 col-span-5" id="filter-no-results">Enter keywords or select criteria and click Apply Filter.</p>
                    </div>

                    <div id="filter-pagination" class="mt-6 flex justify-center space-x-2">
                    </div>
                </div>
            </div>

            <div id="page-history" class="page hidden">
                <div class="bg-gray-800 p-4 rounded-lg shadow-xl">
                    <h2 class="text-xl font-bold border-b-2 border-orange-500 pb-2 mb-4 text-white">‚åö RECENTLY VIEWED TOPICS</h2>
                    <ul id="watched-history-list" class="space-y-3 text-sm">
                        <li class="text-gray-400" id="empty-history-message">Your history is empty.</li>
                    </ul>
                    <button id="clear-history" class="mt-4 bg-gray-700 text-gray-200 p-2 rounded hover:bg-orange-600 hover:text-white transition">Clear History</button>
                </div>
            </div>

            <div id="page-search-results" class="page hidden">
                <div class="bg-gray-800 p-4 rounded-lg shadow-xl mb-8">
                    <h2 id="rules-title" class="text-xl font-bold border-b-2 border-orange-500 pb-2 mb-4 text-white"></h2>
                    <div id="rules-content" class="text-gray-300"></div>
                </div>
            </div>

        </div>
    </main>

    <div id="detail-modal" class="hidden fixed inset-0 z-50 bg-black bg-opacity-80">
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-4xl p-6 relative">

                <button id="close-modal" class="absolute top-4 right-4 text-gray-400 hover:text-white transition">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>

                <h2 id="modal-title" class="text-3xl font-bold text-orange-500 mb-4 border-b pb-2">Full Guide Title</h2>

                <div class="max-h-[80vh] overflow-y-auto pr-4">
                    <p id="modal-explanation" class="text-lg text-gray-300 mb-6"></p>

                    <h3 class="text-xl font-bold border-b-2 border-orange-500 pb-1 mb-3 text-white">Step-by-Step Instructions</h3>
                    <div id="modal-steps-container" class="mb-6 space-y-3">
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <h3 class="text-xl font-bold border-b-2 border-green-500 pb-1 mb-3 text-white">‚úÖ Key DOs</h3>
                            <ul id="modal-dos-container" class="dos-list text-sm text-gray-300 space-y-1 pl-4"></ul>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold border-b-2 border-red-500 pb-1 mb-3 text-white">‚ùå Key DON'Ts</h3>
                            <ul id="modal-donts-container" class="donts-list text-sm text-gray-300 space-y-1 pl-4"></ul>
                        </div>
                    </div>
                    <h3 class="text-xl font-bold border-b-2 border-orange-500 pb-1 mb-3 text-white">Examples & Scenarios</h3>
                    <div id="modal-examples" class="text-sm text-gray-300 space-y-3">
                    </div>
                </div>

            </div>
        </div>
    </div>


    <footer class="bg-gray-800 mt-12 py-6">
        <div class="container mx-auto px-4 text-center text-sm text-gray-500">
            <p>&copy; <span id="currentYear">2024</span> DisasterHelper. Survival knowledge is critical.</p>
        </div>
    </footer>

    <script>
        // --- CONSTANTS ---
        const ITEMS_PER_PAGE = 20;
        const STEPS_PER_PAGE = 10;
        const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        const FALLBACK_IMAGE_URL = 'img/fallbackimage.jpg';

        let SURVIVAL_RULES = {};
        let EMERGENCY_HOTLINES = {};

        let TOPIC_TYPES = [];
        let ALL_CATEGORIES = [];
        let guidesData = [];
        let popularGuides = [];
        let activePage = 'home';

        const animeArchiveLinks = [
            { letter: "A", link: "#" }, { letter: "B", link: "#" }, { letter: "C", link: "#" },
            { letter: "D", link: "#" }, { letter: "E", link: "#" }, { letter: "F", link: "#" },
            { letter: "G", link: "#" }, { letter: "H", link: "#" }, { letter: "I", link: "#" },
            { letter: "J", link: "#" }, { letter: "K", link: "#" }, { letter: "L", link: "#" },
            { letter: "M", link: "#" }, { letter: "N", link: "#" }, { letter: "O", link: "#" },
            { letter: "P", link: "#" }, { letter: "Q", link: "#" }, { letter: "R", link: "#" },
            { letter: "S", link: "#" }, { letter: "T", link: "#" }, { letter: "U", link: "#" },
            { letter: "V", link: "#" }, { letter: "W", link: "#" }, { letter: "X", link: "#" },
            { letter: "Y", link: "#" }, { letter: "Z", link: "#" }, { letter: "0-9", link: "#" },
        ];

        // Updated Hotline Data Structure

        // --- Dummy Data Generation for Latest Guides (50 items for pagination demo) ---
        const today = new Date();

        //guidesData.type = TOPIC_TYPES[0];
        //categories = ALL_CATEGORIES


        let DATA = [];
        let currentFilteredResults = guidesData;
        let currentArchiveFilter = null;
        let currentPage = 1;
        let currentFeaturedTopicId = 0;// DATA.length > 0 ? DATA[0].id : null; // Track the featured topic

        // --- Core Functions ---

        /**
         * Toggles the document or body element into or out of full-screen mode.
         * Handles vendor prefixes for cross-browser compatibility.
         */
        function toggleFullScreen() {
            const doc = window.document;
            const docEl = doc.documentElement;

            // Get vendor-prefixed request/exit fullscreen methods
            const requestFullScreen = docEl.requestFullscreen || docEl.mozRequestFullScreen || docEl.webkitRequestFullScreen || docEl.msRequestFullscreen;
            const cancelFullScreen = doc.exitFullscreen || doc.mozCancelFullScreen || doc.webkitExitFullscreen || doc.msExitFullscreen;

            // Check which element is currently in full-screen mode (includes vendor prefixes)
            const isFullScreen = doc.fullscreenElement || doc.mozFullScreenElement || doc.webkitFullscreenElement || doc.msFullscreenElement;

            if (!isFullScreen) {
                // Enter full screen
                if (requestFullScreen) {
                    // Call requestFullScreen on the document's root element (documentElement)
                    requestFullScreen.call(docEl);
                } else {
                    console.warn("Fullscreen mode not natively supported by this browser or security restrictions prevent it.");
                }
            } else {
                // Exit full screen
                if (cancelFullScreen) {
                    // Call exitFullscreen on the document
                    cancelFullScreen.call(doc);
                }
            }
        }


        function loadJsonData(url) {
            // $.getJSON returns a jqXHR object, which is a promise-like object.
            // It is effectively a shorthand for $.ajax({url: url, dataType: 'json', ...})
            return new Promise((resolve, reject) => {
                $.getJSON(url)
                    .done(function (jsonData) {
                        // 1. Success: The data is already parsed as a JS object.
                        // This corresponds to steps 1, 2 (if status is 200), and 3 in your original function.
                        resolve(jsonData);
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) {
                        // 2. Failure: Handles network errors, 4xx/5xx status codes, and JSON parsing errors.
                        let errorMessage = `Failed to load JSON data from ${url}.`;

                        if (textStatus === "parsererror") {
                            errorMessage += " JSON parsing failed.";
                        } else if (errorThrown) {
                            // errorThrown will often contain the HTTP status text (e.g., "Not Found").
                            errorMessage += ` HTTP error: ${errorThrown}`;
                        } else {
                            errorMessage += ` Status: ${jqXHR.status}`;
                        }

                        console.error(errorMessage, jqXHR);
                        // Reject the promise so the calling function can catch the error.
                        reject(new Error(errorMessage));
                    });
            });
        }

        function showPage(pageId) {
            $('.page').addClass('hidden');
            $('#' + pageId).removeClass('hidden');
            $('#anime-detail-panel').addClass('hidden');

            $('.nav-item').removeClass('active').css('border-bottom', 'none');
            const dataPage = pageId.replace('page-', '').replace('-results', '');
            activePage = dataPage;

            if (pageId === 'page-filter') {
                $(`.nav-item[data-page="filter"]`).addClass('active');
            } else {
                $(`.nav-item[data-page="${dataPage}"]`).addClass('active');
            }

            if (pageId === 'page-archive') {
                $('.archive-letter').removeClass('active');
                if (currentArchiveFilter) {
                    renderArchiveList(currentArchiveFilter);
                    $(`.archive-letter[data-letter="${currentArchiveFilter}"]`).addClass('active');
                } else {
                    $('#anime-archive-table').html('<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500" id="archive-empty-message">Select a letter to filter the guides.</td></tr>');
                    $('#archive-title').text('All Topics');
                }
            }
        }

        function renderSurvivalTopicList(topics, containerId) {
            const container = $(containerId);
            const topicCount = topics.length;
            container.empty();
            const isEmpty = topics.length === 0;

            function handleEmptyState(isEmpty, currentContainerId) {
                // Determine the ID of the specific "no results" message to show/hide
                let targetMessageId = null;
                if (currentContainerId === '#latest-episodes') {
                    targetMessageId = '#latest-empty-message';
                } else if (currentContainerId === '#filtered-results-list') {
                    targetMessageId = '#filter-no-results';
                }

                // Specific container for latest episodes that needs style adjustments
                const latestContainer = $('#latest-episodes-container');

                if (targetMessageId) {
                    $(targetMessageId).toggleClass('hidden', !isEmpty);
                }

                if (currentContainerId === '#latest-episodes') {
                    // Adjust parent container styling for centering when empty
                    latestContainer.css({
                        'display': isEmpty ? 'flex' : 'block',
                        'align-items': isEmpty ? 'center' : 'initial',
                        'justify-content': isEmpty ? 'center' : 'initial'
                    });

                    const $latestCount = $('#latest-count');
                    $latestCount.text(topicCount);
                }

                if (currentContainerId === '#popular-series') {
                    const $popularCount = $('#popular-count');
                    $popularCount.text(topicCount);
                }
            }

            // Apply the empty state logic
            handleEmptyState(isEmpty, containerId);

            // Stop rendering if the list is empty after handling the empty state
            if (isEmpty) return;

            topics.forEach(guideTopic => {
                // Tag for the "Step" (e.g., 'Step 1: Introduction')
                const stepTag = guideTopic.step ? `<p class="text-xs text-orange-500/80 mb-1">${guideTopic.step}</p>` : '';

                // Badge for the "Type" (e.g., 'Video', 'Article') - MOVED TO ITS OWN ROW
                // Adjusted margin bottom from mb-2 to mb-1 for tighter spacing
                const typeTag = guideTopic.type ? `<div class="mb-1 flex-shrink-0"><span class="bg-orange-600 text-white text-xs font-bold px-2 py-0.5 rounded-full">${guideTopic.type}</span></div>` : '';

                // Badges for multiple "Categories"
                const categoryBadges = guideTopic.categories ? guideTopic.categories.map(cat =>
                    `<span class="text-xs text-gray-400 px-1 border border-gray-600 rounded-sm">${cat}</span>`
                ).join(' ') : '';

                const itemEvent = activePage === 'home' && containerId !== '#popular-series' ? `renderFeaturedTopic(${guideTopic.id}); showPage('page-home'); smoothScrollToTop(); return false;` : `showTopicModal(${guideTopic.id}); smoothScrollToTop(); return false;`;

                const itemHtml = `
                                <a href="#" data-topic-id="${guideTopic.id}" class="topic-item block relative p-4 border border-gray-600 bg-gray-900/50 rounded-lg hover:bg-gray-800 transition duration-300 shadow-md mb-3"
                                    onclick="${itemEvent}">

                                    ${typeTag}

                                    <div class="mb-1">
                                        <p class="text-sm font-semibold text-white">${guideTopic.title}</p>
                                        ${stepTag}
                                    </div>

                                    <div class="flex flex-wrap gap-1 mt-2 pt-2 border-t border-gray-700/50">
                                        ${categoryBadges}
                                    </div>

                                </a>
                            `;
                container.append(itemHtml);
            });
        }

        /**
         * Renders the full topic details in the Featured Tutorial section on the Home page.
         * This function handles navigation logic and sets up the modal button.
         */
        function renderFeaturedTopic(id) {
            const topic = DATA.find(a => a.id === id);
            if (!topic) return;

            // 1. Update Home Page Featured Section
            $('#featured-title').text(topic.title);

            const $featuredImage = $('#featured-image');
            // Keep the reference to the page details element
            const $featuredPageDetails = $('#featured-page-details');

            // Use fallback if image is explicitly empty or null
            const imageUrl = topic.image || FALLBACK_IMAGE_URL;
            $featuredImage.attr('src', imageUrl).attr('alt', topic.title);

            // Add error handler specifically for the featured image
            $featuredImage.off('error').on('error', function () {
                // Prevent infinite loop if fallback image also fails
                if ($(this).attr('src') !== FALLBACK_IMAGE_URL) {
                    $(this).attr('src', FALLBACK_IMAGE_URL);
                }
            });

            // This uses the topic's description (Key Explanation)
            $('#featured-explanation').text(topic.description);

            // Quick Steps Snippet (How-To Snippet)
            const stepsContainer = $('#featured-steps-snippet').empty();
            // This uses the topic's quickSteps (unique guide data)
            (topic.quickSteps || []).slice(0, 4).forEach((step, index) => {
                stepsContainer.append(`<p class="flex items-start"><span class="text-orange-400 mr-2 font-bold">${index + 1}.</span> ${step}</p>`);
            });
            if ((topic.fullSteps || []).length > 4) {
                stepsContainer.append(`<p class="text-sm text-gray-400 mt-2">... view full guide for all ${topic.fullSteps.length} steps.</p>`);
            } else if ((topic.fullSteps || []).length === 0) {
                stepsContainer.append(`<p class="text-sm text-gray-400">No quick steps available. View full guide for details.</p>`);
            }

            // Categories
            const catContainer = $('#featured-categories').empty();
            if (topic.categories) {
                topic.categories.forEach(cat => {
                    const badge = `<span class="bg-orange-600 text-white text-xs font-semibold px-2 py-1 rounded-full">${cat}</span>`;
                    catContainer.append(badge);
                });
            }

            // 2. Set Current State & Update Navigation
            currentFeaturedTopicId = id;
            const allIds = DATA.map(t => t.id);
            const currentIndex = allIds.indexOf(id);
            const totalTopics = allIds.length; // Total count of topics

            const prevButton = $('#prev-featured');
            const nextButton = $('#next-featured');

            prevButton.prop('disabled', currentIndex <= 0);
            nextButton.prop('disabled', currentIndex >= totalTopics - 1);

            // ‚≠êÔ∏è Modification to Populate Page Details
            if ($featuredPageDetails.length) {
                // Display as (Current Index + 1) of (Total Topics)
                $featuredPageDetails.text(`${currentIndex + 1} of ${totalTopics}`);
            }

            // 3. Mark as viewed
            markWatched(topic.id, topic.title, topic.type);
        }

        // NEW: Smooth Scroll Function
        function smoothScrollToTop() {
            $('html, body').animate({
                scrollTop: 0
            }, 500); // 500ms duration for a smooth scroll
        }

        // --- Hotline Functions ---

        function setupHotlineDropdown() {
            const countrySelect = $('#country-select');
            countrySelect.empty();

            // Add options based on the EMERGENCY_HOTLINES keys
            Object.keys(EMERGENCY_HOTLINES).forEach(key => {
                const country = EMERGENCY_HOTLINES[key];
                const option = $(`<option value="${key}">${country.name}</option>`);
                countrySelect.append(option);
            });

            // Set the default selection (Philippines)
            countrySelect.val('philippines');
        }

        function renderHotlines(countryKey) {
            const listContainer = $('#hotlines-list').empty();
            const countryData = EMERGENCY_HOTLINES[countryKey];

            if (!countryData) {
                listContainer.html('<li class="text-gray-400">Hotline data not found for this country.</li>');
                return;
            }

            countryData.lines.forEach(line => {
                const lineHtml = `
                <li class="border-b border-gray-700 pb-1 flex flex-col sm:flex-row justify-between items-start sm:items-baseline">
                    <span class="font-bold text-gray-300 w-full sm:w-7/12 flex-shrink-0 mb-1 sm:mb-0">${line.service}:</span>

                    <a href="${line.link}" class="text-orange-400 hover:text-orange-500 transition font-mono text-right w-full sm:w-auto">${line.number}</a>
                </li>
            `;
                listContainer.append(lineHtml);
            });
        }

        // NEW: Render Survival Rules page
        function renderSurvivalRules() {
            const container = $('#page-search-results');
            const contentContainer = $('#rules-content').empty();

            $('#rules-title').text(SURVIVAL_RULES.title);
            // Construct the content dynamically
            SURVIVAL_RULES.content.forEach(item => {
                if (item.type === 'p') {
                    contentContainer.append(`<p class="mb-4">${item.text}</p>`);
                } else if (item.type === 'h3') {
                    contentContainer.append(`<h3 class="text-xl font-bold border-b border-gray-700 pb-1 mb-3 mt-4 text-white">${item.text}</h3>`);
                } else if (item.type === 'ul') {
                    const list = $(`<ul class="list-disc ${item.listClass || ''} space-y-1 mb-4"></ul>`);
                    item.items.forEach(listItem => {
                        list.append(`<li>${listItem}</li>`);
                    });
                    contentContainer.append(list);
                }
            });
        }


        // --- Other Functions (Modal, Archive, Filter, History - Unchanged Logic) ---

        function showTopicModal(id) {
            const topic = DATA.find(a => a.id === id);
            if (!topic) return;

            $('#modal-title').text(topic.title);
            $('#modal-explanation').text(topic.description);

            // Render Full Steps
            const stepsContainer = $('#modal-steps-container').empty();
            (topic.fullSteps || []).forEach((stepObj, index) => {
                const stepHtml = `
                <div class="instruction-step">
                    <span class="instruction-step-number">${index + 1}</span>
                    <div>
                        <p class="text-sm font-semibold text-white">${stepObj.step}</p>
                        <p class="text-xs text-gray-400 mt-0.5">${stepObj.detail}</p>
                    </div>
                </div>
            `;
                stepsContainer.append(stepHtml);
            });
            if ((topic.fullSteps || []).length === 0) {
                stepsContainer.html('<p class="text-gray-400">No detailed steps provided for this guide.</p>');
            }

            // NEW: Render Dos
            const dosContainer = $('#modal-dos-container').empty();
            (topic.dos || []).forEach(item => {
                dosContainer.append(`<li>${item}</li>`);
            });
            if ((topic.dos || []).length === 0) {
                dosContainer.html('<li class="text-gray-500 list-none">No specific DOs listed.</li>');
            }

            // NEW: Render Don'ts
            const dontsContainer = $('#modal-donts-container').empty();
            (topic.donts || []).forEach(item => {
                dontsContainer.append(`<li>${item}</li>`);
            });
            if ((topic.donts || []).length === 0) {
                dontsContainer.html('<li class="text-gray-500 list-none">No specific DON\'Ts listed.</li>');
            }

            // Render Examples
            const examplesContainer = $('#modal-examples').empty();
            (topic.examples || []).forEach((example, index) => {
                examplesContainer.append(`<p class="bg-gray-700 p-3 rounded"><span class="font-bold text-orange-400">Scenario/Example ${index + 1}:</span> ${example}</p>`);
            });
            if ((topic.examples || []).length === 0) {
                examplesContainer.html('<p class="text-gray-400">No practical examples provided for this guide.</p>');
            }

            // ‚≠êÔ∏è MODIFICATION: Add justify-center and items-center to center the modal content
            $('#detail-modal').removeClass('hidden').addClass('flex justify-center items-center');

            // Also ensure your #detail-modal has the following CSS setup in its HTML/CSS:
            // class="fixed inset-0 z-50 bg-black bg-opacity-70 hidden"
        }


        function renderArchiveLinks() {
            const container = $('#anime-archive-links').empty();
            const archiveGrid = $('<div class="grid grid-cols-7 sm:grid-cols-9 lg:grid-cols-13 gap-1"></div>');

            animeArchiveLinks.forEach(item => {
                const link = $(`<a href="#" data-letter="${item.letter}" class="archive-letter text-center font-bold text-xs bg-gray-700 p-1 rounded hover:bg-orange-500 hover:text-gray-900 transition duration-200">${item.letter}</a>`);
                link.on('click', function (e) {
                    e.preventDefault();
                    $('.archive-letter').removeClass('active');
                    $(this).addClass('active');

                    renderArchiveList(item.letter);
                });
                archiveGrid.append(link);
            });
            container.append(archiveGrid);
        }

        function renderArchiveList(filterLetter = currentArchiveFilter) {
            currentArchiveFilter = filterLetter;
            if (!filterLetter) return;

            $('#archive-title').text(`Topics Starting With: ${filterLetter}`);

            let filteredList = DATA.filter(topic => {
                const firstChar = topic.title.charAt(0).toUpperCase();
                if (filterLetter === '0-9') {
                    return !isNaN(parseInt(firstChar));
                } else {
                    return firstChar === filterLetter;
                }
            });

            const sortBy = $('#archive-sort-by').val();
            const sortOrder = $('#archive-sort-order').val();

            filteredList.sort((a, b) => {
                let valA, valB;

                if (sortBy === 'title') {
                    valA = a.title.toLowerCase();
                    valB = b.title.toLowerCase();
                } else if (sortBy === 'type') {
                    valA = a.type || '';
                    valB = b.type || '';
                } else if (sortBy === 'date') {
                    valA = a.date ? a.date.getTime() : 0;
                    valB = b.date ? b.date.getTime() : 0;
                }

                if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
                if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
                return 0;
            });

            const container = $('#anime-archive-table').empty();

            const $resultCount = $('#archive-result-count');
            $resultCount.text(filteredList.length);

            if (filteredList.length === 0) {
                container.html(`<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No guides found starting with '${filterLetter}'.</td></tr>`);
                return;
            }

            filteredList.forEach(topic => {
                const dateString = 'n/a';// topic.date ? topic.date.toLocaleDateString() : 'N/A';
                const categoriesString = topic.categories ? topic.categories.slice(0, 2).join(', ') + (topic.categories.length > 2 ? '...' : '') : 'N/A';

                const typeBadgeClass = topic.type === 'First Aid' ? 'bg-red-700 text-white' : topic.type === 'Preparedness' ? 'bg-green-700 text-white' : 'bg-orange-600 text-white';
                const event = `showTopicModal(${topic.id});`; // `renderFeaturedTopic(${topic.id}); showPage('page-home'); smoothScrollToTop();`;

                const rowHtml = `
                        <tr class="hover:bg-gray-700 transition duration-150 cursor-pointer" onclick="${event}">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-white">${topic.title}</div>
                                <div class="text-xs text-orange-400">${topic.type}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${typeBadgeClass}">
                                    ${topic.status || 'N/A'}
                                </span>
                            </td>
                            <td class="px-6 py-4 text-sm text-gray-400 max-w-xs truncate">${categoriesString}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${dateString}</td>
                        </tr>
                    `;
                container.append(rowHtml);
            });
        }

        function renderFilterPage(page) {
            currentPage = page;
            const totalItems = currentFilteredResults.length;
            const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
            const start = (currentPage - 1) * ITEMS_PER_PAGE;
            const end = start + ITEMS_PER_PAGE;
            const paginatedList = currentFilteredResults.slice(start, end);

            renderSurvivalTopicList(paginatedList, '#filtered-results-list');
            renderPaginationControls(totalPages, currentPage, '#filter-pagination', renderFilterPage);
        }

        function setupFilterDropdowns() {
            const $filterDay = $('#filter-day'); for (let i = 1; i <= 31; i++) { $filterDay.append(`<option value="${i}">${i}</option>`); }
            const $filterMonth = $('#filter-month'); MONTHS.forEach((month, index) => { $filterMonth.append(`<option value="${index + 1}">${month}</option>`); });
            const $filterYear = $('#filter-year'); const currentYear = new Date().getFullYear(); for (let i = 0; i < 5; i++) { $filterYear.append(`<option value="${currentYear - i}">${currentYear - i}</option>`); }
            const $filterCategory = $('#filter-category');
            ALL_CATEGORIES.forEach(cat => { $filterCategory.append(`<option value="${cat}">${cat}</option>`); });
        }

        function applyFilter() {
            const day = $('#filter-day').val();
            const month = $('#filter-month').val();
            const year = $('#filter-year').val();
            const category = $('#filter-category').val();
            const searchTerm = $('#filter-search-input').val().toLowerCase().trim();

            // Start with all topic data
            let results = DATA;

            // 1. Apply Search Term Filter
            if (searchTerm) {
                results = results.filter(topic => topic.title.toLowerCase().includes(searchTerm) || (topic.description && topic.description.toLowerCase().includes(searchTerm)));
            }

            // 2. Apply Date and Category Filters
            if (day || month || year || category) {
                results = results.filter(topic => {
                    const d = topic.date; // Use the Date object
                    const matchesDay = !day || (d && d.getDate() == parseInt(day));
                    const matchesMonth = !month || (d && (d.getMonth() + 1) == parseInt(month));
                    const matchesYear = !year || (d && d.getFullYear() == parseInt(year));
                    const matchesCategory = !category || (topic.categories && topic.categories.includes(category));

                    return matchesDay && matchesMonth && matchesYear && matchesCategory;
                });
            }

            currentFilteredResults = results;

            const $resultCount = $('#search-result-count');
            $resultCount.text(results.length);
            renderFilterPage(1);
        }

        function filterLatest() {
            // Reset filter controls visually AND clear search box
            $('#filter-day').val('');
            $('#filter-month').val('');
            $('#filter-year').val('');
            $('#filter-category').val('');
            $('#filter-search-input').val('');

            applyFilter(); // Apply empty filter on all data to show everything
        }

        function renderPaginationControls(totalPages, activePage, containerId, callback) {
            const container = $(containerId).empty();
            if (totalPages <= 1) return;

            const prevButton = $(`<button class="bg-gray-700 text-white p-2 rounded hover:bg-orange-600 transition" ${activePage === 1 ? 'disabled' : ''}>Previous</button>`);
            prevButton.on('click', () => callback(activePage - 1));
            if (activePage === 1) prevButton.prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
            container.append(prevButton);

            for (let i = 1; i <= totalPages; i++) {
                const buttonClass = i === activePage ? 'bg-orange-600 text-white' : 'bg-gray-700 text-gray-300 hover:bg-gray-600';
                const button = $(`<button class="w-8 h-8 rounded ${buttonClass} text-sm font-bold">${i}</button>`);
                button.on('click', () => callback(i));
                container.append(button);
            }

            const nextButton = $(`<button class="bg-gray-700 text-white p-2 rounded hover:bg-orange-600 transition" ${activePage === totalPages ? 'disabled' : ''}>Next</button>`);
            nextButton.on('click', () => callback(activePage + 1));
            if (activePage === totalPages) nextButton.prop('disabled', true).addClass('opacity-50 cursor-not-allowed');
            container.append(nextButton);
        }

        function markWatched(id, title, detail) {
            const history = getWatchedHistory();
            const now = new Date().toLocaleString();
            const newItem = { id, title, detail, watchedAt: now };
            const newHistory = history.filter(item => item.id !== id);
            newHistory.unshift(newItem);
            const finalHistory = newHistory.slice(0, 30);
            try { localStorage.setItem('watchedHistory', JSON.stringify(finalHistory)); } catch (e) { console.error("Could not save history to localStorage:", e); }
            if (!$('#page-history').hasClass('hidden')) { renderWatchedHistory(finalHistory); }
        }

        function getWatchedHistory() {
            try { return localStorage.getItem('watchedHistory') ? JSON.parse(localStorage.getItem('watchedHistory')) : []; } catch (e) { return []; }
        }

        function renderWatchedHistory(historyList) {
            const history = historyList || getWatchedHistory();
            const container = $('#watched-history-list').empty();
            if (history.length === 0) { container.append('<li class="text-gray-400" id="empty-history-message">Your history is empty.</li>'); $('#clear-history').addClass('hidden'); return; }
            $('#clear-history').removeClass('hidden');
            history.forEach(item => {
                const event = `showTopicModal(${item.id}); return false;`; //`renderFeaturedTopic(${item.id}); showPage('page-home'); smoothScrollToTop(); return false;`;
                const itemHtml = `
                        <li class="border-b border-gray-700 pb-2 flex justify-between items-center">
                            <div><p class="font-bold text-white hover:text-orange-400 transition">${item.title} - <span class="text-orange-400">${item.detail}</span></p>
                            <span class="text-xs text-gray-500">Last viewed: ${item.watchedAt}</span></div>
                            <a href="#" class="text-xs text-orange-400 hover:underline" onclick="${event}">View Again</a>
                        </li>`;
                container.append(itemHtml);
            });
        }

        function clearHistory() {
            if (confirm("Are you sure you want to clear your entire view history?")) {
                localStorage.removeItem('watchedHistory');
                renderWatchedHistory([]);
            }
        }

        function renderAllCategoryBadges() {
            const container = $('#all-categories-badges').empty();
            ALL_CATEGORIES.forEach(cat => {
                const badge = $(`<button class="bg-gray-700 text-orange-500 text-sm font-semibold px-3 py-1 rounded-full hover:bg-orange-600 hover:text-white transition">${cat}</button>`);
                badge.on('click', function () {
                    // Set category filter and trigger search page
                    $('#filter-category').val(cat);
                    applyFilter();
                    showPage('page-filter');
                });
                container.append(badge);
            });
        }

        // --- Initialization ---

        $(document).ready(function () {
            let retryCount = 0;
            const MAX_RETRIES = 15;
            const RETRY_DELAY_MS = 1000;
            
            async function initializeApp() {
                console.log(`Attempting to load JSON data (Attempt ${retryCount + 1})...`);
                
                try {
                    // Load Data - Assuming loadJsonData returns null/undefined or throws on failure
                    const jsonData = await loadJsonData('assets/disaster_helper.json');
            
                    if (!jsonData) {
                        // Handle cases where loadJsonData returns a falsy value but doesn't throw
                        throw new Error("JSON data loading failed: returned falsy value.");
                    }
            
                    // --- Data Processing (Your original code) ---
                    EMERGENCY_HOTLINES = jsonData.emergencyHotlines;
                    ALL_CATEGORIES = jsonData.categories;
                    TOPIC_TYPES = jsonData.types;
                    SURVIVAL_RULES = jsonData.survivalRules;
                    popularGuides = jsonData.popularSurvivalGuides;
                    guidesData = jsonData.survivalGuides;
                    DATA = [...guidesData, ...popularGuides];
            
                    const randomIndex = Math.floor(Math.random() * popularGuides.length);
                    const randomGuide = popularGuides[randomIndex];
                    currentFeaturedTopicId = randomGuide.id;
            
                    if (currentFeaturedTopicId) {
                        renderFeaturedTopic(currentFeaturedTopicId);
                    }
            
                    renderHotlines('philippines'); // Default to Philippines
            
                    // Initial Content Rendering
                    renderSurvivalTopicList(guidesData.slice(0, ITEMS_PER_PAGE), '#latest-episodes');
                    renderSurvivalTopicList(popularGuides, '#popular-series');
                    renderWatchedHistory();
                    renderAllCategoryBadges();
            
                    // Render Archive Links (A-Z)
                    renderArchiveLinks();
            
                    // Setup and Render Emergency Hotline List
                    setupHotlineDropdown();
            
                    // Setup Filter/Search Page
                    setupFilterDropdowns();
            
                    const year = new Date().getFullYear();
                    const yearElement = document.getElementById('currentYear');
                    if (yearElement) {
                        yearElement.textContent = year;
                    }
                    // --- End of Data Processing ---
            
                    console.log("JSON data loaded and app initialized successfully.");
                    retryCount = 0; // Reset retry count on success
            
                } catch (error) {
                    console.error("Error loading JSON data:", error);
                    
                    if (retryCount < MAX_RETRIES) {
                        retryCount++;
                        console.log(`Retrying in ${RETRY_DELAY_MS / 1000} seconds... (Retry ${retryCount}/${MAX_RETRIES})`);
                        
                        setTimeout(initializeApp, RETRY_DELAY_MS);
                    } else {
                        console.error("Maximum retries reached. App initialization failed.");
                    }
                }
            }

            initializeApp();

            // Bind the applyFilter function to both the main search button and the detailed filter button
            $('#apply-filter').on('click', applyFilter);
            $('#search-apply-button').on('click', applyFilter);
            $('#filter-search-input').on('keypress', function (e) { if (e.which === 13) { applyFilter(); } });

            $('#reset-filter').on('click', function () {
                $('#filter-day').val('');
                $('#filter-month').val('');
                $('#filter-year').val('');
                $('#filter-category').val('');
                $('#filter-search-input').val('');
                applyFilter(); // Apply empty filter
            });

            // Setup Archive Sorting Handler
            $('#apply-archive-sort').on('click', function () {
                renderArchiveList(); // Re-render with new sort criteria
            });

            // --- Featured Topic Navigation Handlers ---
            $('#prev-featured').on('click', () => {
                const allIds = DATA.map(t => t.id);
                const currentIndex = allIds.indexOf(currentFeaturedTopicId);
                if (currentIndex > 0) {
                    renderFeaturedTopic(allIds[currentIndex - 1]);
                }
            });

            $('#next-featured').on('click', () => {
                const allIds = DATA.map(t => t.id);
                const currentIndex = allIds.indexOf(currentFeaturedTopicId);
                if (currentIndex < allIds.length - 1) {
                    renderFeaturedTopic(allIds[currentIndex + 1]);
                }
            });

            // --- Modal Handlers ---
            $('#close-modal').on('click', () => {
                $('#detail-modal').addClass('hidden').removeClass('flex');
            });
            $('#detail-modal').on('click', function (e) {
                // Close modal if user clicks on the backdrop
                if ($(e.target).is(this)) {
                    $('#detail-modal').addClass('hidden').removeClass('flex');
                }
            });
            $('#show-details-modal').on('click', () => {
                showTopicModal(currentFeaturedTopicId);
            });

            // --- Event Handlers ---
            $('.nav-item').on('click', function (e) {
                e.preventDefault();
                const page = $(this).data('page');
                if (page === 'history') { renderWatchedHistory(); }
                showPage('page-' + page);
                smoothScrollToTop(); // Added smooth scroll on navigation
            });
            $('#clear-history').on('click', clearHistory);

            showPage('page-home');
        });
    </script>
</body>

</html>
