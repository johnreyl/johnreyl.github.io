<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Puter.js Unlimited Image Gallery</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Load Puter.js -->
    <script src="https://js.puter.com/v2/"></script>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles for loading and layout */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 */
        }
        .container-card {
            max-width: 900px;
            width: 100%;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="container-card mx-auto">
        <div class="bg-white p-6 md:p-8 rounded-xl shadow-2xl mb-6">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-1 text-center">
                üñºÔ∏è Puter.js Art Gallery
            </h1>
            <p class="text-md text-indigo-600 font-semibold mb-6 text-center">
                Unlimited Image Generation (Puter.js Test Mode)
            </p>

            <!-- Prompt Input -->
            <div class="mb-4">
                <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">Enter your prompt:</label>
                <textarea id="prompt" class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 resize-none" rows="3" placeholder="e.g., A futuristic city floating in the sky, cinematic lighting, 8k"></textarea>
            </div>
            
            <!-- Controls -->
            <div class="flex flex-col sm:flex-row gap-3">
                <button id="generate" class="flex-grow flex items-center justify-center px-6 py-3 text-white bg-indigo-600 rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out font-semibold disabled:opacity-50" disabled>
                    <span id="buttonText">Generate Image</span>
                    <div id="loadingIcon" class="spinner ml-3 hidden"></div>
                </button>
                <button id="clear" class="w-full sm:w-auto px-6 py-3 text-gray-700 bg-gray-200 rounded-lg shadow-md hover:bg-gray-300 transition duration-150 ease-in-out font-semibold">
                    Clear All
                </button>
            </div>

            <!-- Loading Status -->
            <div id="loadingMessage" class="text-center mt-4 hidden">
                <div class="text-indigo-600 font-medium">
                    Generating image... This may take a moment.
                </div>
            </div>
        </div>

        <!-- Gallery -->
        <div id="gallery" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Images will be prepended here -->
        </div>
        
        <div id="emptyGalleryMessage" class="text-center text-gray-500 mt-12 text-lg">
            Start by entering a prompt and clicking "Generate Image"!
        </div>
    </div>

    <script>
        // --- DOM Elements & State ---
        const promptInput = document.getElementById('prompt');
        const generateBtn = document.getElementById('generate');
        const clearBtn = document.getElementById('clear');
        const gallery = document.getElementById('gallery');
        const loadingIcon = document.getElementById('loadingIcon');
        const buttonText = document.getElementById('buttonText');
        const loadingMessage = document.getElementById('loadingMessage');
        const emptyGalleryMessage = document.getElementById('emptyGalleryMessage');

        let isGenerating = false;

        // --- Utility Functions ---

        /** Shows a notification using Puter.js if available, falls back to console. */
        function showNotification(message, type = 'info') {
            if (window.puter && puter.ui && puter.ui.notify) {
                puter.ui.notify({ message, type });
            } else {
                console.log(`[Notification - ${type.toUpperCase()}]: ${message}`);
            }
        }

        /** Sets the UI state for buttons and loading indicators. */
        function setUIState(generating) {
            isGenerating = generating;
            promptInput.disabled = generating;
            generateBtn.disabled = generating || promptInput.value.trim() === '';
            clearBtn.disabled = generating;
            
            loadingIcon.classList.toggle('hidden', !generating);
            loadingMessage.classList.toggle('hidden', !generating);
            buttonText.textContent = generating ? 'Generating...' : 'Generate Image';
        }

        /** Converts an <img> element to a downloadable blob URL. */
        async function getImageBlobUrl(imgElement) {
            return new Promise((resolve, reject) => {
                const canvas = document.createElement("canvas");
                // Use natural dimensions if loaded, otherwise default
                canvas.width = imgElement.naturalWidth || 512;
                canvas.height = imgElement.naturalHeight || 512; 
                const ctx = canvas.getContext("2d");
                
                // Draw the image onto the canvas
                ctx.drawImage(imgElement, 0, 0, canvas.width, canvas.height);
                
                // Get the blob
                canvas.toBlob((blob) => {
                    if (blob) {
                        resolve(URL.createObjectURL(blob));
                    } else {
                        reject(new Error("Failed to create blob from image."));
                    }
                }, "image/png");
            });
        }

        // --- Gallery Management ---

        /** Adds a new image card to the gallery. */
        function addToGallery(imageEl, prompt, isPlaceholder) {
            const id = "img-" + Date.now();
            const promptShort = prompt.length > 50 ? prompt.substring(0, 50) + '...' : prompt;

            // Apply Tailwind classes for modern card design
            const cardHTML = `
                <div class="col" id="${id}">
                    <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 overflow-hidden">
                        <div class="p-1 bg-gray-100">
                            <!-- Image container -->
                            <div class="relative aspect-square flex items-center justify-center bg-gray-200 rounded-lg">
                                ${imageEl.outerHTML}
                            </div>
                        </div>
                        <div class="p-3">
                            <p class="text-sm text-gray-800 font-medium mb-1 line-clamp-2" title="${prompt}">
                                ${promptShort}
                            </p>
                            ${isPlaceholder ? `<p class="text-red-500 text-xs font-semibold mb-2">(Placeholder: Generation Failed)</p>` : ""}
                            <div class="flex gap-2 pt-2 border-t border-gray-100">
                                <button class="btn btn-sm flex-1 download-btn bg-green-500 hover:bg-green-600 text-white font-semibold py-1.5 rounded-lg text-xs transition" data-id="${id}">
                                    Download
                                </button>
                                <button class="btn btn-sm remove-btn bg-red-500 hover:bg-red-600 text-white font-semibold py-1.5 rounded-lg text-xs transition" data-target="${id}">
                                    Remove
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Prepend the new card to the gallery
            gallery.insertAdjacentHTML('afterbegin', cardHTML.trim());
            updateEmptyMessage();
        }

        /** Updates the visibility of the "empty gallery" message. */
        function updateEmptyMessage() {
            emptyGalleryMessage.classList.toggle('hidden', gallery.children.length > 0);
        }

        // --- Event Handlers ---

        /** Handles the image generation process. */
        async function handleGenerateClick() {
            const prompt = promptInput.value.trim();
            if (!prompt || isGenerating) return;

            setUIState(true);
            
            try {
                // Call Puter.js AI with testMode: true for unlimited, free usage
                const imageEl = await puter.ai.txt2img(prompt, false); 

                // Check if a valid <img> element was returned
                if (!imageEl || imageEl.tagName !== 'IMG') {
                    throw new Error('Puter.js failed to return a valid image element.');
                }
                
                // Set necessary attributes for the image to display correctly
                imageEl.classList.add('w-full', 'h-full', 'object-contain', 'generated-img');
                imageEl.alt = prompt;

                addToGallery(imageEl, prompt, false);
                promptInput.value = ''; // Clear input after successful generation
                showNotification("Image generated successfully!", 'success');

            } catch (err) {
                console.error("Puter.js Generation Error:", err);
                
                // Fallback: Create a placeholder image
                const fallbackUrl = `https://placehold.co/512x512/ff5733/ffffff?text=Error: ${encodeURIComponent(prompt.substring(0, 20) + '...')}`;
                const fallbackImage = document.createElement('img');
                fallbackImage.src = fallbackUrl;
                fallbackImage.alt = "Placeholder image due to error";
                fallbackImage.onerror = () => { fallbackImage.src = 'https://placehold.co/512x512/CCCCCC/333333?text=ERROR'; };
                
                addToGallery(fallbackImage, prompt, true);
                showNotification("Generation failed. Placeholder image used.", 'error');

            } finally {
                setUIState(false);
            }
        }

        /** Handles image download click. */
        async function handleDownloadClick(e) {
            const downloadBtn = e.target.closest('.download-btn');
            if (!downloadBtn) return;
            
            e.preventDefault();
            
            const cardId = downloadBtn.dataset.id;
            const card = document.getElementById(cardId);
            const img = card ? card.querySelector(".generated-img") : null;
            const promptEl = card ? card.querySelector(".card-text") : null;

            if (!img) {
                showNotification("Error: Image element not found.", 'error');
                return;
            }

            try {
                // Temporarily disable the button during blob creation
                downloadBtn.disabled = true; 
                
                const blobUrl = await getImageBlobUrl(img);

                const a = document.createElement("a");
                a.href = blobUrl;
                
                // Clean up filename from prompt
                const promptText = promptEl ? promptEl.textContent.replace('Prompt:', '').trim() : 'generated';
                const filename = promptText.substring(0, 30).replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'generated_image';
                a.download = `${filename}.png`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(blobUrl);

                showNotification("Download started!", 'success');
            } catch (error) {
                console.error("Download Error:", error);
                showNotification("Failed to download image.", 'error');
            } finally {
                downloadBtn.disabled = false;
            }
        }

        /** Handles removing an image card. */
        function handleRemoveClick(e) {
            const removeBtn = e.target.closest('.remove-btn');
            if (!removeBtn) return;

            const targetId = removeBtn.dataset.target;
            const cardToRemove = document.getElementById(targetId);
            if (cardToRemove) {
                cardToRemove.remove();
                showNotification("Image removed from gallery.", 'info');
                updateEmptyMessage();
            }
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Initial state check
            promptInput.addEventListener('input', () => setUIState(isGenerating));
            setUIState(false); 
            updateEmptyMessage();

            // Set up main listeners
            generateBtn.addEventListener('click', handleGenerateClick);
            clearBtn.addEventListener('click', () => {
                gallery.innerHTML = '';
                promptInput.value = '';
                showNotification("Gallery cleared.", 'info');
                updateEmptyMessage();
            });

            // Set up delegated listeners for gallery actions
            gallery.addEventListener('click', handleDownloadClick);
            gallery.addEventListener('click', handleRemoveClick);
            
            showNotification("Puter.js Image Studio loaded successfully.", 'info');
        });
    </script>
</body>
</html>

