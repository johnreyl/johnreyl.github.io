<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Puter.js Image Analyzer & Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://js.puter.com/v2/"></script>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
img.preview { max-width: 200px; margin: 0.5rem; border:1px solid #ccc; border-radius:4px; display:block; }
#loadingIcon, #chatLoading { display:none; }
.resultBox { white-space: pre-wrap; background:#f8f9fa; padding:1rem; border-radius:0.5rem; margin-top:1rem; max-height:300px; overflow-y:auto; }
.invalidList { color:red; list-style-type:disc; margin-left:1rem; }
</style>
</head>
<body>
<div class="container">
<h1 class="mb-4">Puter.js Multi-Image Analyzer & Chat</h1>

<div class="mb-3">
    <label class="form-label">Image URL:</label>
    <input type="text" id="imageUrl" class="form-control" placeholder="Enter image URL">
</div>

<div class="mb-3">
    <label class="form-label">Or Upload Images:</label>
    <input type="file" id="imageFiles" class="form-control" multiple>
</div>

<div class="mb-3">
    <button id="analyzeBtn" class="btn btn-primary">Analyze Images</button>
    <span id="loadingIcon" class="spinner-border spinner-border-sm text-primary ms-2" role="status"></span>
</div>

<div id="imagesContainer" class="d-flex flex-wrap"></div>

<hr>

<h3>Interact with AI</h3>
<div class="mb-3">
    <textarea id="chatPrompt" class="form-control" rows="3" placeholder="Ask something about the analyzed images..."></textarea>
</div>
<div class="mb-3">
    <button id="chatBtn" class="btn btn-success">Send</button>
    <span id="chatLoading" class="spinner-border spinner-border-sm text-success ms-2" role="status"></span>
</div>
<div id="chatResult" class="resultBox"></div>
</div>

<script>
$(function(){
    let selectedImages = [];
    const chatHistory = []; // Keep AI interaction history

    function addPreview(src){
        const img = $('<img>').addClass('preview').attr('src', src);
        $('#imagesContainer').append(img);
    }

    // Handle file selection
    $('#imageFiles').on('change', function(e){
        selectedImages = [];
        $('#imagesContainer').empty();
        const files = e.target.files;
        Array.from(files).forEach(file=>{
            const url = URL.createObjectURL(file);
            selectedImages.push({src:url, name:file.name});
            addPreview(url);
        });
        $('#imageUrl').val('');
    });

    // Handle URL input
    $('#imageUrl').on('input', function(){
        const url = $(this).val().trim();
        if(url){
            selectedImages = [{src:url, name:'URL Image'}];
            $('#imagesContainer').empty();
            addPreview(url);
            $('#imageFiles').val('');
        }
    });

    // Analyze Images
    $('#analyzeBtn').on('click', async ()=>{
        if(selectedImages.length===0){ alert('Please select or enter images.'); return; }
        $('#loadingIcon').show();
        for(const imgObj of selectedImages){
            const container = $('<div class="mb-3"></div>');
            const resBox = $('<div class="resultBox">Analyzing...</div>');
            const invalidUl = $('<ul class="invalidList"></ul>');
            container.append(`<strong>${imgObj.name}</strong>`);
            container.append(resBox).append(invalidUl);
            $('#imagesContainer').append(container);

            try{
                const analysis = await puter.ai.chat(
                    "Analyze this image for content and describe it.",
                    imgObj.src,
                    {model:"gpt-5-nano"}
                );
                // Check for invalid prompts/nudity if available
                if(analysis.invalidPrompts && analysis.invalidPrompts.length>0){
                    analysis.invalidPrompts.forEach(p=>{
                        invalidUl.append(`<li>${p}</li>`);
                    });
                    resBox.text('Image flagged as invalid.');
                } else {
                    resBox.text(analysis);
                    chatHistory.push(`Analysis of ${imgObj.name}: ${analysis}`);
                }
            }catch(e){
                console.error(e);
                resBox.text('Error analyzing image.');
            }
        }
        $('#loadingIcon').hide();
        updateChatResult();
    });

    // Update chat result box
    function updateChatResult(){
        $('#chatResult').html(chatHistory.join("\n\n"));
        $('#chatResult').scrollTop($('#chatResult')[0].scrollHeight);
    }

    // Chat with AI about analyzed images
    $('#chatBtn').on('click', async ()=>{
        const prompt = $('#chatPrompt').val().trim();
        if(!prompt){ alert('Enter a question to ask the AI.'); return; }
        $('#chatLoading').show();
        try{
            // Include previous history as context
            const context = chatHistory.join("\n\n");
            const chatResp = await puter.ai.chat(`${context}\n\nUser: ${prompt}\nAI:`);
            chatHistory.push(`User: ${prompt}\nAI: ${chatResp}`);
            updateChatResult();
        }catch(e){
            console.error(e);
            chatHistory.push(`User: ${prompt}\nAI: Error communicating with AI.`);
            updateChatResult();
        }
        $('#chatLoading').hide();
        $('#chatPrompt').val('');
    });
});
</script>
</body>
</html>

