<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carla - HCBI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <style>
        /* Base Styling */
        body {
            font-family: "Inter", sans-serif;
            min-height: 100vh;
            background-color: #f7f7f7;
        }

        /* Fixed Position Container (Icon remains bottom right) */
        #carla-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }

        /* Carla Icon Button (Floating Image/Icon) */
        .carla-icon-btn {
            width: 70px;
            height: 70px;
            padding: 0;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 4px solid #fff;
            overflow: hidden;
            cursor: pointer;
            outline: none;
            background-color: #1f3a9a; /* Deep Blue for HCBI theme */
        }
        .carla-icon-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
        }

        /* Popover Styling */
        .carla-popover {
            width: 380px;
            height: 500px; 
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            /* Updated for better scroll control */
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        
        /* Header */
        .carla-popover-header {
            background-color: #1f3a9a; /* Deep Blue Header */
            color: white;
            flex-shrink: 0; 
        }

        /* Body (Chat Area) */
        .carla-popover-body {
            flex-grow: 1;
            /* CRUCIAL FIX: Changed 'auto' to 'scroll' to force the scrollbar to be visible */
            overflow-y: scroll; 
            padding: 1rem;
            background-color: #f9faff; /* Light blue background for chat */
        }

        /* ---------------------------------------------------- */
        /* Scrollbar Styling for Navigation */
        /* ---------------------------------------------------- */
        .carla-popover-body::-webkit-scrollbar {
            width: 8px; /* Width of the scrollbar */
        }
        .carla-popover-body::-webkit-scrollbar-thumb {
            /* Scrollbar handle */
            background-color: #a0a0a0; 
            border-radius: 10px;
            border: 2px solid #f9faff;
        }
        .carla-popover-body::-webkit-scrollbar-thumb:hover {
             background-color: #707070;
        }
        .carla-popover-body::-webkit-scrollbar-track {
             /* Scrollbar track */
            background: #f1f1f1;
        }
        /* ---------------------------------------------------- */

        /* Carla Response Bubble */
        .carla-response-container {
             display: flex;
             align-items: flex-start;
             margin-bottom: 1rem;
        }
        .carla-response-avatar {
             width: 32px;
             height: 32px;
             min-width: 32px;
             background-color: #1f3a9a; 
             color: white;
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
             margin-right: 0.5rem;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .carla-response {
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #d1d5db;
            max-width: 85%;
        }

        /* User Query Bubble */
        .user-query-container {
            display: flex;
            justify-content: flex-end;
            align-items: flex-end;
            margin-bottom: 1rem;
        }
        .user-query-avatar {
             width: 32px;
             height: 32px;
             min-width: 32px;
             background-color: #6366f1; /* Indigo for user */
             color: white;
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
             margin-left: 0.5rem;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .user-query-content {
             display: inline-block;
             max-width: 85%;
             background-color: #1f3a9a; /* Deep Blue Bubble */
             color: white;
             padding: 0.75rem;
             border-radius: 0.75rem 0.75rem 0 0.75rem;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }


        /* Input Area */
        .carla-popover-footer {
            border-top: 1px solid #e0e0e0;
            padding: 1rem;
            background-color: #ffffff;
            flex-shrink: 0; 
        }
        
        .loading-dots span {
            animation: pulse 1s infinite;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body>

    <div id="carla-container">
        <button id="carla-icon-btn" class="carla-icon-btn flex items-center justify-center">
            <div id="carla-btn-content" class="w-full h-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-white">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 9.75a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H7.5m2.25 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm3.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm3.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-2.625.75L15 15m-4.755-4.245L12 18m-4.245-2.25L7.5 21m-4.625-4.375l2.25 2.25M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
        </button>

        <div id="carla-popover" class="carla-popover absolute bottom-full right-0 mb-3">
            
            <div class="carla-popover-header p-4 flex justify-between items-center rounded-t-xl">
                <h2 class="text-lg font-bold">Carla - HCBI Assistant</h2>
                <button id="carla-close-btn" class="text-white hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="carla-popover-body" class="carla-popover-body flex flex-col">
                <div class="carla-response-container">
                    <div class="carla-response-avatar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                            <path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.065A8.243 8.243 0 0010 18.25a8.236 8.236 0 006.125-2.692 1.23 1.23 0 00.41-1.065A8.236 8.236 0 0010 10.75a8.236 8.236 0 00-6.535 3.743z" />
                        </svg>
                    </div>
                    <div class="carla-response shadow-md">
                        <h3 class="font-bold text-xl text-indigo-700 mb-2">Hello, I'm Carla!</h3>
                        <p class="text-gray-700">
                            I am your dedicated assistant for the **Healthcare Billing Institute (HCBI)**. I can help answer questions about our courses, certifications, and medical billing industry topics.
                        </p>
                        <p class="text-sm text-gray-500 mt-2">
                            Ask me anything about HCBI! For example: "What certifications do you offer?"
                        </p>
                    </div>
                </div>
            </div>

            <div class="carla-popover-footer">
                <div class="flex items-center space-x-2">
                    <input type="text" id="carla-input" placeholder="Ask a question..." 
                           class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                    
                    <button id="carla-ask-btn" class="px-3 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center justify-center" style="width: 44px; height: 44px;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6">
                            <path d="M3.105 2.15A1 1 0 014.28 1.488l14.02 7.01a1 1 0 010 1.764l-14.02 7.01A1 1 0 013.105 17.85L17.85 10l-14.745-7.85z" />
                        </svg>
                    </button>
                </div>
                <div id="carla-status" class="text-sm text-center text-gray-500 mt-2 hidden">
                    Carla is thinking<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Global variables for Firebase access (required by the execution environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Core Application Logic ---

        // 1. Local Knowledge Base (formerly data.csv)
        const localData = [
            {
                question: "What is HCBI's primary mission?",
                answer: "The Healthcare Billing Institute (HCBI) is dedicated to providing high-quality training and certification for medical billing and coding professionals.",
                keywords: ["mission", "purpose", "primary goal", "what is hcbi"]
            },
            {
                question: "Do you offer courses for beginners?",
                answer: "Yes, HCBI offers comprehensive beginner courses that cover the fundamentals of medical coding and billing, perfect for those new to the field. Check out our 'Medical Billing Specialist' course.",
                keywords: ["beginner", "new", "start", "entry level", "courses for beginners"]
            },
            {
                question: "Where can I find pricing information?",
                answer: "For current course pricing and enrollment details, please visit the 'Courses' section on the main Healthcare Billing Institute website (https://healthcarebillinginstitute.com).",
                keywords: ["price", "cost", "enrollment", "fees", "how much"]
            },
            {
                question: "What certifications do you offer?",
                answer: "HCBI offers several professional certifications, including the Certified Medical Biller (CMB) and the Certified Medical Coder (CMC), designed to boost your career prospects.",
                keywords: ["certification", "certifications", "cmb", "cmc", "licensed"]
            }
        ];

        /**
         * Formats the localData array into a string representation for the LLM prompt.
         * Format: [question, keyword|keyword, answer]
         */
        function formatLocalDataForPrompt() {
            let formattedData = "LOCAL KNOWLEDGE BASE (DATA.CSV):\n";
            localData.forEach(item => {
                const keywords = item.keywords.join('|');
                // Ensure the answer is clean and on one line for the prompt
                const answer = item.answer.replace(/\s+/g, ' ').trim(); 
                formattedData += `[${item.question}, ${keywords}, ${answer}]\n`;
            });
            return formattedData.trim();
        }


        // Function to search the local, embedded dataset (Fast Path)
        function searchLocalData(query) {
            const lowerQuery = query.toLowerCase();
            for (const item of localData) {
                // Check if the query contains the main question or any of the keywords
                if (lowerQuery.includes(item.question.toLowerCase()) || 
                    item.keywords.some(keyword => lowerQuery.includes(keyword))) {
                    return item.answer;
                }
            }
            return null;
        }

        // Function to update the chat body with the latest response
        function updateCarlaResponse(htmlContent, isUser=false) {
            const body = $('#carla-popover-body');
            
            if (isUser) {
                // User query with updated profile icon
                body.append(`
                    <div class="user-query-container">
                        <div class="user-query-content shadow-md">${htmlContent}</div>
                        <div class="user-query-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-5.5-2.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM10 12a5.99 5.99 0 00-4.72 2.72.75.75 0 00.33 1.05A7.472 7.472 0 0010 16a7.472 7.472 0 004.39-1.23.75.75 0 00.33-1.05A5.99 5.99 0 0010 12z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                `);
            } else {
                // Carla response with avatar
                body.append(`
                    <div class="carla-response-container">
                        <div class="carla-response-avatar">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.065A8.243 8.243 0 0010 18.25a8.236 8.236 0 006.125-2.692 1.23 1.23 0 00.41-1.065A8.236 8.236 0 0010 10.75a8.236 8.236 0 00-6.535 3.743z" />
                            </svg>
                        </div>
                        <div class="carla-response shadow-md">
                            ${htmlContent}
                        </div>
                    </div>
                `);
            }
            // Always scroll to the bottom to see the latest message
            body.scrollTop(body[0].scrollHeight);
        }

        // Global state for request in progress
        let isRequestInProgress = false;

        // Function to handle the LLM API call (with Google Search grounding for external HCBI content)
        async function geminiApiCall(userQuery, attempts = 0) {
            const maxRetries = 3;
            // Updated System Prompt to account for the injected 'LOCAL KNOWLEDGE BASE'
            const systemPrompt = "You are Carla, an expert assistant for the Healthcare Billing Institute (HCBI). Your goal is to answer questions using both a provided LOCAL KNOWLEDGE BASE (DATA.CSV) and Google Search grounding. 1. If the user's prompt includes a 'LOCAL KNOWLEDGE BASE', prioritize finding the answer there first. 2. If the LOCAL KNOWLEDGE BASE is insufficient or not present, you MUST use Google Search to find information specifically on the HCBI website (https://healthcarebillinginstitute.com) or related external sources. Keep your response professional, friendly, and concise. Only answer questions related to HCBI or medical billing.";
            const apiKey = "" 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && attempts < maxRetries) {
                        const delay = Math.pow(2, attempts) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return geminiApiCall(userQuery, attempts + 1);
                    }
                    throw new Error(`API request failed with status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;

                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title); 
                    }
                    
                    let sourceHtml = '';
                    if (sources.length > 0) {
                        // Only show unique source titles for conciseness
                        const uniqueSources = Array.from(new Set(sources.map(s => s.title)));
                        sourceHtml = `
                            <div class="mt-3 pt-3 border-t border-gray-100 text-xs text-gray-500">
                                <span class="font-semibold text-gray-600">Sources:</span> 
                                ${uniqueSources.join(', ')}
                            </div>`;
                    }

                    updateCarlaResponse(`
                        <h3 class="font-bold text-lg text-indigo-700 mb-2">Carla's Response:</h3>
                        <p class="text-gray-700">${text}</p>
                        ${sourceHtml}
                    `);

                } else {
                     updateCarlaResponse(`
                        <h3 class="font-bold text-lg text-red-500 mb-2">Error:</h3>
                        <p class="text-gray-700">I received an empty response. Please try phrasing your question differently.</p>
                    `);
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                 updateCarlaResponse(`
                    <h3 class="font-bold text-lg text-red-500 mb-2">Network Error:</h3>
                    <p class="text-gray-700">I encountered an issue connecting to the knowledge base. Please check your connection or try again later.</p>
                `);
            }
        }

        // Main function to answer the user's question
        async function answerQuestion(query) {
            query = query.trim();
            if (!query || isRequestInProgress) return;

            isRequestInProgress = true;
            $('#carla-input').prop('disabled', true).val(''); // Clear and disable input
            $('#carla-ask-btn').prop('disabled', true).addClass('opacity-50');
            $('#carla-status').removeClass('hidden');

            // 1. Display user query
            updateCarlaResponse(query, true);

            // 2. Check Local Knowledge Base (data.csv equivalent)
            const localAnswer = searchLocalData(query);
            
            if (localAnswer) {
                updateCarlaResponse(`
                    <h3 class="font-bold text-lg text-indigo-700 mb-2">Carla's Local Response:</h3>
                    <p class="text-gray-700">${localAnswer}</p>
                    <p class="text-xs text-gray-500 mt-2">This answer was retrieved from Carla's internal knowledge base (fast lookup).</p>
                `);
            } else {
                // 3. Call LLM API with Local Data as context
                
                // Construct the prompt to include the local data
                const dataPrompt = formatLocalDataForPrompt();
                const fullPrompt = `User Query: "${query}"\n\nIf the User Query can be answered by the data provided below (LOCAL KNOWLEDGE BASE), use that answer. Otherwise, proceed with search.\n\n${dataPrompt}`;
                
                await geminiApiCall(fullPrompt);
            }

            // 4. Reset state
            isRequestInProgress = false;
            $('#carla-input').prop('disabled', false).focus();
            $('#carla-ask-btn').prop('disabled', false).removeClass('opacity-50');
            $('#carla-status').addClass('hidden');
        }


        // --- Event Handlers and Initialization ---

        $(document).ready(function() {
            
            // --- Carla Image Loading Logic ---
            const carlaBtnContent = $('#carla-btn-content');
            const carlaSvg = carlaBtnContent.html(); // Store the default SVG

            // Function to load the image or fall back to SVG
            const loadCarlaImage = () => {
                const img = new Image();
                img.src = 'carla.jpg';
                img.alt = 'Carla Assistant Avatar';
                img.className = 'w-full h-full object-cover';
                
                // If image loads successfully, replace the SVG
                img.onload = function() {
                    carlaBtnContent.empty().append(img);
                };

                // If image fails to load, ensure the SVG is displayed (it's the default anyway)
                img.onerror = function() {
                    carlaBtnContent.html(carlaSvg); 
                };
            };

            // Run the image loading logic on initialization
            loadCarlaImage();

            // --- Popover Toggle and Close ---
            
            // Toggle Popover visibility
            $('#carla-icon-btn, #carla-close-btn').on('click', function(e) {
                e.stopPropagation(); // Prevent the click from immediately closing the popover via the document handler
                $('#carla-popover').slideToggle(200);
            });

            // Close popover when clicking outside the container
            $(document).on('click', function(e) {
                const container = $('#carla-container');
                const popover = $('#carla-popover');
                const iconBtn = $('#carla-icon-btn');
                
                // Check if the popover is visible and the click is outside the container (excluding the icon button itself)
                if (popover.is(':visible') && !container.is(e.target) && container.has(e.target).length === 0 && !iconBtn.is(e.target) && iconBtn.has(e.target).length === 0) {
                    popover.slideUp(200);
                }
            });

            // Prevent clicks inside the popover from closing it
            $('#carla-popover').on('click', function(e) {
                e.stopPropagation();
            });


            // --- Input and Ask Button Handlers ---
            
            // Bind Ask button and Enter key to the main Q&A function
            function handleAsk() {
                const query = $('#carla-input').val();
                if (query.trim()) {
                    answerQuestion(query);
                }
            }
            
            $('#carla-ask-btn').on('click', handleAsk);

            $('#carla-input').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    handleAsk();
                }
            });

        });
    </script>

</body>
</html>
