<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Task Planner (Cloud/Local Guest)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Professional Color Palette (Inspired by Google/Material) */
        :root {
            --color-primary: #1a73e8; /* Blue */
            --color-success: #34a853; /* Green */
            --color-warning: #fbbc05; /* Yellow/Warning */
            --color-info: #4285f4; /* Lighter Blue */
            --color-text-subtle: #5f6368; /* Gray Text */
            --color-danger: #ea4335; /* Red */
        }

        body { background-color: #f8f9fa; font-family: 'Roboto', sans-serif; }
        .container { max-width: 950px; margin-top: 30px; }
        .card { border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); border-radius: 8px; }
        
        /* Custom Colors */
        .bg-primary { background-color: var(--color-primary) !important; }
        .btn-primary { background-color: var(--color-primary); border-color: var(--color-primary); }
        .text-primary { color: var(--color-primary) !important; }

        /* Tabs and List Styling */
        .nav-link.active { font-weight: 500; border-bottom: 2px solid var(--color-primary); color: var(--color-primary) !important; background-color: transparent !important; }
        
        /* Home Tab Specific Styles */
        .home-banner {
            background: linear-gradient(135deg, #a400ff, #4285f4); 
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* Loading indicator for Firebase */
        #loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1050;
        }

        /* Custom Loading Overlay used by signInWithGoogle function */
        #auth-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: none; /* Starts hidden */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        /* Cloud Sync Modal Styling */
        .start-sync-modal-body {
            text-align: center;
            padding: 30px;
        }
        .google-sign-in-btn {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            width: 100%;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        .google-sign-in-btn:hover {
            background-color: #357ae8;
        }
        .guest-button {
            background-color: #e9ecef;
            color: #495057;
            border: 1px solid #ced4da;
            width: 100%;
        }

        /* Toast Message Styling */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1060;
        }
        .custom-toast {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(100%);
        }
        .custom-toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Filter Styles */
        .filter-input-group label { font-size: 0.8rem; color: var(--color-text-subtle); margin-bottom: 0.1rem; }
        .filter-input-group input { height: 32px; font-size: 0.9rem; padding: 0.25rem 0.5rem; }
        .filter-card { background-color: #f1f3f4; border-bottom: 1px solid #dee2e6; padding: 10px; border-radius: 8px 8px 0 0; }
        .filter-card h6 { font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; color: #5f6368; }

        /* Reports Tab Custom Styles for Alignment and Mobile */
        .summary-box {
            border-left: 3px solid transparent;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center; /* Center align for titles */
        }
        .summary-box h6 {
            white-space: nowrap;
            text-align: center;
        }
        .summary-box p {
            width: 100%;
            text-align: center;
            font-variant-numeric: tabular-nums; /* Helps align digits */
            font-size: 1.5rem !important;
        }

        /* Specific left-border colors using utility classes */
        .border-left-info { border-left-color: var(--color-info) !important; }
        .border-left-success { border-left-color: var(--color-success) !important; }
        .border-left-primary { border-left-color: var(--color-primary) !important; }
        .border-left-warning { border-left-color: var(--color-warning) !important; }

        /* NEW: Custom style for Cancelled list item */
        .list-group-item.list-group-item-danger {
            background-color: #f8d7da !important; /* Bootstrap's alert-danger light color */
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-muted-subtle mb-0">Professional Task Planner</h1>
            <button id="auth-action-btn" class="btn btn-outline-danger btn-sm d-none">
                <i class="fas fa-sign-out-alt me-1"></i> Sign Out
            </button>
        </div>

        
        <div id="loading-indicator" class="d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-primary mt-2" id="loading-text">Connecting...</p>
        </div>

        <div id="auth-loading-overlay">
            <div class="spinner-border text-light mb-3" role="status"></div>
            <p class="text-light">Waiting for Google Sign-In...</p>
        </div>

        <div id="toast-container"></div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">
                    <i class="fas fa-home me-2"></i>Home
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="new-task-tab" data-bs-toggle="tab" data-bs-target="#new-task" type="button" role="tab" aria-controls="new-task" aria-selected="false">
                    <i class="fas fa-plus-circle me-2"></i>New Task
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="todo-list-tab" data-bs-toggle="tab" data-bs-target="#todo-list" type="button" role="tab" aria-controls="todo-list" aria-selected="false">
                    <i class="fas fa-list-check me-2"></i>To-Do List
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">
                    <i class="fas fa-chart-line me-2"></i>Reporting
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div class="home-banner">
                    <h2>Welcome to Your Planner!</h2>
                    <p class="mb-0">Your data is saved securely in the <span id="banner-storage-mode" class="fw-bold">...</span></p>
                </div>
                
                <div class="row g-4">
                    <div class="col-md-7">
                        <div class="card p-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-chart-pie me-2"></i>Accumulated Estimates (Total Cost)</h5>
                            <div class="row g-3">
                                <div class="col-md-4 summary-metric">
                                    <h6 class="text-muted-subtle">This Week's Tasks</h6>
                                    <p class="text-success fw-bold mb-1">Cost: <span id="home-week-cost">$0.00</span></p>
                                    <p class="text-warning fw-bold mb-0">Time: <span id="home-week-time">0.0 hrs</span></p>
                                </div>
                                <div class="col-md-4 summary-metric">
                                    <h6 class="text-muted-subtle">This Month's Tasks</h6>
                                    <p class="text-success fw-bold mb-1">Cost: <span id="home-month-cost">$0.00</span></p>
                                    <p class="text-warning fw-bold mb-0">Time: <span id="home-month-time">0.0 hrs</span></p>
                                </div>
                                <div class="col-md-4 summary-metric">
                                    <h6 class="text-muted-subtle">This Year's Tasks</h6>
                                    <p class="text-success fw-bold mb-1">Cost: <span id="home-year-cost">$0.00</span></p>
                                    <p class="text-warning fw-bold mb-0">Time: <span id="home-year-time">0.0 hrs</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-5">
                        <div class="card p-4">
                            <h5 class="text-info mb-3"><i class="fas fa-calendar-check me-2"></i>Top 3 Upcoming Events</h5>
                            <ul class="list-group list-group-flush" id="upcoming-events-list">
                                <li class="list-group-item text-center text-muted-subtle">Loading...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="new-task" role="tabpanel" aria-labelledby="new-task-tab">
                <div class="card p-4">
                    <h5 class="card-title text-primary mb-3"><i class="fas fa-edit me-2"></i>Add Task Details</h5>
                    <form id="party-form" class="row g-3">
                        <div class="col-md-4"><label for="company-name" class="form-label text-muted-subtle">Company/Client</label><input type="text" class="form-control" id="company-name" placeholder="e.g., Acme Corp"></div>
                        <div class="col-md-4"><label for="event-name" class="form-label text-muted-subtle">Event/Project Name</label><input type="text" class="form-control" id="event-name" required value="New Event Project"></div>
                        <div class="col-md-4"><label for="event-task" class="form-label text-muted-subtle">Event Title</label><input type="text" class="form-control" id="event-task" required placeholder="e.g., Finalize venue contract"></div>
                        <div class="col-md-3"><label for="event-date" class="form-label text-muted-subtle">Date</label><input type="date" class="form-control" id="event-date" required></div>
                        <div class="col-md-3"><label for="event-start-time" class="form-label text-muted-subtle">Start Time</label><input type="time" class="form-control" id="event-start-time" value=""></div>
                        <div class="col-md-3"><label for="estimated-cost" class="form-label text-muted-subtle">Est. Cost ($)</label><input type="number" step="0.01" min="0" class="form-control" id="estimated-cost" value="0.00"></div>
                        <div class="col-md-3"><label for="estimated-time" class="form-label text-muted-subtle">Est. Time (Hrs)</label><input type="number" step="0.5" min="0" class="form-control" id="estimated-time" value="1"></div>
                        <div class="col-12"><label for="task-description" class="form-label text-muted-subtle">Description / Notes</label><textarea class="form-control" id="task-description" rows="2" placeholder="Detailed notes for execution and follow-up."></textarea></div>
                        <div class="col-12 text-end"><button type="submit" class="btn btn-primary mt-3"><i class="fas fa-save me-2"></i>Save Task</button></div>
                    </form>
                </div>
            </div>

            <div class="tab-pane fade" id="todo-list" role="tabpanel" aria-labelledby="todo-list-tab">
    
                <div class="filter-card mb-0 d-flex justify-content-between align-items-center flex-wrap">
                    <button id="toggle-filters-btn" class="btn btn-outline-primary btn-sm mb-2 mb-sm-0" data-bs-toggle="collapse" data-bs-target="#todo-filter-inputs" aria-expanded="false" aria-controls="todo-filter-inputs">
                        <i class="fas fa-filter me-1"></i> Show Filters
                    </button>
                    <h6 class="mb-2 mb-sm-0 text-info order-md-2">Current Task List (<span id="task-count">0</span>)</h6>
                    <div class="d-flex flex-wrap order-md-3">
                        <button id="clear-filters-btn" class="btn btn-outline-secondary btn-sm me-2 mb-1 mb-sm-0"><i class="fas fa-times me-1"></i> Clear</button>
                        <button id="apply-filters-btn" class="btn btn-primary btn-sm"><i class="fas fa-check me-1"></i> Apply Filters</button>
                    </div>
                </div>
                
                <div id="todo-filter-inputs" class="collapse filter-card rounded-top-0 mb-3">
                    <div class="row g-2 p-2">
                        <div class="col-12 filter-input-group">
                            <h6><i class="fas fa-calendar-alt me-1"></i>Date Range</h6>
                            <div class="d-flex">
                                <input type="date" id="filter-date-start" class="form-control form-control-sm me-1" placeholder="Start">
                                <input type="date" id="filter-date-end" class="form-control form-control-sm" placeholder="End">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-2 px-2 pb-2">
                         <div class="col-12 filter-input-group">
                             <h6><i class="fas fa-dollar-sign me-1"></i>Cost Range ($)</h6>
                            <div class="d-flex">
                                <input type="number" step="0.01" min="0" id="filter-cost-min" class="form-control form-control-sm me-1" placeholder="Min">
                                <input type="number" step="0.01" min="0" id="filter-cost-max" class="form-control form-control-sm" placeholder="Max">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-2 px-2 pb-2">
                        <div class="col-12 filter-input-group">
                            <h6><i class="fas fa-clock me-1"></i>Time Range (Hrs)</h6>
                            <div class="d-flex">
                                <input type="number" step="0.5" min="0" id="filter-time-min" class="form-control form-control-sm me-1" placeholder="Min">
                                <input type="number" step="0.5" min="0" id="filter-time-max" class="form-control form-control-sm" placeholder="Max">
                            </div>
                        </div>
                    </div>
                </div>

                <div id="filtered-summary" class="card p-3 mb-3 d-none">
                    <h6 class="text-primary mb-2"><i class="fas fa-calculator me-1"></i>Cost Summary for Filtered Tasks</h6>
                    <div class="row g-2 text-center">
                        <div class="col-6 col-md-3">
                            <h6 class="text-muted-subtle mb-0" style="font-size: 0.8rem;">Total Est. Budget</h6>
                            <p class="fw-bold text-success mb-0">$<span id="filtered-est-cost">0.00</span></p>
                        </div>
                        <div class="col-6 col-md-3">
                            <h6 class="text-muted-subtle mb-0" style="font-size: 0.8rem;">Total Additional Cost</h6>
                            <p class="fw-bold text-danger mb-0">$<span id="filtered-additional-cost">0.00</span></p>
                        </div>
                        <div class="col-12 col-md-6">
                            <h6 class="text-muted-subtle mb-0" style="font-size: 0.8rem;">GRAND TOTAL COST</h6>
                            <p class="fw-bold text-primary mb-0" style="font-size: 1.1rem;">$<span id="filtered-grand-total">0.00</span></p>
                        </div>
                    </div>
                </div>

                <div class="card rounded-top-0">
                    <ul id="task-list" class="list-group list-group-flush">
                        <li class="list-group-item text-center text-muted-subtle">Tasks will load after successful setup.</li>
                    </ul>
                </div>
                
                <div id="task-pagination-controls" class="d-flex justify-content-between align-items-center p-3 border-top bg-light rounded-bottom flex-wrap">
                    <button id="prev-page-btn" class="btn btn-outline-primary btn-sm mb-2 mb-sm-0" disabled><i class="fas fa-chevron-left me-1"></i> Previous</button>
                    <span id="page-info" class="text-muted-subtle mx-auto mb-2 mb-sm-0" style="font-size: 0.9rem;">Page 0 of 0</span>
                    <button id="next-page-btn" class="btn btn-outline-primary btn-sm" disabled>Next <i class="fas fa-chevron-right ms-1"></i></button>
                </div>
            </div>

            <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                 <div class="row g-4">
                    <div class="col-md-12">
                         <div class="card p-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-chart-area me-2"></i>Summary Overview (All Time)</h5>
                            <div class="row text-center g-3">
                                <div class="col-6 col-lg-2"><div class="summary-box p-2 border-left-info"><h6 class="text-muted-subtle">Total Tasks</h6><p class="h4 text-info" id="total-tasks">0</p></div></div>
                                <div class="col-6 col-lg-2"><div class="summary-box p-2 border-left-success"><h6 class="text-muted-subtle">Total Est. Budget</h6><p class="h4 text-success">$<span id="total-cost-est">0.00</span></p></div></div>
                                <div class="col-6 col-lg-2"><div class="summary-box p-2 border-left-success"><h6 class="text-muted-subtle">Total Additional</h6><p class="h4 text-success">$<span id="total-additional-cost">0.00</span></p></div></div>
                                <div class="col-6 col-lg-3"><div class="summary-box p-2 border-left-primary"><h6 class="text-muted-subtle">GRAND TOTAL COST</h6><p class="h4 text-primary">$<span id="grand-total-cost">0.00</span></p></div></div>
                                <div class="col-12 col-lg-3"><div class="summary-box p-2 border-left-warning"><h6 class="text-muted-subtle">Total Effort (Hrs)</h6><p class="h4 text-warning"><span id="total-time-est">0</span> hrs</p></div></div>
                                <div class="col-12 text-center mt-3"><h6 class="text-muted-subtle">Remaining Tasks: <span class="text-danger fw-bold" id="remaining-tasks">0</span></h6></div>
                            </div>
                         </div>
                    </div>
                    <div class="col-md-12">
                        <div class="card p-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-tools me-2"></i>Reporting Tools</h5>
                            
                            <div id="report-filter-section" class="bg-light p-3 mb-3 rounded">
                                <h6 class="text-info mb-2"><i class="fas fa-filter me-1"></i>Filter Report By Date (Optional)</h6>
                                <div class="row g-2">
                                    <div class="col-md-5">
                                        <label for="report-date-start" class="form-label text-muted-subtle mb-1">Start Date</label>
                                        <input type="date" id="report-date-start" class="form-control form-control-sm">
                                    </div>
                                    <div class="col-md-5">
                                        <label for="report-date-end" class="form-label text-muted-subtle mb-1">End Date</label>
                                        <input type="date" id="report-date-end" class="form-control form-control-sm">
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button id="clear-report-filters-btn" class="btn btn-outline-secondary btn-sm w-100">Clear</button>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-outline-primary w-100" id="download-csv-btn">
                                <i class="fas fa-download me-2"></i>Download Data as CSV Report
                                <span class="d-block" id="download-filter-status" style="font-size: 0.8rem;">(All Time)</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div> </div>

    <div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="taskDetailModalLabel">Task Details</h5>
            <button type="button" class="btn-close btn-close-white close-modal-btn" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="modal-task-id">
            <form id="task-update-form" class="row g-3">
                
                <div class="col-md-6 border-end pe-3">
                    <h6 class="text-primary mb-3"><i class="fas fa-calendar-alt me-2"></i>Event Details</h6>
                    <div class="row g-3">
                        <div class="col-12"><label for="modal-company-name-input" class="form-label text-muted-subtle">Company/Client</label><input type="text" class="form-control" id="modal-company-name-input"></div>
                        <div class="col-12"><label for="modal-event-name-input" class="form-label text-muted-subtle">Event/Project Name</label><input type="text" class="form-control" id="modal-event-name-input" required></div>
                        <div class="col-12"><label for="modal-event-task-input" class="form-label text-muted-subtle">Event Title</label><input type="text" class="form-control" id="modal-event-task-input" required></div>
                        <div class="col-md-6"><label for="modal-event-date-input" class="form-label text-muted-subtle">Date</label><input type="date" class="form-control" id="modal-event-date-input" required></div>
                        <div class="col-md-6"><label for="modal-event-time-input" class="form-label text-muted-subtle">Start Time</label><input type="time" class="form-control" id="modal-event-time-input"></div>
                        <div class="col-12"><label for="modal-task-description-input" class="form-label text-muted-subtle">Task Description</label><textarea class="form-control" id="modal-task-description-input" rows="2"></textarea></div>
                    </div>
                </div>

                <div class="col-md-6 ps-3">
                    <h6 class="text-info mb-3"><i class="fas fa-user-gear me-2"></i>Organizer Inputs</h6>
                    <div class="row g-3">
                        <div class="col-md-6"><label for="modal-estimated-cost-input" class="form-label text-muted-subtle">Est. Budget ($)</label><input type="number" step="0.01" min="0" class="form-control" id="modal-estimated-cost-input"></div>
                        <div class="col-md-6"><label for="modal-additional-cost-input" class="form-label text-muted-subtle">Additional Cost ($)</label><input type="number" step="0.01" min="0" class="form-control" id="modal-additional-cost-input" value="0.00"></div>
                        <div class="col-12"><label for="modal-estimated-time-input" class="form-label text-muted-subtle">Est. Effort (Hrs)</label><input type="number" step="0.5" min="0" class="form-control" id="modal-estimated-time-input"></div>
                        <div class="col-12"><label for="modal-organizer-notes-input" class="form-label text-muted-subtle">Organizer Notes</label><textarea class="form-control" id="modal-organizer-notes-input" rows="3"></textarea></div>
                        <div class="col-12 mt-4"><strong>Status:</strong> <span id="modal-task-status" class="badge" title="Click to toggle status"></span></div>
                    </div>
                </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-danger me-auto" id="modal-delete-task-btn">
                <i class="fas fa-trash-alt me-2"></i>Delete Task
            </button>
            <button type="submit" form="task-update-form" class="btn btn-primary">
                <i class="fas fa-sync-alt me-2"></i>Update Task
            </button>
            <button type="button" class="btn btn-secondary close-modal-btn" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="StartCloudSyncModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="StartCloudSyncModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="StartCloudSyncModalLabel">Start Cloud Sync</h5>
                </div>
                <div class="modal-body start-sync-modal-body">
                    <p>Choose how you want to access your planner. **Permanent login** is recommended for secure, multi-device data saving.</p>
                    <button id="google-sign-in-btn" class="google-sign-in-btn">
                        <i class="fab fa-google me-2"></i> Sign in with Google
                    </button>
                    <button id="guest-sign-in-btn" class="btn btn-light guest-button">
                        Continue as Guest (Temporary Local Storage)
                    </button>
                    </div>
            </div>
        </div>
    </div>

    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyDHUMDVGfZY2dwF-uxeG17r9yW3f2gBr-A",
            authDomain: "multitools-fbc73.firebaseapp.com",
            projectId: "multitools-fbc73",
            storageBucket: "multitools-fbc73.firebasestorage.app",
            messagingSenderId: "277024201427",
            appId: "1:277024201427:web:b1d23c088add4324226",
            measurementId: "G-1HJ0N30X1W"
        });
        window.__app_id = 'task_planner_app';
    </script>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        // Import Firebase modules and expose them globally as window.FirebaseTools
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // NOTE: We change the imports from collection/setDoc/doc/onSnapshot/updateDoc/deleteDoc 
        // to only use `doc` and `onSnapshot` for single-document data model
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 1. Expose Firebase Tools Globally to match the provided auth code ---
        window.FirebaseTools = {
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, 
            onAuthStateChanged, signOut, getFirestore, signInAnonymously
        };

        // --- Global State & Initialization ---
        
        const LOCAL_STORAGE_KEY = 'taskPlannerTasks_v11_local'; 
        const FIREBASE_COLLECTION_PATH = 'events';
        const APP_ID = window.__app_id || 'default_app'; // NEW: Get APP_ID from window
        const FIREBASE_DOC_ID = 'main_data'; // NEW: Document ID for the single data doc
        
        let app; 
        let auth; // Global auth variable
        let db;   // Global db variable
        let tasksDocRef = null; // Changed from tasksCollectionRef to tasksDocRef
        let allCurrentTasks = []; // Holds ALL tasks (unfiltered)
        let currentTasks = [];    // Holds the currently rendered/filtered tasks
        let firebaseUnsubscribe = null; 
        
        let storageMode = ''; 
        let userId = null;
        let isGoogleSignedIn = false;
        
        // Pagination State - Set to 25 items per page
        const TASKS_PER_PAGE = 25; 
        let currentPage = 1;       
        
        // UPDATED: Replaced 'completed' with 'status'
        const defaultTask = {
            companyName: '', 
            eventName: 'New Event Project',
            eventDate: '',
            eventStartTime: '',
            eventTask: '',
            taskDescription: '',
            estimatedCost: '0.00',
            estimatedTime: '1.0',
            additionalCost: '0.00',
            organizerNotes: '',
            status: 'Pending', // <-- NEW: Status field
            createdAt: new Date().toISOString()
        };
        
        // --- 2. Custom UI Overlays/Toasts ---
        const loadingOverlay = document.getElementById('auth-loading-overlay');
        
        function showToast(message, duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            toast.textContent = message;
            container.appendChild(toast);

            // Show
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Hide
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500); // Wait for transition
            }, duration);
        }

        // --- UI & Utility Functions ---

        function showLoading(text) {
            $('#loading-text').text(text);
            $('#loading-indicator').removeClass('d-none');
        }

        function hideLoading() {
            $('#loading-indicator').addClass('d-none');
        }

        function showCloudSyncModal() {
            const modalElement = document.getElementById('StartCloudSyncModal');
            const syncModal = new bootstrap.Modal(modalElement, {
                backdrop: 'static', 
                keyboard: false     
            });
            syncModal.show();
        }

        function hideCloudSyncModal() {
            const modalElement = document.getElementById('StartCloudSyncModal');
            const syncModal = bootstrap.Modal.getInstance(modalElement);
            if (syncModal) syncModal.hide();
        }

        function updateUIOnModeChange() {
            if (storageMode === 'firebase') {
                const userEmail = auth.currentUser?.email || 'Authenticated User';
                const modeText = isGoogleSignedIn ? `Permanent Cloud (User: ${userEmail})` : 'Temporary Cloud (Guest)';
                $('#banner-storage-mode').text(modeText);
                
                $('#auth-action-btn').removeClass('d-none').text('Sign Out').off('click').on('click', async () => {
                    if (confirm("Are you sure you want to sign out?")) {
                        await signOut(auth);
                    }
                });
            } else if (storageMode === 'local') {
                $('#banner-storage-mode').text('Local Storage (Guest Mode - Browser Only)');
                $('#auth-action-btn').removeClass('d-none').text('Exit Guest Mode').off('click').on('click', () => {
                    if (confirm("Are you sure you want to exit Guest Mode?")) {
                        storageMode = ''; 
                        allCurrentTasks = [];
                        currentTasks = [];
                        renderTasks(allCurrentTasks);
                        updateUIOnModeChange(); 
                        showCloudSyncModal(); 
                    }
                });
            } else {
                $('#banner-storage-mode').text('None (Please sign in)');
                $('#auth-action-btn').addClass('d-none');
                renderTasks([]); 
            }
        }
        
        // Helper to find the index of a task
        function findTaskIndex(taskId, tasks) {
            return tasks.findIndex(t => t.id === taskId);
        }

        // Helper to update tasks in the global array (used by Firebase functions)
        function getUpdatedTasks(taskId, updatedFields) {
            const tasks = [...allCurrentTasks];
            const index = findTaskIndex(taskId, tasks);

            if (index > -1) {
                tasks[index] = { ...tasks[index], ...updatedFields };
            } else if (!taskId) {
                // If no ID is provided, assume this is a brand new task
                // Ensure new tasks default to 'Pending' status
                tasks.push({ ...defaultTask, ...updatedFields, id: `firebase-${Date.now()}`, status: updatedFields.status || 'Pending' }); 
            }
            
            // Sort tasks before saving
            tasks.sort((a, b) => DateUtils.parseDate(a.eventDate) - DateUtils.parseDate(b.eventDate));
            
            return tasks;
        }

        // --- CORE LOGIC: Storage Implementation ---
        
        const LocalStorageImpl = {
            load: () => {
                showLoading("Loading from Local Storage...");
                const tasks = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
                const normalizedTasks = tasks.map((task, index) => ({
                    ...defaultTask, 
                    ...task,
                    id: task.id || `local-${index}`,
                    // Ensure status is present, fall back from old 'completed' to 'Pending'/'Completed'
                    status: task.status || (task.completed ? 'Completed' : 'Pending') 
                }));
                normalizedTasks.sort((a, b) => DateUtils.parseDate(a.eventDate) - DateUtils.parseDate(b.eventDate));
                setTimeout(hideLoading, 300); 
                return normalizedTasks;
            },
            save: (tasks) => localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tasks)),
            add: (newTask) => {
                const tasks = LocalStorageImpl.load();
                tasks.push({...defaultTask, ...newTask, id: `local-${Date.now()}`});
                LocalStorageImpl.save(tasks);
                // Call TaskManager.loadAndRender to re-pull, sort, and re-filter
                TaskManager.loadAndRender(); 
            },
            update: (taskId, updatedFields) => {
                const tasks = LocalStorageImpl.load();
                const index = findTaskIndex(taskId, tasks);
                if (index > -1) {
                    tasks[index] = { ...tasks[index], ...updatedFields };
                    // Remove legacy 'completed' field if 'status' is being used
                    delete tasks[index].completed; 
                    LocalStorageImpl.save(tasks);
                    TaskManager.loadAndRender(); 
                }
            },
            delete: (taskId) => {
                const tasks = LocalStorageImpl.load().filter(t => t.id !== taskId);
                LocalStorageImpl.save(tasks);
                TaskManager.loadAndRender(); 
            }
        };

        const FirebaseImpl = {
            startSync: () => {
                if (!tasksDocRef) return;
                
                if (firebaseUnsubscribe) { firebaseUnsubscribe(); } 
                
                showLoading("Syncing with Firebase Cloud...");
                
                firebaseUnsubscribe = onSnapshot(tasksDocRef, (docSnapshot) => {
                    let tasks = [];
                    if (docSnapshot.exists() && docSnapshot.data().tasks) {
                        // The entire list of tasks is stored in a single field called 'tasks'
                        tasks = docSnapshot.data().tasks || [];
                    }
                    
                    // Normalize tasks for status field migration
                    tasks = tasks.map(task => ({
                        ...defaultTask,
                        ...task,
                        status: task.status || (task.completed ? 'Completed' : 'Pending') // Handle migration from old completed field
                    }));

                    tasks.sort((a, b) => DateUtils.parseDate(a.eventDate) - DateUtils.parseDate(b.eventDate));
                    
                    // Update allCurrentTasks and trigger filtering
                    renderTasks(tasks); 
                    hideLoading();
                }, (error) => {
                    console.error("Error reading data from Firestore: ", error);
                    showToast("Error connecting to Firebase: " + error.message, 5000);
                    hideLoading();
                });
            },
            stopSync: () => {
                if (firebaseUnsubscribe) {
                    firebaseUnsubscribe();
                    firebaseUnsubscribe = null;
                }
            },
            // Save the entire tasks array back to the single document
            _saveTasksArray: async (tasksArray) => {
                if (!tasksDocRef) return;
                try {
                    // Overwrite the single document with the new array
                    // Ensure the tasks saved do not contain the legacy 'completed' field if 'status' is present
                    const tasksToSave = tasksArray.map(task => {
                        const { completed, ...rest } = task; // Destructure to remove completed
                        return rest;
                    });

                    await setDoc(tasksDocRef, { tasks: tasksToSave || [] }); 
                } catch(e) {
                    console.error("Error saving tasks array to Firebase:", e);
                    showToast("Failed to save tasks to cloud: " + e.message, 5000);
                }
            },
            add: async (newTask) => {
                // Add a temporary ID for tracking before saving. Ensure status is set.
                const taskWithId = { ...defaultTask, ...newTask, id: `firebase-${Date.now()}` }; 
                const updatedTasks = getUpdatedTasks(null, taskWithId);
                await FirebaseImpl._saveTasksArray(updatedTasks);
            },
            update: async (taskId, updatedFields) => {
                // Use helper to create the new array with the single updated task
                const updatedTasks = getUpdatedTasks(taskId, updatedFields);
                await FirebaseImpl._saveTasksArray(updatedTasks);
            },
            delete: async (taskId) => {
                // Filter the task out and save the remaining array
                const filteredTasks = allCurrentTasks.filter(t => t.id !== taskId);
                await FirebaseImpl._saveTasksArray(filteredTasks);
            }
        };

        // --- Task Manager Interface (The Router) ---
        const TaskManager = {
            loadAndRender: () => {
                updateUIOnModeChange();

                if (storageMode === 'firebase') {
                    FirebaseImpl.startSync();
                } else if (storageMode === 'local') {
                    FirebaseImpl.stopSync();
                    const tasks = LocalStorageImpl.load();
                    renderTasks(tasks); // This calls renderTasks, which calls applyFiltersAndRender
                } else {
                    renderTasks([]);
                }
            },
            add: (newTask) => {
                if (storageMode === 'firebase') return FirebaseImpl.add(newTask);
                if (storageMode === 'local') return LocalStorageImpl.add(newTask);
            },
            update: (taskId, updatedFields) => {
                if (storageMode === 'firebase') return FirebaseImpl.update(taskId, updatedFields);
                if (storageMode === 'local') return LocalStorageImpl.update(taskId, updatedFields);
            },
            delete: (taskId) => {
                if (storageMode === 'firebase') return FirebaseImpl.delete(taskId);
                if (storageMode === 'local') return LocalStorageImpl.delete(taskId);
            },
            // Removed toggleComplete, status logic is now implemented directly in event handlers using TaskManager.update
        };

        // --- Auth Functions ---

        async function signInWithGoogle() {
            if (!window.FirebaseTools) {
                showToast("Cloud connection is not available.", 3000);
                return false;
            }

            const { GoogleAuthProvider, signInWithPopup } = window.FirebaseTools;
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' }); 

            loadingOverlay.style.display = 'flex';
            loadingOverlay.querySelector('p').textContent = 'Waiting for Google Sign-In...';

            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                userId = user.uid;
                isGoogleSignedIn = true; 
                
                loadingOverlay.style.display = 'none';
                showToast(`Signed in as ${user.displayName || 'Google User'}! ðŸš€`, 4000);
                return true;
            } catch (error) {
                loadingOverlay.style.display = 'none';
                
                if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
                    showToast("Google Sign-In canceled.", 3000);
                } else {
                    console.error("Google Sign-In Error:", error);
                    showToast(`Sign-In Failed: ${error.message.substring(0, 50)}...`, 5000);
                }
                return false;
            }
        }

        async function initializeFirebase() {
            if (!window.FirebaseTools) return;
            try {
                const firebaseConfig = JSON.parse(window.__firebase_config);
                const { initializeApp, getAuth, signInAnonymously, getFirestore } = window.FirebaseTools;

                app = initializeApp(firebaseConfig);
                auth = getAuth(app); 
                db = getFirestore(app);
                
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
                
            } catch (e) {
                console.error("Firebase Initialization Failed:", e);
                showToast("Firebase Initialization Failed. Check console.", 5000);
            }
        }

        // --- Filtering Logic ---
        function getFilterValues() {
            return {
                dateStart: $('#filter-date-start').val(),
                dateEnd: $('#filter-date-end').val(),
                // Use || 0 to default to minimum possible value if field is empty (for range checks)
                costMin: parseFloat($('#filter-cost-min').val() || 0),
                // Use || Infinity to default to maximum possible value if field is empty
                costMax: parseFloat($('#filter-cost-max').val() || Infinity), 
                timeMin: parseFloat($('#filter-time-min').val() || 0),
                timeMax: parseFloat($('#filter-time-max').val() || Infinity),
            };
        }

        function applyFiltersAndRender(tasksToFilter) {
            const filters = getFilterValues();
            
            const filtered = tasksToFilter.filter(task => {
                // Total cost now depends on the status
                const estCost = parseFloat(task.estimatedCost) || 0;
                const addCost = parseFloat(task.additionalCost || 0);
                
                let totalCost = addCost; // Always include additional cost
                if (task.status !== 'Cancelled') { // Only include estimated cost if NOT cancelled
                    totalCost += estCost;
                }
                
                const totalTime = parseFloat(task.estimatedTime);
                const taskDate = DateUtils.parseDate(task.eventDate);

                // Date Filter
                if (filters.dateStart && taskDate < DateUtils.parseDate(filters.dateStart)) return false;
                if (filters.dateEnd && taskDate > DateUtils.parseDate(filters.dateEnd)) return false;

                // Cost Filter (Filter checks against calculated TOTAL cost)
                if (totalCost < filters.costMin) return false;
                if (totalCost > filters.costMax) return false;

                // Time Filter
                if (totalTime < filters.timeMin) return false;
                if (totalTime > filters.timeMax) return false;

                return true;
            });

            currentTasks = filtered;
            
            // --- Calculate and Display Filtered Totals for To-Do List ---
            let totalEstCost = 0;
            let totalAddCost = 0;
            
            filtered.forEach(task => {
                // Estimated cost logic
                if (task.status !== 'Cancelled') {
                    totalEstCost += parseFloat(task.estimatedCost) || 0;
                }
                
                // Additional cost logic
                totalAddCost += parseFloat(task.additionalCost) || 0;
            });
            
            const grandTotal = totalEstCost + totalAddCost;
            
            // Display totals
            if (filtered.length > 0) {
                $('#filtered-est-cost').text(totalEstCost.toFixed(2));
                $('#filtered-additional-cost').text(totalAddCost.toFixed(2));
                $('#filtered-grand-total').text(grandTotal.toFixed(2));
                $('#filtered-summary').removeClass('d-none');
            } else {
                $('#filtered-summary').addClass('d-none');
            }
            // ---------------------------------------------------

            _renderFilteredList(currentTasks);
        }

        // --- Rendering Logic (Split into two parts) ---

        // 1. Receives unfiltered data, stores it, and triggers filtering/summary updates
        function renderTasks(tasks) {
            allCurrentTasks = tasks; // Store all tasks
            
            // 1. Update Home and Reporting Summaries based on ALL tasks
            updateReportingSummary(allCurrentTasks);
            renderHomeTab(allCurrentTasks);
            
            // 2. Apply filters to all tasks and render the list
            // Reset to the first page when the list changes
            currentPage = 1; 
            applyFiltersAndRender(allCurrentTasks);
        }

        // 2. Renders the list based on the already filtered 'currentTasks'
        function _renderFilteredList(tasks) {
            const $taskList = $('#task-list');
            $taskList.empty();
            $('#task-count').text(tasks.length);

            // Pagination Logic
            const totalPages = Math.ceil(tasks.length / TASKS_PER_PAGE);
            currentPage = Math.min(currentPage, totalPages || 1); // Clamp current page to total pages
            
            const startIndex = (currentPage - 1) * TASKS_PER_PAGE;
            const endIndex = startIndex + TASKS_PER_PAGE;
            const tasksToRender = tasks.slice(startIndex, endIndex);

            // Update Pagination UI
            $('#page-info').text(`Page ${currentPage} of ${totalPages}`);
            $('#prev-page-btn').prop('disabled', currentPage === 1);
            $('#next-page-btn').prop('disabled', currentPage >= totalPages || totalPages === 0);
            
            if (tasksToRender.length === 0) {
                 const modeText = storageMode === 'local' ? 'Local Storage (Temporary)' : 'Cloud Storage';
                 $taskList.append(`<li class="list-group-item text-center text-muted-subtle">No tasks found in ${modeText} or no tasks match the current filters.</li>`);
            }

            tasksToRender.forEach(task => {
                // Calculate total cost based on the new logic for display purposes
                const estCost = parseFloat(task.estimatedCost) || 0;
                const addCost = parseFloat(task.additionalCost || 0);
                let totalCost = addCost;
                if (task.status !== 'Cancelled') {
                    totalCost += estCost;
                }
                
                const costDisplay = totalCost.toFixed(2);
                const timeDisplay = parseFloat(task.estimatedTime);
                const timeBadge = task.eventStartTime ? `<span class="badge bg-secondary ms-1" title="Start Time">${task.eventStartTime}</span>` : '';
                const companyDisplay = task.companyName ? `<span class="text-muted-subtle ms-1">(${task.companyName})</span>` : '';

                let listItemClass = '';
                let statusBadgeClass = 'bg-info text-white'; // Default for Pending
                let textDecoration = 'fw-bold'; // Default for Pending

                if (task.status === 'Completed') {
                    listItemClass = 'list-group-item-success';
                    statusBadgeClass = 'bg-success';
                    textDecoration = 'text-decoration-line-through text-success';
                } else if (task.status === 'Cancelled') {
                    listItemClass = 'list-group-item-danger'; // Light red background
                    statusBadgeClass = 'bg-danger'; // Red badge
                    textDecoration = 'text-decoration-line-through text-danger'; // Red strike-through
                }

                const $li = $('<li>')
                    .addClass(`list-group-item d-flex justify-content-between align-items-center flex-column flex-md-row ${listItemClass}`)
                    .attr('data-task-id', task.id); 

                const taskContent = `
                    <div class="text-center text-md-start mb-2 mb-md-0">
                        <strong>${task.eventName}</strong> ${companyDisplay}: 
                        <span class="${textDecoration}">${task.eventTask}</span> 
                        <span class="badge bg-secondary ms-2">${task.eventDate}</span>
                        ${timeBadge}
                        
                        <span class="badge bg-success ms-2" title="Total Calculated Cost">$${costDisplay}</span>
                        <span class="badge bg-warning text-dark" title="Estimated Time">${timeDisplay}h</span>
                    </div>
                `;

                const actionButtons = `
                    <div class="d-flex justify-content-center justify-content-md-end">
                        <span class="badge ${statusBadgeClass} complete-toggle me-2" 
                            style="cursor: pointer;" title="Click to cycle status: Pending -> Completed -> Cancelled">
                            ${task.status.toUpperCase()}
                        </span>
                        <button class="btn btn-sm btn-outline-primary details-btn" title="Show/Edit Details">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                `;

                $li.append(taskContent).append(actionButtons);
                $taskList.append($li);
            });
        }
        
        // --- Remaining Utility Functions ---
        
        const DateUtils = {
            getPeriodStartEnd: (period) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let start = new Date(today);
                let end = new Date(today);

                if (period === 'week') { end.setDate(today.getDate() + 7); } 
                else if (period === 'month') { start.setDate(1); end = new Date(today.getFullYear(), today.getMonth() + 1, 0); } 
                else if (period === 'year') { start.setMonth(0, 1); end.setMonth(11, 31); }
                return { start, end };
            },
            parseDate: (dateString) => {
                const parts = dateString.split('-');
                return new Date(parts[0], parts[1] - 1, parts[2]); 
            }
        };

        function updateReportingSummary(tasks) {
            let totalCostEst = 0;
            let totalAdditionalCost = 0;
            let totalTimeEst = 0;
            let completedCount = 0;
            let cancelledCount = 0; // NEW: Track cancelled tasks

            tasks.forEach(task => {
                const estCost = parseFloat(task.estimatedCost) || 0;
                const addCost = parseFloat(task.additionalCost) || 0;

                // NEW LOGIC: Estimated Cost is only included if NOT Cancelled
                if (task.status !== 'Cancelled') {
                    totalCostEst += estCost;
                }
                
                // NEW LOGIC: Additional Cost is ALWAYS included
                totalAdditionalCost += addCost; 
                
                totalTimeEst += parseFloat(task.estimatedTime) || 0;
                
                if (task.status === 'Completed') { completedCount++; }
                if (task.status === 'Cancelled') { cancelledCount++; }
            });
            
            const grandTotalCost = totalCostEst + totalAdditionalCost;

            $('#total-tasks').text(tasks.length);
            $('#total-cost-est').text(totalCostEst.toFixed(2));
            $('#total-additional-cost').text(totalAdditionalCost.toFixed(2)); 
            $('#grand-total-cost').text(grandTotalCost.toFixed(2));           
            $('#total-time-est').text(totalTimeEst.toFixed(1));
            // Remaining tasks are now those that are PENDING
            $('#remaining-tasks').text(tasks.length - completedCount - cancelledCount);
        }

        function renderHomeTab(tasks) {
            const today = DateUtils.parseDate(new Date().toISOString().split('T')[0]);
            
            ['week', 'month', 'year'].forEach(period => {
                const { start, end } = DateUtils.getPeriodStartEnd(period);
                let costTotal = 0;
                let timeTotal = 0;

                const filteredTasks = tasks.filter(task => {
                    const taskDate = DateUtils.parseDate(task.eventDate);
                    return taskDate >= start && taskDate <= end;
                });

                filteredTasks.forEach(task => {
                    const estCost = parseFloat(task.estimatedCost) || 0;
                    const addCost = parseFloat(task.additionalCost) || 0;
                    
                    // NEW LOGIC: Apply new business logic
                    if (task.status !== 'Cancelled') {
                        costTotal += estCost;
                    }
                    costTotal += addCost; // Additional cost is ALWAYS included
                    
                    timeTotal += parseFloat(task.estimatedTime) || 0;
                });

                $(`#home-${period}-cost`).text(`$${costTotal.toFixed(2)}`);
                $(`#home-${period}-time`).text(`${timeTotal.toFixed(1)} hrs`);
            });

            const upcomingTasks = tasks
                // Filter only tasks that are 'Pending' and in the future
                .filter(task => task.status === 'Pending' && DateUtils.parseDate(task.eventDate) >= today)
                .sort((a, b) => DateUtils.parseDate(a.eventDate) - DateUtils.parseDate(b.eventDate))
                .slice(0, 3);

            const $upcomingList = $('#upcoming-events-list');
            $upcomingList.empty();

            if (upcomingTasks.length === 0) {
                $upcomingList.append('<li class="list-group-item text-center text-muted-subtle">No pending upcoming events!</li>');
            } else {
                upcomingTasks.forEach(task => {
                    const taskDate = DateUtils.parseDate(task.eventDate);
                    const daysLeft = Math.ceil((taskDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                    
                    $upcomingList.append(`
                        <li class="list-group-item d-flex justify-content-between align-items-center home-upcoming-item" 
                            data-task-id="${task.id}">
                            <div>
                                <i class="fas fa-calendar-alt text-primary me-2"></i>
                                <strong>${task.eventTask}</strong> (${task.eventName})
                            </div>
                            <span class="badge ${daysLeft <= 3 ? 'bg-danger' : 'bg-info'}">
                                ${daysLeft <= 0 ? 'Due Today' : `${daysLeft} days left`}
                            </span>
                        </li>
                    `);
                });
            }
        }

        function showTaskDetailsModal(task) {
            $('#modal-task-id').val(task.id); 
            $('#modal-company-name-input').val(task.companyName);
            $('#modal-event-name-input').val(task.eventName);
            $('#modal-event-task-input').val(task.eventTask);
            $('#modal-event-date-input').val(task.eventDate);
            $('#modal-event-time-input').val(task.eventStartTime);
            $('#modal-estimated-cost-input').val(parseFloat(task.estimatedCost).toFixed(2));
            $('#modal-estimated-time-input').val(parseFloat(task.estimatedTime).toFixed(1));
            $('#modal-task-description-input').val(task.taskDescription);
            $('#modal-additional-cost-input').val(parseFloat(task.additionalCost || 0).toFixed(2));
            $('#modal-organizer-notes-input').val(task.organizerNotes);
            
            const $statusBadge = $('#modal-task-status');
            let badgeClass = 'bg-info text-white';
            if (task.status === 'Completed') {
                badgeClass = 'bg-success';
            } else if (task.status === 'Cancelled') {
                badgeClass = 'bg-danger';
            }

            $statusBadge.text(task.status);
            $statusBadge.removeClass().addClass('badge').addClass(badgeClass);
            
            const taskModal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
            taskModal.show();
        }

        // --- Event Handlers ---
        $(document).ready(async function() {
            
            // Step 1: Initialize Firebase and define the AUTH object.
            await initializeFirebase();

            // Step 2: Define and attach the onAuthStateChanged listener now that 'auth' exists.
            let isFirstAuthCheck = true;
            onAuthStateChanged(auth, (user) => { 
                if (user) {
                    userId = user.uid;

                    if (!user.isAnonymous) {
                        // Google/Email user session is active
                        storageMode = 'firebase';
                        isGoogleSignedIn = true;
                        
                        // NEW: Define the single document reference using the complex path
                        const docPath = `artifacts/${APP_ID}/users/${userId}/${FIREBASE_COLLECTION_PATH}/${FIREBASE_DOC_ID}`;
                        tasksDocRef = doc(db, docPath);
                        
                        hideCloudSyncModal();
                        TaskManager.loadAndRender();
                    } else if (storageMode === 'firebase' && !isFirstAuthCheck) {
                        // This case is unlikely if sign-out works correctly, but as a guard:
                        signOut(auth);
                    }
                    
                } else {
                    // User signed out or no session found (anonymous included if explicitly signed out)
                    tasksDocRef = null;
                    FirebaseImpl.stopSync();

                    if (storageMode === 'firebase' || storageMode === '') {
                        storageMode = ''; 
                        updateUIOnModeChange();
                        renderTasks([]); // Clears lists
                        showCloudSyncModal();
                    }
                }
                isFirstAuthCheck = false;
            });

            // Step 3: Initial UI/Modal State Check (runs immediately after async initializeFirebase)
            if (auth.currentUser && !auth.currentUser.isAnonymous) {
                 storageMode = 'firebase';
                 // Listener handles loadAndRender
            } else if (auth.currentUser && auth.currentUser.isAnonymous) {
                 // Anonymous session is active, prompt for permanent storage
                 showCloudSyncModal();
            } else {
                 // Fallback if no session found, prompt for permanent storage
                 showCloudSyncModal();
            }
            
            // --- MODAL/AUTH BUTTONS ---
            
            $('#google-sign-in-btn').on('click', async function() {
                await signInWithGoogle();
            });
            
            $('#guest-sign-in-btn').on('click', function() {
                storageMode = 'local';
                hideCloudSyncModal();
                TaskManager.loadAndRender();
            });
            
            // --- TO-DO LIST FILTER EVENT HANDLERS ---
            
            const filterInputs = '#filter-date-start, #filter-date-end, #filter-cost-min, #filter-cost-max, #filter-time-min, #filter-time-max';

            // 1. Toggle Button Text
            $('#todo-filter-inputs').on('shown.bs.collapse', function () {
                $('#toggle-filters-btn').html('<i class="fas fa-filter-slash me-1"></i> Hide Filters');
            });
            $('#todo-filter-inputs').on('hidden.bs.collapse', function () {
                $('#toggle-filters-btn').html('<i class="fas fa-filter me-1"></i> Show Filters');
            });

            // 2. Apply Filters Button
            $('#apply-filters-btn').on('click', () => {
                applyFiltersAndRender(allCurrentTasks);
            });

            // 3. Clear Filters Button
            $('#clear-filters-btn').on('click', function() {
                $(filterInputs).val('');
                // Reset page on clear
                currentPage = 1; 
                applyFiltersAndRender(allCurrentTasks); // Apply filters immediately after clearing
                
                // Optional: Hide the filter panel after clearing
                const filterCollapse = bootstrap.Collapse.getInstance(document.getElementById('todo-filter-inputs'));
                if (filterCollapse) filterCollapse.hide();
            });
            
            // 4. Pagination Button Handlers
            $('#prev-page-btn').on('click', function() {
                if (currentPage > 1) {
                    currentPage--;
                    _renderFilteredList(currentTasks); // Re-render with new page
                }
            });

            $('#next-page-btn').on('click', function() {
                const totalPages = Math.ceil(currentTasks.length / TASKS_PER_PAGE);
                if (currentPage < totalPages) {
                    currentPage++;
                    _renderFilteredList(currentTasks); // Re-render with new page
                }
            });


            // --- REPORTING FILTER EVENT HANDLERS ---
            const reportDateInputs = '#report-date-start, #report-date-end';
            $(reportDateInputs).on('change', function() {
                const start = $('#report-date-start').val();
                const end = $('#report-date-end').val();
                let statusText = '(All Time)';
                if (start || end) {
                    statusText = `(Filtered: ${start || 'Start'} to ${end || 'End'})`;
                }
                $('#download-filter-status').text(statusText);
            });
            
            $('#clear-report-filters-btn').on('click', function() {
                $(reportDateInputs).val('');
                $('#download-filter-status').text('(All Time)');
            });

            // --- MAIN FORM & CRUD HANDLERS ---
            
            // 1. Handle form submission (Add Task)
            $('#party-form').on('submit', function(e) {
                e.preventDefault();

                if (storageMode === 'firebase' && (!auth.currentUser || auth.currentUser.isAnonymous)) {
                    showToast("Please fully sign in with Google to save tasks to the cloud.", 4000);
                    showCloudSyncModal();
                    return;
                }
                
                if (!storageMode) {
                    alert('Please select a storage method (Sign In or Guest Mode) before adding tasks.');
                    showCloudSyncModal();
                    return;
                }

                const newTask = {
                    companyName: $('#company-name').val().trim(),
                    eventName: $('#event-name').val().trim(),
                    eventDate: $('#event-date').val(),
                    eventStartTime: $('#event-start-time').val().trim(),
                    eventTask: $('#event-task').val().trim(),
                    taskDescription: $('#task-description').val().trim(),
                    estimatedCost: parseFloat($('#estimated-cost').val() || 0).toFixed(2),
                    estimatedTime: parseFloat($('#estimated-time').val() || 0).toFixed(1),
                    status: 'Pending' // Set new task status to Pending
                };

                if (!newTask.eventName || !newTask.eventDate || !newTask.eventTask) {
                    alert('Please fill in required fields.');
                    return;
                }

                TaskManager.add(newTask);
                
                $('#event-task').val('');
                $('#task-description').val('');
                new bootstrap.Tab($('#todo-list-tab')).show(); 
            });
            
            // 2. Handle Task Update Form Submission (Inside Modal)
            $('#task-update-form').on('submit', function(e) {
                e.preventDefault();

                const taskId = $('#modal-task-id').val();
                
                const updatedFields = {
                    companyName: $('#modal-company-name-input').val().trim(),
                    eventName: $('#modal-event-name-input').val().trim(),
                    eventDate: $('#modal-event-date-input').val(),
                    eventStartTime: $('#modal-event-time-input').val().trim(),
                    eventTask: $('#modal-event-task-input').val().trim(),
                    taskDescription: $('#modal-task-description-input').val().trim(),
                    estimatedCost: parseFloat($('#modal-estimated-cost-input').val() || 0).toFixed(2),
                    estimatedTime: parseFloat($('#modal-estimated-time-input').val() || 0).toFixed(1),
                    additionalCost: parseFloat($('#modal-additional-cost-input').val() || 0).toFixed(2), 
                    organizerNotes: $('#modal-organizer-notes-input').val().trim(), 
                    // Status is updated via the badge click handler, not the form submission fields.
                    // We explicitly fetch the current status from the badge's text for redundancy, 
                    // but rely on the click handler to update the model.
                };
                
                const currentTask = allCurrentTasks.find(t => t.id === taskId);
                updatedFields.status = currentTask?.status || 'Pending'; // Preserve status

                if (!updatedFields.eventName || !updatedFields.eventDate || !updatedFields.eventTask) {
                    alert('Required fields must be filled.');
                    return;
                }
                
                TaskManager.update(taskId, updatedFields);
                
                const modalElement = document.getElementById('taskDetailModal');
                const taskModal = bootstrap.Modal.getInstance(modalElement);
                if (taskModal) taskModal.hide();
            });

            // 3. Modal: Toggle Status by clicking STATUS badge
            $('#taskDetailModal').on('click', '#modal-task-status', function() {
                const taskId = $('#modal-task-id').val();
                const task = allCurrentTasks.find(t => t.id === taskId);
                if (!task) return;
                
                let newStatus = 'Pending';
                if (task.status === 'Pending') {
                    newStatus = 'Completed';
                } else if (task.status === 'Completed') {
                    newStatus = 'Cancelled';
                } else if (task.status === 'Cancelled') {
                    newStatus = 'Pending';
                }

                // Update the model
                TaskManager.update(taskId, { status: newStatus });

                // Manual badge update for immediate visual feedback
                const $statusBadge = $(this);
                let badgeClass = 'bg-info text-white';
                if (newStatus === 'Completed') {
                    badgeClass = 'bg-success';
                } else if (newStatus === 'Cancelled') {
                    badgeClass = 'bg-danger';
                }

                $statusBadge.text(newStatus);
                $statusBadge.removeClass().addClass('badge').addClass(badgeClass);
            });
            
            // 4. Modal: Handle Delete Task button click
            $('#modal-delete-task-btn').on('click', function() {
                const taskId = $('#modal-task-id').val();
                const task = allCurrentTasks.find(t => t.id === taskId);
                
                if (confirm(`Are you sure you want to delete this task: "${task.eventTask}"`)) {
                    TaskManager.delete(taskId);
                    
                    const modalElement = document.getElementById('taskDetailModal');
                    const taskModal = bootstrap.Modal.getInstance(modalElement);
                    if (taskModal) taskModal.hide();
                }
            });

            // 5. Home Tab: Handle click on upcoming event item to show modal (View/Edit)
            $('#upcoming-events-list').on('click', '.home-upcoming-item', function() {
                const taskId = $(this).data('task-id');
                const task = allCurrentTasks.find(t => t.id === taskId);
                
                if (task) { showTaskDetailsModal(task); }
            });

            // 6. To-Do List: Handle click on Details/Edit button
            $('#task-list').on('click', '.details-btn', function(e) {
                e.stopPropagation();
                const taskId = $(this).closest('li').data('task-id');
                const task = allCurrentTasks.find(t => t.id === taskId);
                if (task) { showTaskDetailsModal(task); }
            });

            // 7. Task list actions (Toggle Status)
            $('#task-list').on('click', '.complete-toggle', function(e) {
                e.stopPropagation(); 
                const taskId = $(this).closest('li').data('task-id');
                const task = allCurrentTasks.find(t => t.id === taskId);
                if (!task) return;
                
                // Cycle logic: Pending -> Completed -> Cancelled -> Pending
                let newStatus = 'Pending';
                if (task.status === 'Pending') {
                    newStatus = 'Completed';
                } else if (task.status === 'Completed') {
                    newStatus = 'Cancelled';
                } else if (task.status === 'Cancelled') {
                    newStatus = 'Pending';
                }
                
                TaskManager.update(taskId, { status: newStatus });
            });
            
            // 8. Reporting and Utility Buttons (CSV download)
            $('#download-csv-btn').on('click', function() {
                if (allCurrentTasks.length === 0) {
                    alert('No data to download!');
                    return;
                }
                
                const reportDateStart = $('#report-date-start').val();
                const reportDateEnd = $('#report-date-end').val();
                
                let tasksToDownload = allCurrentTasks;
                
                // Apply date filter for reporting
                if (reportDateStart || reportDateEnd) {
                    tasksToDownload = allCurrentTasks.filter(task => {
                        const taskDate = DateUtils.parseDate(task.eventDate);
                        
                        if (reportDateStart && taskDate < DateUtils.parseDate(reportDateStart)) return false;
                        if (reportDateEnd && taskDate > DateUtils.parseDate(reportDateEnd)) return false;
                        
                        return true;
                    });
                    
                    if (tasksToDownload.length === 0) {
                        showToast("No tasks found for the selected date range.", 4000);
                        return;
                    }
                }

                const headers = [
                    "CompanyName", "EventName", "Task", "Description", "Date", "StartTime",
                    "EstimatedCost", "AdditionalCost", "OrganizerNotes", "TotalCost", "EstimatedTime (Hrs)", "Status"
                ];
                
                const csvRows = tasksToDownload.map(task => {
                    // Apply new business logic for Total Cost in CSV
                    const estCost = parseFloat(task.estimatedCost) || 0;
                    const addCost = parseFloat(task.additionalCost) || 0;
                    
                    let totalCost = addCost; // Always include additional cost
                    if (task.status !== 'Cancelled') {
                        totalCost += estCost; // Only include estimated cost if NOT cancelled
                    }
                    
                    return [
                        `"${task.companyName.replace(/"/g, '""')}"`,
                        `"${task.eventName.replace(/"/g, '""')}"`,
                        `"${task.eventTask.replace(/"/g, '""')}"`,
                        `"${task.taskDescription.replace(/"/g, '""')}"`,
                        task.eventDate,
                        task.eventStartTime, 
                        task.estimatedCost,
                        task.additionalCost, 
                        `"${task.organizerNotes.replace(/"/g, '""')}"`, 
                        totalCost.toFixed(2), // Total Cost
                        task.estimatedTime,
                        task.status // Use the new status field directly
                    ].join(',');
                });

                const csvContent = [headers.join(','), ...csvRows].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);

                link.setAttribute("href", url);
                link.setAttribute("download", `task_report_${new Date().toISOString().slice(0, 10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            // 9. Modal close cleanup
            $('.close-modal-btn').on('click', function() {
                const modalElement = document.getElementById('taskDetailModal');
                const taskModal = bootstrap.Modal.getInstance(modalElement);
                if (taskModal) taskModal.hide();
            });

            $('#taskDetailModal').on('hidden.bs.modal', function () {
                $('body').removeClass('modal-open').css('padding-right', '');
                $('.modal-backdrop').remove();
            });
        });
    </script>
</body>
</html>