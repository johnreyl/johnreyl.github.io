<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Task Planner (Cloud/Local Guest)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Professional Color Palette (Inspired by Google/Material) */
        :root {
            --color-primary: #1a73e8; /* Blue */
            --color-success: #34a853; /* Green */
            --color-warning: #fbbc05; /* Yellow/Warning */
            --color-info: #4285f4; /* Lighter Blue */
            --color-text-subtle: #5f6368; /* Gray Text */
            --color-danger: #ea4335; /* Red */
        }

        body { background-color: #f8f9fa; font-family: 'Roboto', sans-serif; }
        .container { max-width: 950px; margin-top: 30px; }
        .card { border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); border-radius: 8px; }
        
        /* Custom Colors */
        .bg-primary { background-color: var(--color-primary) !important; }
        .btn-primary { background-color: var(--color-primary); border-color: var(--color-primary); }
        .text-primary { color: var(--color-primary) !important; }

        /* Tabs and List Styling */
        .nav-link.active { font-weight: 500; border-bottom: 2px solid var(--color-primary); color: var(--color-primary) !important; background-color: transparent !important; }
        
        /* Home Tab Specific Styles */
        .home-banner {
            background: linear-gradient(135deg, #a400ff, #4285f4); 
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* Loading indicator for Firebase */
        #loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1050;
        }

        /* Custom Loading Overlay used by signInWithGoogle */
        #auth-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: none; /* Starts hidden */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        /* Cloud Sync Modal Styling */
        .start-sync-modal-body {
            text-align: center;
            padding: 30px;
        }
        .google-sign-in-btn {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            width: 100%;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        .google-sign-in-btn:hover {
            background-color: #357ae8;
        }
        .guest-button {
            background-color: #e9ecef;
            color: #495057;
            border: 1px solid #ced4da;
            width: 100%;
        }

        /* Toast Message Styling */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1060;
        }
        .custom-toast {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(100%);
        }
        .custom-toast.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-muted-subtle mb-0">Professional Task Planner</h1>
            <button id="auth-action-btn" class="btn btn-outline-danger btn-sm d-none">
                <i class="fas fa-sign-out-alt me-1"></i> Sign Out
            </button>
        </div>

        
        <div id="loading-indicator" class="d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-primary mt-2" id="loading-text">Connecting...</p>
        </div>

        <div id="auth-loading-overlay">
            <div class="spinner-border text-light mb-3" role="status"></div>
            <p class="text-light">Waiting for Google Sign-In...</p>
        </div>

        <div id="toast-container"></div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">
                    <i class="fas fa-home me-2"></i>Home
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="new-task-tab" data-bs-toggle="tab" data-bs-target="#new-task" type="button" role="tab" aria-controls="new-task" aria-selected="false">
                    <i class="fas fa-plus-circle me-2"></i>New Task
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="todo-list-tab" data-bs-toggle="tab" data-bs-target="#todo-list" type="button" role="tab" aria-controls="todo-list" aria-selected="false">
                    <i class="fas fa-list-check me-2"></i>To-Do List
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">
                    <i class="fas fa-chart-line me-2"></i>Reporting
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div class="home-banner">
                    <h2>Welcome to Your Planner!</h2>
                    <p class="mb-0">Your data is saved securely in the <span id="banner-storage-mode" class="fw-bold">...</span></p>
                </div>
                
                <div class="row g-4">
                    <div class="col-md-7">
                        <div class="card p-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-chart-pie me-2"></i>Accumulated Estimates</h5>
                            <div class="row g-3">
                                <div class="col-md-4 summary-metric">
                                    <h6 class="text-muted-subtle">This Week's Tasks</h6>
                                    <p class="text-success fw-bold mb-1">Cost: <span id="home-week-cost">$0.00</span></p>
                                    <p class="text-warning fw-bold mb-0">Time: <span id="home-week-time">0.0 hrs</span></p>
                                </div>
                                <div class="col-md-4 summary-metric">
                                    <h6 class="text-muted-subtle">This Month's Tasks</h6>
                                    <p class="text-success fw-bold mb-1">Cost: <span id="home-month-cost">$0.00</span></p>
                                    <p class="text-warning fw-bold mb-0">Time: <span id="home-month-time">0.0 hrs</span></p>
                                </div>
                                <div class="col-md-4 summary-metric">
                                    <h6 class="text-muted-subtle">This Year's Tasks</h6>
                                    <p class="text-success fw-bold mb-1">Cost: <span id="home-year-cost">$0.00</span></p>
                                    <p class="text-warning fw-bold mb-0">Time: <span id="home-year-time">0.0 hrs</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-5">
                        <div class="card p-4">
                            <h5 class="text-info mb-3"><i class="fas fa-calendar-check me-2"></i>Top 3 Upcoming Events</h5>
                            <ul class="list-group list-group-flush" id="upcoming-events-list">
                                <li class="list-group-item text-center text-muted-subtle">Loading...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="new-task" role="tabpanel" aria-labelledby="new-task-tab">
                <div class="card p-4">
                    <h5 class="card-title text-primary mb-3"><i class="fas fa-edit me-2"></i>Add Task Details</h5>
                    <form id="party-form" class="row g-3">
                        <div class="col-md-4"><label for="company-name" class="form-label text-muted-subtle">Company/Client</label><input type="text" class="form-control" id="company-name" placeholder="e.g., Acme Corp"></div>
                        <div class="col-md-4"><label for="event-name" class="form-label text-muted-subtle">Event/Project Name</label><input type="text" class="form-control" id="event-name" required value="New Event Project"></div>
                        <div class="col-md-4"><label for="event-task" class="form-label text-muted-subtle">Event Title</label><input type="text" class="form-control" id="event-task" required placeholder="e.g., Finalize venue contract"></div>
                        <div class="col-md-3"><label for="event-date" class="form-label text-muted-subtle">Date</label><input type="date" class="form-control" id="event-date" required></div>
                        <div class="col-md-3"><label for="event-start-time" class="form-label text-muted-subtle">Start Time</label><input type="time" class="form-control" id="event-start-time" value=""></div>
                        <div class="col-md-3"><label for="estimated-cost" class="form-label text-muted-subtle">Est. Cost ($)</label><input type="number" step="0.01" min="0" class="form-control" id="estimated-cost" value="0.00"></div>
                        <div class="col-md-3"><label for="estimated-time" class="form-label text-muted-subtle">Est. Time (Hrs)</label><input type="number" step="0.5" min="0" class="form-control" id="estimated-time" value="1"></div>
                        <div class="col-12"><label for="task-description" class="form-label text-muted-subtle">Description / Notes</label><textarea class="form-control" id="task-description" rows="2" placeholder="Detailed notes for execution and follow-up."></textarea></div>
                        <div class="col-12 text-end"><button type="submit" class="btn btn-primary mt-3"><i class="fas fa-save me-2"></i>Save Task</button></div>
                    </form>
                </div>
            </div>

            <div class="tab-pane fade" id="todo-list" role="tabpanel" aria-labelledby="todo-list-tab">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>Current Task List</h5>
                    </div>
                    <ul id="task-list" class="list-group list-group-flush">
                        <li class="list-group-item text-center text-muted-subtle">Tasks will load after successful setup.</li>
                    </ul>
                </div>
            </div>

            <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                 <div class="row g-4">
                    <div class="col-md-12">
                         <div class="card p-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-chart-area me-2"></i>Summary Overview (All Time)</h5>
                            <div class="row text-center g-3">
                                <div class="col-md-3"><div class="summary-box p-2" style="border-left-color: var(--color-info);"><h6 class="text-muted-subtle">Total Tasks</h6><p class="h4 text-info" id="total-tasks">0</p></div></div>
                                <div class="col-md-3"><div class="summary-box p-2" style="border-left-color: var(--color-success);"><h6 class="text-muted-subtle">Total Est. Budget</h6><p class="h4 text-success">$<span id="total-cost-est">0.00</span></p></div></div>
                                <div class="col-md-3"><div class="summary-box p-2" style="border-left-color: var(--color-warning);"><h6 class="text-muted-subtle">Total Est. Effort (Hrs)</h6><p class="h4 text-warning"><span id="total-time-est">0</span> hrs</p></div></div>
                                <div class="col-md-3"><div class="summary-box p-2" style="border-left-color: var(--color-danger);"><h6 class="text-muted-subtle">Remaining Tasks</h6><p class="h4 text-danger" id="remaining-tasks">0</p></div></div>
                            </div>
                         </div>
                    </div>
                    <div class="col-md-12">
                        <div class="card p-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-tools me-2"></i>Reporting Tools</h5>
                            <button class="btn btn-outline-primary w-100" id="download-csv-btn">
                                <i class="fas fa-download me-2"></i>Download All Data as CSV Report
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div> </div>

    <div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="taskDetailModalLabel">Task Details</h5>
            <button type="button" class="btn-close btn-close-white close-modal-btn" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="modal-task-id">
            <form id="task-update-form" class="row g-3">
                
                <div class="col-md-6 border-end pe-3">
                    <h6 class="text-primary mb-3"><i class="fas fa-calendar-alt me-2"></i>Event Details</h6>
                    <div class="row g-3">
                        <div class="col-12"><label for="modal-company-name-input" class="form-label text-muted-subtle">Company/Client</label><input type="text" class="form-control" id="modal-company-name-input"></div>
                        <div class="col-12"><label for="modal-event-name-input" class="form-label text-muted-subtle">Event/Project Name</label><input type="text" class="form-control" id="modal-event-name-input" required></div>
                        <div class="col-12"><label for="modal-event-task-input" class="form-label text-muted-subtle">Event Title</label><input type="text" class="form-control" id="modal-event-task-input" required></div>
                        <div class="col-md-6"><label for="modal-event-date-input" class="form-label text-muted-subtle">Date</label><input type="date" class="form-control" id="modal-event-date-input" required></div>
                        <div class="col-md-6"><label for="modal-event-time-input" class="form-label text-muted-subtle">Start Time</label><input type="time" class="form-control" id="modal-event-time-input"></div>
                        <div class="col-12"><label for="modal-task-description-input" class="form-label text-muted-subtle">Task Description</label><textarea class="form-control" id="modal-task-description-input" rows="2"></textarea></div>
                    </div>
                </div>

                <div class="col-md-6 ps-3">
                    <h6 class="text-info mb-3"><i class="fas fa-user-gear me-2"></i>Organizer Inputs</h6>
                    <div class="row g-3">
                        <div class="col-md-6"><label for="modal-estimated-cost-input" class="form-label text-muted-subtle">Est. Budget ($)</label><input type="number" step="0.01" min="0" class="form-control" id="modal-estimated-cost-input"></div>
                        <div class="col-md-6"><label for="modal-additional-cost-input" class="form-label text-muted-subtle">Additional Cost ($)</label><input type="number" step="0.01" min="0" class="form-control" id="modal-additional-cost-input" value="0.00"></div>
                        <div class="col-12"><label for="modal-estimated-time-input" class="form-label text-muted-subtle">Est. Effort (Hrs)</label><input type="number" step="0.5" min="0" class="form-control" id="modal-estimated-time-input"></div>
                        <div class="col-12"><label for="modal-organizer-notes-input" class="form-label text-muted-subtle">Organizer Notes</label><textarea class="form-control" id="modal-organizer-notes-input" rows="3"></textarea></div>
                        <div class="col-12 mt-4"><strong>Status:</strong> <span id="modal-task-status" class="badge" title="Click to toggle status"></span></div>
                    </div>
                </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-outline-danger me-auto" id="modal-delete-task-btn">
                <i class="fas fa-trash-alt me-2"></i>Delete Task
            </button>
            <button type="submit" form="task-update-form" class="btn btn-primary">
                <i class="fas fa-sync-alt me-2"></i>Update Task
            </button>
            <button type="button" class="btn btn-secondary close-modal-btn" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="StartCloudSyncModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="StartCloudSyncModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="StartCloudSyncModalLabel">Start Cloud Sync</h5>
                </div>
                <div class="modal-body start-sync-modal-body">
                    <p>Choose how you want to access your planner. **Permanent login** is recommended for secure, multi-device data saving.</p>
                    <button id="google-sign-in-btn" class="google-sign-in-btn">
                        <i class="fab fa-google me-2"></i> Sign in with Google
                    </button>
                    <button id="guest-sign-in-btn" class="btn btn-light guest-button">
                        Continue as Guest (Temporary Local Storage)
                    </button>
                    </div>
            </div>
        </div>
    </div>

    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyDHUMDVGfZY2dwF-uxeG17r9yW3f2gBr-A",
            authDomain: "multitools-fbc73.firebaseapp.com",
            projectId: "multitools-fbc73",
            storageBucket: "multitools-fbc73.firebasestorage.app",
            messagingSenderId: "277024201427",
            appId: "1:277024201427:web:b1d23c088add4324226",
            measurementId: "G-1HJ0N30X1W"
        });
        window.__app_id = 'task_planner_app';
    </script>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        // Import Firebase modules and expose them globally as window.FirebaseTools
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, setDoc, doc, onSnapshot, updateDoc, deleteDoc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 1. Expose Firebase Tools Globally to match the provided sign-in code ---
        window.FirebaseTools = {
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, 
            onAuthStateChanged, signOut, getFirestore, signInAnonymously
        };

        // --- Global State & Initialization ---
        
        const LOCAL_STORAGE_KEY = 'taskPlannerTasks_v11_local'; 
        
        let app; 
        let auth; // Global auth variable
        let db;   // Global db variable
        let tasksCollectionRef = null; 
        let currentTasks = [];
        let firebaseUnsubscribe = null; 
        
        let storageMode = ''; 
        let userId = null;
        let isGoogleSignedIn = false;
        
        const defaultTask = {
            companyName: '', 
            eventName: 'New Event Project',
            eventDate: '',
            eventStartTime: '',
            eventTask: '',
            taskDescription: '',
            estimatedCost: '0.00',
            estimatedTime: '1.0',
            additionalCost: '0.00',
            organizerNotes: '',
            completed: false,
            createdAt: new Date().toISOString()
        };
        
        // --- 2. Custom UI Overlays/Toasts (Placeholders for provided auth code) ---
        const loadingOverlay = document.getElementById('auth-loading-overlay');
        
        function showToast(message, duration = 3000) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'custom-toast';
            toast.textContent = message;
            container.appendChild(toast);

            // Show
            setTimeout(() => toast.classList.add('show'), 10);
            
            // Hide
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500); // Wait for transition
            }, duration);
        }

        // --- UI & Utility Functions (Adjusted) ---

        function showLoading(text) {
            $('#loading-text').text(text);
            $('#loading-indicator').removeClass('d-none');
        }

        function hideLoading() {
            $('#loading-indicator').addClass('d-none');
        }

        function showCloudSyncModal() {
            const modalElement = document.getElementById('StartCloudSyncModal');
            const syncModal = new bootstrap.Modal(modalElement, {
                backdrop: 'static', 
                keyboard: false     
            });
            syncModal.show();
        }

        function hideCloudSyncModal() {
            const modalElement = document.getElementById('StartCloudSyncModal');
            const syncModal = bootstrap.Modal.getInstance(modalElement);
            if (syncModal) syncModal.hide();
        }

        function updateUIOnModeChange() {
            if (storageMode === 'firebase') {
                const userEmail = auth.currentUser?.email || 'Authenticated User';
                const modeText = isGoogleSignedIn ? `Permanent Cloud (User: ${userEmail})` : 'Temporary Cloud (Guest)';
                $('#banner-storage-mode').text(modeText);
                
                $('#auth-action-btn').removeClass('d-none').text('Sign Out').off('click').on('click', async () => {
                    if (confirm("Are you sure you want to sign out?")) {
                        await signOut(auth);
                    }
                });
            } else if (storageMode === 'local') {
                $('#banner-storage-mode').text('Local Storage (Guest Mode - Browser Only)');
                $('#auth-action-btn').removeClass('d-none').text('Exit Guest Mode').off('click').on('click', () => {
                    if (confirm("Are you sure you want to exit Guest Mode?")) {
                        storageMode = ''; 
                        currentTasks = [];
                        renderTasks([]);
                        updateUIOnModeChange(); 
                        showCloudSyncModal(); 
                    }
                });
            } else {
                $('#banner-storage-mode').text('None (Please sign in)');
                $('#auth-action-btn').addClass('d-none');
                renderTasks([]); 
            }
        }

        // --- CORE LOGIC: Storage Implementation ---
        
        const LocalStorageImpl = {
            load: () => {
                showLoading("Loading from Local Storage...");
                const tasks = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY) || '[]');
                const normalizedTasks = tasks.map((task, index) => ({
                    ...defaultTask, 
                    ...task,
                    id: task.id || `local-${index}` 
                }));
                normalizedTasks.sort((a, b) => DateUtils.parseDate(a.eventDate) - DateUtils.parseDate(b.eventDate));
                setTimeout(hideLoading, 300); 
                return normalizedTasks;
            },
            save: (tasks) => localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tasks)),
            add: (newTask) => {
                const tasks = LocalStorageImpl.load();
                tasks.push({...defaultTask, ...newTask, id: `local-${Date.now()}`});
                LocalStorageImpl.save(tasks);
                renderTasks(tasks); 
            },
            update: (taskId, updatedFields) => {
                const tasks = LocalStorageImpl.load();
                const index = tasks.findIndex(t => t.id === taskId);
                if (index > -1) {
                    tasks[index] = { ...tasks[index], ...updatedFields };
                    LocalStorageImpl.save(tasks);
                    renderTasks(tasks); 
                }
            },
            delete: (taskId) => {
                const tasks = LocalStorageImpl.load().filter(t => t.id !== taskId);
                LocalStorageImpl.save(tasks);
                renderTasks(tasks); 
            }
        };

        const FirebaseImpl = {
            startSync: () => {
                if (!tasksCollectionRef) return;
                
                if (firebaseUnsubscribe) { firebaseUnsubscribe(); } 
                
                showLoading("Syncing with Firebase Cloud...");
                
                firebaseUnsubscribe = onSnapshot(query(tasksCollectionRef), (snapshot) => {
                    const tasks = [];
                    snapshot.forEach(doc => {
                        tasks.push({ id: doc.id, ...defaultTask, ...doc.data() }); 
                    });
                    
                    tasks.sort((a, b) => DateUtils.parseDate(a.eventDate) - DateUtils.parseDate(b.eventDate));
                    
                    renderTasks(tasks); 
                    hideLoading();
                }, (error) => {
                    console.error("Error reading data from Firestore: ", error);
                    showToast("Error connecting to Firebase: " + error.message, 5000);
                    hideLoading();
                });
            },
            stopSync: () => {
                if (firebaseUnsubscribe) {
                    firebaseUnsubscribe();
                    firebaseUnsubscribe = null;
                }
            },
            add: async (newTask) => {
                if (!tasksCollectionRef || !auth.currentUser) return;
                const newDocRef = doc(collection(db, `users/${auth.currentUser.uid}/sticky_notes`));
                await setDoc(newDocRef, { ...defaultTask, ...newTask, createdAt: new Date().toISOString() });
            },
            update: async (taskId, updatedFields) => {
                if (!tasksCollectionRef) return;
                const taskRef = doc(db, tasksCollectionRef.path, taskId);
                await updateDoc(taskRef, updatedFields);
            },
            delete: async (taskId) => {
                if (!tasksCollectionRef) return;
                const taskRef = doc(db, tasksCollectionRef.path, taskId);
                await deleteDoc(taskRef);
            }
        };

        // --- Task Manager Interface (The Router) ---
        const TaskManager = {
            loadAndRender: () => {
                updateUIOnModeChange();

                if (storageMode === 'firebase') {
                    FirebaseImpl.startSync();
                } else if (storageMode === 'local') {
                    FirebaseImpl.stopSync();
                    const tasks = LocalStorageImpl.load();
                    renderTasks(tasks);
                } else {
                    renderTasks([]);
                }
            },
            add: (newTask) => {
                if (storageMode === 'firebase') return FirebaseImpl.add(newTask);
                if (storageMode === 'local') return LocalStorageImpl.add(newTask);
            },
            update: (taskId, updatedFields) => {
                if (storageMode === 'firebase') return FirebaseImpl.update(taskId, updatedFields);
                if (storageMode === 'local') return LocalStorageImpl.update(taskId, updatedFields);
            },
            delete: (taskId) => {
                if (storageMode === 'firebase') return FirebaseImpl.delete(taskId);
                if (storageMode === 'local') return LocalStorageImpl.delete(taskId);
            },
            toggleComplete: (taskId) => {
                const task = currentTasks.find(t => t.id === taskId);
                if (!task) return;
                TaskManager.update(taskId, { completed: !task.completed });
            }
        };

        // --- 3. Integrated Auth Functions from User ---

        async function signInWithGoogle() {
            if (!window.FirebaseTools) {
                showToast("Cloud connection is not available.", 3000);
                return false;
            }

            const { GoogleAuthProvider, signInWithPopup } = window.FirebaseTools;
            const provider = new GoogleAuthProvider();
            provider.setCustomParameters({ prompt: 'select_account' }); 

            loadingOverlay.style.display = 'flex';
            loadingOverlay.querySelector('p').textContent = 'Waiting for Google Sign-In...';

            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                userId = user.uid;
                isGoogleSignedIn = true; 
                
                loadingOverlay.style.display = 'none';
                showToast(`Signed in as ${user.displayName || 'Google User'}! ðŸš€`, 4000);
                return true;
            } catch (error) {
                loadingOverlay.style.display = 'none';
                
                if (error.code === 'auth/popup-closed-by-user' || error.code === 'auth/cancelled-popup-request') {
                    showToast("Google Sign-In canceled.", 3000);
                } else {
                    console.error("Google Sign-In Error:", error);
                    showToast(`Sign-In Failed: ${error.message.substring(0, 50)}...`, 5000);
                }
                return false;
            }
        }

        async function initializeFirebase() {
            if (!window.FirebaseTools) return;
            try {
                const firebaseConfig = JSON.parse(window.__firebase_config);
                const { initializeApp, getAuth, signInAnonymously, getFirestore } = window.FirebaseTools;

                app = initializeApp(firebaseConfig);
                auth = getAuth(app); 
                db = getFirestore(app);
                
                // If no user is currently authenticated (new session or sign-out), sign in anonymously
                if (!auth.currentUser) {
                    await signInAnonymously(auth);
                }
                
            } catch (e) {
                console.error("Firebase Initialization Failed:", e);
                showToast("Firebase Initialization Failed. Check console.", 5000);
            }
        }

        // --- Remaining Utility Functions ---
        
        const DateUtils = {
            getPeriodStartEnd: (period) => {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let start = new Date(today);
                let end = new Date(today);

                if (period === 'week') { end.setDate(today.getDate() + 7); } 
                else if (period === 'month') { start.setDate(1); end = new Date(today.getFullYear(), today.getMonth() + 1, 0); } 
                else if (period === 'year') { start.setMonth(0, 1); end.setMonth(11, 31); }
                return { start, end };
            },
            parseDate: (dateString) => {
                const parts = dateString.split('-');
                return new Date(parts[0], parts[1] - 1, parts[2]); 
            }
        };

        function renderTasks(tasks) {
            currentTasks = tasks;
            const $taskList = $('#task-list');
            $taskList.empty();

            if (tasks.length === 0) {
                 const modeText = storageMode === 'local' ? 'Local Storage (Temporary)' : 'Cloud Storage';
                 $taskList.append(`<li class="list-group-item text-center text-muted-subtle">No tasks found in ${modeText}.</li>`);
            }

            tasks.forEach(task => {
                const costDisplay = (parseFloat(task.estimatedCost) + parseFloat(task.additionalCost || 0)).toFixed(2);
                const timeDisplay = parseFloat(task.estimatedTime);
                const timeBadge = task.eventStartTime ? `<span class="badge bg-secondary ms-1" title="Start Time">${task.eventStartTime}</span>` : '';
                const companyDisplay = task.companyName ? `<span class="text-muted-subtle ms-1">(${task.companyName})</span>` : '';

                const $li = $('<li>')
                    .addClass(`list-group-item d-flex justify-content-between align-items-center ${task.completed ? 'list-group-item-success' : ''}`)
                    .attr('data-task-id', task.id); 

                const taskContent = `
                    <div>
                        <strong>${task.eventName}</strong> ${companyDisplay}: 
                        <span class="${task.completed ? 'text-decoration-line-through text-success' : 'fw-bold'}">${task.eventTask}</span> 
                        <span class="badge bg-secondary ms-2">${task.eventDate}</span>
                        ${timeBadge}
                        
                        <span class="badge bg-success ms-2" title="Total Estimated Cost">$${costDisplay}</span>
                        <span class="badge bg-warning text-dark" title="Estimated Time">${timeDisplay}h</span>
                    </div>
                `;

                const actionButtons = `
                    <div>
                        <span class="badge ${task.completed ? 'bg-success' : 'bg-info'} text-white complete-toggle me-2" 
                            style="cursor: pointer;" title="Toggle Status">
                            ${task.completed ? 'DONE' : 'PENDING'}
                        </span>
                        <button class="btn btn-sm btn-outline-primary details-btn" title="Show/Edit Details">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                `;

                $li.append(taskContent).append(actionButtons);
                $taskList.append($li);
            });

            updateReportingSummary(tasks);
            renderHomeTab(tasks);
        }

        function updateReportingSummary(tasks) {
            let totalCostEst = 0;
            let totalTimeEst = 0;
            let completedCount = 0;

            tasks.forEach(task => {
                totalCostEst += parseFloat(task.estimatedCost) || 0;
                totalTimeEst += parseFloat(task.estimatedTime) || 0;
                if (task.completed) { completedCount++; }
            });

            $('#total-tasks').text(tasks.length);
            $('#total-cost-est').text(totalCostEst.toFixed(2));
            $('#total-time-est').text(totalTimeEst.toFixed(1));
            $('#remaining-tasks').text(tasks.length - completedCount);
        }

        function renderHomeTab(tasks) {
            const today = DateUtils.parseDate(new Date().toISOString().split('T')[0]);
            
            ['week', 'month', 'year'].forEach(period => {
                const { start, end } = DateUtils.getPeriodStartEnd(period);
                let costTotal = 0;
                let timeTotal = 0;

                const filteredTasks = tasks.filter(task => {
                    const taskDate = DateUtils.parseDate(task.eventDate);
                    return taskDate >= start && taskDate <= end;
                });

                filteredTasks.forEach(task => {
                    costTotal += parseFloat(task.estimatedCost) || 0;
                    timeTotal += parseFloat(task.estimatedTime) || 0;
                });

                $(`#home-${period}-cost`).text(`$${costTotal.toFixed(2)}`);
                $(`#home-${period}-time`).text(`${timeTotal.toFixed(1)} hrs`);
            });

            const upcomingTasks = tasks
                .filter(task => !task.completed && DateUtils.parseDate(task.eventDate) >= today)
                .sort((a, b) => DateUtils.parseDate(a.eventDate) - DateUtils.parseDate(b.eventDate))
                .slice(0, 3);

            const $upcomingList = $('#upcoming-events-list');
            $upcomingList.empty();

            if (upcomingTasks.length === 0) {
                $upcomingList.append('<li class="list-group-item text-center text-muted-subtle">No pending upcoming events!</li>');
            } else {
                upcomingTasks.forEach(task => {
                    const taskDate = DateUtils.parseDate(task.eventDate);
                    const daysLeft = Math.ceil((taskDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                    
                    $upcomingList.append(`
                        <li class="list-group-item d-flex justify-content-between align-items-center home-upcoming-item" 
                            data-task-id="${task.id}">
                            <div>
                                <i class="fas fa-calendar-alt text-primary me-2"></i>
                                <strong>${task.eventTask}</strong> (${task.eventName})
                            </div>
                            <span class="badge ${daysLeft <= 3 ? 'bg-danger' : 'bg-info'}">
                                ${daysLeft <= 0 ? 'Due Today' : `${daysLeft} days left`}
                            </span>
                        </li>
                    `);
                });
            }
        }

        function showTaskDetailsModal(task) {
            $('#modal-task-id').val(task.id); 
            $('#modal-company-name-input').val(task.companyName);
            $('#modal-event-name-input').val(task.eventName);
            $('#modal-event-task-input').val(task.eventTask);
            $('#modal-event-date-input').val(task.eventDate);
            $('#modal-event-time-input').val(task.eventStartTime);
            $('#modal-estimated-cost-input').val(parseFloat(task.estimatedCost).toFixed(2));
            $('#modal-estimated-time-input').val(parseFloat(task.estimatedTime).toFixed(1));
            $('#modal-task-description-input').val(task.taskDescription);
            $('#modal-additional-cost-input').val(parseFloat(task.additionalCost || 0).toFixed(2));
            $('#modal-organizer-notes-input').val(task.organizerNotes);
            
            const $statusBadge = $('#modal-task-status');
            $statusBadge.text(task.completed ? 'Completed' : 'Pending');
            $statusBadge.removeClass().addClass('badge');
            $statusBadge.addClass(task.completed ? 'bg-success' : 'bg-info text-white');
            
            const taskModal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
            taskModal.show();
        }

        // --- Event Handlers (Updated for new auth flow) ---
        $(document).ready(async function() {
            
            // Step 1: Initialize Firebase and define the AUTH object.
            await initializeFirebase();

            // Step 2: Define and attach the onAuthStateChanged listener now that 'auth' exists.
            let isFirstAuthCheck = true;
            onAuthStateChanged(auth, (user) => { 
                if (user) {
                    userId = user.uid;

                    if (!user.isAnonymous) {
                        // Google/Email user session is active
                        storageMode = 'firebase';
                        isGoogleSignedIn = true;
                        tasksCollectionRef = collection(db, `users/${user.uid}/sticky_notes`); 
                        hideCloudSyncModal();
                        TaskManager.loadAndRender();
                    } else if (storageMode === 'firebase' && !isFirstAuthCheck) {
                        // If an Anonymous user tries to use 'firebase' mode (shouldn't happen), sign out.
                        signOut(auth);
                    }
                    
                } else {
                    // User signed out or no session found (anonymous included if explicitly signed out)
                    tasksCollectionRef = null;
                    FirebaseImpl.stopSync();

                    if (storageMode === 'firebase' || storageMode === '') {
                        // If we were in Firebase mode, revert and show modal.
                        // Also show modal if storageMode is unselected ('').
                        storageMode = ''; 
                        updateUIOnModeChange();
                        renderTasks([]);
                        showCloudSyncModal();
                    }
                }
                isFirstAuthCheck = false;
            });

            // Step 3: Initial UI/Modal State Check
            // If the user is connected (Google or Anonymous), the onAuthStateChanged listener takes over.
            // If they are not connected with Google, the listener (above) will show the modal.
            if (auth.currentUser && !auth.currentUser.isAnonymous) {
                 // Already signed in with Google, start immediately
                 storageMode = 'firebase';
                 TaskManager.loadAndRender();
            } else if (auth.currentUser && auth.currentUser.isAnonymous) {
                 // Anonymous session is active, but we need to prompt them for permanent storage
                 showCloudSyncModal();
            }
            
            // Handle Google Sign-In Button Click (Uses the custom signInWithGoogle function)
            $('#google-sign-in-btn').on('click', async function() {
                await signInWithGoogle();
                // Auth state change handler will run the rest of the logic
            });
            
            // Handle Guest Sign-In Button Click (Local Storage)
            $('#guest-sign-in-btn').on('click', function() {
                storageMode = 'local';
                hideCloudSyncModal();
                TaskManager.loadAndRender();
            });
            
            // 1. Handle form submission (Add Task)
            $('#party-form').on('submit', function(e) {
                e.preventDefault();

                if (storageMode === 'firebase' && (!auth.currentUser || auth.currentUser.isAnonymous)) {
                    showToast("Please fully sign in with Google to save tasks to the cloud.", 4000);
                    showCloudSyncModal();
                    return;
                }
                
                if (!storageMode) {
                    alert('Please select a storage method (Sign In or Guest Mode) before adding tasks.');
                    showCloudSyncModal();
                    return;
                }

                const newTask = {
                    companyName: $('#company-name').val().trim(),
                    eventName: $('#event-name').val().trim(),
                    eventDate: $('#event-date').val(),
                    eventStartTime: $('#event-start-time').val().trim(),
                    eventTask: $('#event-task').val().trim(),
                    taskDescription: $('#task-description').val().trim(),
                    estimatedCost: parseFloat($('#estimated-cost').val() || 0).toFixed(2),
                    estimatedTime: parseFloat($('#estimated-time').val() || 0).toFixed(1),
                    completed: false
                };

                if (!newTask.eventName || !newTask.eventDate || !newTask.eventTask) {
                    alert('Please fill in required fields.');
                    return;
                }

                TaskManager.add(newTask);
                
                $('#event-task').val('');
                $('#task-description').val('');
                new bootstrap.Tab($('#todo-list-tab')).show(); 
            });
            
            // 2. Handle Task Update Form Submission (Inside Modal)
            $('#task-update-form').on('submit', function(e) {
                e.preventDefault();

                const taskId = $('#modal-task-id').val();
                
                const updatedFields = {
                    companyName: $('#modal-company-name-input').val().trim(),
                    eventName: $('#modal-event-name-input').val().trim(),
                    eventDate: $('#modal-event-date-input').val(),
                    eventStartTime: $('#modal-event-time-input').val().trim(),
                    eventTask: $('#modal-event-task-input').val().trim(),
                    taskDescription: $('#modal-task-description-input').val().trim(),
                    estimatedCost: parseFloat($('#modal-estimated-cost-input').val() || 0).toFixed(2),
                    estimatedTime: parseFloat($('#modal-estimated-time-input').val() || 0).toFixed(1),
                    additionalCost: parseFloat($('#modal-additional-cost-input').val() || 0).toFixed(2), 
                    organizerNotes: $('#modal-organizer-notes-input').val().trim(), 
                };
                
                const currentTask = currentTasks.find(t => t.id === taskId);
                updatedFields.completed = currentTask?.completed || false; 

                if (!updatedFields.eventName || !updatedFields.eventDate || !updatedFields.eventTask) {
                    alert('Required fields must be filled.');
                    return;
                }
                
                TaskManager.update(taskId, updatedFields);
                
                const modalElement = document.getElementById('taskDetailModal');
                const taskModal = bootstrap.Modal.getInstance(modalElement);
                if (taskModal) taskModal.hide();
            });

            // 3. Modal: Toggle Complete by clicking STATUS badge
            $('#taskDetailModal').on('click', '#modal-task-status', function() {
                const taskId = $('#modal-task-id').val();
                TaskManager.toggleComplete(taskId);

                const task = currentTasks.find(t => t.id === taskId);
                const newCompleted = !task.completed;
                const $statusBadge = $(this);
                $statusBadge.text(newCompleted ? 'Completed' : 'Pending');
                $statusBadge.removeClass().addClass('badge');
                $statusBadge.addClass(newCompleted ? 'bg-success' : 'bg-info text-white');
            });
            
            // 4. Modal: Handle Delete Task button click
            $('#modal-delete-task-btn').on('click', function() {
                const taskId = $('#modal-task-id').val();
                const task = currentTasks.find(t => t.id === taskId);
                
                if (confirm(`Are you sure you want to delete this task: "${task.eventTask}"?`)) {
                    TaskManager.delete(taskId);
                    
                    const modalElement = document.getElementById('taskDetailModal');
                    const taskModal = bootstrap.Modal.getInstance(modalElement);
                    if (taskModal) taskModal.hide();
                }
            });


            // 5. Home Tab: Handle click on upcoming event item to show modal (View/Edit)
            $('#upcoming-events-list').on('click', '.home-upcoming-item', function() {
                const taskId = $(this).data('task-id');
                const task = currentTasks.find(t => t.id === taskId);
                
                if (task) { showTaskDetailsModal(task); }
            });

            // 6. To-Do List: Handle click on Details/Edit button
            $('#task-list').on('click', '.details-btn', function(e) {
                e.stopPropagation();
                const taskId = $(this).closest('li').data('task-id');
                const task = currentTasks.find(t => t.id === taskId);
                if (task) { showTaskDetailsModal(task); }
            });

            // 7. Task list actions (Toggle Complete)
            $('#task-list').on('click', '.complete-toggle', function(e) {
                e.stopPropagation(); 
                const taskId = $(this).closest('li').data('task-id');
                TaskManager.toggleComplete(taskId);
            });
            
            // 8. Reporting and Utility Buttons (CSV download)
            $('#download-csv-btn').on('click', function() {
                if (currentTasks.length === 0) {
                    alert('No data to download!');
                    return;
                }
                
                const headers = [
                    "CompanyName", "EventName", "Task", "Description", "Date", "StartTime",
                    "EstimatedCost", "AdditionalCost", "OrganizerNotes", "EstimatedTime (Hrs)", "Status"
                ];
                
                const csvRows = currentTasks.map(task => [
                    `"${task.companyName.replace(/"/g, '""')}"`,
                    `"${task.eventName.replace(/"/g, '""')}"`,
                    `"${task.eventTask.replace(/"/g, '""')}"`,
                    `"${task.taskDescription.replace(/"/g, '""')}"`,
                    task.eventDate,
                    task.eventStartTime, 
                    task.estimatedCost,
                    task.additionalCost, 
                    `"${task.organizerNotes.replace(/"/g, '""')}"`, 
                    task.estimatedTime,
                    task.completed ? "Completed" : "Pending"
                ].join(','));

                const csvContent = [headers.join(','), ...csvRows].join('\n');

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);

                link.setAttribute("href", url);
                link.setAttribute("download", `task_report_${new Date().toISOString().slice(0, 10)}.csv`);
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
            
            // 9. Modal close cleanup
            $('.close-modal-btn').on('click', function() {
                const modalElement = document.getElementById('taskDetailModal');
                const taskModal = bootstrap.Modal.getInstance(modalElement);
                if (taskModal) taskModal.hide();
            });

            $('#taskDetailModal').on('hidden.bs.modal', function () {
                $('body').removeClass('modal-open').css('padding-right', '');
                $('.modal-backdrop').remove();
            });
        });
    </script>
</body>
</html>