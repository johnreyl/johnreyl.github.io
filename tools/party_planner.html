<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Professional Party Planner (Cloud/Local Sync)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Professional Color Palette (Inspired by Google/Material) */
        :root {
            --color-primary: #1a73e8; /* Blue */
            --color-success: #34a853; /* Green */
            --color-warning: #fbbc05; /* Yellow/Warning */
            --color-info: #4285f4; /* Lighter Blue */
            --color-text-subtle: #5f6368; /* Gray Text */
            --color-danger: #ea4335; /* Red */
        }

        body { background-color: #f8f9fa; font-family: 'Roboto', sans-serif; }
        .container { max-width: 950px; margin-top: 30px; }
        .card { border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); border-radius: 8px; }
        
        /* Custom Colors */
        .bg-primary { background-color: var(--color-primary) !important; }
        .btn-primary { background-color: var(--color-primary); border-color: var(--color-primary); }
        .text-primary { color: var(--color-primary) !important; }

        /* Tabs and List Styling */
        .nav-link.active { font-weight: 500; border-bottom: 2px solid var(--color-primary); color: var(--color-primary) !important; background-color: transparent !important; }
        
        /* Home Tab Specific Styles */
        .home-banner {
            background: linear-gradient(135deg, #a400ff, #4285f4); 
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* Loading indicator for Firebase */
        #loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1050;
        }

        /* Custom Loading Overlay used by signInWithGoogle function */
        #auth-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            display: none; /* Starts hidden */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        /* Cloud Sync Modal Styling */
        .start-sync-modal-body {
            text-align: center;
            padding: 30px;
        }
        .google-sign-in-btn {
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            font-weight: bold;
            width: 100%;
            margin-bottom: 10px;
            transition: background-color 0.2s;
        }
        .google-sign-in-btn:hover {
            background-color: #357ae8;
        }
        .guest-button {
            background-color: #e9ecef;
            color: #495057;
            border: 1px solid #ced4da;
            width: 100%;
        }

        /* Toast Message Styling */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1060;
        }
        .custom-toast {
            background-color: #333;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(100%);
        }
        .custom-toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        /* Filter Styles */
        .filter-input-group label { font-size: 0.8rem; color: var(--color-text-subtle); margin-bottom: 0.1rem; }
        .filter-input-group input { height: 32px; font-size: 0.9rem; padding: 0.25rem 0.5rem; }
        .filter-card { background-color: #f1f3f4; border-bottom: 1px solid #dee2e6; padding: 10px; border-radius: 8px 8px 0 0; }
        .filter-card h6 { font-size: 0.9rem; font-weight: 500; margin-bottom: 0.5rem; color: #5f6368; }

        /* Reports Tab Custom Styles for Alignment and Mobile */
        .summary-box {
            border-left: 3px solid transparent;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center; /* Center align for titles */
        }
        .summary-box h6 {
            white-space: nowrap;
            text-align: center;
        }
        .summary-box p {
            width: 100%;
            text-align: center;
            font-variant-numeric: tabular-nums; /* Helps align digits */
            font-size: 1.5rem !important;
        }
        
        /* ADDITION: Reports Mobile Adjustments */
        @media (max-width: 576px) { 
            .summary-box h6 {
                font-size: 0.7rem !important; 
                white-space: normal;
                line-height: 1.2;
            }
            .summary-box p {
                font-size: 1.2rem !important; 
            }
        }
        /* END ADDITION */

        /* Specific left-border colors using utility classes */
        .border-left-info { border-left-color: var(--color-info) !important; }
        .border-left-success { border-left-color: var(--color-success) !important; }
        .border-left-primary { border-left-color: var(--color-primary) !important; }
        .border-left-warning { border-left-color: var(--color-warning) !important; }

        /* NEW: Custom style for Cancelled list item */
        .list-group-item.list-group-item-danger {
            background-color: #f8d7da !important; /* Bootstrap's alert-danger light color */
        }
        /* Style for revenue display */
        .text-revenue { color: #008000 !important; } /* A bright green for revenue */
        .border-left-revenue { border-left-color: #008000 !important; }
        /* Template 6: Refund Issued (e.g., a light taupe/gray) */
        .btn-template-6 {
            background-color: #f7f7f7; /* Very light gray */
            color: #6c757d; /* Bootstrap secondary gray */
            border-color: #f7f7f7;
            transition: all 0.2s ease-in-out;
        }

        .btn-template-6:hover {
            background-color: #e6e6e6; /* Slightly darker on hover */
            border-color: #e6e6e6;
            color: #5a6268;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .btn-template-6:active,
        .btn-template-6:focus {
            background-color: #d8d8d8 !important;
            border-color: #d8d8d8 !important;
            color: #495057 !important;
            box-shadow: 0 0 0 0.25rem rgba(108, 117, 125, 0.25) !important;
        }
        /* Template 7: Down Payment Received (e.g., a light yellow/gold) */
        .btn-template-7 {
            background-color: #fffde7; /* Very light yellow/cream */
            color: #e3bc00; /* Darker gold/yellow for text */
            border-color: #fffde7;
            transition: all 0.2s ease-in-out;
        }

        .btn-template-7:hover {
            background-color: #fffac7; /* Slightly darker on hover */
            border-color: #fffac7;
            color: #b39200;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .btn-template-7:active,
        .btn-template-7:focus {
            background-color: #fff4a3 !important;
            border-color: #fff4a3 !important;
            color: #8c7300 !important;
            box-shadow: 0 0 0 0.25rem rgba(227, 188, 0, 0.25) !important;
        }

        /* Ensure all button styles are included in your final CSS file */
        .btn-template-1,
        .btn-template-2,
        .btn-template-3,
        .btn-template-4,
        .btn-template-5,
        .btn-template-6,
        .btn-template-7 {
            font-weight: 500;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="text-muted-subtle mb-0">Professional Party Planner</h1>
            <button id="auth-action-btn" class="btn btn-outline-danger btn-sm d-none">
                <i class="fas fa-sign-out-alt me-1"></i> Sign Out
            </button>
        </div>

        
        <div id="loading-indicator" class="d-none">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-primary mt-2" id="loading-text">Connecting...</p>
        </div>

        <div id="auth-loading-overlay">
            <div class="spinner-border text-light mb-3" role="status"></div>
            <p class="text-light">Waiting for Google Sign-In...</p>
        </div>

        <div id="toast-container"></div>

        <ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">
                    <i class="fas fa-home me-2"></i>Home
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="new-task-tab" data-bs-toggle="tab" data-bs-target="#new-task" type="button" role="tab" aria-controls="new-task" aria-selected="false">
                    <i class="fas fa-plus-circle me-2"></i>New Task
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="todo-list-tab" data-bs-toggle="tab" data-bs-target="#todo-list" type="button" role="tab" aria-controls="todo-list" aria-selected="false">
                    <i class="fas fa-list-check me-2"></i>To-Do List
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button" role="tab" aria-controls="reports" aria-selected="false">
                    <i class="fas fa-chart-line me-2"></i>Reporting
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div class="home-banner">
                    <h2>Welcome to Your Party Planner!</h2>
                    <p class="mb-0">Your data is saved securely in the <span id="banner-storage-mode" class="fw-bold">...</span></p>
                </div>
                
                <div class="row g-4">
                    <div class="col-md-7">
                        <div class="card p-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-chart-pie me-2"></i>Accumulated Estimates (Costs & Revenue)</h5>
                            <div class="row g-3">
                                <div class="col-md-4 summary-metric">
                                    <h6 class="text-muted-subtle">This Week's Tasks</h6>
                                    <p class="text-danger fw-bold mb-1">Cost: <span id="home-week-cost">0.00</span></p>
                                    <p class="text-revenue fw-bold mb-1">Revenue: <span id="home-week-revenue">0.00</span></p>
                                    <p class="fw-bold mb-0">Time: <span id="home-week-time">0.0 hrs</span></p>
                                </div>
                                <div class="col-md-4 summary-metric">
                                    <h6 class="text-muted-subtle">This Month's Tasks</h6>
                                    <p class="text-danger fw-bold mb-1">Cost: <span id="home-month-cost">0.00</span></p>
                                    <p class="text-revenue fw-bold mb-1">Revenue: <span id="home-month-revenue">0.00</span></p>
                                    <p class="fw-bold mb-0">Time: <span id="home-month-time">0.0 hrs</span></p>
                                </div>
                                <div class="col-md-4 summary-metric">
                                    <h6 class="text-muted-subtle">This Year's Tasks</h6>
                                    <p class="text-danger fw-bold mb-1">Cost: <span id="home-year-cost">0.00</span></p>
                                    <p class="text-revenue fw-bold mb-1">Revenue: <span id="home-year-revenue">0.00</span></p>
                                    <p class="fw-bold mb-0">Time: <span id="home-year-time">0.0 hrs</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-5">
                        <div class="card p-4 mb-4">
                            <h5 class="text-success mb-3"><i class="fas fa-users-viewfinder me-2"></i>5 Most Recent Active Clients</h5>
                            <ul class="list-group list-group-flush" id="recent-clients-list">
                                <li class="list-group-item text-center text-muted-subtle">Loading...</li>
                            </ul>
                        </div>
                        
                        <div class="card p-4">
                            <h5 class="text-info mb-3"><i class="fas fa-calendar-check me-2"></i>Top 10 Upcoming Events</h5>
                            <ul class="list-group list-group-flush" id="upcoming-events-list">
                                <li class="list-group-item text-center text-muted-subtle">Loading...</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-pane fade" id="new-task" role="tabpanel" aria-labelledby="new-task-tab">
                <div class="card p-4">
                    <h5 class="card-title text-primary mb-3"><i class="fas fa-edit me-2"></i>Add Task Details</h5>
                    <form id="party-form" class="row g-3">
                        
                        <div class="col-12 mt-1 mb-0"><h6 class="text-info"><i class="fas fa-file-invoice me-2"></i>Primary Event Details</h6><hr class="mt-1 mb-2"></div>

                        <div class="col-md-3"><label for="client-host-name" class="form-label text-muted-subtle">Client/Host Name</label><input type="text" class="form-control" id="client-host-name" placeholder="e.g., Mikaela's Parents"></div>
                        <div class="col-md-3"><label for="party-event-title" class="form-label text-muted-subtle">Party/Event Title</label><input type="text" class="form-control" id="party-event-title" required value="New Party Event"></div>
                        <div class="col-md-3"><label for="task-item-description" class="form-label text-muted-subtle">Task/Item Description</label><input type="text" class="form-control" id="task-item-description" required placeholder="e.g., Book Catering Vendor"></div>
                        <div class="col-md-3">
                            <label for="category-service" class="form-label text-muted-subtle">Category/Service</label>
                            <select class="form-select" id="category-service" required>
                                <option value="Catering">Catering</option>
                                <option value="Venue">Venue</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Decorations">Decorations</option>
                                <option value="Guest Management">Guest Management</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Other" selected>Other</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label for="client-phone-number" class="form-label text-muted-subtle">Client Phone Number</label>
                            <input type="tel" class="form-control" id="client-phone-number" placeholder="e.g., +1 (555) 123-4567">
                        </div>
                        <div class="col-md-6">
                            <label for="client-email" class="form-label text-muted-subtle">Client Email</label>
                            <input type="email" class="form-control" id="client-email" placeholder="e.g., client@example.com">
                        </div>
                        
                        <div class="col-12 mt-3 mb-0"><h6 class="text-info"><i class="fas fa-calendar-check me-2"></i>Scheduling & Estimated Effort</h6><hr class="mt-1 mb-2"></div>

                        <div class="col-md-3"><label for="event-date" class="form-label text-muted-subtle">Date</label><input type="date" class="form-control" id="event-date" required></div>
                        <div class="col-md-3"><label for="event-start-time" class="form-label text-muted-subtle">Start Time</label><input type="time" class="form-control" id="event-start-time" value=""></div>
                        
                        <div class="col-md-3"><label for="estimated-vendor-cost" class="form-label text-muted-subtle">Processing Cost (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="estimated-vendor-cost" value="0.00"></div>
                        <div class="col-md-3"><label for="estimated-planning-time" class="form-label text-muted-subtle">Est. Planning Effort (Hrs)</label><input type="number" step="0.5" min="0" class="form-control" id="estimated-planning-time" value="1"></div>
                        
                        <div class="col-12 mt-3 mb-0"><h6 class="text-info"><i class="fas fa-hand-holding-dollar me-2"></i>Financial & Personnel</h6><hr class="mt-1 mb-2"></div>
                        
                        <div class="col-md-3"><label for="responsible-person" class="form-label text-muted-subtle">Responsible Person</label><input type="text" class="form-control" id="responsible-person" placeholder="e.g., Jane Organizer"></div>
                        
                        <div class="col-md-3"><label for="client-payment" class="form-label text-muted-subtle">Client Payment (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="client-payment" value="0.00"></div>
                        <div class="col-md-3"><label for="down-payment" class="form-label text-muted-subtle">Down Payment (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="down-payment" value="0.00"></div>
                        
                        <div class="col-md-3"><label for="guest-count" class="form-label text-muted-subtle">Guest Count (Est.)</label><input type="number" min="0" class="form-control" id="guest-count" value="0"></div>
                        
                        <div class="col-12 mt-3 mb-0"><h6 class="text-info"><i class="fas fa-truck-fast me-2"></i>Vendor/Supplier Notes</h6><hr class="mt-1 mb-2"></div>

                        <div class="col-12"><label for="vendor-supplier-details" class="form-label text-muted-subtle">Vendor/Supplier Details</label><textarea class="form-control" id="vendor-supplier-details" rows="4" placeholder="Vendor contact, agreement details, or payment terms."></textarea></div>
                        
                        <div class="col-12 text-end"><button type="submit" class="btn btn-primary mt-3"><i class="fas fa-save me-2"></i>Save Task</button></div>
                    </form>
                </div>
            </div>

            <div class="tab-pane fade" id="todo-list" role="tabpanel" aria-labelledby="todo-list-tab">
    
                <div class="filter-card mb-0 d-flex justify-content-between align-items-center flex-wrap">
                    <button id="toggle-filters-btn" class="btn btn-outline-primary btn-sm mb-2 mb-sm-0" data-bs-toggle="collapse" data-bs-target="#todo-filter-inputs" aria-expanded="false" aria-controls="todo-filter-inputs">
                        <i class="fas fa-filter me-1"></i> Show Filters
                    </button>
                    <h6 class="mb-2 mb-sm-0 text-info order-md-2">Current Task List (<span id="task-count">0</span>)</h6>
                    <div class="d-flex flex-wrap order-md-3">
                        <button id="clear-filters-btn" class="btn btn-outline-secondary btn-sm me-2 mb-1 mb-sm-0"><i class="fas fa-times me-1"></i> Clear</button>
                        <button id="apply-filters-btn" class="btn btn-primary btn-sm"><i class="fas fa-check me-1"></i> Apply Filters</button>
                    </div>
                </div>
                
                <div id="todo-filter-inputs" class="collapse filter-card rounded-top-0 mb-3">
                    <div class="row g-2 p-2">
                        <div class="col-12 filter-input-group">
                            <h6><i class="fas fa-calendar-alt me-1"></i>Date Range</h6>
                            <div class="d-flex">
                                <input type="date" id="filter-date-start" class="form-control form-control-sm me-1" placeholder="Start">
                                <input type="date" id="filter-date-end" class="form-control form-control-sm" placeholder="End">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-2 px-2 pb-2">
                         <div class="col-12 filter-input-group">
                             <h6><i class="fas fa-dollar-sign me-1"></i>Cost Range (₱)</h6>
                            <div class="d-flex">
                                <input type="number" step="0.01" min="0" id="filter-cost-min" class="form-control form-control-sm me-1" placeholder="Min">
                                <input type="number" step="0.01" min="0" id="filter-cost-max" class="form-control form-control-sm" placeholder="Max">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-2 px-2 pb-2">
                        <div class="col-12 filter-input-group">
                            <h6><i class="fas fa-clock me-1"></i>Time Range (Hrs)</h6>
                            <div class="d-flex">
                                <input type="number" step="0.5" min="0" id="filter-time-min" class="form-control form-control-sm me-1" placeholder="Min">
                                <input type="number" step="0.5" min="0" id="filter-time-max" class="form-control form-control-sm" placeholder="Max">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-2 px-2 pb-2">
                        <div class="col-12 filter-input-group">
                            <h6><i class="fas fa-sitemap me-1"></i>Category</h6>
                            <select id="filter-category" class="form-select form-select-sm">
                                <option value="All">All Categories</option>
                                <option value="Catering">Catering</option>
                                <option value="Venue">Venue</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Decorations">Decorations</option>
                                <option value="Guest Management">Guest Management</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-2 px-2 pb-2">
                        <div class="col-12 filter-input-group">
                            <h6><i class="fas fa-check-circle me-1"></i>Status</h6>
                            <select id="filter-status" class="form-select form-select-sm">
                                <option value="All">All Statuses</option>
                                <option value="Pending">Pending</option>
                                <option value="Inquiry Sent">Inquiry Sent</option>
                                <option value="Confirmed/Paid">Confirmed/Paid</option>
                                <option value="Cancelled">Cancelled</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row g-2 px-2 pb-2">
                        <div class="col-12 filter-input-group">
                            <h6><i class="fas fa-user-tie me-1"></i>Client/Host Name</h6>
                            <select id="filter-client" class="form-select form-select-sm">
                                <option value="All">All Clients/Hosts</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-2 px-2 pb-2">
                        <div class="col-12 filter-input-group">
                            <h6><i class="fas fa-users me-1"></i>Responsible Person</h6>
                            <select id="filter-responsible-person" class="form-select form-select-sm">
                                <option value="All">All Persons</option>
                            </select>
                        </div>
                    </div>
                    
                </div>

                <div id="filtered-summary" class="card p-3 mb-3 d-none">
                    <h6 class="text-primary mb-2"><i class="fas fa-calculator me-1"></i>Financial Summary for Filtered Tasks</h6>
                    <div class="row g-2 text-center">
                        <div class="col-6 col-md-3">
                            <h6 class="text-muted-subtle mb-0" style="font-size: 0.8rem;">Total Proc. Cost (Est.)</h6>
                            <p class="fw-bold text-danger mb-0"><span id="filtered-est-cost">0.00</span></p>
                        </div>
                        <div class="col-6 col-md-3">
                            <h6 class="text-muted-subtle mb-0" style="font-size: 0.8rem;">Total Client Income</h6>
                            <p class="fw-bold text-info mb-0"><span id="filtered-client-payment">0.00</span></p>
                        </div>
                         <div class="col-6 col-md-3">
                            <h6 class="text-muted-subtle mb-0" style="font-size: 0.8rem;">Total Additional Cost</h6>
                            <p class="fw-bold text-danger mb-0"><span id="filtered-additional-cost">0.00</span></p>
                        </div>
                        <div class="col-6 col-md-3">
                            <h6 class="text-muted-subtle mb-0" style="font-size: 0.8rem;">NET REVENUE</h6>
                            <p class="fw-bold text-revenue mb-0" style="font-size: 1.1rem;"><span id="filtered-net-revenue">0.00</span></p>
                        </div>
                    </div>
                </div>

                <div class="card rounded-top-0">
                    <ul id="task-list" class="list-group list-group-flush">
                        <li class="list-group-item text-center text-muted-subtle">Tasks will load after successful setup.</li>
                    </ul>
                </div>
                
                <div id="task-pagination-controls" class="d-flex justify-content-between align-items-center p-3 border-top bg-light rounded-bottom flex-wrap">
                    <button id="prev-page-btn" class="btn btn-outline-primary btn-sm mb-2 mb-sm-0" disabled><i class="fas fa-chevron-left me-1"></i> Previous</button>
                    <span id="page-info" class="text-muted-subtle mx-auto mb-2 mb-sm-0" style="font-size: 0.9rem;">Page 0 of 0</span>
                    <button id="next-page-btn" class="btn btn-outline-primary btn-sm" disabled>Next <i class="fas fa-chevron-right ms-1"></i></button>
                </div>
            </div>

            <div class="tab-pane fade" id="reports" role="tabpanel" aria-labelledby="reports-tab">
                 <div class="row g-4">
                    <div class="col-md-12">
                         <div class="card p-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-chart-area me-2"></i>Summary Overview (All Time)</h5>
                            <div class="row text-center g-3">
                                <div class="col-6 col-lg-3"><div class="summary-box p-2 border-left-info"><h6 class="text-muted-subtle">Total Tasks</h6><p class="h5 text-info" id="total-tasks">0</p></div></div>
                                <div class="col-6 col-lg-3"><div class="summary-box p-2 border-left-warning"><h6 class="text-muted-subtle">Total Proc. Cost (Est.)</h6><p class="h5 text-danger" id="total-cost-est">0.00</p></div></div>
                                <div class="col-6 col-lg-3"><div class="summary-box p-2 border-left-warning"><h6 class="text-muted-subtle">Total Additional Cost</h6><p class="h5 text-danger" id="total-additional-cost">0.00</p></div></div>
                                
                                <div class="col-6 col-lg-3"><div class="summary-box p-2 border-left-warning"><h6 class="text-muted-subtle">FINAL EXPENSE TOTAL</h6><p class="h5 text-danger" id="grand-total-cost">0.00</p></div></div>
                                
                                <div class="col-6 col-lg-3"><div class="summary-box p-2 border-left-info"><h6 class="text-muted-subtle">Total Client Income</h6><p class="h5 text-info" id="total-client-payment">0.00</p></div></div>
                                <div class="col-6 col-lg-3"><div class="summary-box p-2 border-left-revenue"><h6 class="text-muted-subtle">NET REVENUE (All Time)</h6><p class="h5 text-revenue" id="total-net-revenue">0.00</p></div></div>
                                <div class="col-6 col-lg-3"><div class="summary-box p-2 border-left-warning"><h6 class="text-muted-subtle">Total Planning Hours (Est.)</h6><p class="h5 text-warning"><span id="total-time-est">0</span> hrs</p></div></div>
                                <div class="col-6 col-lg-3"><div class="summary-box p-2 border-left-info"><h6 class="text-muted-subtle">Cost Per Guest (Est.)</h6><p class="h5 text-info" id="cost-per-guest">0.00</p></div></div>
                                <div class="col-12 text-center mt-3"><h6 class="text-muted-subtle">Remaining Tasks: <span class="text-danger fw-bold" id="remaining-tasks">0</span></h6></div>
                            </div>
                         </div>
                    </div>
                    <div class="col-md-12">
                        <div class="card p-4">
                            <h5 class="text-primary mb-3"><i class="fas fa-tools me-2"></i>Reporting Tools</h5>
                            
                            <div id="report-filter-section" class="bg-light p-3 mb-3 rounded">
                                <h6 class="text-info mb-2"><i class="fas fa-filter me-1"></i>Filter Report By Date (Optional)</h6>
                                <div class="row g-2">
                                    <div class="col-md-5">
                                        <label for="report-date-start" class="form-label text-muted-subtle mb-1">Start Date</label>
                                        <input type="date" id="report-date-start" class="form-control form-control-sm">
                                    </div>
                                    <div class="col-md-5">
                                        <label for="report-date-end" class="form-label text-muted-subtle mb-1">End Date</label>
                                        <input type="date" id="report-date-end" class="form-control form-control-sm">
                                    </div>
                                    <div class="col-md-2 d-flex align-items-end">
                                        <button id="clear-report-filters-btn" class="btn btn-outline-secondary btn-sm w-100">Clear</button>
                                    </div>
                                </div>
                            </div>
                            
                            <button class="btn btn-outline-primary w-100" id="download-csv-btn">
                                <i class="fas fa-download me-2"></i>Download Data as CSV Report
                                <span class="d-block" id="download-filter-status" style="font-size: 0.8rem;">(All Time)</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

        </div> </div>

    <div class="modal fade" id="taskDetailModal" tabindex="-1" aria-labelledby="taskDetailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="taskDetailModalLabel">Task Details</h5>
                    <button type="button" class="btn-close btn-close-white close-modal-btn" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                
                <div class="modal-body">
                    <input type="hidden" id="modal-task-id">
                    
                    <ul class="nav nav-tabs mb-3" id="taskDetailTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="event-details-tab" data-bs-toggle="tab" data-bs-target="#tab-event-details" type="button" role="tab" aria-controls="tab-event-details" aria-selected="true"><i class="fas fa-calendar-alt me-2"></i>Event Details</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="organizer-inputs-tab" data-bs-toggle="tab" data-bs-target="#tab-organizer-inputs" type="button" role="tab" aria-controls="tab-organizer-inputs" aria-selected="false"><i class="fas fa-user-gear me-2"></i>Organizer Inputs</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="generate-text-tab" data-bs-toggle="tab" data-bs-target="#tab-generate-text" type="button" role="tab" aria-controls="tab-generate-text" aria-selected="false"><i class="fas fa-mobile-alt me-2"></i>Generate Text Message</button>
                        </li>
                    </ul>

                    <form id="task-update-form"> 
                        <div class="tab-content" id="taskDetailTabContent">
                            
                            <div class="tab-pane fade show active" id="tab-event-details" role="tabpanel" aria-labelledby="event-details-tab">
                                <div class="row g-3">
                                    <div class="col-12"><label for="modal-client-host-name-input" class="form-label text-muted-subtle">Client/Host Name</label><input type="text" class="form-control" id="modal-client-host-name-input"></div>
                                    
                                    <div class="col-md-6"><label for="modal-client-phone-input" class="form-label text-muted-subtle">Client Phone Number</label><input type="tel" class="form-control" id="modal-client-phone-input" placeholder="e.g., +1 (555) 123-4567"></div>
                                    <div class="col-md-6"><label for="modal-client-email-input" class="form-label text-muted-subtle">Client Email</label><input type="email" class="form-control" id="modal-client-email-input" placeholder="e.g., client@example.com"></div>
                                    <div class="col-12"><label for="modal-party-event-title-input" class="form-label text-muted-subtle">Party/Event Title</label><input type="text" class="form-control" id="modal-party-event-title-input" required></div>
                                    <div class="col-12"><label for="modal-task-item-description-input" class="form-label text-muted-subtle">Task/Item Description</label><input type="text" class="form-control" id="modal-task-item-description-input" required></div>
                                    
                                    <div class="col-12">
                                        <label for="modal-category-service-input" class="form-label text-muted-subtle">Category/Service</label>
                                        <select class="form-select" id="modal-category-service-input">
                                            <option value="Catering">Catering</option>
                                            <option value="Venue">Venue</option>
                                            <option value="Entertainment">Entertainment</option>
                                            <option value="Decorations">Decorations</option>
                                            <option value="Guest Management">Guest Management</option>
                                            <option value="Marketing">Marketing</option>
                                            <option value="Other" selected>Other</option>
                                        </select>
                                    </div>

                                    <div class="col-md-6"><label for="modal-event-date-input" class="form-label text-muted-subtle">Date</label><input type="date" class="form-control" id="modal-event-date-input" required></div>
                                    <div class="col-md-6"><label for="modal-event-time-input" class="form-label text-muted-subtle">Start Time</label><input type="time" class="form-control" id="modal-event-time-input"></div>
                                    
                                    <div class="col-12"><label for="modal-vendor-supplier-details-input" class="form-label text-muted-subtle">Vendor/Supplier Details</label><textarea class="form-control" id="modal-vendor-supplier-details-input" rows="4"></textarea></div>
                                </div>
                            </div>

                            <div class="tab-pane fade" id="tab-organizer-inputs" role="tabpanel" aria-labelledby="organizer-inputs-tab">
                                <div class="row g-3">
                                    <div class="col-md-6"><label for="modal-estimated-vendor-cost-input" class="form-label text-muted-subtle">Processing Cost (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="modal-estimated-vendor-cost-input"></div>
                                    <div class="col-md-6"><label for="modal-actual-cost-variance-input" class="form-label text-muted-subtle">Additional Cost (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="modal-actual-cost-variance-input" value="0.00"></div>
                                    
                                    <div class="col-md-6"><label for="modal-client-payment-input" class="form-label text-muted-subtle">Client Payment (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="modal-client-payment-input" value="0.00"></div>
                                    <div class="col-md-6"><label for="modal-down-payment-input" class="form-label text-muted-subtle">Down Payment (₱)</label><input type="number" step="0.01" min="0" class="form-control" id="modal-down-payment-input" value="0.00"></div>

                                    <div class="col-12"><label for="modal-estimated-planning-time-input" class="form-label text-muted-subtle">Est. Planning Effort (Hrs)</label><input type="number" step="0.5" min="0" class="form-control" id="modal-estimated-planning-time-input"></div>
                                    
                                    <div class="col-md-6"><label for="modal-responsible-person-input" class="form-label text-muted-subtle">Responsible Person</label><input type="text" class="form-control" id="modal-responsible-person-input"></div>
                                    <div class="col-md-6"><label for="modal-guest-count-input" class="form-label text-muted-subtle">Guest Count (Est.)</label><input type="number" min="0" class="form-control" id="modal-guest-count-input" value="0"></div>

                                    <div class="col-12"><label for="modal-internal-notes-input" class="form-label text-muted-subtle">Internal Notes</label><textarea class="form-control" id="modal-internal-notes-input" rows="3"></textarea></div>
                                    
                                    <div class="col-12 mt-4"><strong>Status:</strong> <span id="modal-task-status" class="badge" title="Click to cycle status: Pending -> Inquiry Sent -> Confirmed/Paid -> Cancelled"></span></div>
                                </div>
                            </div>
                            
                            <div class="tab-pane fade" id="tab-generate-text" role="tabpanel" aria-labelledby="generate-text-tab">
                                
                                <div class="mb-3">
                                    <label for="modal-generated-text-message" class="form-label text-muted-subtle">Generated Message Preview</label>
                                    <textarea class="form-control" id="modal-generated-text-message" rows="6" readonly placeholder="Click a 'Generate Message' button to create a client inquiry text based on the Event Details."></textarea>
                                </div>
                                
                                <div class="d-flex flex-wrap gap-2 mb-3"> 
                                    <button type="button" class="btn btn-template-1 flex-grow-1" id="modal-generate-template-1-btn">
                                        <i class="fas fa-wand-magic-sparkles me-2"></i>Generate **Follow-up**
                                    </button>
                                    <button type="button" class="btn btn-template-2 flex-grow-1" id="modal-generate-template-2-btn">
                                        <i class="fas fa-file-signature me-2"></i>Generate **Confirmation**
                                    </button>
                                    <button type="button" class="btn btn-template-3 flex-grow-1" id="modal-generate-template-3-btn">
                                        <i class="fas fa-money-bill-wave me-2"></i>Generate **Payment**
                                    </button>
                                    <button type="button" class="btn btn-template-4 flex-grow-1" id="modal-generate-template-4-btn">
                                        <i class="fas fa-receipt me-2"></i>Generate **Payment Received**
                                    </button>
                                    
                                    <button type="button" class="btn btn-template-5 flex-grow-1" id="modal-generate-template-5-btn">
                                        <i class="fas fa-ban me-2"></i>Generate **Cancelled**
                                    </button>
                                    <button type="button" class="btn btn-template-6 flex-grow-1" id="modal-generate-template-6-btn">
                                        <i class="fas fa-undo me-2"></i>Generate **Refund**
                                    </button>
                                    <button type="button" class="btn btn-template-7 flex-grow-1" id="modal-generate-template-7-btn">
                                        <i class="fas fa-money-check-alt me-2"></i>Generate **Down Payment**
                                    </button>
                                </div>

                                <button type="button" class="btn btn-outline-success w-100 mb-3" id="modal-copy-text-btn" disabled>
                                    <i class="fas fa-copy me-2"></i>Copy Message to Clipboard
                                </button>

                                <p class="mt-3 text-muted-subtle" style="font-size: 0.8rem;">Note: Messages are automatically generated using data from the Event Details tab.</p>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger me-auto" id="modal-delete-task-btn">
                        <i class="fas fa-trash-alt me-2"></i>Delete Task
                    </button>
                    <button type="submit" form="task-update-form" class="btn btn-primary">
                        <i class="fas fa-sync-alt me-2"></i>Update Task
                    </button>
                    <button type="button" class="btn btn-secondary close-modal-btn" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="StartCloudSyncModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="StartCloudSyncModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="StartCloudSyncModalLabel">Start Cloud Sync</h5>
                </div>
                <div class="modal-body start-sync-modal-body">
                    <p>Choose how you want to access your planner. **Permanent login** is recommended for secure, multi-device data saving.</p>
                    <button id="google-sign-in-btn" class="google-sign-in-btn">
                        <i class="fab fa-google me-2"></i> Sign in with Google
                    </button>
                    <button id="guest-sign-in-btn" class="btn btn-light guest-button">
                        Continue as Guest (Temporary Local Storage)
                    </button>
                    </div>
            </div>
        </div>
    </div>

    <script>
        window.__firebase_config = JSON.stringify({
            apiKey: "AIzaSyDHUMDVGfZY2dwF-uxeG17r9yW3f2gBr-A",
            authDomain: "multitools-fbc73.firebaseapp.com",
            projectId: "multitools-fbc73",
            storageBucket: "multitools-fbc73.firebasestorage.app",
            messagingSenderId: "277024201427",
            appId: "1:277024201427:web:b1d23c088add4324226",
            measurementId: "G-1HJ0N30X1W"
        });
        window.__app_id = 'task_planner_app';
    </script>
    
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        // Import Firebase modules and expose them globally as window.FirebaseTools
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 1. Expose Firebase Tools Globally to match the provided auth code ---
        window.FirebaseTools = {
            initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, 
            onAuthStateChanged, signOut, getFirestore, signInAnonymously,
            doc, onSnapshot, setDoc 
        };

        // --- Global State & Initialization ---
        
        const LOCAL_STORAGE_KEY = 'taskPlannerTasks_v11_local'; 
        const FIREBASE_COLLECTION_PATH = 'events';
        const APP_ID = window.__app_id || 'default_app'; 
        const FIREBASE_DOC_ID = 'main_data'; 
        
        let app; 
        let auth; 
        let db;   
        let tasksDocRef = null; 
        let allCurrentTasks = []; 
        let currentTasks = [];    
        let firebaseUnsubscribe = null; 
        let storageMode = ''; // '', 'local', or 'firebase'
        let userId = null; 
        let isGoogleSignedIn = false;
        
        // Pagination state
        const TASKS_PER_PAGE = 10;
        let currentPage = 1;
        let totalPages = 1;

        // Filtering state
        let currentFilters = {
            dateStart: '', dateEnd: '',
            costMin: '', costMax: '',
            timeMin: '', timeMax: '',
            category: 'All', status: 'All',
            client: 'All', responsiblePerson: 'All'
        };


        // --- Utility Functions ---

        /**
         * Generates a unique, time-based ID.
         * @returns {string} Unique ID.
         */
        const generateId = () => {
            return APP_ID + '_' + Date.now().toString(36) + Math.random().toString(36).substring(2);
        };

        /**
         * Shows a temporary toast notification.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'danger', 'info', or 'warning'.
         */
        const showToast = (message, type = 'info') => {
            const toastContainer = $('#toast-container');
            const toast = $(`<div class="custom-toast bg-${type}">${message}</div>`);
            
            toastContainer.append(toast);
            setTimeout(() => {
                toast.addClass('show');
            }, 10); // Short delay to trigger transition
            
            setTimeout(() => {
                toast.removeClass('show');
                setTimeout(() => {
                    toast.remove();
                }, 500);
            }, 3000);
        };

        /**
         * Toggles the loading indicator.
         * @param {boolean} show - Whether to show or hide.
         * @param {string} text - The loading text.
         */
        const toggleLoading = (show, text = 'Connecting...') => {
            $('#loading-indicator').toggleClass('d-none', !show);
            $('#loading-text').text(text);
        };

        /**
         * Shows the full-screen authentication loading overlay.
         * @param {string} text - The text to display.
         */
        const showAuthLoadingOverlay = (text) => {
             $('#auth-loading-overlay').css('display', 'flex').find('p').text(text);
        };
        
        /**
         * Hides the full-screen authentication loading overlay.
         */
        const hideAuthLoadingOverlay = () => {
             $('#auth-loading-overlay').css('display', 'none');
        };


        /**
         * Shows the Cloud Sync modal.
         */
        const showCloudSyncModal = () => {
            const modal = new bootstrap.Modal(document.getElementById('StartCloudSyncModal'), {});
            modal.show();
        };

        /**
         * Hides the Cloud Sync modal.
         */
        const hideCloudSyncModal = () => {
             const modalEl = document.getElementById('StartCloudSyncModal');
             const modal = bootstrap.Modal.getInstance(modalEl);
             if (modal) {
                 modal.hide();
             }
        };

        /**
         * Converts array of tasks to a CSV string.
         * @param {Array<Object>} tasks - The list of task objects.
         * @returns {string} The CSV formatted data.
         */
        const convertToCSV = (tasks) => {
            if (tasks.length === 0) return '';
            
            // Define headers explicitly to ensure order
            const headers = [
                "ID", "Client/Host Name", "Party/Event Title", "Task/Item Description", 
                "Date", "Time", "Category/Service", "Status", "Responsible Person",
                "Est. Planning Effort (Hrs)", "Processing Cost (₱)", "Additional Cost (₱)", 
                "Client Payment (₱)", "Down Payment (₱)", "Guest Count (Est.)",
                "Vendor/Supplier Details", "Internal Notes", "Net Revenue (Calculated)", "Total Expense (Calculated)",
                //"Last Updated", 
                "Client Phone Number", "Client Email"
            ];
            
            // Map the data to the correct header order
            const data = tasks.map(task => {
                // CALCULATE TOTAL REVENUE for Net Revenue column
                const totalRevenue = (parseFloat(task.clientPayment) || 0) + (parseFloat(task.downPayment) || 0);
                const totalExpense = (parseFloat(task.estimatedVendorCost) || 0) + (parseFloat(task.actualCostVariance) || 0);

                return [
                    task.id,
                    task.clientHostName,
                    task.partyEventTitle,
                    task.taskItemDescription,
                    task.eventDate,
                    task.eventStartTime,
                    task.categoryService,
                    task.status,
                    task.responsiblePerson,
                    task.estimatedPlanningTime,
                    task.estimatedVendorCost,
                    task.actualCostVariance || 0,
                    task.clientPayment,
                    task.downPayment, // Added downPayment to data
                    task.guestCount,
                    `"${(task.vendorSupplierDetails || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`, // Escape quotes and newlines
                    `"${(task.internalNotes || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`,
                    totalRevenue - totalExpense, // Updated Net Revenue calculation
                    totalExpense,
                    //task.lastUpdated ? new Date(task.lastUpdated).toLocaleString() : '',
                    task.clientPhoneNumber,
                    task.clientEmail
                ];
            });

            // Combine headers and data
            const csvContent = [
                headers.join(","),
                ...data.map(row => row.join(","))
            ].join("\n");
            
            return csvContent;
        };

        // --- New Modal Functionality: Text Message Generator ---
        const setupTextGenerator = () => {
            // Select all the new buttons and the message/copy field
            const generateBtn1 = $('#modal-generate-template-1-btn');
            const generateBtn2 = $('#modal-generate-template-2-btn');
            const generateBtn3 = $('#modal-generate-template-3-btn');
            const generateBtn4 = $('#modal-generate-template-4-btn');
            const generateBtn5 = $('#modal-generate-template-5-btn');
            const generateBtn6 = $('#modal-generate-template-6-btn');
            const generateBtn7 = $('#modal-generate-template-7-btn');
            const copyBtn = $('#modal-copy-text-btn'); // Re-introduced Copy button
            const messageField = $('#modal-generated-text-message');

            // Helper function to format the date
            const formatDate = (dateValue) => {
                return dateValue ? 
                    new Date(dateValue + 'T00:00:00').toLocaleDateString('en-US', { 
                        weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' 
                    }) : 
                    'a future date';
            };

            /**
             * Generates and displays a message based on the selected template.
             * @param {number} templateType - 1, 2, or 3 corresponding to the message template.
             */
            const generateMessage = (templateType) => {
                const clientName = $('#modal-client-host-name-input').val() || 'Client';
                const eventTitle = $('#modal-party-event-title-input').val() || 'their event';
                const downPayment = $('#modal-down-payment-input').val() || '0.00';
                const clientPayment = $('#modal-client-payment-input').val() || '0.00';
                const eventDate = $('#modal-event-date-input').val();
                const taskDesc = $('#modal-task-item-description-input').val() || 'the task details';
                const dateString = formatDate(eventDate);
                
                let message = '';

                switch (templateType) {
                    case 1:
                        // Template 1: Follow-up/Initial Inquiry (Based on your original template)
                        message = `Hi ${clientName},\n\nThis is the party organizer following up on your event, "${eventTitle}" on ${dateString}. We are currently working on your task: "${taskDesc}". Can you please confirm the next steps are okay? You can reply to this message or call us back.\n\nThanks!`;
                        break;
                    case 2:
                        // Template 2: Confirmation Message
                        message = `Hi ${clientName}!\n\nGreat news! Your booking for the "${eventTitle}" on ${dateString} has been confirmed. We've locked in the details for "${taskDesc}". Let us know if you have any questions.\n\nSee you then!`;
                        break;
                    case 3:
                        // Template 3: Payment Reminder
                        message = `Hi ${clientName},\n\nJust a friendly reminder about the payment for your upcoming event, "${eventTitle}" on ${dateString}. Please complete the payment to finalize the task: "${taskDesc}".\n\nCall us if you need assistance!`;
                        break;
                    case 4:
                        // NEW Template 4: Payment Received
                        message = `Payment Received! 🎉\n\nThank you, ${clientName}. We have successfully received your payment(₱"${clientPayment}") for the task: "${taskDesc}" related to the "${eventTitle}" event on ${dateString}.\n\nEverything is now finalized!`;
                        break;
                    case 5:
                        // NEW Template 5: Cancelled
                        message = `Hello ${clientName},\n\nWe regret to inform you that your task: "${taskDesc}" for the event "${eventTitle}" on ${dateString} has been cancelled.\n\nPlease contact us immediately to discuss this further. Thank you.`;
                        break;
                    case 6:
                        // Template 6: Refund Issued
                        message = `Hi ${clientName},\n\nWe've processed the refund(₱"${clientPayment}") for the task: "${taskDesc}" related to the event "${eventTitle}" on ${dateString}. Please allow 3-5 business days for the funds to reflect in your account.\n\nThank you.`;
                        break;
                    case 7:
                        // NEW Template 7: Down Payment Received
                        message = `Hi ${clientName}!\n\nThank you for your ₱"${downPayment}" down payment for the "${eventTitle}" event on ${dateString}. This secures the task: "${taskDesc}".\n\nWe'll be in touch soon with the next steps!`;
                        break;
                    default:
                        message = 'Error: Invalid template selected.';
                }
                
                messageField.val(message);
                copyBtn.prop('disabled', false); // Enable copy button after message is generated
            };

            // --- Modern Copy Function (using Clipboard API) ---
            const copyMessage = () => {
                const message = messageField.val();
                if (!message) {
                    showToast('No message to copy.', 'warning');
                    return;
                }

                if (navigator.clipboard && navigator.clipboard.writeText) {
                    // Use modern Clipboard API (requires secure context/HTTPS)
                    navigator.clipboard.writeText(message)
                        .then(() => {
                            // Assuming showToast is a function for notifications
                            showToast('Message copied to clipboard! (Modern API)', 'success');
                        })
                        .catch(err => {
                            console.error('Could not copy text using modern API. Falling back.', err);
                            // Fallback to execCommand if modern API fails (unlikely on modern browsers)
                            fallbackCopyMessage(message); 
                        });
                } else {
                    // Fallback for non-secure contexts or older browsers
                    fallbackCopyMessage(message);
                }
            };
            
            // --- Fallback function for document.execCommand('copy') ---
            const fallbackCopyMessage = (message) => {
                const tempInput = document.createElement('textarea');
                tempInput.value = message;
                tempInput.setAttribute('readonly', '');
                tempInput.style.position = 'absolute';
                tempInput.style.left = '-9999px'; 

                document.body.appendChild(tempInput);
                tempInput.select();
                
                try {
                    document.execCommand('copy');
                    showToast('Message copied to clipboard! (Fallback)', 'success');
                } catch (err) {
                    console.error('Fallback copy failed', err);
                    showToast('Failed to copy message. Please copy manually.', 'danger');
                } finally {
                    document.body.removeChild(tempInput);
                }
            };


            // --- Event Listeners ---
            generateBtn1.on('click', () => generateMessage(1));
            generateBtn2.on('click', () => generateMessage(2));
            generateBtn3.on('click', () => generateMessage(3));
            generateBtn4.on('click', () => generateMessage(4));
            generateBtn5.on('click', () => generateMessage(5));
            generateBtn6.on('click', () => generateMessage(6));
            generateBtn7.on('click', () => generateMessage(7));
            copyBtn.on('click', copyMessage); // Hook up the new copy function
            
            // Clear message and disable copy button when modal is hidden
            $('#taskDetailModal').on('hidden.bs.modal', () => {
                messageField.val('');
                copyBtn.prop('disabled', true);
            });
        };
        
        // --- Core Application Logic ---

        /**
         * Object to handle all data persistence logic (Local Storage or Firebase).
         */
        const DataService = {
            /**
             * Initializes the data store (Firebase or Local Storage).
             */
            init: () => {
                const config = JSON.parse(window.__firebase_config);
                app = FirebaseTools.initializeApp(config);
                auth = FirebaseTools.getAuth(app);
                db = FirebaseTools.getFirestore(app);
            },

            /**
             * Gets all tasks from the current storage medium.
             * @returns {Array<Object>} The array of tasks.
             */
            getTasks: () => {
                if (storageMode === 'local') {
                    const tasksJson = localStorage.getItem(LOCAL_STORAGE_KEY);
                    return tasksJson ? JSON.parse(tasksJson) : [];
                }
                // If storageMode is 'firebase', the data is handled by the real-time listener (allCurrentTasks)
                return allCurrentTasks; 
            },

            /**
             * Saves the current task list to the determined storage medium.
             * @param {Array<Object>} tasks - The list of tasks to save.
             */
            saveTasks: (tasks) => {
                allCurrentTasks = tasks; // Update local memory immediately

                if (storageMode === 'local') {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(tasks));
                    showToast('Saved to Local Storage', 'success');
                } else if (storageMode === 'firebase') {
                    // This function is only called when tasks are updated (added/edited/deleted)
                    if (tasksDocRef) {
                        FirebaseImpl.writeTasksToDB(tasks);
                    } else {
                        console.warn("Attempted to save tasks to Firebase before docRef was ready.");
                        showToast('Cloud Sync Not Ready. Data saved locally.', 'warning');
                    }
                }
                
                // Re-filter and re-render the list after saving
                filterTasks();
                updateAllReports();
            },

            /**
             * Clears the current list of tasks and memory.
             */
            clearTasks: () => {
                allCurrentTasks = [];
                currentTasks = [];
                // Only clear local storage if explicitly needed, e.g., if the user manually cleared it,
                // otherwise, for a true Firebase sign out, we let the auth listener handle the UI change.
                if (storageMode === 'local') {
                    // This path is technically not used for the 'End Guest Session' button anymore,
                    // but it's safe to keep for scenarios where a deep clear is needed.
                    localStorage.removeItem(LOCAL_STORAGE_KEY); 
                }
            },
            
            /**
             * Sets the storage mode to 'local' (Guest Mode).
             */
            resetToLocalMode: () => {
                storageMode = 'local';
                userId = generateId(); // Unique ID for local storage keying/data tracking
                isGoogleSignedIn = false;
                // FIX: Removed the empty array argument to force loadTasks to check local storage
                DataService.loadTasks(); 
            },

            /**
             * Loads tasks from the new storage mode and updates global state.
             * @param {Array<Object>} fetchedTasks - Tasks fetched directly (e.g., from Firebase listener).
             */
            loadTasks: (fetchedTasks = null) => {
                toggleLoading(true, `Loading from ${storageMode === 'firebase' ? 'Cloud' : 'Local Storage'}...`);
                
                if (fetchedTasks) {
                    allCurrentTasks = fetchedTasks;
                } else {
                    // This is where getTasks() is called, which reads from localStorage in 'local' mode
                    allCurrentTasks = DataService.getTasks();
                }

                // Initial processing and rendering
                allCurrentTasks.sort((a, b) => new Date(a.eventDate) - new Date(b.eventDate));
                filterTasks(); // Filters to update currentTasks and render list
                updateAllReports();
                updateClientFilterOptions();
                updateResponsiblePersonFilterOptions();
                toggleLoading(false);
            },
            
            /**
             * Adds a new task.
             * @param {Object} taskData - The new task object.
             */
            addTask: (taskData) => {
                const newTask = {
                    id: generateId(),
                    status: 'Pending',
                    lastUpdated: Date.now(),
                    ...taskData
                };
                allCurrentTasks.push(newTask);
                DataService.saveTasks(allCurrentTasks);
                showToast('New Task Added!', 'success');
            },

            /**
             * Updates an existing task by ID.
             * @param {string} taskId - The ID of the task to update.
             * @param {Object} updatedData - The new data for the task.
             */
            updateTask: (taskId, updatedData) => {
                const index = allCurrentTasks.findIndex(t => t.id === taskId);
                if (index > -1) {
                    allCurrentTasks[index] = {
                        ...allCurrentTasks[index],
                        ...updatedData,
                        lastUpdated: Date.now()
                    };
                    DataService.saveTasks(allCurrentTasks);
                    showToast('Task Updated!', 'success');
                }
            },
            
            /**
             * Deletes a task by ID.
             * @param {string} taskId - The ID of the task to delete.
             */
            deleteTask: (taskId) => {
                allCurrentTasks = allCurrentTasks.filter(t => t.id !== taskId);
                DataService.saveTasks(allCurrentTasks);
                showToast('Task Deleted!', 'danger');
            }
        };


        /**
         * Object to handle all Firebase-specific operations.
         */
        const FirebaseImpl = {
            /**
             * Writes the entire task array to Firestore.
             * @param {Array<Object>} tasks - The task list to save.
             */
            writeTasksToDB: (tasks) => {
                // Firebase writes are batched and handled in the DataService.saveTasks
                // This function is only responsible for the actual Firebase write operation
                toggleLoading(true, 'Syncing to Cloud...');
                
                // Set the entire array under a single document
                setDoc(tasksDocRef, {
                    tasks: tasks,
                    lastUpdated: Date.now()
                })
                .then(() => {
                    // Success is handled by the real-time listener
                })
                .catch((error) => {
                    console.error("Error writing document: ", error);
                    showToast('Cloud sync failed. Check connection.', 'danger');
                })
                .finally(() => {
                    toggleLoading(false);
                });
            },

            /**
             * Sets up a real-time listener for the user's task data.
             * @param {string} uid - The Firebase User ID.
             */
            setupDataListener: (uid) => {
                if (firebaseUnsubscribe) {
                    firebaseUnsubscribe(); // Unsubscribe previous listener
                }

                // Document path: 'events' collection -> user's UID document
                tasksDocRef = FirebaseTools.doc(db, FIREBASE_COLLECTION_PATH, uid);
                
                toggleLoading(true, 'Waiting for Cloud Data...');

                firebaseUnsubscribe = FirebaseTools.onSnapshot(tasksDocRef, (doc) => {
                    if (doc.exists()) {
                        const fetchedData = doc.data().tasks || [];
                        DataService.loadTasks(fetchedData);
                    } else {
                        // Document doesn't exist, this is likely a brand new user
                        console.log("No initial task data found, creating an empty document.");
                        FirebaseImpl.writeTasksToDB([]); // Create the initial document
                    }
                }, (error) => {
                    console.error("Firestore listener failed:", error);
                    showToast("Failed to load data from cloud. Switching to local mode.", 'danger');
                    // We don't force sign out here, we let the user continue in local mode if possible
                });
            },

            /**
             * Attempts to sign the user in using the Google provider popup.
             */
            signInWithGoogle: async () => {
                showAuthLoadingOverlay("Waiting for Google Sign-In...");
                try {
                    const provider = new FirebaseTools.GoogleAuthProvider();
                    await FirebaseTools.signInWithPopup(auth, provider);
                } catch (error) {
                    console.error("Google Sign-In Error:", error);
                    const errorMessage = (error.code === 'auth/popup-closed-by-user') ? 
                                         "Sign-in popup closed." : 
                                         "Sign-in failed. Please try again.";
                    showToast(errorMessage, 'danger');
                } finally {
                    hideAuthLoadingOverlay();
                }
            },
            
            /**
             * Signs the current user in anonymously (Guest Mode).
             */
            signInAnonymously: async () => {
                try {
                    await FirebaseTools.signInAnonymously(auth);
                } catch (error) {
                    console.error("Guest Sign-In Error:", error);
                    showToast("Guest sign-in failed. Please try again.", 'danger');
                }
            },

            /**
             * Signs the current user out (Firebase and Google).
             */
            signOutUser: async () => {
                if (firebaseUnsubscribe) {
                    firebaseUnsubscribe();
                    firebaseUnsubscribe = null;
                }
                // Firebase sign out: This clears the Firebase session and triggers onAuthStateChanged,
                // which then handles the UI and modal.
                await FirebaseTools.signOut(auth); 
                // We keep clearTasks here just in case, but onAuthStateChanged will handle the rest.
                DataService.clearTasks(); 
                DataService.loadTasks(allCurrentTasks);
                updateClientFilterOptions();
                updateResponsiblePersonFilterOptions();
            },

            /**
             * Sets up the main listener for Firebase Authentication state changes.
             */
            setupAuthListeners: () => {
                FirebaseTools.onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in (Google or Anonymous)
                        userId = user.uid;
                        isGoogleSignedIn = !user.isAnonymous;
                        storageMode = 'firebase';
                        
                        hideCloudSyncModal();
                        updateUIOnModeChange();
                        
                        // Start the real-time listener for task data
                        FirebaseImpl.setupDataListener(userId);

                    } else {
                        // User is signed out or has not chosen a mode yet (Firebase sign-out path)
                        userId = null;
                        isGoogleSignedIn = false;
                        
                        // Only show the sync modal if the storageMode is not already set to local
                        if (storageMode !== 'local') {
                            storageMode = ''; // Clear state if user signed out
                            updateUIOnModeChange(); // Update banner to 'None'
                            showCloudSyncModal();
                        }
                    }
                });
            }
        };
        
        // --- NEW FUNCTION: Ends Local Guest Session Without Deleting LocalStorage ---
        /**
         * Handles ending a local storage (Guest) session without deleting local data.
         */
        const endLocalSession = () => {
            // Clear in-memory state, but do NOT touch localStorage
            allCurrentTasks = [];
            currentTasks = [];
            
            // Reset mode flags
            storageMode = ''; // This causes updateUIOnModeChange to show 'None'
            userId = null; 
            isGoogleSignedIn = false;

            // Update UI and re-render the now empty in-memory list
            updateUIOnModeChange();
            filterTasks(); 
            updateAllReports();
            
            // Show the modal to prompt for the next mode
            showCloudSyncModal();
            showToast('Local Guest Session Ended. Data remains in your browser and will load if you return to Guest Mode.', 'info');
        };
        // --- END NEW FUNCTION ---


        // --- UI Update & Report Logic ---

        /**
         * Updates the UI elements based on the current storage mode.
         */
        const updateUIOnModeChange = () => {
            let bannerText = '';
            let authBtnText = '';
            let authBtnClass = 'btn-outline-danger';
            let showSignOut = false;
            
            if (storageMode === 'firebase') {
                bannerText = isGoogleSignedIn ? 'Cloud (Google Account)' : 'Cloud (Guest Session)';
                authBtnText = isGoogleSignedIn ? 'Sign Out' : 'End Guest Session';
                showSignOut = true;
            } else if (storageMode === 'local') {
                bannerText = 'Local Storage (Guest Mode)';
                authBtnText = 'End Guest Session';
                showSignOut = true;
            } else {
                bannerText = 'None. Please choose a mode.';
            }

            $('#banner-storage-mode').text(bannerText);
            $('#auth-action-btn').html(`<i class="fas fa-sign-out-alt me-1"></i> ${authBtnText}`).toggleClass('d-none', !showSignOut);
        };
        
        // ... (updateAllReports, updateClientFilterOptions, updateResponsiblePersonFilterOptions, filterTasks, renderTaskList, createTaskListItem functions remain the same) ...
        
        /**
         * Calculates and updates all metrics on the Home and Reports tabs.
         */
        const updateAllReports = () => {
            const now = new Date();
            const startOfWeek = new Date(now.setDate(now.getDate() - now.getDay()));
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfYear = new Date(now.getFullYear(), 0, 1);
            
            let totalTasks = 0;
            let remainingTasks = 0;
            let grandTotalCost = 0;
            let totalClientPayment = 0;
            let totalTimeEst = 0;
            let totalGuestCount = 0;
            let totalAdditionalCost = 0;
            
            let weekCost = 0;
            let weekRevenue = 0;
            let weekTime = 0;
            
            let monthCost = 0;
            let monthRevenue = 0;
            let monthTime = 0;
            
            let yearCost = 0;
            let yearRevenue = 0;
            let yearTime = 0;
            
            // Map to track client activity (clientName: latestDate)
            const clientActivity = new Map();

            allCurrentTasks.forEach(task => {
                totalTasks++;
                
                const taskDate = new Date(task.eventDate);
                const cost = parseFloat(task.estimatedVendorCost) || 0;
                // FIX: Include downPayment in total client income/payment
                const payment = (parseFloat(task.clientPayment) || 0) + (parseFloat(task.downPayment) || 0); 
                const time = parseFloat(task.estimatedPlanningTime) || 0;
                const additionalCost = parseFloat(task.actualCostVariance) || 0;
                const guestCount = parseInt(task.guestCount) || 0;
                
                const netRevenue = payment - cost - additionalCost;

                grandTotalCost += cost + additionalCost;
                totalClientPayment += payment; // Updated to include downPayment
                totalTimeEst += time;
                totalGuestCount += guestCount;
                totalAdditionalCost += additionalCost;
                
                if (task.status !== 'Confirmed/Paid' && task.status !== 'Cancelled') {
                    remainingTasks++;
                }

                // Update client activity
                const clientName = task.clientHostName || 'N/A';
                if (!clientActivity.has(clientName) || taskDate > clientActivity.get(clientName)) {
                    clientActivity.set(clientName, taskDate);
                }

                // Home Tab Metrics
                if (taskDate >= startOfWeek) {
                    weekCost += cost + additionalCost;
                    weekRevenue += netRevenue;
                    weekTime += time;
                }
                
                if (taskDate >= startOfMonth) {
                    monthCost += cost + additionalCost;
                    monthRevenue += netRevenue;
                    monthTime += time;
                }
                
                if (taskDate >= startOfYear) {
                    yearCost += cost + additionalCost;
                    yearRevenue += netRevenue;
                    yearTime += time;
                }
            });
            
            const totalNetRevenue = totalClientPayment - grandTotalCost;
            const costPerGuest = totalGuestCount > 0 ? (grandTotalCost / totalGuestCount) : 0;
            
            // --- Update Home Tab ---
            $('#home-week-cost').text(weekCost.toFixed(2));
            $('#home-week-revenue').text(weekRevenue.toFixed(2));
            $('#home-week-time').text(weekTime.toFixed(1));
            
            $('#home-month-cost').text(monthCost.toFixed(2));
            $('#home-month-revenue').text(monthRevenue.toFixed(2));
            $('#home-month-time').text(monthTime.toFixed(1));
            
            $('#home-year-cost').text(yearCost.toFixed(2));
            $('#home-year-revenue').text(yearRevenue.toFixed(2));
            $('#home-year-time').text(yearTime.toFixed(1));

            // Populate Recent Clients
            const sortedClients = Array.from(clientActivity.entries())
                .sort(([, dateA], [, dateB]) => dateB - dateA) // Sort by most recent date
                .slice(0, 5); // Take top 5

            const clientList = $('#recent-clients-list').empty();
            if (sortedClients.length === 0) {
                clientList.append('<li class="list-group-item text-center text-muted-subtle">No active clients yet.</li>');
            } else {
                sortedClients.forEach(([name, date]) => {
                    clientList.append(`<li class="list-group-item d-flex justify-content-between align-items-center">
                        ${name}
                        <span class="badge bg-secondary rounded-pill">${date.toLocaleDateString()}</span>
                    </li>`);
                });
            }

            // Populate Upcoming Events (Top 10)
            const upcomingEvents = allCurrentTasks
                .filter(task => new Date(task.eventDate) >= new Date(new Date().setHours(0,0,0,0)))
                .sort((a, b) => new Date(a.eventDate) - new Date(b.eventDate))
                .slice(0, 10);
                
            const eventList = $('#upcoming-events-list').empty();
            if (upcomingEvents.length === 0) {
                eventList.append('<li class="list-group-item text-center text-muted-subtle">No upcoming events scheduled.</li>');
            } else {
                 upcomingEvents.forEach(task => {
                    const date = new Date(task.eventDate).toLocaleDateString();
                    eventList.append(`<li class="list-group-item d-flex justify-content-between align-items-center py-1">
                        <small class="text-truncate">${task.partyEventTitle}: ${task.taskItemDescription}</small>
                        <span class="badge bg-primary rounded-pill ms-2">${date}</span>
                    </li>`);
                });
            }


            // --- Update Reports Tab ---
            $('#total-tasks').text(totalTasks);
            $('#remaining-tasks').text(remainingTasks);
            $('#total-cost-est').text((grandTotalCost - totalAdditionalCost).toFixed(2));
            $('#total-additional-cost').text(totalAdditionalCost.toFixed(2));
            $('#grand-total-cost').text(grandTotalCost.toFixed(2));
            $('#total-client-payment').text(totalClientPayment.toFixed(2)); // Updated to include downPayment
            $('#total-net-revenue').text(totalNetRevenue.toFixed(2));
            $('#total-time-est').text(totalTimeEst.toFixed(1));
            $('#cost-per-guest').text(costPerGuest.toFixed(2));
            
            // Update CSV download button filter status
            const reportStart = $('#report-date-start').val();
            const reportEnd = $('#report-date-end').val();
            if (reportStart || reportEnd) {
                 $('#download-filter-status').text(`(Filtered: ${reportStart || 'Any'} to ${reportEnd || 'Any'})`);
            } else {
                 $('#download-filter-status').text('(All Time)');
            }
        };


        // --- Filtering Logic ---
        
        /**
         * Updates the list of available Client/Host names in the filter dropdown.
         */
        const updateClientFilterOptions = () => {
            // FIX: Use robust trimming and length check to ensure only valid names populate
            const clientNames = new Set(allCurrentTasks
                .map(t => (t.clientHostName || '').trim())
                .filter(name => name.length > 0)
            );
            const select = $('#filter-client').empty().append('<option value="All">All Clients/Hosts</option>');
            Array.from(clientNames).sort().forEach(name => {
                select.append($('<option>', { value: name, text: name }));
            });
            select.val(currentFilters.client); // Restore selected value
        };
        
        /**
         * Updates the list of available Responsible Persons in the filter dropdown.
         */
        const updateResponsiblePersonFilterOptions = () => {
             // FIX: Use robust trimming and length check to ensure only valid names populate
             const persons = new Set(allCurrentTasks
                .map(t => (t.responsiblePerson || '').trim())
                .filter(name => name.length > 0)
             );
             const select = $('#filter-responsible-person').empty().append('<option value="All">All Persons</option>');
             Array.from(persons).sort().forEach(name => {
                 select.append($('<option>', { value: name, text: name }));
             });
             select.val(currentFilters.responsiblePerson); // Restore selected value
        };


        /**
         * Applies the current filters to allCurrentTasks and updates the rendered list.
         */
        const filterTasks = () => {
            const filters = currentFilters;

            currentTasks = allCurrentTasks.filter(task => {
                const taskDate = new Date(task.eventDate);
                const cost = parseFloat(task.estimatedVendorCost) || 0;
                const time = parseFloat(task.estimatedPlanningTime) || 0;
                
                // Date Range Filter
                if (filters.dateStart && taskDate < new Date(filters.dateStart)) return false;
                if (filters.dateEnd && taskDate > new Date(filters.dateEnd)) return false;
                
                // Cost Range Filter
                if (filters.costMin && cost < parseFloat(filters.costMin)) return false;
                if (filters.costMax && cost > parseFloat(filters.costMax)) return false;
                
                // Time Range Filter
                if (filters.timeMin && time < parseFloat(filters.timeMin)) return false;
                if (filters.timeMax && time > parseFloat(filters.timeMax)) return false; // Corrected: changed cost to time
                
                // Category Filter
                if (filters.category !== 'All' && task.categoryService !== filters.category) return false;

                // Status Filter
                if (filters.status !== 'All' && task.status !== filters.status) return false;

                // Client Filter
                if (filters.client !== 'All' && task.clientHostName !== filters.client) return false;
                
                // Responsible Person Filter
                if (filters.responsiblePerson !== 'All' && task.responsiblePerson !== filters.responsiblePerson) return false;

                return true;
            });

            // Calculate filtered summary
            const summary = {
                estCost: 0,
                additionalCost: 0,
                clientPayment: 0,
                netRevenue: 0
            };

            currentTasks.forEach(task => {
                const estCost = parseFloat(task.estimatedVendorCost) || 0;
                const additionalCost = parseFloat(task.actualCostVariance) || 0;
                // FIX: Include downPayment in clientPayment for summary
                const clientPayment = (parseFloat(task.clientPayment) || 0) + (parseFloat(task.downPayment) || 0); 
                
                summary.estCost += estCost;
                summary.additionalCost += additionalCost;
                summary.clientPayment += clientPayment;
                summary.netRevenue += clientPayment - estCost - additionalCost;
            });
            
            // FIX: Always show the summary if there are tasks in the list, filtered or not.
            if (currentTasks.length > 0) {
                $('#filtered-summary').removeClass('d-none');
            } else {
                $('#filtered-summary').addClass('d-none');
            }

            $('#filtered-est-cost').text(summary.estCost.toFixed(2));
            $('#filtered-additional-cost').text(summary.additionalCost.toFixed(2));
            $('#filtered-client-payment').text(summary.clientPayment.toFixed(2));
            $('#filtered-net-revenue').text(summary.netRevenue.toFixed(2));


            // Reset pagination and render
            currentPage = 1;
            totalPages = Math.ceil(currentTasks.length / TASKS_PER_PAGE);
            renderTaskList();
        };

        /**
         * Renders the task list for the current page.
         */
        const renderTaskList = () => {
            const list = $('#task-list').empty();
            const startIndex = (currentPage - 1) * TASKS_PER_PAGE;
            const endIndex = startIndex + TASKS_PER_PAGE;
            const tasksToRender = currentTasks.slice(startIndex, endIndex);

            if (tasksToRender.length === 0) {
                list.append('<li class="list-group-item text-center text-muted-subtle">No tasks match the current filters.</li>');
            } else {
                tasksToRender.forEach(task => {
                    const listItem = createTaskListItem(task);
                    list.append(listItem);
                });
            }

            // Update pagination controls
            $('#task-count').text(currentTasks.length);
            $('#page-info').text(`Page ${totalPages > 0 ? currentPage : 0} of ${totalPages}`);
            $('#prev-page-btn').prop('disabled', currentPage === 1 || totalPages === 0);
            $('#next-page-btn').prop('disabled', currentPage === totalPages || totalPages === 0);
            
            // Hide pagination if only one page
            $('#task-pagination-controls').toggleClass('d-none', totalPages <= 1);
        };

        /**
         * Creates a single list item element for a task.
         * @param {Object} task - The task object.
         * @returns {JQuery} The list item element.
         */
        const createTaskListItem = (task) => {
            let statusClass = 'bg-secondary';
            if (task.status === 'Confirmed/Paid') statusClass = 'bg-success';
            else if (task.status === 'Inquiry Sent') statusClass = 'bg-info';
            else if (task.status === 'Cancelled') statusClass = 'bg-danger';

            let listItemClass = '';
            if (task.status === 'Cancelled') listItemClass = 'list-group-item-danger';

            const cost = (parseFloat(task.estimatedVendorCost) || 0) + (parseFloat(task.actualCostVariance) || 0);
            // FIX: Include downPayment in revenue display
            const revenue = (parseFloat(task.clientPayment) || 0) + (parseFloat(task.downPayment) || 0);
            const net = revenue - cost;
            const netClass = net >= 0 ? 'text-revenue' : 'text-danger';

            const listItem = $(`
                <li class="list-group-item ${listItemClass} d-flex justify-content-between align-items-center task-item" data-id="${task.id}" data-bs-toggle="modal" data-bs-target="#taskDetailModal">
                    <div class="d-flex flex-column flex-grow-1 me-2">
                        <div class="d-flex align-items-baseline mb-1">
                            <h6 class="mb-0 me-2 text-primary text-truncate">${task.partyEventTitle}</h6>
                            <small class="text-muted-subtle">${task.clientHostName || 'N/A'}</small>
                        </div>
                        <small class="text-secondary mb-1">
                            <i class="fas fa-list-check me-1"></i> ${task.taskItemDescription} 
                            <span class="ms-2 badge bg-light text-dark">${task.categoryService}</span>
                        </small>
                        <small class="d-flex flex-wrap">
                             <span class="text-danger me-3"><i class="fas fa-dollar-sign me-1"></i> Cost: ${cost.toFixed(2)}</span>
                             <span class="text-info me-3"><i class="fas fa-hand-holding-dollar me-1"></i> Income: ${revenue.toFixed(2)}</span>
                             <span class="${netClass} fw-bold"><i class="fas fa-wallet me-1"></i> Net: ${net.toFixed(2)}</span>
                        </small>
                    </div>
                    <div class="text-end d-flex flex-column align-items-end flex-shrink-0">
                         <span class="badge ${statusClass} mb-1">${task.status}</span>
                         <small class="text-muted-subtle">${task.eventDate}</small>
                    </div>
                </li>
            `);
            return listItem;
        };


        // --- Setup Functions ---

        /**
         * Sets up event handlers for the New Task form.
         */
        const setupForm = () => {
            $('#party-form').on('submit', function(e) {
                e.preventDefault();
                
                const taskData = {
                    clientHostName: $('#client-host-name').val().trim(),
                    partyEventTitle: $('#party-event-title').val().trim(),
                    taskItemDescription: $('#task-item-description').val().trim(),
                    categoryService: $('#category-service').val(),
                    eventDate: $('#event-date').val(),
                    eventStartTime: $('#event-start-time').val(),
                    estimatedVendorCost: $('#estimated-vendor-cost').val(),
                    estimatedPlanningTime: $('#estimated-planning-time').val(),
                    responsiblePerson: $('#responsible-person').val().trim(),
                    clientPayment: $('#client-payment').val(),
                    downPayment: $('#down-payment').val(),
                    guestCount: $('#guest-count').val(),
                    vendorSupplierDetails: $('#vendor-supplier-details').val().trim(),
                    internalNotes: "", // Default empty
                    actualCostVariance: 0, // Default 0 for new tasks
                    clientPhoneNumber: $('#client-phone-number').val(),
                    clientEmail: $('#client-email').val()
                };

                DataService.addTask(taskData);
                
                // Reset only the dynamic parts of the form, keeping the title as a placeholder for the next task
                $('#party-form')[0].reset(); 
                $('#category-service').val('Other');
                $('#estimated-vendor-cost').val('0.00');
                $('#estimated-planning-time').val('1');
                $('#client-payment').val('0.00');
                $('#down-payment').val('0.00');
                $('#guest-count').val('0');
                $('#party-event-title').val(taskData.partyEventTitle);
            });
        };

        /**
         * Sets up event handlers for the Task Detail Modal.
         */
        const setupModals = {
            /**
             * Populates the modal fields when a task is clicked.
             */
            populateModal: (task) => {
                $('#modal-task-id').val(task.id);
                $('#modal-client-host-name-input').val(task.clientHostName);
                $('#modal-party-event-title-input').val(task.partyEventTitle);
                $('#modal-task-item-description-input').val(task.taskItemDescription);
                $('#modal-category-service-input').val(task.categoryService);
                $('#modal-event-date-input').val(task.eventDate);
                $('#modal-event-time-input').val(task.eventStartTime);
                $('#modal-estimated-vendor-cost-input').val(task.estimatedVendorCost);
                $('#modal-actual-cost-variance-input').val(task.actualCostVariance || 0.00);
                $('#modal-client-payment-input').val(task.clientPayment);
                $('#modal-down-payment-input').val(task.downPayment);
                $('#modal-responsible-person-input').val(task.responsiblePerson);
                $('#modal-guest-count-input').val(task.guestCount);
                $('#modal-estimated-planning-time-input').val(task.estimatedPlanningTime);
                $('#modal-vendor-supplier-details-input').val(task.vendorSupplierDetails);
                $('#modal-internal-notes-input').val(task.internalNotes);
                $('#modal-client-phone-input').val(task.clientPhoneNumber);
                $('#modal-client-email-input').val(task.clientEmail);

                // Status Badge
                const statusBadge = $('#modal-task-status');
                statusBadge.text(task.status);
                statusBadge.removeClass().addClass('badge');
                if (task.status === 'Confirmed/Paid') statusBadge.addClass('bg-success');
                else if (task.status === 'Inquiry Sent') statusBadge.addClass('bg-info');
                else if (task.status === 'Cancelled') statusBadge.addClass('bg-danger');
                else statusBadge.addClass('bg-secondary');
            },

            /**
             * Cycles the task status on badge click.
             */
            cycleStatus: (e) => {
                const badge = $(e.currentTarget);
                const currentStatus = badge.text();
                let newStatus = '';
                
                switch (currentStatus) {
                    case 'Pending': newStatus = 'Inquiry Sent'; break;
                    case 'Inquiry Sent': newStatus = 'Confirmed/Paid'; break;
                    case 'Confirmed/Paid': newStatus = 'Cancelled'; break;
                    case 'Cancelled': newStatus = 'Pending'; break;
                    default: newStatus = 'Pending';
                }
                
                badge.text(newStatus);
                // Update styling instantly
                badge.removeClass().addClass('badge');
                if (newStatus === 'Confirmed/Paid') badge.addClass('bg-success');
                else if (newStatus === 'Inquiry Sent') badge.addClass('bg-info');
                else if (newStatus === 'Cancelled') badge.addClass('bg-danger');
                else badge.addClass('bg-secondary');
            },

            /**
             * Sets up the main event listeners for the modal.
             */
            setupEditForm: () => {
                // Event listener to populate the modal
                $('#taskDetailModal').on('show.bs.modal', function(e) {
                    const taskId = $(e.relatedTarget).data('id');
                    const task = allCurrentTasks.find(t => t.id === taskId);
                    if (task) {
                        setupModals.populateModal(task);
                    }
                });

                // Status Cycling
                $('#modal-task-status').on('click', setupModals.cycleStatus);

                // Update Form Submission
                $('#task-update-form').on('submit', function(e) {
                    e.preventDefault();
                    
                    const taskId = $('#modal-task-id').val();
                    const updatedData = {
                        clientHostName: $('#modal-client-host-name-input').val().trim(),
                        partyEventTitle: $('#modal-party-event-title-input').val().trim(),
                        taskItemDescription: $('#modal-task-item-description-input').val().trim(),
                        categoryService: $('#modal-category-service-input').val(),
                        eventDate: $('#modal-event-date-input').val(),
                        eventStartTime: $('#modal-event-time-input').val(),
                        estimatedVendorCost: $('#modal-estimated-vendor-cost-input').val(),
                        actualCostVariance: $('#modal-actual-cost-variance-input').val(),
                        clientPayment: $('#modal-client-payment-input').val(),
                        downPayment: $('#modal-down-payment-input').val(),
                        responsiblePerson: $('#modal-responsible-person-input').val().trim(),
                        guestCount: $('#modal-guest-count-input').val(),
                        estimatedPlanningTime: $('#modal-estimated-planning-time-input').val(),
                        vendorSupplierDetails: $('#modal-vendor-supplier-details-input').val().trim(),
                        internalNotes: $('#modal-internal-notes-input').val().trim(),
                        status: $('#modal-task-status').text(),
                        clientPhoneNumber: $('#modal-client-phone-input').val(),
                        clientEmail: $('#modal-client-email-input').val()
                    }; 

                    DataService.updateTask(taskId, updatedData);
                    bootstrap.Modal.getInstance(document.getElementById('taskDetailModal')).hide();
                });
                // Delete Task Button
                $('#modal-delete-task-btn').on('click', function() {
                    if (confirm("Are you sure you want to permanently delete this task?")) {
                        const taskId = $('#modal-task-id').val();
                        DataService.deleteTask(taskId);
                        bootstrap.Modal.getInstance(document.getElementById('taskDetailModal')).hide();
                    }
                });
            }
        };

        /**
         * Sets up event handlers for filtering and pagination.
         */
        const setupFiltering = () => {
            // Apply Filters Button
            $('#apply-filters-btn').on('click', () => {
                currentFilters.dateStart = $('#filter-date-start').val();
                currentFilters.dateEnd = $('#filter-date-end').val();
                currentFilters.costMin = $('#filter-cost-min').val();
                currentFilters.costMax = $('#filter-cost-max').val();
                currentFilters.timeMin = $('#filter-time-min').val();
                currentFilters.timeMax = $('#filter-time-max').val();
                currentFilters.category = $('#filter-category').val();
                currentFilters.status = $('#filter-status').val();
                currentFilters.client = $('#filter-client').val();
                currentFilters.responsiblePerson = $('#filter-responsible-person').val();
                
                filterTasks();
            });

            // Clear Filters Button
            $('#clear-filters-btn').on('click', () => {
                $('#todo-filter-inputs input, #todo-filter-inputs select').val('');
                $('#filter-category').val('All');
                $('#filter-status').val('All');
                $('#filter-client').val('All');
                $('#filter-responsible-person').val('All');

                currentFilters = {
                    dateStart: '', dateEnd: '',
                    costMin: '', costMax: '',
                    timeMin: '', timeMax: '',
                    category: 'All', status: 'All',
                    client: 'All', responsiblePerson: 'All'
                };
                filterTasks();
            });

            // Pagination Controls
            $('#prev-page-btn').on('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderTaskList();
                }
            });

            $('#next-page-btn').on('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderTaskList();
                }
            });
        };
        
        /**
         * Sets up event handlers for the Reports tab.
         */
        const setupReports = () => {
            // Clear Report Date Filters Button
            $('#clear-report-filters-btn').on('click', () => {
                $('#report-date-start').val('');
                $('#report-date-end').val('');
                updateAllReports(); // This call only updates the download filter status
            });
            
            // Download CSV Button
            $('#download-csv-btn').on('click', () => {
                const reportStart = $('#report-date-start').val();
                const reportEnd = $('#report-date-end').val();
                
                let tasksToReport = allCurrentTasks;
                
                if (reportStart || reportEnd) {
                    tasksToReport = allCurrentTasks.filter(task => {
                        const taskDate = new Date(task.eventDate);
                        if (reportStart && taskDate < new Date(reportStart)) return false;
                        if (reportEnd && taskDate > new Date(reportEnd)) return false;
                        return true;
                    });
                }
                
                if (tasksToReport.length === 0) {
                    showToast('No tasks to report for the selected filter.', 'warning');
                    return;
                }

                const csv = convertToCSV(tasksToReport);
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                
                let fileName = 'party_planner_report';
                if (reportStart || reportEnd) {
                    fileName += `_${reportStart || 'start'}_to_${reportEnd || 'end'}`;
                }
                fileName += '.csv';

                if (navigator.msSaveBlob) { // IE 10+
                    navigator.msSaveBlob(blob, fileName);
                } else {
                    link.href = URL.createObjectURL(blob);
                    link.setAttribute('download', fileName);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                
                showToast('Report Downloaded!', 'success');
            });
            
            // Re-update status text when report filter inputs change
            $('#report-date-start, #report-date-end').on('change', updateAllReports);
        };


        /**
         * Sets up event handlers for the Authentication Modal and buttons.
         */
        const setupAuthListeners = () => {
            DataService.init(); // Initialize Firebase app
            
            // Primary Sign-In button handlers
            $('#google-sign-in-btn').on('click', FirebaseImpl.signInWithGoogle);
            
            // Guest Sign-In button handler
            $('#guest-sign-in-btn').on('click', () => {
                hideCloudSyncModal();
                DataService.resetToLocalMode(); 
                updateUIOnModeChange();
                showToast('Continuing in Guest Mode. Data is only saved locally.', 'info');
            });
            
            // MODIFIED: Check storageMode to determine if a Firebase sign-out is needed or just a local session reset.
            $('#auth-action-btn').on('click', () => {
                if (storageMode === 'local') {
                    endLocalSession();
                } else {
                    // This handles Google sign out and Firebase anonymous sign out.
                    // The onAuthStateChanged listener will handle the final UI update and modal show.
                    FirebaseImpl.signOutUser(); 
                }
            });

            // Firebase Auth State Listener (main app controller)
            FirebaseImpl.setupAuthListeners();
        };

        
        // --- Document Ready ---
        $(function() {
            // Initialize event listeners for all parts of the application
            setupForm();
            setupModals.setupEditForm();
            setupFiltering();
            setupReports();
            setupAuthListeners();
            setupTextGenerator();
            // The initial render will be handled by the data loading process (local or firebase)
            // Initial task load handled inside setupAuthListeners via DataService.getTasks() or Firebase listener
        });
    </script>
</body>
</html>