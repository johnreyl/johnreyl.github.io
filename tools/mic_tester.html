<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Microphone Tester with Record</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <style>
    body { padding: 2rem; background: #f8f9fa; }
    #meter { width: 100%; height: 30px; background: #e9ecef; border-radius: 5px; overflow: hidden; margin-top: 1rem; }
    #level { width: 0%; height: 100%; background: #0d6efd; transition: width 0.05s; }
    #status { margin-top: 1rem; font-weight: bold; }
    #audioPlayback { margin-top: 1rem; }
  </style>
</head>
<body>
<div class="container text-center">
  <h1>Microphone Tester with Record</h1>
  <p>Click "Start Test" to see input levels, "Record" to record audio, then play it back.</p>

  <button id="startBtn" class="btn btn-primary">Start Test</button>
  <button id="stopBtn" class="btn btn-danger ms-2" disabled>Stop Test</button>
  <button id="recordBtn" class="btn btn-success ms-2" disabled>Start Recording</button>
  <button id="stopRecordBtn" class="btn btn-warning ms-2" disabled>Stop Recording</button>

  <div id="meter">
    <div id="level"></div>
  </div>

  <div id="status">Status: Not started</div>

  <audio id="audioPlayback" controls></audio>
</div>

<script>
let audioContext, analyser, microphone, dataArray, rafId;
let mediaRecorder, recordedChunks = [];

// Start mic test
function startMicTest() {
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert("Microphone access not supported in this browser.");
    return;
  }

  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioContext.createAnalyser();
      microphone = audioContext.createMediaStreamSource(stream);
      microphone.connect(analyser);
      analyser.fftSize = 256;
      dataArray = new Uint8Array(analyser.frequencyBinCount);

      $("#status").text("Status: Mic access granted");
      $("#startBtn").prop("disabled", true);
      $("#stopBtn").prop("disabled", false);
      $("#recordBtn").prop("disabled", false);

      updateMeter();
    })
    .catch(err => {
      $("#status").text("Status: Microphone access denied");
      console.error(err);
    });
}

// Update input level meter
function updateMeter() {
  analyser.getByteTimeDomainData(dataArray);
  let max = 0;
  for (let i = 0; i < dataArray.length; i++) {
    let val = Math.abs(dataArray[i] - 128);
    if (val > max) max = val;
  }
  let level = Math.min(100, (max / 128) * 100);
  $("#level").css("width", level + "%");
  rafId = requestAnimationFrame(updateMeter);
}

// Stop mic test
function stopMicTest() {
  if (rafId) cancelAnimationFrame(rafId);
  if (microphone) microphone.disconnect();
  if (analyser) analyser.disconnect();
  if (audioContext) audioContext.close();

  $("#level").css("width", "0%");
  $("#status").text("Status: Stopped");
  $("#startBtn").prop("disabled", false);
  $("#stopBtn").prop("disabled", true);
  $("#recordBtn").prop("disabled", true);
  $("#stopRecordBtn").prop("disabled", true);
}

// Start recording
function startRecording() {
  recordedChunks = [];
  navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };
      mediaRecorder.onstop = () => {
        const blob = new Blob(recordedChunks, { type: 'audio/webm' });
        const url = URL.createObjectURL(blob);
        $("#audioPlayback").attr("src", url);
      };
      mediaRecorder.start();
      $("#status").text("Status: Recording...");
      $("#recordBtn").prop("disabled", true);
      $("#stopRecordBtn").prop("disabled", false);
    })
    .catch(err => console.error(err));
}

// Stop recording
function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== "inactive") {
    mediaRecorder.stop();
    $("#status").text("Status: Recording stopped, playback ready");
    $("#recordBtn").prop("disabled", false);
    $("#stopRecordBtn").prop("disabled", true);
  }
}

$(function(){
  $("#startBtn").on("click", startMicTest);
  $("#stopBtn").on("click", stopMicTest);
  $("#recordBtn").on("click", startRecording);
  $("#stopRecordBtn").on("click", stopRecording);
});
</script>
</body>
</html>

