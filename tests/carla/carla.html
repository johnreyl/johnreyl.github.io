<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carla - HCBI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.js"></script>
    <style>
        /* Base Styling */
        body {
            font-family: "Inter", sans-serif;
            min-height: 100vh;
            background-color: #f7f7f7;
        }

        /* Fixed Position Container (Icon remains bottom right) */
        #carla-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1050;
        }

        /* Carla Icon Button (Floating Image/Icon) */
        .carla-icon-btn {
            width: 70px;
            height: 70px;
            padding: 0;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 4px solid #fff;
            overflow: hidden;
            cursor: pointer;
            outline: none;
            background-color: #1f3a9a; /* Deep Blue for HCBI theme */
        }
        .carla-icon-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
        }

        /* Popover Styling */
        .carla-popover {
            width: 380px;
            height: 500px; 
            background: white;
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            /* Updated for better scroll control */
            display: flex; 
            flex-direction: column; 
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        
        /* Header */
        .carla-popover-header {
            background-color: #1f3a9a; /* Deep Blue Header */
            color: white;
            flex-shrink: 0; 
        }

        /* Body (Chat Area) */
        .carla-popover-body {
            flex-grow: 1;
            /* CRUCIAL FIX: Changed 'auto' to 'scroll' to force the scrollbar to be visible */
            overflow-y: scroll; 
            padding: 1rem;
            background-color: #f9faff; /* Light blue background for chat */
        }

        /* ---------------------------------------------------- */
        /* Scrollbar Styling for Navigation */
        /* ---------------------------------------------------- */
        .carla-popover-body::-webkit-scrollbar {
            width: 8px; /* Width of the scrollbar */
        }
        .carla-popover-body::-webkit-scrollbar-thumb {
            /* Scrollbar handle */
            background-color: #a0a0a0; 
            border-radius: 10px;
            border: 2px solid #f9faff;
        }
        .carla-popover-body::-webkit-scrollbar-thumb:hover {
             background-color: #707070;
        }
        .carla-popover-body::-webkit-scrollbar-track {
             /* Scrollbar track */
            background: #f1f1f1;
        }
        /* ---------------------------------------------------- */

        /* Carla Response Bubble */
        .carla-response-container {
             display: flex;
             align-items: flex-start;
             margin-bottom: 1rem;
        }
        .carla-response-avatar {
             width: 32px;
             height: 32px;
             min-width: 32px;
             background-color: #1f3a9a; 
             color: white;
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
             margin-right: 0.5rem;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .carla-response {
            background-color: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #d1d5db;
            max-width: 85%;
        }

        /* User Query Bubble */
        .user-query-container {
            display: flex;
            justify-content: flex-end;
            align-items: flex-end;
            margin-bottom: 1rem;
        }
        .user-query-avatar {
             width: 32px;
             height: 32px;
             min-width: 32px;
             background-color: #6366f1; /* Indigo for user */
             color: white;
             border-radius: 50%;
             display: flex;
             align-items: center;
             justify-content: center;
             margin-left: 0.5rem;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .user-query-content {
             display: inline-block;
             max-width: 85%;
             background-color: #1f3a9a; /* Deep Blue Bubble */
             color: white;
             padding: 0.75rem;
             border-radius: 0.75rem 0.75rem 0 0.75rem;
             box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }


        /* Input Area */
        .carla-popover-footer {
            border-top: 1px solid #e0e0e0;
            padding: 1rem;
            background-color: #ffffff;
            flex-shrink: 0; 
        }
        
        .loading-dots span {
            animation: pulse 1s infinite;
        }
        .loading-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .loading-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

        /* Styling for Quick Response Buttons */
        #quick-response-buttons {
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid #e0e0e0; /* Subtle separator line */
        }
        
        .quick-response-button {
            padding: 0.25rem 0.75rem; /* Smaller padding */
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 9999px; /* Pill shape */
            font-size: 0.75rem; /* text-xs for smaller look */
            font-weight: 500;
            color: #1f3a9a; /* Deep Blue text */
            background-color: #f0f4ff; /* Very light background */
            border: 1px solid #c7d2fe; /* Light Indigo border */
            cursor: pointer;
            transition: background-color 0.15s, transform 0.1s;
        }

        .quick-response-button:hover {
            background-color: #e0e7ff;
            transform: translateY(-1px);
        }
    </style>
</head>
<body>
    <!-- NEW DEBUG DIV FOR DISPLAYING LOCALDATA -->
    <div id="debug-data" class="fixed top-0 left-0 w-80 h-1/2 p-4 bg-gray-100 border border-gray-300 rounded-lg overflow-auto z-50 shadow-lg text-xs">
        <h3 class="font-bold text-sm mb-2 text-indigo-700">Local Data Debug View:</h3>
        <pre id="local-data-output" class="whitespace-pre-wrap font-mono"></pre>
    </div>
    <!-- END NEW DEBUG DIV -->

    <div id="carla-container">
        <button id="carla-icon-btn" class="carla-icon-btn flex items-center justify-center">
            <div id="carla-btn-content" class="w-full h-full flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-white">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 9.75a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H7.5m2.25 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm3.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm3.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm-2.625.75L15 15m-4.755-4.245L12 18m-4.245-2.25L7.5 21m-4.625-4.375l2.25 2.25M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
            </div>
        </button>

        <div id="carla-popover" class="carla-popover absolute bottom-full right-0 mb-3 hidden">
            
            <div class="carla-popover-header p-4 flex justify-between items-center rounded-t-xl">
                <h2 class="text-lg font-bold">Carla - HCBI Assistant</h2>
                <button id="carla-close-btn" class="text-white hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <div id="carla-popover-body" class="carla-popover-body flex flex-col">
                <div id="carla-initial-response" class="carla-response-container">
                    <div class="carla-response-avatar">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                            <path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.065A8.243 8.243 0 0010 18.25a8.236 8.236 0 006.125-2.692 1.23 1.23 0 00.41-1.065A8.236 8.236 0 0010 10.75a8.236 8.236 0 00-6.535 3.743z" />
                        </svg>
                    </div>
                    <div class="carla-response shadow-md">
                        <h3 class="font-bold text-xl text-indigo-700 mb-2">Hello, I'm Carla!</h3>
                        <p class="text-gray-700">
                            I am your dedicated assistant for the **Healthcare Billing Institute (HCBI)**. I can help answer questions about our courses, certifications, and medical billing industry topics.
                        </p>
                        <p class="text-sm text-gray-500 mt-2">
                            Ask me anything about HCBI! For example: "What certifications do you offer?"
                        </p>
                        <!-- QUICK RESPONSE BUTTONS ARE NOW INSIDE THE RESPONSE BUBBLE -->
                        <div id="quick-response-buttons" class="mt-2 flex flex-wrap justify-start">
                            <!-- Buttons go here -->
                        </div>
                    </div>
                </div>
            </div>

            <div class="carla-popover-footer">
                <div class="flex items-center space-x-2">
                    <input type="text" id="carla-input" placeholder="Ask a question..." 
                           class="flex-grow p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm">
                    
                    <button id="carla-ask-btn" class="px-3 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150 flex items-center justify-center" style="width: 44px; height: 44px;">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-6 h-6">
                            <path d="M3.105 2.15A1 1 0 014.28 1.488l14.02 7.01a1 1 0 010 1.764l-14.02 7.01A1 1 0 013.105 17.85L17.85 10l-14.745-7.85z" />
                        </svg>
                    </button>
                </div>
                <div id="carla-status" class="text-sm text-center text-gray-500 mt-2 hidden">
                    Carla is thinking<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // --- HCBI .INI CONTENT FALLBACK (Quick Response Buttons) ---
        const mockupDataIni = `[menu buttons]`;

        /**
         * Attempts to fetch carla.ini and falls back to mockupDataIni on failure.
         * @returns {Promise<string>} The INI content string.
         */
        async function loadIniContent() {
            try {
                // Attempt to fetch the external INI file using the simple relative path.
                const iniUrl = 'carla.ini';
                const response = await fetch(iniUrl);
                
                // If the response is not OK (e.g., a 404 error), throw an error to trigger the catch block.
                if (!response.ok) {
                    throw new Error(`Failed to fetch carla.ini: ${response.statusText}`); 
                }
                
                console.log("Successfully loaded carla.ini.");
                return await response.text();
            } catch (error) {
                // FALLBACK LOGIC: On any error (network failure, 404 status, etc.), 
                // the function correctly logs the issue and returns the mockup data.
                console.error("Error loading carla.ini. Using mockup fallback.", error);
                return mockupDataIni;
            }
        }

        // --- INI PARSING AND RENDERING FUNCTIONS ---

        /**
         * Parses the INI content to extract quick response buttons.
         * @returns {Array<{label: string, type: 'link'|'prompt', value: string}>}
         */
        function parseIniContent(content) {
            const buttons = [];
            const lines = content.split('\n');
            let inButtonsSection = false;

            for (const line of lines) {
                const trimmedLine = line.trim();
                if (trimmedLine === '[menu buttons]') {
                    inButtonsSection = true;
                    continue;
                }
                
                if (inButtonsSection && trimmedLine.startsWith('[') && trimmedLine.endsWith(']')) {
                    // Start of a new section, stop parsing buttons
                    break; 
                }

                if (inButtonsSection && trimmedLine) {
                    const parts = trimmedLine.split(',');
                    if (parts.length >= 3) {
                        const label = parts[0].trim();
                        const type = parts[1].trim();
                        let value = parts.slice(2).join(',').trim(); // Handles values containing commas
                        
                        // Remove surrounding quotes from the value if present
                        if (value.startsWith("'") && value.endsWith("'")) {
                            value = value.substring(1, value.length - 1);
                        }

                        if (type === 'link' || type === 'prompt') {
                            buttons.push({ label, type, value });
                        }
                    }
                }
            }
            return buttons;
        }

        /**
         * Renders quick response buttons into the dedicated container.
         */
        function renderQuickResponseButtons(buttons) {
            const container = $('#quick-response-buttons');
            container.empty();
            if (buttons.length > 0) {
                buttons.forEach((button, index) => {
                    const btn = $(`<button 
                                        class="quick-response-button" 
                                        data-type="${button.type}" 
                                        data-value="${button.value}"
                                        data-label="${button.label}"
                                    >
                                        ${button.label}
                                    </button>`);
                    container.append(btn);
                });
            }
        }

        // --- CORE CHAT LOGIC FUNCTIONS ---

        /**
         * Function to update the chat body with the latest response
         */
        function updateCarlaResponse(htmlContent, isUser=false) {
            const body = $('#carla-popover-body');
            
            if (isUser) {
                body.append(`
                    <div class="user-query-container">
                        <div class="user-query-content shadow-md">${htmlContent}</div>
                        <div class="user-query-avatar">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-5.5-2.5a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zM10 12a5.99 5.99 0 00-4.72 2.72.75.75 0 00.33 1.05A7.472 7.472 0 0010 16a7.472 7.472 0 004.39-1.23.75.75 0 00.33-1.05A5.99 5.99 0 0010 12z" clip-rule="evenodd" />
                            </svg>
                        </div>
                    </div>
                `);
            } else {
                body.append(`
                    <div class="carla-response-container">
                        <div class="carla-response-avatar">
                             <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path d="M10 8a3 3 0 100-6 3 3 0 000 6zM3.465 14.493a1.23 1.23 0 00.41 1.065A8.243 8.243 0 0010 18.25a8.236 8.236 0 006.125-2.692 1.23 1.23 0 00.41-1.065A8.236 8.236 0 0010 10.75a8.236 8.236 0 00-6.535 3.743z" />
                            </svg>
                        </div>
                        <div class="carla-response shadow-md">
                            ${htmlContent}
                        </div>
                    </div>
                `);
            }
            body.scrollTop(body[0].scrollHeight);
        }

        // Global state for request in progress
        let isRequestInProgress = false;
        
        // ------------------------------------------------------------------
        // --- BEGIN MODIFIED LOGIC FOR data.csv LOADING & SEARCHING ---
        // ------------------------------------------------------------------

        // 1. Local Knowledge Base (formerly data.csv)
        let localData = []; 

        /** A set of common words to ignore during search scoring to improve relevance. */
        const STOP_WORDS = new Set([
            'a', 'an', 'the', 'is', 'what', 'are', 'i', 'me', 'my', 'mine', 'we', 'us', 'our', 'ours', 
            'you', 'your', 'yours', 'he', 'she', 'it', 'they', 'them', 'their', 'of', 'and', 'or', 
            'to', 'in', 'on', 'at', 'with', 'for', 'from', 'be', 'am', 'was', 'were', 'been', 'do', 
            'does', 'did', 'have', 'has', 'had', 'will', 'would', 'can', 'could', 'should', 'about',
            'how', 'long', 'much', 'many', 'this', 'that', 'these', 'those', 'as', 'but', 'by', 's',
            'm', 'll', 're', 've', 'd', // common contractions
            'hi', 'hello', 'hey', 'tell', 'me', 'about' // conversational phrases
        ]);

        /**
         * Cleans and tokenizes text (splits it into keywords), converting to lowercase and removing stop words.
         * This function handles the user's request to "study and split the keywords within the user prompt(query)".
         * @param {string} text - The input string (query or knowledge base entry).
         * @returns {string[]} An array of cleaned, relevant tokens (keywords).
         */
        function getCleanTokens(text) {
            // Remove punctuation and split by whitespace
            return text.toLowerCase()
                .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, "") // Remove punctuation
                .split(/\s+/) // Split by whitespace
                .filter(token => token.length > 2 && !STOP_WORDS.has(token)); // Filter short words and stop words
        }


        /**
         * Parses CSV text into the expected array of knowledge objects.
         */
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const data = [];
            
            // Skip header line
            if (lines.length <= 1) return [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // 1. Find the index of the first separator comma (end of Question)
                const firstCommaIndex = line.indexOf(',');
                
                // 2. Find the index of the second separator comma (end of keywords)
                const secondCommaIndex = line.indexOf(',', firstCommaIndex + 1);

                if (firstCommaIndex === -1 || secondCommaIndex === -1) {
                    console.warn(`Skipping malformed CSV line (missing 2 separators): ${line}`);
                    continue; 
                }

                // Extract fields based on fixed column positions
                const question = line.substring(0, firstCommaIndex).trim();
                const rawKeywordsString = line.substring(firstCommaIndex + 1, secondCommaIndex).trim();
                const rawAnswer = line.substring(secondCommaIndex + 1).trim();
                
                // Clean up any double quotes that might wrap the fields (though usually unnecessary)
                const cleanedQuestion = question.replace(/^"|"$/g, '');
                const cleanedRawKeywordsString = rawKeywordsString.replace(/^"|"$/g, '');
                const cleanedRawAnswer = rawAnswer.replace(/^"|"$/g, '');

                if (cleanedQuestion && cleanedRawKeywordsString && cleanedRawAnswer) {
                    data.push({
                        question: cleanedQuestion,
                        answer: cleanedRawAnswer,
                        // Keywords are pipe-separated in the middle column
                        keywords: cleanedRawKeywordsString.split('|').map(k => k.trim()).filter(k => k.length > 0),
                        questionTokens: getCleanTokens(cleanedQuestion),
                        answerTokens: getCleanTokens(cleanedRawAnswer)
                    });
                } else {
                     console.warn(`Skipping CSV line due to empty content: ${line}`);
                }
            }
            return data;
        }

        /**
         * Loads the local knowledge data via AJAX.
         */
        function loadLocalData() {
            return new Promise(resolve => {
                $.ajax({
                    url: "data.csv",
                    dataType: "text",
                    success: function(csvText) {
                        console.log("Successfully loaded data.csv.");
                        try {
                            localData = parseCSV(csvText);
                        } catch (e) {
                            console.error("Error parsing CSV data. Using blank fallback.", e);
                            localData = []; 
                        }
                        resolve();
                    },
                    error: function(xhr, status, error) {
                        console.error(`Error loading data.csv (${status}: ${error}). Using blank fallback.`, xhr);
                        localData = []; 
                        resolve();
                    }
                });
            });
        }
        
        /**
         * Finds the best matching answer based on token overlap within a specific field set.
         * @param {string[]} queryTokens - The cleaned tokens of the user's query.
         * @param {Array<Object>} items - The subset of data items to score.
         * @param {string} tokenKey - The property name on the item containing the tokens to compare against ('questionTokens' or 'answerTokens').
         * @returns {string|null} The answer of the best match, or null.
         */
        function findBestTokenMatch(queryTokens, items, tokenKey) {
            if (!items || items.length === 0) return null;

            let bestMatchAnswer = null;
            let highestMatchCount = 0;
            // Require at least 40% of query tokens, or 1, whichever is greater
            const MIN_TOKEN_MATCH = Math.max(1, Math.ceil(queryTokens.length * 0.4)); 

            for (const item of items) {
                const itemTokensSet = new Set(item[tokenKey]);
                let matchCount = 0;

                for (const qToken of queryTokens) {
                    if (itemTokensSet.has(qToken)) {
                        matchCount++;
                    }
                }

                if (matchCount >= MIN_TOKEN_MATCH && matchCount > highestMatchCount) {
                    highestMatchCount = matchCount;
                    bestMatchAnswer = item.answer;
                }
            }

            // Return the best match if it met the minimum threshold
            return highestMatchCount >= MIN_TOKEN_MATCH ? bestMatchAnswer : null;
        }


        /**
         * Function to search the local, embedded dataset using the requested three-tier priority (Fast Path).
         * Priority order: Keywords > Question > Answer
         * @param {string} query - The user's input query.
         * @returns {string|null} The answer string if a high-confidence match is found, otherwise null.
         */
        function searchLocalData(query) {
            if (!localData || localData.length === 0) return null; 
            
            const lowerQuery = query.toLowerCase();
            const queryTokens = getCleanTokens(query); // The split keywords from the user's prompt
            if (queryTokens.length === 0) return null; // No meaningful query

            // --- TIER 1: KEYWORDS (Most precise match) ---
            // 1a. Filter by keyword inclusion (exact phrase matching using CSV keywords)
            const keywordMatches = localData.filter(item => 
                item.keywords.some(keyword => 
                    // Use simple substring check for keywords, as they are often specific terms
                    lowerQuery.includes(keyword.toLowerCase())
                )
            );

            if (keywordMatches.length === 1) {
                // Perfect, unique keyword match found. Return immediately for speed.
                console.log("Local search found unique keyword match (Tier 1 - Exact).");
                return keywordMatches[0].answer;
            } else if (keywordMatches.length > 1) {
                // Multiple keyword matches. Use token overlap on the original question (questionTokens) 
                // to break the tie and find the best fit.
                console.log(`Local search found ${keywordMatches.length} keyword matches (Tier 1 - Scored). Scoring to find best fit...`);
                // Use findBestTokenMatch to score candidates based on queryTokens overlap
                const bestMatch = findBestTokenMatch(queryTokens, keywordMatches, 'questionTokens');
                if (bestMatch) return bestMatch;
            }


            // --- TIER 2: QUESTION ---
            // If no unique keyword match, look for the best token match against the question field.
            console.log("Local search proceeding to Question tier (Token Match)...");
            const questionMatches = localData; 
            const bestQuestionAnswer = findBestTokenMatch(queryTokens, questionMatches, 'questionTokens');
            
            if (bestQuestionAnswer) {
                console.log("Local match found in Question tier.");
                return bestQuestionAnswer;
            }


            // --- TIER 3: ANSWER ---
            // If no match in Question, look for the best match in the Answer field.
            console.log("Local search proceeding to Answer tier (Token Match)...");
            const answerMatches = localData; 
            const bestAnswer = findBestTokenMatch(queryTokens, answerMatches, 'answerTokens');
            
            if (bestAnswer) {
                console.log("Local match found in Answer tier.");
                return bestAnswer;
            }

            // --- NO MATCH ---
            console.log("Local search found no suitable match.");
            return null;
        }

        // ------------------------------------------------------------------
        // --- END MODIFIED LOGIC FOR data.csv LOADING & SEARCHING ---
        // ------------------------------------------------------------------

        /**
         * Function to update the debug div with the current localData content.
         */
        function displayLocalDataForDebug() {
            const outputElement = $('#local-data-output');
            if (localData && localData.length > 0) {
                // Use JSON.stringify for a structured view, indenting for readability
                const formattedData = JSON.stringify(localData, null, 2);
                outputElement.text(formattedData);
            } else {
                outputElement.text("No data loaded or parsed.");
            }
        }


        /**
         * Formats the localData array into a string representation for the LLM prompt.
         * Format: [question, keyword|keyword, answer]
         */
        function formatLocalDataForPrompt() {
            let formattedData = "LOCAL KNOWLEDGE BASE (DATA.CSV):\n";
            // Check if localData is populated before iterating
            if (localData && localData.length > 0) {
                 localData.forEach(item => {
                    const keywords = item.keywords.join('|');
                    // Ensure the answer is clean and on one line for the prompt
                    const answer = item.answer.replace(/\s+/g, ' ').trim(); 
                    formattedData += `[${item.question}, ${keywords}, ${answer}]\n`;
                });
            } else {
                 formattedData += "No local data loaded.\n";
            }
            return formattedData.trim();
        }

        /**
         * Function to handle the LLM API call (with Google Search grounding for external HCBI content).
         */
        async function geminiApiCall(userQuery, attempts = 0) {
            const maxRetries = 3;
            const systemPrompt = "You are Carla, an expert assistant for the Healthcare Billing Institute (HCBI). Your goal is to answer questions using both a provided LOCAL KNOWLEDGE BASE (DATA.CSV) and Google Search grounding. 1. If the user's prompt includes a 'LOCAL KNOWLEDGE BASE', prioritize finding the answer there first. 2. If the LOCAL KNOWLEDGE BASE is insufficient or not present, you MUST use Google Search to find information specifically on the HCBI website (https://healthcarebillinginstitute.com) or related external sources. Keep your response professional, friendly, and concise. Only answer questions related to HCBI or medical billing.";
            const apiKey = "" 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && attempts < maxRetries) {
                        const delay = Math.pow(2, attempts) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return geminiApiCall(userQuery, attempts + 1);
                    }
                    throw new Error(`API request failed with status: ${response.status}`);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    let text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;

                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title); 
                    }
                    
                    let sourceHtml = '';
                    if (sources.length > 0) {
                        // Only show unique source titles for conciseness
                        const uniqueSources = Array.from(new Set(sources.map(s => s.title)));
                        sourceHtml = `
                            <div class="mt-3 pt-3 border-t border-gray-100 text-xs text-gray-500">
                                <span class="font-semibold text-gray-600">Sources:</span> 
                                ${uniqueSources.join(', ')}
                            </div>`;
                    }

                    updateCarlaResponse(`
                        <h3 class="font-bold text-lg text-indigo-700 mb-2">Carla's Response:</h3>
                        <p class="text-gray-700">${text}</p>
                        ${sourceHtml}
                    `);

                } else {
                     updateCarlaResponse(`
                        <h3 class="font-bold text-lg text-red-500 mb-2">Error:</h3>
                        <p class="text-gray-700">I received an empty response. Please try phrasing your question differently.</p>
                    `);
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                 updateCarlaResponse(`
                    <h3 class="font-bold text-lg text-red-500 mb-2">Network Error:</h3>
                    <p class="text-gray-700">I encountered an issue connecting to the knowledge base. Please check your connection or try again later.</p>
                `);
            }
        }


        /**
         * Main function to answer the user's question (from input box).
         */
        async function answerQuestion(query) {
            query = query.trim();
            if (!query || isRequestInProgress) return;

            isRequestInProgress = true;
            $('#carla-input').prop('disabled', true).val(''); // Clear and disable input
            $('#carla-ask-btn').prop('disabled', true).addClass('opacity-50');
            $('#carla-status').removeClass('hidden');

            // 1. Display user query
            updateCarlaResponse(query, true);

            // 2. Check Local Knowledge Base (data.csv equivalent)
            const localAnswer = searchLocalData(query);
            
            if (localAnswer) {
                updateCarlaResponse(`
                    <h3 class="font-bold text-lg text-indigo-700 mb-2">Carla's Local Response:</h3>
                    <p class="text-gray-700">${localAnswer}</p>
                    <p class="text-xs text-gray-500 mt-2">This answer was retrieved from Carla's internal knowledge base (fast lookup).</p>
                `);
            } else {
                // 3. Call LLM API with Local Data as context
                
                // Construct the prompt to include the local data
                const dataPrompt = formatLocalDataForPrompt();
                const fullPrompt = `User Query: "${query}"\n\nIf the User Query can be answered by the data provided below (LOCAL KNOWLEDGE BASE), use that answer. Otherwise, proceed with search.\n\n${dataPrompt}`;
                
                await geminiApiCall(fullPrompt);
            }

            // 4. Reset state
            isRequestInProgress = false;
            $('#carla-input').prop('disabled', false).focus();
            $('#carla-ask-btn').prop('disabled', false).removeClass('opacity-50');
            $('#carla-status').addClass('hidden');
        }

        /**
         * Function to handle a prompt button click directly, displaying its value as the response.
         */
        async function handlePromptButton(label, value) {
            if (isRequestInProgress) return;

            isRequestInProgress = true;
            $('#carla-input').prop('disabled', true);
            $('#carla-ask-btn').prop('disabled', true).addClass('opacity-50');
            $('#carla-status').removeClass('hidden');

            // 1. Show the button's label as the *intent* of the user
            updateCarlaResponse(`**User selected Quick Response:** "${label}"`, true);
            
            // 2. Display the prompt value directly as Carla's response.
            updateCarlaResponse(`
                <h3 class="font-bold text-lg text-indigo-700 mb-2">Carla's Quick Reply:</h3>
                <p class="text-gray-700">${value}</p>
            `);

            // 3. Reset state
            isRequestInProgress = false;
            $('#carla-input').prop('disabled', false).focus();
            $('#carla-ask-btn').prop('disabled', false).removeClass('opacity-50');
            $('#carla-status').addClass('hidden');
        }


        // --- Event Handlers and Initialization ---

        $(document).ready(async function() {
            
            // --- DATA LOADING ---
            await loadLocalData();
            console.log(`Local data initialization complete. ${localData.length} records loaded.`);

            // --- DEBUG DATA DISPLAY (NEW) ---
            displayLocalDataForDebug();

            // --- Carla Image Loading Logic ---
            const carlaBtnContent = $('#carla-btn-content');
            const carlaSvg = carlaBtnContent.html(); // Store the default SVG

            const loadCarlaImage = () => {
                const img = new Image();
                img.src = 'carla.jpg';
                img.alt = 'Carla Assistant Avatar';
                img.className = 'w-full h-full object-cover';
                
                img.onload = function() {
                    carlaBtnContent.empty().append(img);
                };

                img.onerror = function() {
                    carlaBtnContent.html(carlaSvg); 
                };
            };

            loadCarlaImage();
            
            // --- Quick Response Button Rendering ---
            const iniContent = await loadIniContent(); 
            const quickResponseButtons = parseIniContent(iniContent);
            renderQuickResponseButtons(quickResponseButtons);


            // --- Popover Toggle and Close ---
            
            $('#carla-icon-btn, #carla-close-btn').on('click', function(e) {
                e.stopPropagation(); 
                $('#carla-popover').slideToggle(200, function() {
                    if ($(this).is(':visible')) {
                        $(this).css('display', 'flex');
                    }
                });
            });

            $(document).on('click', function(e) {
                const container = $('#carla-container');
                const popover = $('#carla-popover');
                const iconBtn = $('#carla-icon-btn');
                
                if (popover.is(':visible') && !container.is(e.target) && container.has(e.target).length === 0 && !iconBtn.is(e.target) && iconBtn.has(e.target).length === 0) {
                    popover.slideUp(200);
                }
            });

            $('#carla-popover').on('click', function(e) {
                e.stopPropagation();
            });


            // --- Input and Ask Button Handlers ---
            
            function handleAsk() {
                const query = $('#carla-input').val();
                if (query.trim()) {
                    answerQuestion(query);
                }
            }
            
            $('#carla-ask-btn').on('click', handleAsk);

            $('#carla-input').on('keypress', function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    handleAsk();
                }
            });
            
            // --- INI Button Logic ---
            $('#quick-response-buttons').on('click', '.quick-response-button', function() {
                const type = $(this).data('type');
                const value = $(this).data('value');
                const label = $(this).data('label'); // Get the label for display purposes

                if (type === 'link') {
                    window.open(value, '_blank'); 
                } else if (type === 'prompt') {
                    handlePromptButton(label, value);
                }
            });
            // --- END INI Button Logic ---


        });
    </script>

</body>
</html>
