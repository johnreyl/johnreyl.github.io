<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Inventory System (Catalog-Backed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define the primary theme color (Deep Blue, inspired by Gogoanime) */
        .theme-blue-500 { --tw-bg-opacity: 1; background-color: rgb(29 78 216 / var(--tw-bg-opacity)); }
        .theme-blue-600 { --tw-bg-opacity: 1; background-color: rgb(37 99 235 / var(--tw-bg-opacity)); }
        .theme-blue-700 { --tw-bg-opacity: 1; background-color: rgb(30 64 175 / var(--tw-bg-opacity)); }
        .theme-text-blue-600 { color: rgb(37 99 235); }
        /* Focus styles for inputs */
        .theme-focus-blue-500:focus { border-color: rgb(37 99 235); ring-color: rgb(37 99 235); }

        /* Custom CSS for the camera feed and responsiveness */
        #scanner-container {
            position: relative;
            width: 100%;
            height: 300px; 
            overflow: hidden;
            background: #1f2937; /* Dark background */
            border-radius: 0.5rem;
        }

        #scanner-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* The canvas used by Quagga2 for drawing detection lines */
        #scanner-container canvas.drawingBuffer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        /* Modal Overlays Styling (Combined Delete and Unknown Item Modal) */
        .modal-overlay {
            background-color: rgba(17, 24, 39, 0.9); /* Darker overlay */
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            pointer-events: none;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .modal-dialog {
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.3s ease-in-out;
        }

        .modal-overlay.active .modal-dialog {
            transform: scale(1);
            opacity: 1;
        }

        body {
            background-color: #f3f4f6; /* Light gray background */
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8">

    <div id="confirm-modal" class="modal-overlay fixed inset-0 hidden items-center justify-center z-50" aria-modal="true" role="dialog">
        <div class="modal-dialog bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-xl font-semibold text-gray-900 mb-4">Confirm Action</h3>
            <p id="confirm-message" class="text-sm text-gray-600 mb-6">Are you sure you want to proceed?</p>
            <div class="flex justify-end space-x-3">
                <button id="confirm-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150">Cancel</button>
                <button id="confirm-ok" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Confirm</button>
            </div>
        </div>
    </div>

    <div id="unknown-item-modal" class="modal-overlay fixed inset-0 hidden items-center justify-center z-50" aria-modal="true" role="dialog">
        <div class="modal-dialog bg-white p-6 rounded-xl shadow-2xl max-w-lg w-full">
            <h3 class="text-xl font-bold theme-text-blue-600 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                New Item Detected!
            </h3>
            <p class="text-sm text-gray-700 mb-4">Barcode <strong id="modal-barcode-display" class="font-mono text-gray-900"></strong> is not in inventory or catalog. Please enter essential details.</p>

            <form id="unknown-item-form" class="space-y-4">
                <input type="hidden" id="modal-barcode-input" name="barcode">
                <div>
                    <label for="modal-name" class="block text-sm font-medium text-gray-700">Product Name</label>
                    <input type="text" id="modal-name" name="name" required
                           class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border theme-focus-blue-500 transition duration-150 ease-in-out"
                           placeholder="Enter product name">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="modal-quantity" class="block text-sm font-medium text-gray-700">Initial Quantity</label>
                        <input type="number" id="modal-quantity" name="quantity" required min="1"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border theme-focus-blue-500 transition duration-150 ease-in-out"
                               value="1">
                    </div>
                    <div>
                        <label for="modal-price" class="block text-sm font-medium text-gray-700">Unit Price ($)</label>
                        <input type="number" id="modal-price" name="price" required step="0.01" min="0"
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border theme-focus-blue-500 transition duration-150 ease-in-out"
                               placeholder="0.00">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" id="modal-cancel-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-150">Cancel</button>
                    <button type="submit" id="modal-save-btn"
                            class="px-4 py-2 rounded-lg shadow-md text-sm font-medium text-white theme-blue-600 hover:theme-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                        Save and Add Stock
                    </button>
                </div>
            </form>
        </div>
    </div>


    <div id="message-box" class="fixed top-5 right-5 p-4 rounded-lg shadow-xl text-white opacity-0 transition-opacity duration-300 pointer-events-none" role="alert">
        <span id="message-text"></span>
    </div>

    <div class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Smart Inventory Tracker</h1>
            <p class="text-lg text-gray-500 mt-2">Scan, Track, and Manage your stock effortlessly (Catalog-Backed).</p>
        </header>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <div class="bg-white p-6 rounded-xl shadow-lg h-fit">
                <h2 class="text-2xl font-semibold theme-text-blue-600 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2m4-4l-4 4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Stock Movement (Add/Edit)
                </h2>
                <form id="item-form" class="space-y-4">
                    <div>
                        <label for="barcode" class="block text-sm font-medium text-gray-700">Barcode / SKU (Scanned)</label>
                        <input type="text" id="barcode" name="barcode" required
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border theme-focus-blue-500 bg-gray-100 transition duration-150 ease-in-out"
                               placeholder="Scan or enter barcode" readonly>
                    </div>
                    <div>
                        <label for="name" class="block text-sm font-medium text-gray-700">Product Name</label>
                        <input type="text" id="name" name="name" required
                               class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border theme-focus-blue-500 transition duration-150 ease-in-out"
                               placeholder="Auto-filled/Manually entered">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity to Add</label>
                            <input type="number" id="quantity" name="quantity" required min="1"
                                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border theme-focus-blue-500 transition duration-150 ease-in-out"
                                   value="1">
                        </div>
                        <div>
                            <label for="price" class="block text-sm font-medium text-gray-700">Unit Price ($)</label>
                            <input type="number" id="price" name="price" required step="0.01" min="0"
                                   class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm p-3 border theme-focus-blue-500 transition duration-150 ease-in-out"
                                   placeholder="0.00">
                        </div>
                    </div>

                    <button type="submit" id="save-item-btn"
                            class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-sm font-medium text-white theme-blue-600 hover:theme-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out disabled:theme-blue-500/50">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2m4-4l-4 4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        Add Stock to Inventory
                    </button>
                </form>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold theme-text-blue-600 mb-6 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10m0 0h16m0 0v-6m0 6l-5-5m5 5l-5 5m0-5h-6m6 0v-4m-4 4h-2m2 0v-2m0 2h-2"></path></svg>
                    Barcode Scanner
                </h2>

                <div id="scanner-container">
                    <div id="interactive" class="viewport"></div>
                </div>

                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-4">
                    <button id="start-scanner-btn"
                            class="flex-1 py-3 px-4 rounded-lg shadow-md text-sm font-medium text-white theme-blue-600 hover:theme-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                        Start Camera Scan
                    </button>
                    <button id="stop-scanner-btn" disabled
                            class="flex-1 py-3 px-4 rounded-lg shadow-md text-sm font-medium text-white bg-red-500 hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out disabled:bg-red-300">
                        Stop Scanner
                    </button>
                </div>
                <p id="scanner-status" class="mt-4 text-center text-sm text-gray-600">Scanner Ready. Click 'Start Camera Scan' to begin.</p>
            </div>
        </div>
        <div class="mt-12 bg-white p-6 rounded-xl shadow-lg">
            <h2 class="text-2xl font-semibold theme-text-blue-600 mb-6 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                Current Inventory
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Barcode/SKU</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Qty</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventory-list" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="text-center py-4 text-gray-500">Inventory loading or empty...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2/dist/quagga.min.js"></script>

    <script>

        let pendingDeleteId = null; 
        let currentInventory = []; 
        const LOCAL_STORAGE_KEY = 'smartInventoryData';
        let scannerRunning = false; 

        // --- PRODUCT CATALOG DEFINITION ---
        // Contains product metadata (name, description, image, base price).
        const productCatalog = [
            {
                barcode: '9300605002593', 
                name: 'Crunchy Cereal Box',
                description: 'A large box of crunchy, honey-glazed oat cereal, perfect for breakfast.',
                image: 'https://images.unsplash.com/photo-1543825824-c1044455855f?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwzNTkyOXwwfDF8c2VhcmNofDEzfHxoc3xlbnwwfHx8fDE2NzA4NDc3MTc&ixlib=rb-4.0.3&q=80&w=400',
                price: 4.50 
            },
            {
                barcode: '123456789012', 
                name: 'Ergonomic Wireless Mouse',
                description: '2.4GHz wireless mouse with adjustable DPI, designed for all-day comfort.',
                image: 'https://images.unsplash.com/photo-1546252912-886915152064?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwzNTkyOXwwfDF8c2VhcmNofDR8fGNvbXB1dGVyJTIwbW91c2V8ZW58MHx8fHwxNjcwODQ4MjIy&ixlib=rb-4.0.3&q=80&w=400',
                price: 29.99
            },
            {
                barcode: '987654321098', 
                name: 'Mechanical Keyboard (Black)',
                description: 'Full-size keyboard with tactile brown switches and RGB backlight.',
                image: 'https://images.unsplash.com/photo-1587840176317-a068097b3708?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=MnwzNTkyOXwwfDF8c2VhcmNofDIyfHxrZXlib2FyZHxlbnwwfHx8fDE2NzA4NDgyMjI&ixlib=rb-4.0.3&q=80&w=400',
                price: 59.95
            }
        ];
        // ----------------------------
        
        // --- Utility Functions ---
        const showMessage = (text, type = 'success') => {
            const $msgBox = $('#message-box');
            let colorClass = 'bg-green-500'; 
            if (type === 'error') colorClass = 'bg-red-500';
            if (type === 'warning') colorClass = 'bg-yellow-500';
            if (type === 'info') colorClass = 'theme-blue-600'; 

            $msgBox.removeClass('bg-red-500 bg-yellow-500 bg-green-500 theme-blue-600').addClass(colorClass);
            $('#message-text').text(text);
            $msgBox.removeClass('opacity-0 pointer-events-none').addClass('opacity-100');

            setTimeout(() => {
                $msgBox.removeClass('opacity-100').addClass('opacity-0 pointer-events-none');
            }, 3000);
        };


        // --- Local Storage Management ---

        // Loads inventory data from localStorage (Inventory starts empty, not using mock data)
        const loadInventoryFromStorage = () => {
            try {
                const data = localStorage.getItem(LOCAL_STORAGE_KEY);
                currentInventory = data ? JSON.parse(data) : [];
                
                renderInventoryList(currentInventory);
            } catch (error) {
                console.error("Error loading inventory from local storage:", error);
                showMessage("Error loading inventory data. Starting empty.", 'error');
                currentInventory = [];
                renderInventoryList(currentInventory);
            }
        };

        // Saves inventory data to localStorage and re-renders the list
        const saveInventoryToStorage = () => {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(currentInventory));
                renderInventoryList(currentInventory);
            } catch (error) {
                console.error("Error saving inventory to local storage:", error);
                showMessage("Error saving inventory data.", 'error');
            }
        };


        // --- Modal/UI Handlers ---
        const showConfirmModal = (message, itemId) => { 
            pendingDeleteId = itemId;
            $('#confirm-message').text(message);
            $('#confirm-ok').text('Confirm Delete');
            $('#confirm-modal').removeClass('hidden').addClass('active flex');
        };

        const hideConfirmModal = () => { 
            $('#confirm-modal').removeClass('active flex').addClass('hidden');
            pendingDeleteId = null;
        };
        
        // Modal logic uses catalog data if available to prefill
        const showUnknownItemModal = (barcode, catalogItem = null) => {
            $('#modal-barcode-display').text(barcode);
            $('#modal-barcode-input').val(barcode);
            
            // Prefill from catalog if available (or empty strings)
            $('#modal-name').val(catalogItem ? catalogItem.name : '');
            $('#modal-price').val(catalogItem ? catalogItem.price : 0.00); 
            $('#modal-quantity').val(1); 
            
            $('#unknown-item-modal').removeClass('hidden').addClass('active flex');

            $('html, body').animate({
                scrollTop: $('#item-form').offset().top
            }, 500);

            resetAutofillForm();
        };

        const hideUnknownItemModal = () => {
            $('#unknown-item-modal').removeClass('active flex').addClass('hidden');
        };


        // --- Data Operations (Stock Tracking Logic) ---

        const saveItem = (itemData) => {
            const existingItem = currentInventory.find(item => item.barcode === itemData.barcode);

            if (existingItem) {
                // UPDATE: Increase quantity
                const newQuantity = existingItem.quantity + itemData.quantity;
                existingItem.quantity = newQuantity;

                // Update name/price only if different (allows for corrections)
                if (itemData.name !== existingItem.name) existingItem.name = itemData.name;
                if (itemData.price !== existingItem.price) existingItem.price = itemData.price;


                showMessage(`Added ${itemData.quantity} of ${existingItem.name}. New Qty: ${existingItem.quantity}`, 'info');
            } else {
                // ADD new item to inventory
                const newItem = {
                    id: crypto.randomUUID(),
                    ...itemData,
                    timestamp: Date.now()
                };
                currentInventory.push(newItem);
                showMessage(`Added new item to inventory: ${newItem.name}`, 'success');
            }
            
            saveInventoryToStorage();
        };

        const deleteItem = (itemId) => {
            const initialLength = currentInventory.length;
            currentInventory = currentInventory.filter(item => item.id !== itemId);

            if (currentInventory.length < initialLength) {
                saveInventoryToStorage();
                showMessage("Item deleted successfully!", 'success');
            } else {
                showMessage("Error: Item not found.", 'error');
            }
        };

        // --- UI Rendering ---

        const renderInventoryList = (items) => {
            const $listBody = $('#inventory-list');
            $listBody.empty(); // Clear existing list

            if (items.length === 0) {
                $listBody.append('<tr><td colspan="5" class="text-center py-4 text-gray-500">Inventory is empty. Scan an item to add stock.</td></tr>');
                return;
            }

            items.forEach(item => {
                const row = `
                                <tr class="hover:bg-gray-50 transition duration-150 ease-in-out">
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.barcode}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${(item.price || 0).toFixed(2)}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <button data-id="${item.id}" data-name="${item.name}" class="delete-btn text-red-600 hover:text-red-900 transition duration-150 ease-in-out p-1 rounded-lg hover:bg-red-100">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            `;
                $listBody.append(row);
            });

            // Attach delete listener using the custom modal
            $('.delete-btn').off('click').on('click', function () {
                const itemId = $(this).data('id');
                const itemName = $(this).data('name');
                showConfirmModal(`Are you sure you want to delete "${itemName}" from the inventory?`, itemId);
            });
        };

        // --- Barcode Scanner Logic (Quagga2) ---
        const stopScanner = () => {
             const QuaggaRef = window.Quagga;
             if (typeof QuaggaRef !== 'undefined' && QuaggaRef.initialized) {
                 if (QuaggaRef.stop) {
                     QuaggaRef.stop();
                 }
                 $('#interactive').empty(); 
                 $('#scanner-status').text('Scanner stopped.');
                 $('#start-scanner-btn').prop('disabled', false).removeClass('bg-gray-400').addClass('theme-blue-600');
                 $('#stop-scanner-btn').prop('disabled', true);
                 scannerRunning = false;
                 console.log("Scanner stopped.");
             } else if (scannerRunning) {
                 $('#scanner-status').text('Scanner stopped (manual halt).');
                 $('#start-scanner-btn').prop('disabled', false).removeClass('bg-gray-400').addClass('theme-blue-600');
                 $('#stop-scanner-btn').prop('disabled', true);
                 scannerRunning = false;
             }
        }

        const startScanner = () => { 
            if (scannerRunning) return;

            const QuaggaRef = window.Quagga;

            if (typeof QuaggaRef === 'undefined') {
                showMessage("Barcode scanner library failed to load. Please try refreshing.", 'error');
                $('#scanner-status').text('Error: Scanner library not available.');
                return;
            }

            QuaggaRef.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#interactive'),
                    constraints: {
                        facingMode: "environment", // Use rear camera on mobile
                        width: { min: 640, ideal: 1280 },
                        height: { min: 480, ideal: 720 },
                        singleChannel: true
                    }
                },
                decoder: {
                    readers: ["ean_reader", "upc_reader", "ean_8_reader", "code_128_reader"],
                    multiple: false
                },
                locator: {
                    patchSize: "medium",
                    halfSample: true,
                    minConfidence: 0.8
                },
                numOfWorkers: 0,
                frequency: 10,
            }, function (err) {
                if (err) {
                    console.error(err);
                    $('#scanner-status').text(`Error initializing scanner: ${err.name}. Try starting again.`);
                    showMessage(`Camera error: ${err.message || 'Cannot access camera. Check permissions.'}`, 'error');
                    return
                }
                QuaggaRef.start();
                scannerRunning = true;
                $('#scanner-status').text('Scanning... Point camera at a barcode.');
                $('#start-scanner-btn').prop('disabled', true).removeClass('theme-blue-600').addClass('bg-gray-400');
                $('#stop-scanner-btn').prop('disabled', false);
            });

            // Handle detection success
            QuaggaRef.onDetected(function (result) {
                const code = result.codeResult.code;
                console.log("Barcode detected:", code);

                stopScanner(); // Stop the scanner immediately upon detection
                handleScannedBarcode(code); // Process the scanned code

                showMessage(`Barcode detected: ${code}`, 'info');
            });
            
            // Handle drawing on the canvas 
            QuaggaRef.onProcessed(function (result) {
                if (typeof window.Quagga === 'undefined' || !window.Quagga.canvas) return;

                const drawingCtx = window.Quagga.canvas.ctx.overlay,
                    drawingCanvas = window.Quagga.canvas.dom.overlay;

                if (result) {
                    drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                    if (result.box) {
                        window.Quagga.ImageDebug.drawPath(result.box, { x: 0, y: 1 }, drawingCtx, { color: "#00F", lineWidth: 2 });
                    }
                    if (result.codeResult && result.codeResult.code) {
                        window.Quagga.ImageDebug.drawPath(result.line, { x: 'x', y: 'y' }, drawingCtx, { color: "red", lineWidth: 3 });
                    }
                }
            });
        }

        // Resets and clears the autofill form section
        const resetAutofillForm = () => {
            $('#item-form').trigger('reset'); // Clear form
            $('#barcode').val('').prop('readonly', true);
            $('#name').val('');
            $('#quantity').val(1);
            $('#price').val('');
        };

        // Main logic to handle a scanned barcode
        const handleScannedBarcode = (barcode) => {
            const existingItem = currentInventory.find(item => item.barcode === barcode);
            const catalogItem = productCatalog.find(item => item.barcode === barcode); // Check catalog for metadata

            if (existingItem) {
                // EXISTING STOCK: Auto-fill form for quick adding of stock (+1)
                $('#barcode').val(barcode).prop('readonly', true);
                $('#name').val(existingItem.name);
                $('#quantity').val(1); // Default to adding 1
                $('#price').val(existingItem.price);

                showMessage(`Existing stock detected: ${existingItem.name}. Ready to add stock.`, 'info');

            } else {
                 // NEW ITEM: Use catalog data if available, otherwise prompt via modal
                if (catalogItem) {
                    // Item exists in Catalog, auto-fill form for adding initial stock
                    $('#barcode').val(barcode).prop('readonly', true);
                    $('#name').val(catalogItem.name);
                    $('#quantity').val(1); 
                    $('#price').val(catalogItem.price);
                    
                    showMessage(`Product found in catalog: ${catalogItem.name}. Ready to add initial stock.`, 'info');
                } else {
                    // Item not in Catalog or Inventory, show modal
                    showUnknownItemModal(barcode);
                }
            }
            
            // Scroll to the form
            $('html, body').animate({
                scrollTop: $('#item-form').offset().top
            }, 500);
        };

        // --- Document Ready and Event Binding ---

        $(document).ready(function () {

            // Load inventory on startup (inventory starts empty)
            loadInventoryFromStorage();

            // Bind scanner buttons
            $('#start-scanner-btn').on('click', startScanner);
            $('#stop-scanner-btn').on('click', stopScanner); 

            // Bind manual form submission (for existing items or manual entry)
            $('#item-form').on('submit', function (e) {
                e.preventDefault();

                const barcode = $('#barcode').val();
                if (!barcode) {
                    showMessage("Please scan a barcode or enter a SKU manually.", 'warning');
                    return;
                }
                
                // Form data to JSON object (Stock fields)
                const itemData = {
                    barcode: barcode,
                    name: $('#name').val(),
                    quantity: parseInt($('#quantity').val() || 0),
                    price: parseFloat($('#price').val() || 0),
                };

                // Validate
                if (itemData.quantity <= 0 || itemData.price < 0 || !itemData.name) {
                    showMessage("Please ensure all fields are filled correctly (Qty > 0, Price >= 0).", 'error');
                    return;
                }

                saveItem(itemData);
                resetAutofillForm(); // Clear the form after saving
            });


            // Bind Unknown Item Modal submission
            $('#unknown-item-form').on('submit', function(e) {
                e.preventDefault();
                
                // Form data to JSON object (Stock fields)
                const itemData = {
                    barcode: $('#modal-barcode-input').val(),
                    name: $('#modal-name').val(),
                    quantity: parseInt($('#modal-quantity').val() || 0),
                    price: parseFloat($('#modal-price').val() || 0),
                };

                // Validate
                if (itemData.quantity <= 0 || itemData.price < 0 || !itemData.name) {
                    showMessage("Please ensure all fields are filled correctly.", 'error');
                    return;
                }
                
                saveItem(itemData);
                hideUnknownItemModal(); // Close the modal
            });

            // Bind Unknown Item Modal Cancel Button
            $('#modal-cancel-btn').on('click', function() {
                hideUnknownItemModal();
                showMessage("New item entry cancelled.", 'warning');
            });


            // Confirmation Modal Event Handlers
            $('#confirm-cancel').on('click', hideConfirmModal);
            $('#confirm-ok').on('click', function () {
                if (pendingDeleteId) {
                    deleteItem(pendingDeleteId);
                }
                hideConfirmModal();
            });
        });

        // Ensure scanner stops when the page is unloaded (best practice)
        window.onbeforeunload = function () {
            stopScanner();
        };
    </script>
</body>
</html>